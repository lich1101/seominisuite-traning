var liveTime=0;var now=0;var diff=0;var onlytabs=["https://seominisuite.com/quan-ly-backlink/du-an","https://seominisuite.com/kiem-tra-dao-van","https://seominisuite.com/quan-ly-keywords/du-an"];console.log("now",now);console.log("Service Worker");function resetAll(tab=null){chrome.storage.local.get("key",async function(result){let key=result.key;key["executeTab"]=null;key["request"]=null;key["sender"]=null;if(tab!==null){key["removeTab"]=true}key["executeTabTimeout"]=0;chrome.storage.local.set({key:key},function(e){})})}async function cassiopeiaKeywordPromiseResponse(response,responseText,_request,_sender,waitStatus){if(response!==undefined){chrome.storage.local.get("key",async function(result){let key=result.key;let sender=key.sender;let request=key.request;let executeTabTimeout=key.executeTabTimeout;let executeTabDelay=key.executeTabDelay;if(responseText==="waiting"){let responseObj={};responseObj["status"]="waiting";responseObj["index"]=request.currentObj.index;responseObj["id"]=request.currentObj.id;responseObj["currentObj"]=request.currentObj;responseObj["checkType"]=request.type;cassiopeiaSendResponse(request.data,responseObj,sender,"captcha_stop");resetAll()}else if(responseText==="error"){let responseObj={};responseObj["status"]="error";responseObj["index"]=request.currentObj.index;responseObj["id"]=request.currentObj.id;responseObj["currentObj"]=request.currentObj;responseObj["checkType"]=request.type;cassiopeiaSendResponse(request.data,responseObj,sender,"captcha_stop");resetAll()}else{if(response.url.includes("sorry/index?continue=https://www.google.com")){chrome.tabs.create({url:response.url,active:false},async function(tab){setVariables(null,null,tab);var editorExtensionId=chrome.runtime.id;const tabId=await tab.id;if(!tab.url)await onTabUrlUpdated(tabId);const results=await chrome.scripting.executeScript({target:{tabId:tabId},func:setTabId,args:[editorExtensionId,tab]},()=>{});const sss=await chrome.scripting.executeScript({target:{tabId:tabId,allFrames:true},files:["js/tab_captcha.js"]},result=>{if(executeTabTimeout!==0){clearTimeout(executeTabTimeout)}executeTabTimeout=setTimeout(function(){chrome.storage.local.get("key",async function(result){let executeTab=result.key.executeTab;let request=result.key.request;let sender=result.key.sender;key=result.key;key["removeTab"]=true;if(sender&&sender.tab.id===sender.tab.id&&executeTab&&executeTab.id===tabId){let responseObj={};responseObj["timeout"]="timeout";responseObj["index"]=request.currentObj.index;responseObj["url"]=request.currentObj.url;responseObj["id"]=request.currentObj.id;responseObj["stt"]=request.currentObj.stt;responseObj["currentObj"]=request.currentObj;responseObj["content"]=new Array(responseText);cassiopeiaSendResponse(request.data,responseObj,sender,"KeyCheck");resetAll()}clearTimeout(executeTabTimeout);setVariables(null,null,null,0)})},executeTabDelay)})})}else{chrome.storage.local.get("key",async function(result){let request=result.key.request;let sender=result.key.sender;let responseObj={};if(request!==null){responseObj["index"]=request.currentObj.index;responseObj["url"]=request.currentObj.url;responseObj["id"]=request.currentObj.id;responseObj["stt"]=request.currentObj.stt;responseObj["currentObj"]=request.currentObj;responseObj["content"]=new Array(responseText);cassiopeiaSendResponse(request.data,responseObj,sender,"KeyCheck");resetAll()}})}}})}else{}}async function sendKeywordResponse(response){chrome.storage.local.get("key",async function(result){let key=result.key;let executeTab=key.executeTab;let executeTabTimeout=key.executeTabTimeout;let executeTabDelay=key.executeTabDelay;let responseText;const longTask=()=>new Promise(resolve=>resolve(response.text())).then(value=>cassiopeiaKeywordPromiseResponse(response,value,key.request,key.sender,true)).catch(_error=>console.log("error",_error));const timeout=(cb,interval)=>()=>new Promise(resolve=>setTimeout(()=>cb(resolve),interval));const onTimeout=timeout(resolve=>resolve("waiting"),12e4);Promise.race([longTask,onTimeout].map(f=>f())).then(value=>cassiopeiaKeywordPromiseResponse(response,value,key.request,key.sender,true));responseText=await response.text()})}function clearTabs(){chrome.storage.local.get("key",async function(result){let key=result.key;key["tabs"]=[];chrome.storage.local.set({key:key})})}function setVariables(sender=null,request=null,executeTab=null,executeTabTimeout=null,executeTabDelay=null){chrome.storage.local.get("key",async function(result){let key=result.key;if(request!==null){key["request"]=request}if(sender!==null){key["sender"]=sender}if(executeTab!==null){key["executeTab"]=executeTab}if(executeTab!==null){key["tabs"].push(executeTab)}if(executeTabTimeout!==null){key["executeTabTimeout"]=executeTabTimeout}if(executeTabDelay!==null){key["executeTabDelay"]=executeTabDelay}chrome.storage.local.set({key:key})})}function setTabId(editorExtensionId,tab){document.body.setAttribute("editorExtensionId",editorExtensionId);document.body.setAttribute("tabID",tab.id)}async function wait(time){return new Promise(resolve=>{setTimeout(resolve,time)})}async function tabDragging(callback){chrome.windows.getAll({populate:true},function(windows){var window=windows.filter(function(x){return x.type==="normal"&&x.focused&&x.tabs&&x.tabs.length})[0];if(window===undefined){return}else{var tab=window.tabs[0];chrome.tabs.move(tab.id,{index:tab.index},function(){callback(chrome.runtime.lastError&&chrome.runtime.lastError.hasOwnProperty("message")&&chrome.runtime.lastError.message.indexOf("dragging")!==-1)})}})}async function deleteTab(tab){return new Promise((resolve,reject)=>{try{chrome.tabs.remove(tab.id,function(tabIds){resolve(tabIds)});removeError()}catch(e){reject(e)}})}function removeError(){chrome.runtime.lastError=null}function getAllTabs(options){return new Promise((resolve,reject)=>{try{chrome.tabs.query(options,function(tabs){resolve(tabs)})}catch(e){reject(e)}})}function cassiopeiaSendResponse(data,responseObj,sender,type){chrome.tabs.sendMessage(sender.tab.id,{type:type,data:data,responseObj:responseObj},function(response){chrome.power.releaseKeepAwake();removeError()})}function cassiopeiaPromiseResponseError(error,_request,_sender,waitStatus){let value="error";return cassiopeiaPromiseResponse(value,_request,_sender,false)}async function cassiopeiaPromiseResponse(value,_request,_sender,waitStatus){let data={};if(value!==undefined){data["currentObj"]=_request.currentObj;if(value==="waiting"){data["index"]=_request.currentObj.index;data["id"]=_request.currentObj.id;data["stt"]=_request.currentObj.stt;data["status"]="TIME_OUT";data["waitStatus"]="waiting";cassiopeiaSendResponse(_request.data,data,_sender,_request.type)}else if(value==="error"){data["index"]=_request.currentObj.index;data["id"]=_request.currentObj.id;data["stt"]=_request.currentObj.stt;data["recheck"]=_request.currentObj.recheck;data["waitStatus"]=true;data["status"]="ERROR";cassiopeiaSendResponse(_request.data,data,_sender,_request.type)}else{let status=value.status;let responseText=await value.text();data["index"]=_request.currentObj.index;data["id"]=_request.currentObj.id;data["stt"]=_request.currentObj.stt;data["waitStatus"]=waitStatus;data["status"]=status;data["responseText"]=new Array(responseText);cassiopeiaSendResponse(_request.data,data,_sender,_request.type)}}}chrome.runtime.onMessage.addListener(async function(_request,_sender,sendResponse){chrome.power.requestKeepAwake("system");chrome.storage.local.get("key",async function(result){let key=result.key;let executeTab=key.executeTab;let executeTabTimeout=key.executeTabTimeout;let executeTabDelay=key.executeTabDelay;let sender=key.sender;let request=key.request;let _tabs=key.tabs;if(_tabs.length){_tabs.forEach(function(item,index){if(item.pendingUrl.includes("google.com/search?")||item.pendingUrl.includes("sorry/index?continue")){deleteTab(item)}})}key["tabs"]=[];key["auto_remove"]=true;chrome.storage.local.set({key:key});if(_request.type==="captcha_dos"){if(_sender&&executeTab&&executeTab.id===_sender.tab.id){let responseObj={};responseObj["index"]=request.currentObj.index;responseObj["id"]=request.currentObj.id;responseObj["currentObj"]=request.currentObj;responseObj["checkType"]=request.type;cassiopeiaSendResponse(request.data,responseObj,sender,"captcha_dos");resetAll()}sendResponse({response:true})}else if(_request.type==="getNow"){let _temp;if(now===0){_temp=0}else{_temp=(performance.now()-now)/1e3}chrome.tabs.sendMessage(_sender.tab.id,{type:_request.type,data:_request.data,stt:_request.stt,now:_temp},function(response){chrome.power.releaseKeepAwake();removeError()})}else if(_request.type==="captcha_not_hander"){let responseObj={};if(request!==null){responseObj["index"]=request.currentObj.index;responseObj["id"]=request.currentObj.id;responseObj["currentObj"]=request.currentObj;responseObj["checkType"]=request.type;cassiopeiaSendResponse(request.data,responseObj,sender,"captcha_stop")}resetAll()}else{setVariables(_sender,_request);sendResponse({response:""});if(_request.type==="KeyCheck"){if(now===0){now=performance.now()}else{diff=(performance.now()-now)/1e3;if(diff>295){let responseObj={};responseObj["index"]=_request.currentObj.index;responseObj["id"]=_request.currentObj.id;responseObj["currentObj"]=_request.currentObj;responseObj["checkType"]=_request.type;cassiopeiaSendResponse(_request.data,responseObj,_sender,"may_doi_tao_30s");resetAll();return}}let linkUrl=_request.currentObj.searchEngine+"/search?q="+_request.currentObj.key+"&num=100&hl="+_request.currentObj.language+"&start=0&ie=utf-8&oe=utf-8";var myRequest=new Request(linkUrl);let response=await fetch(myRequest);if(response.ok){let responseText=await response.text();cassiopeiaKeywordPromiseResponse(response,responseText,key.request,key.sender,true)}else{if(response.url.includes("sorry/index?continue=https://www.google.com")){chrome.tabs.create({url:response.url,active:false},async function(tab){key["request"]=_request;key["sender"]=_sender;key["auto_remove"]=false;chrome.storage.local.set({key:key});let _delay=Math.floor((295-diff)*1e3);if(executeTabDelay>_delay){executeTabDelay=_delay}setVariables(null,null,tab);var editorExtensionId=chrome.runtime.id;if(tab==null){let responseObj={};responseObj["index"]=request.currentObj.index;responseObj["id"]=request.currentObj.id;responseObj["currentObj"]=request.currentObj;responseObj["checkType"]=request.type;cassiopeiaSendResponse(request.data,responseObj,sender,"captcha_stop")}else{const tabId=await tab.id;if(!tab.url)await onTabUrlUpdated(tabId);const results=await chrome.scripting.executeScript({target:{tabId:tabId},func:setTabId,args:[editorExtensionId,tab]},()=>{});const sss=await chrome.scripting.executeScript({target:{tabId:tabId,allFrames:true},files:["js/tab_captcha.js"]},result=>{if(executeTabTimeout!==0){clearTimeout(executeTabTimeout)}executeTabTimeout=setTimeout(async function(){let responseText=await response.text();chrome.storage.local.get("key",async function(result){let executeTab=result.key.executeTab;let request=result.key.request;let sender=result.key.sender;if(sender&&sender.tab.id===sender.tab.id&&executeTab&&executeTab.id===tabId){let responseObj={};responseObj["timeout"]="timeout";responseObj["index"]=request.currentObj.index;responseObj["url"]=request.currentObj.url;responseObj["id"]=request.currentObj.id;responseObj["stt"]=request.currentObj.stt;responseObj["currentObj"]=request.currentObj;responseObj["content"]=new Array(responseText);cassiopeiaSendResponse(request.data,responseObj,sender,"KeyCheck");resetAll()}clearTimeout(executeTabTimeout);setVariables(null,null,null,0)})},executeTabDelay)})}})}else{let responseObj={};responseObj["index"]=_request.currentObj.index;responseObj["id"]=_request.currentObj.id;responseObj["currentObj"]=_request.currentObj;responseObj["checkType"]=_request.type;cassiopeiaSendResponse(_request.data,responseObj,_sender,_request.type);resetAll()}}}else if(_request.type==="CheckBackLinkIndexed"){if(now===0){now=performance.now()}else{diff=(performance.now()-now)/1e3;if(diff>295){let responseObj={};responseObj["index"]=_request.currentObj.index;responseObj["id"]=_request.currentObj.id;responseObj["currentObj"]=_request.currentObj;responseObj["checkType"]=_request.type;cassiopeiaSendResponse(_request.data,responseObj,_sender,"may_doi_tao_30s");resetAll();return}}let linkUrl="https://www.google.com/search?q=site:"+_request.currentObj.source+"&hl=vi";let response=await fetch(linkUrl).catch(error=>{});let responseText=await response.text();if(response.url.includes("sorry/index?continue=https://www.google.com")){chrome.tabs.create({url:response.url,active:false},async function(tab){key["request"]=_request;key["sender"]=_sender;key["auto_remove"]=false;chrome.storage.local.set({key:key});let _delay=Math.floor((295-diff)*1e3);if(executeTabDelay>_delay){executeTabDelay=_delay}setVariables(null,null,tab);var editorExtensionId=chrome.runtime.id;const tabId=await tab.id;if(!tab.url)await onTabUrlUpdated(tabId);const results=await chrome.scripting.executeScript({target:{tabId:tabId},func:setTabId,args:[editorExtensionId,tab]},()=>{});chrome.scripting.executeScript({target:{tabId:tabId,allFrames:true},files:["js/tab_captcha.js"]},result=>{executeTab=tab;if(executeTabTimeout!=0){clearTimeout(executeTabTimeout)}executeTabTimeout=setTimeout(function(){chrome.storage.local.get("key",async function(result){let executeTab=result.key.executeTab;let request=result.key.request;let sender=result.key.sender;if(sender&&sender.tab.id===_sender.tab.id&&executeTab&&executeTab.id===tab.id){let responseObj={};responseObj["index"]=_request.currentObj.index;responseObj["id"]=_request.currentObj.id;responseObj["backlink"]=_request.currentObj.backlink;responseObj["currentObj"]=_request.currentObj;responseObj["content"]=new Array(responseText);cassiopeiaSendResponse(_request.data,responseObj,_sender,"CheckBackLinkIndexed");resetAll()}clearTimeout(executeTabTimeout);setVariables(null,null,null,0)})},executeTabDelay)})})}else{let responseObj={};responseObj["index"]=_request.currentObj.index;responseObj["id"]=_request.currentObj.id;responseObj["backlink"]=_request.currentObj.backlink;responseObj["currentObj"]=_request.currentObj;responseObj["content"]=new Array(responseText);cassiopeiaSendResponse(_request.data,responseObj,_sender,"CheckBackLinkIndexed");resetAll()}}else if(_request.type==="CheckBackLink"){if(now===0){now=performance.now()}else{}let _delay;if(_request.delay<290){_delay=Math.floor((295-_request.delay)*1e3)}else{_delay=1e3}let _error=false;const longTask=()=>new Promise(resolve=>resolve(fetch(_request.currentObj.source))).then(value=>cassiopeiaPromiseResponse(value,_request,_sender,true)).catch(_error=>cassiopeiaPromiseResponseError(_error,_request,_sender,false));const timeout=(cb,interval)=>()=>new Promise(resolve=>setTimeout(()=>cb(resolve),interval));const onTimeout=timeout(resolve=>resolve("waiting"),_delay);Promise.race([longTask,onTimeout].map(f=>f())).then(value=>cassiopeiaPromiseResponse(value,_request,_sender,true));return true}else if(_request.type==="CheckDuplicateContent"){if(now===0){now=performance.now()}else{diff=(performance.now()-now)/1e3;if(diff>295){let responseObj={};responseObj["index"]=_request.currentObj.index;responseObj["id"]=_request.currentObj.id;responseObj["currentObj"]=_request.currentObj;responseObj["checkType"]=_request.type;cassiopeiaSendResponse(_request.data,responseObj,_sender,"may_doi_tao_30s");resetAll();return}}let linkUrl='https://www.google.com/search?q="'+_request.currentObj.value+'"&num=100&hl=vi&start=0&ie=utf-8&oe=utf-8';let _error=false;let response=await fetch(linkUrl).catch(error=>{_error=true});if(_error!==true){let responseText=await response.text();if(response.url.includes("sorry/index?continue=https://www.google.com")){chrome.tabs.create({url:response.url,active:false},async function(tab){key["request"]=_request;key["sender"]=_sender;key["auto_remove"]=false;chrome.storage.local.set({key:key});let _delay=Math.floor((295-diff)*1e3);if(executeTabDelay>_delay){executeTabDelay=_delay}setVariables(null,null,tab);var editorExtensionId=chrome.runtime.id;const tabId=await tab.id;if(!tab.url)await onTabUrlUpdated(tabId);const results=await chrome.scripting.executeScript({target:{tabId:tabId},func:setTabId,args:[editorExtensionId,tab]},()=>{});const sss=await chrome.scripting.executeScript({target:{tabId:tabId,allFrames:true},files:["js/tab_captcha.js"]},result=>{if(executeTabTimeout!==0){clearTimeout(executeTabTimeout)}})})}else{chrome.storage.local.get("key",async function(result){let key=result.key;let sender=key.sender;let request=key.request;let executeTabTimeout=key.executeTabTimeout;let executeTabDelay=key.executeTabDelay;let responseObj={};responseObj["index"]=_request.currentObj.index;responseObj["id"]=_request.currentObj.id;responseObj["currentObj"]=_request.currentObj;responseObj["content"]=new Array(responseText);cassiopeiaSendResponse(request.data,responseObj,sender,"CheckDuplicateContent");resetAll()})}}else{}}}});return true});function loadTabJS(){}chrome.tabs.onUpdated.addListener(async function(tabId,changeInfo,tab){$checkInonlytabs=false;for(var i=0;i<onlytabs.length;i++){if(tab.url.includes(onlytabs[i])===true){$checkInonlytabs=true}}if($checkInonlytabs){var tabs=await getAllTabs({});$counterTab=0;if(tabs&&tabs.hasOwnProperty("length")){for(var i=0;i<tabs.length;i++){for(var j=0;j<onlytabs.length;j++){if(tabs[i].url.includes(onlytabs[j])===true){$counterTab=$counterTab+1}}}}if($counterTab>=2){wait(500);await deleteTab(tab);chrome.runtime.lastError=null;alert("Vui lòng chỉ mở 1 tab chức năng!")}else{afterUpdateTab(tabId,changeInfo,tab)}}else{afterUpdateTab(tabId,changeInfo,tab)}});function onTabUrlUpdated(tabId){return new Promise((resolve,reject)=>{const onUpdated=(id,info)=>id===tabId&&info.url&&done(true);const onRemoved=id=>id===tabId&&done(false);chrome.tabs.onUpdated.addListener(onUpdated);chrome.tabs.onRemoved.addListener(onRemoved);function done(ok){chrome.tabs.onUpdated.removeListener(onUpdated);chrome.tabs.onRemoved.removeListener(onRemoved);(ok?resolve:reject)()}})}chrome.tabs.onCreated.addListener(async function(tab){$checkInonlytabs=false;for(var i=0;i<onlytabs.length;i++){if(tab.url.includes(onlytabs[i])===true){$checkInonlytabs=true}}if($checkInonlytabs){var tabs=await getAllTabs({});$counterTab=0;for(var i=0;i<tabs.length;i++){for(var j=0;j<onlytabs.length;j++){if(tab.url.includes(onlytabs[i])===true){$counterTab=$counterTab+1}}}if($counterTab>=1){wait(500);deleteTab(tab);alert("Vui lòng chỉ mở 1 tab chức năng!")}else{}}else{}});chrome.tabs.onRemoved.addListener(function(tabId,removeInfo){chrome.storage.local.get("key",function(result){let key=result.key;let sender=key.sender;let request=key.request;let executeTab=key.executeTab;let auto_remove=key.auto_remove;if(sender){if(executeTab){if(tabId===executeTab.id&&auto_remove==false){let responseObj={};responseObj["index"]=request.currentObj.index;responseObj["id"]=request.currentObj.id;responseObj["currentObj"]=request.currentObj;responseObj["checkType"]=request.type;cassiopeiaSendResponse(request.data,responseObj,sender,"captcha_stop");resetAll()}}}})});function afterUpdateTab(tabId,changeInfo,tab){chrome.storage.local.get("key",function(result){let key=result.key;let executeTab=key.executeTab;let sender=key.sender;let request=key.request;let executeTabTimeout=key.executeTabTimeout;if(changeInfo.hasOwnProperty("url")){if(changeInfo.url.includes("search?q")){if(executeTab!==null&&tabId===executeTab.id){chrome.scripting.executeScript({target:{tabId:tabId},files:["js/tab_script_check_keyword.min.js"]},result=>{let responseObj={};if(request.type==="KeyCheck"){responseObj["captcha"]="yes";responseObj["index"]=request.currentObj.index;responseObj["url"]=request.currentObj.url;responseObj["id"]=request.currentObj.id;responseObj["stt"]=request.currentObj.stt}else if(request.type==="CheckDuplicateContent"){responseObj["index"]=request.currentObj.index;responseObj["id"]=request.currentObj.id}else if(request.type==="CheckBackLinkIndexed"){responseObj["index"]=request.currentObj.index;responseObj["id"]=request.currentObj.id;responseObj["backlink"]=request.currentObj.backlink;responseObj["currentObj"]=request.currentObj}let temp=[];result.forEach(function(item,index,arr){temp.push(item.result)});if(result[0]!==null&&result[0]!==""){responseObj["content"]=temp}responseObj["currentObj"]=request.currentObj;cassiopeiaSendResponse(request.data,responseObj,sender,request.type);clearTimeout(executeTabTimeout);resetAll(tab)})}else{}}else{}}else{}})}chrome.runtime.onInstalled.addListener(async function(details){var key={};key["tabs"]=[];key["executeTab"]=null;key["request"]=null;key["sender"]=null;key["spinUrlRequest"]="";key["executeTabDelay"]=12e4;key["executeTabTimeout"]=0;chrome.storage.local.set({key:key});var tabs=await getAllTabs({});if(tabs&&tabs.hasOwnProperty("length")){for(var i=0;i<tabs.length;i++){if(tabs[i].url.search("https://seominisuite.com")==0){chrome.tabs.reload(tabs[i].id,{},function(){})}}}});chrome.runtime.onMessageExternal.addListener(function(request,sender,sendResponse){sendResponse({response:""})});