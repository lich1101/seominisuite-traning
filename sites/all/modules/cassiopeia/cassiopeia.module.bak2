<?php
global $user;
define("BASIC",171348);
define("AGENCY",158033);
function cassiopeia_init() {
  global $user;
  drupal_add_js(array('user_js_uid' => $user->uid), 'setting');

  drupal_add_css(drupal_get_path('module', 'cassiopeia') . '/js/libs/jquery-confirm/jquery-confirm.min.css');
  drupal_add_js(drupal_get_path('module', 'cassiopeia') . '/js/libs/jquery-confirm/jquery-confirm.min.js');
}
/**
 * Implements hook_menu().
 */
function cassiopeia_menu() {
    $items = array();


    $items['admin/manager/user/export'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_user_excel_export_callback',
        'title'             => t('Download Excel'),
        'access callback' => 'cassiopeia_user_manager_accept',
        'file'              => 'cassiopeia.inc',
    );

    // Thêm tab cài đặt hàng đợi
    $items['admin/config/system/cassiopeia/queue'] = array(
        'title' => 'Cài đặt hàng đợi',
        'description' => 'Cấu hình hàng đợi cho Cassiopeia.',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('cassiopeia_queue_settings_form'),
        'access arguments' => array('administer site configuration'),
        'file' => 'cassiopeia.inc',
    );

    $items['excel/download'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_download_excel_callback',
        'title'             => t('Download Excel'),
        'access arguments'  => array('access content'),
//        'file'              => 'cassiopeia.inc',
    );
    $items['extension/download'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_download_exntesion_callback',
        'title'             => t('Download Extension'),
        'access arguments'  => array('access content'),
//        'file'              => 'cassiopeia.inc',
    );

    // API endpoint để nhận dữ liệu từ extension
    $items['api/extension/data'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_extension_data_callback',
        'delivery callback' => 'drupal_json_output',
        'access arguments'  => array('access content'),
        'file'              => 'cassiopeia.extension.inc',
    );
    $items['active'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_account_active_callback',
        'title'             => t('Kích hoạt tài khoản'),
        'access arguments'  => array('access content'),
//        'file'              => 'cassiopeia.inc',
    );
// Menu
    $items['speech'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_speech_page_callback',
        'delivery callback' => 'drupal_json_output',
        'title' => t('Speech'),
        'access arguments' => array('access content'),
        'file' => 'cassiopeia.inc',
    );

    //Handler



// Enable module cors

    $items['cai-dat'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_setting_page_callback',
        'title'             => t('Cài đặt'),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['get-url'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_get_url_page_callback',
        'title'             => t('Demo'),
        'access arguments' => array('cassiopeia module'),
        'file'              => 'cassiopeia.inc',
    );
    $items['kiem-tra-dao-van'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_check_duplicate_content_page_callback',
        'title'             => t('Kiểm tra đạo văn'),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['booking/complete'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_booking_complete_page_callback',
        'title'             => t('Quản lý từ khóa'),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['quan-ly-keywords'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_keyword_projects_page_callback',
        'title'             => t('Quản lý từ khóa'),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['quan-ly-du-an-content/%project_id'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_content_project_detail_page_callback',
        'title'             => t('Chi tiết dự án Content'),
        'page arguments'    => array(1),
        'access callback' => 'cassiopeia_user_project_accept',
        'access arguments' => array(1),
        'file'              => 'cassiopeia.inc',
    );
    $items['quan-ly-du-an-content/%project_id/add'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_content_add_page_callback',
        'title'             => t('Thêm bài viết content'),
        'page arguments'    => array(1),
        'access callback' => 'cassiopeia_user_project_accept',
        'access arguments' => array(1),
        'file'              => 'cassiopeia.inc',
    );
    $items['quan-ly-du-an-content/%project_id/bai-viet/%content_article/edit'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_content_edit_page_callback',
        'title'             => t('Cập nhật bài viết content'),
        'page arguments'    => array(1,3),
        'access callback' => 'cassiopeia_user_project_accept',
        'access arguments' => array(1),
        'file'              => 'cassiopeia.inc',
    );
    $items['quan-ly-du-an-content/%project_id/bai-viet/%content_id'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_content_project_article_detail_page_callback',
        'title'             => t('Chi tiết bài Content'),
        'page arguments'    => array(2),
        'access callback' => 'cassiopeia_user_project_accept',
        'access arguments' => array(2),
        'file'              => 'cassiopeia.inc',
    );
    $items['quan-ly-du-an-content/du-an/%project_id'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_content_project_detail_page_callback',
        'title'             => t('Quản lý dự án content'),
        'page arguments'    => array(2),
        'access callback' => 'cassiopeia_user_project_accept',
        'access arguments' => array(2),
        'file'              => 'cassiopeia.inc',
    );
    $items['quan-ly-du-an-content'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_content_project_page_callback',
        'title'             => t('Quản lý dự án content'),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['quan-ly-du-an-content/export'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_content_project_page_callback',
        'title'             => t('Quản lý dự án content'),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['quan-ly-backlink'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_backlink_projects__page_callback',
        'title'             => t('Quản lý backlink'),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['quan-ly-backlink/du-an/%project_id'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_backlink_project_detail_page_callback',
        'title'             => t('Dự án backlink'),
        'page arguments'    => array(2),
        'access callback' => 'cassiopeia_user_project_accept',
        'access arguments' => array(2),
        'file'              => 'cassiopeia.inc',
    );
    $items['kiem-tra-dao-van/export'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_duplicate_export_excel_page_callback',
        'title'             => t('Xuất excel'),
//        'page arguments'    => array(2),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
//    $items['quan-ly-backlink/du-an/%project_id/export'] = array(
//        'type'              => MENU_CALLBACK,
//        'page callback'     => 'cassiopeia_backlink_project_detail_page_callback',
//        'title'             => t('Dự án backlink'),
//        'page arguments'    => array(2),
//        'access arguments'  => array('access content'),
////        'file'              => 'cassiopeia.inc',
//    );
    $items['quan-ly-backlink/du-an/%project_id/bao-cao'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_backlink_project_detail_report_page_callback',
        'title'             => t('Báo cáo dự án backlink'),
        'page arguments'    => array(2),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['quan-ly-keywords/du-an/%project_id/bao-cao'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_keyword_project_detail_report_page_callback',
        'title'             => t('Báo cáo dự án Từ khóa'),
        'page arguments'    => array(2),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['quan-ly-keywords/du-an/%project_id'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_keyword_project_detail_page_callback',
        'title'             => t('Dự án Từ khóa'),
        'page arguments'    => array(2),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['kiem-tra-thu-hang-tu-khoa'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_key_check_page_callback',
        'title'             => t('Kiểm tra thứ hạng từ khóa'),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['product'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_product_page_callback',
        'title'             => t('Mua gói dịch vụ'),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['price-board'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_price_board_page_callback',
        'title'             => t('Mua gói dịch vụ'),
        'access arguments'  => array('access content'),
        'file'              => 'cassiopeia.inc',
    );
    $items['price-confirm'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_price_confirm_page_callback',
        'title'             => t('Mua gói dịch vụ'),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['gio-hang'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_shopping_cart_page_callback',
        'title'             => t('Giỏ hàng'),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );

//    $items['admin/dev/config'] = array(
//        'type' => MENU_NORMAL_ITEM,
//        'title' => t('Cài đặt'),
//        'page callback' => array('drupal_get_form'),
//        'page arguments' => array('cassiopeia_dev_config_form'),
//        'access arguments' => array('cassiopeia module'),
//        'file' => 'cassiopeia.inc',
//    );
    $items['get-url/result'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_get_url_result_page_callback',
        'title'             => t('Get urls'),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['test'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_test_page_callback',
        'title'             => t('Test'),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['home'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_home_page_callback',
        'title'             => t('Home'),
        'access arguments'  => array('access content'),
        'file'              => 'cassiopeia.inc',
    );
    $items['dashboard'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_user_dashboard_page_callback',
        'title'             => t('Home'),
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );

    $items['admin/cassiopeia/dev'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_dev_page_callback',
        'title'             => t('For dev'),
        'access arguments'  => array('cassiopeia module'),
        'file'              => 'cassiopeia.inc',
    );
    $items['admin/cassiopeia/dashboard'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_dashboard_page_callback',
        'title'             => t('Dashboard'),
        'access arguments'  => array('cassiopeia module'),
        'file'              => 'cassiopeia.inc',
    );
    $items['admin/manager/user'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_admin_manager_user_page_callback',
        'title'             => t('Quản lý tài khoản người dùng'),
        'access callback' => 'cassiopeia_user_manager_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['admin/manager/report'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_admin_manager_report_page_callback',
        'title'             => t('Báo cáo doanh thu'),
        'access arguments'  => array('cassiopeia module'),
        'file'              => 'cassiopeia.inc',
    );
    $items['admin/manager/booking'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_admin_manager_booking_page_callback',
        'title'             => t('Mua gói sản phẩm'),
        'access callback' => 'cassiopeia_booking_manager_accept',
        'file'              => 'cassiopeia.inc',
    );
    $items['admin/manager/booking/%booking/edit'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_booking_edit_callback',
        'title'             => t('Xử lý đơn hàng'),
        'page arguments'    => array(3),
        'access arguments'  => array('cassiopeia module'),
        'file'              => 'cassiopeia.inc',
    );
    $items['admin/config/cassiopeia'] = array(
        'title'             => 'Cassiopeia',
        'description'       => 'Cassiopeia tools.',
        'page callback'     => 'system_admin_menu_block_page',
        'access arguments'  => array('cassiopeia module'),
        'file'              => 'system.admin.inc',
        'file path'         => drupal_get_path('module', 'system'),
    );

    $items['admin/add/booking'] = array(
        'type'              => MENU_NORMAL_ITEM,
        'title'             => t('Thêm mới'),
        'page callback'     => array('drupal_get_form'),
        'page arguments'    => array('cassiopeia_admin_add_booking_form'),
        'access arguments'  => array('cassiopeia module'),
//        'file'              => 'cassiopeia.inc',
    );
    $items['admin/config/cassiopeia/general'] = array(
        'type'              => MENU_NORMAL_ITEM,
        'title'             => t('General configuration'),
        'page callback'     => array('drupal_get_form'),
        'page arguments'    => array('cassiopeia_config_form'),
        'access arguments'  => array('cassiopeia module'),
        'file'              => 'cassiopeia.inc',
    );
    $items['admin/config/cassiopeia/general'] = array(
        'type'              => MENU_NORMAL_ITEM,
        'title'             => t('General configuration'),
        'page callback'     => array('drupal_get_form'),
        'page arguments'    => array('cassiopeia_config_form'),
        'access arguments'  => array('cassiopeia module'),
        'file'              => 'cassiopeia.inc',
    );
    $items['admin/config/cassiopeia/witai-config'] = array(
        'type'              => MENU_NORMAL_ITEM,
        'title'             => t('Cầu hình WitAI'),
        'page callback'     => array('drupal_get_form'),
        'page arguments'    => array('cassiopeia_config_witai_form'),
        'access arguments'  => array('cassiopeia module'),
//        'file'              => 'cassiopeia.inc',
    );

    $items['cassiopeia/ajax'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_ajax_page',
        'delivery callback' => 'drupal_json_output',
        'access callback' => 'cassiopeia_user_accept',
        'file'              => 'cassiopeia.inc',
    );
 $items['test/ajax'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_test_ajax_page',
        'delivery callback' => 'drupal_json_output',
     'access arguments'  => array('access content'),
        'file'              => 'cassiopeia.inc',
    );

  return $items;
}
function content_article_load($id){
    try{
        $query = db_select("cassiopeia_content","cassiopeia_content");
        $query->fields("cassiopeia_content");
        $query->condition("id",$id);
        $result = $query->execute()->fetchObject();
        return  $result;
    }catch (Exception $e){
        return null;
    }
}
function content_article_delete($node){
    global $user;
    $db_transaction = db_transaction();
    try{
        if($node->uid == $user->uid){
            db_delete("cassiopeia_content")->condition("id",$node->id)->execute();
            db_delete("tbl_tags")->condition("nid",$node->id)->execute();
            return true;
        }
        return false;
    }catch (Exception $e){
        $db_transaction->rollback();
        return false;
    }
}
function cassiopeia_booking_manager_accept(){
    if(user_has_role(3) || user_has_role(5)){
        return true;
    }else{
        return false;
    }
}
function cassiopeia_user_manager_accept(){
    if(user_has_role(3) || user_has_role(5)){
        return true;
    }else{
        return false;
    }
}
function cassiopeia_account_active_callback(){
    $arg = arg();
    if(!empty($arg[1])){
        $md5 = $arg[1];
        try{
            $query = db_select("users","tbl_user");
            $query->fields("tbl_user");
            $query->join("field_data_field_md5","field_md5","field_md5.entity_id=tbl_user.uid");
            $query->condition("field_md5.field_md5_value",$md5);
            $_account = $query->execute()->fetchObject();
            if(!empty($_account)){
                $account = user_load($_account->uid);
                $account->status=1;
                $account->field_md5['und'][0]['value'] = "";
                user_save($account);
                $form_state['uid'] = $account->uid;
                user_login_submit(array(), $form_state);
                drupal_goto("/dashboard");
            }else{
                drupal_set_message("Không tìm thấy tài khoản tương ứng hoặc link kích hoạt đã hết hạn!");
                drupal_goto("/user");
            }
        }catch (Exception $e){
            _print_r($e);
        }
    }
}
/**
 * Implements hook_permission().
 */
function cassiopeia_user_accept(){
    global $user;
    if(!empty($user->uid)){
        return true;
    }else{
        drupal_goto("/user");
    }
}
function cassiopeia_user_project_accept($project_id){
    global $user;
    $project = node_load($project_id);
    if(empty($user->uid)){
        return false;
    }
    if($project->uid==$user->uid || $user->uid==1){
        return true;
    }else{
        return false;
    }
}
function project_id_load($projectID){
    return $projectID;
}
function booking_load($code){
    $result = cassiopeia_get_booking_by_code($code);
    return $result;
}
function cassiopeia_permission() {
  return array(
    'cassiopeia module' => array(
      'title' => t('cassiopeia module'),
      'description' => t('Access for Cassiopeia module'),
    )
  );
}


function _cassiopeia_admin_theme() {
  return 'cassiopeia_admin_theme';
}

// =----- alter -------------

/**
 * Implements hook_menu_alter().
 */
function cassiopeia_menu_alter(&$items) {
//  $items['taxonomy/term/%taxonomy_term']['module'] = 'cassiopeia';
  $items['taxonomy/term/%taxonomy_term']['page callback'] = '_cassiopeia_tvi_render_term_view';
  $items['taxonomy/term/%taxonomy_term']['page arguments'] = array(2);
  $items['node/%node']['page callback'] = '_cassiopeia_node_render_view';
    $items['node/%node/delete']['access callback'] ='_cassiopeia_node_access';
  $items['node/%node']['page arguments'] = array(1);
}
function _cassiopeia_node_access($op, $node = null, $account = NULL) {
    $arg = arg();
    if (empty($account)) {
        $account = $GLOBALS['user'];
        $_user = user_load($account->uid);
    }
    $access = node_access($op, $node, $account);
    $type = is_object($node) ? $node->type : $node;

    if(!empty($account->uid) && $access) {
        if($type=="product"){
//            _print_r($op);
            if(!empty($arg[2])){
                switch ($arg[2]) {
                    case 'edit':
//                        $access = cassiopeia_node_edit_access($node);
                        break;
                    case 'delete':
                        if($arg[1] == BASIC || $arg[1]==AGENCY){
                            return false;
                        }
                        break;
                }
            }

        }

    }else {
//        _print_r("2");
    }
    return $access;
}

/**
 * Implements hook_variable_info().
 */

function cassiopeia_variable_info($options) {
}


// =----- End alter -------------

function _cassiopeia_node_render_view($node) {
  global $user;
  if (is_object($node)) {
    $nid = $node->nid;
  }
  else {
    $node = node_load($node);
  }
  if (module_exists('metatag')) {
    metatag_entity_view($node, 'node', 'full', NULL);
  }
  if ($node->type == 'article') {
     return _cassiopeia_render_theme('module', 'cassiopeia', 'templates/nodes/node-article-detail.tpl.php', array('node' => $node));
  }
  if ($node->type == 'regulation') {
     return _cassiopeia_render_theme('module', 'cassiopeia', 'templates/nodes/node-regulation-detail.tpl.php', array('node' => $node));
  }

  return node_page_view($node);
}



function _cassiopeia_tvi_render_term_view($term, $depth = NULL) {
  if (is_object($term)) {
    $tid = $term->tid;
  }
  else {
    $term = taxonomy_term_load($term);
  }
  if (module_exists('metatag')) {
    metatag_entity_view($term, 'taxonomy_term', 'full', NULL);
  }
  if ($term->vocabulary_machine_name == 'tx_article') {
//    return _cassiopeia_render_theme('module', 'cassiopeia', 'templates/term/page-tx-article.tpl.php', array('term' => $term));
  }


  module_load_include('inc', 'taxonomy', 'taxonomy.pages');
  return taxonomy_term_page($term);
}


function cassiopeia_theme($existing, $type, $theme, $path) {
  $themes = array(
    'cassiopeia_table_drag_components' => array(
      'render element' => 'element'
    ),
      'cassiopeia_user_profile_form' => array(
          'render element' => 'form',
          'template' => 'cassiopeia_user_profile_form',
          'path' => drupal_get_path('module', 'cassiopeia') . '/templates/forms'
      ),

  );
  return $themes;
}

function theme_cassiopeia_table_drag_components($vars) {
  $element = $vars['element'];

  drupal_add_tabledrag($vars['element']['#id'] . '-table', 'order', 'sibling', 'item-row-weight');

  $header = array(
    'label' => t('label'),
    'weight' => t('Weight'),
  );

  $rows = array();
  foreach (element_children($element) as $key) {
    $row = array();
    $row['data'] = array();
    foreach ($header as $fieldname => $title) {
      $row['data'][] = drupal_render($element[$key][$fieldname]);
      $row['class'] = array('draggable');
    }
    $rows[] = $row;
  }

  return theme('table', array(
    'header' => $header,
    'rows' => $rows,
    'attributes' => array('id' => $vars['element']['#id'] . '-table'),
  ));
}

function cassiopeia_page_build(&$page) {
	global $user, $theme_key;
	if ( user_has_role(3) && $theme_key == 'cassiopeia_theme') {
		$page['page_bottom']['c3s_admin_menu'] = array(
			'#markup' => '<div style="position: fixed; top: 40%; left: 10px; background: #ccc; border-radius: 5px; padding: 5px; z-index: 999;">'.l('Quản trị', 'admin/cassiopeia/dashboard').'</div>'
		);
	}
}


// ----- api ------
function cassiopeia_get_nodes($type = array(), $language = NULL, $range = NULL) {
  $_nodes_query = new EntityFieldQuery();
  $_nodes_query_result = NULL;
  if (is_array($type)) {
    $_nodes_query_result = $_nodes_query
      ->entityCondition('entity_type', 'node')
      ->propertyCondition('type', $type, 'IN');

  }
  else {
    $_nodes_query_result = $_nodes_query
      ->entityCondition('entity_type', 'node')
      ->propertyCondition('type', $type, '=');
  }

  if ($language && is_string($language) && $language != 'all') {
    $_nodes_query->propertyCondition('language', $language, '=');
  }

  if ($range && is_array($range) && !empty($range['start']) && is_numeric($range['start']) && !empty($range['end']) && is_numeric($range['end'])) {
    $_nodes_query->range($range['start'], $range['end']);
  }

  $_nodes_query_result = $_nodes_query->execute();

  return $_nodes_query_result;
}




// ----- api core ------

function _cassiopeiaviews_display($view_name, $display_id, $arg = array()) {
  $view = views_get_view($view_name);
  $output = "";
  if (!empty($view)) {
    $output = $view->execute_display($display_id, $arg);
    if (is_array($output)) {
      $output = $output['content'];
    }
    if (!$output && !count($view->result)) {
      $output = "";
    }
  }
  return $output;
}

function _cassiopeia_render_theme($type, $name, $path, $variables = array()) {
  $path_temp = drupal_get_path($type, $name);
  return theme_render_template($path_temp . "/" . $path, $variables);
}


function _cassiopeia_convert_time_ago($timestamp) {
  $_output = "";
  $day = $timestamp / (60 * 60 * 24);
  if ($day >= 365) {
    $_output = floor($day % 365) . ' năm trước';
  }
  elseif ($day >= 30 && $day < 365) {
    $_output = floor($day % 30) . ' tháng trước';
  }
  elseif ($day >= 1 && $day < 30) {
    $_output = floor($day % 30) . ' ngày trước';
  }
  elseif ($day > 0 && $day < 1) {
    if ($day * 24 >= 1) {
      $_output = floor($day * 24) . ' giờ trước';
    }
    elseif ($day * 24 * 60 > 1) {
      $_output = floor($day * 24 * 60) . ' phút trước';
    }
    else {
      $_output = floor($day * 24 * 60 * 60) . ' giây trước';
    }
  }
  return $_output;
}

function _cassiopeia_get_variable($name, $default) {
  global $language;
  $_variable_query = db_select('cassiopeia_variable', 'cv');
  $_variable_query->fields('cv');
  $_variable_query->condition('cv.name', $name, '=');
  $_variable_query->join('cassiopeia_variable_store', 'cvt', ' cv.name = cvt.name');
  $_variable_query->fields('cvt');
  $_variable_query->condition('cvt.language', $language->language, '=');
  $_variable_query = $_variable_query->execute();
  $_variable_query_result = $_variable_query->fetchAssoc();
  if (!empty($_variable_query_result)) {
    return unserialize($_variable_query_result['value']);
  }
  else {
    return $default;
  }
}

function _cassiopeia_set_variable($name, $value) {
  global $language;
  db_merge('cassiopeia_variable')
    ->key(array('name' => $name))
    ->fields(array('name' => $name))
    ->execute();
  db_merge('cassiopeia_variable_store')
    ->key(array('name' => $name, 'language' => $language->language))
    ->fields(array('value' => serialize($value)))
    ->execute();
}

function _cassiopeia_del_variable($name) {
  db_delete('cassiopeia_variable')
    ->condition('name', $name)
    ->execute();
  db_delete('cassiopeia_variable_store')
    ->condition('name', $name)
    ->execute();
}


function _cassiopeia_load_collections ($collections) {
  $_collection_ids = array();
  foreach ($collections as $_key => $_value) {
    $_collection_ids[] =  $_value['value'];
  }
  $_collection = entity_load('field_collection_item', $_collection_ids);
  return $_collection;
}





function cassiopeia_get_items_by_conditions ($conditions = array(),$bundles,$entity_type) {
    $nodes = array();
    try {
        $query = new EntityFieldQuery();
        $query->entityCondition('entity_type', $entity_type)
            ->entityCondition('bundle', $bundles);
        if (!empty($conditions) && is_array($conditions)) {
            foreach ($conditions as $condition_key => $condition_value) {
                if ($condition_value['type'] == 'propertyCondition') {
                    $query->propertyCondition($condition_key, $condition_value['value'],$condition_value['condition']);
                }elseif ($condition_value['type'] == 'fieldCondition') {
//                    print(1);die;
                    $query->fieldCondition($condition_key, $condition_value['key'], $condition_value['value'], $condition_value['condition']);
//                var_dump($query);die;
                }
                elseif ($condition_value['type'] == 'propertyOrderBy') {
                    $query->propertyOrderBy($condition_key, $condition_value['direction']);
                }
                elseif ($condition_value['type'] == 'fieldOrderBy') {
                    $query->fieldOrderBy($condition_key, $condition_value['column'], $condition_value['direction']);
                }
                elseif ($condition_value['type'] == 'range' && isset($condition_value['start']) && isset($condition_value['limit'])) {
                    $query->range($condition_value['start'], $condition_value['limit']);
                }
            }
        }

        $result = $query->execute();
//        var_dump($result);die;
        if($entity_type=="node"){
            if (isset($result['node'])) {
                $node_nids = array_keys($result['node']);
                $nodes = entity_load('node', $node_nids);
            }
        }else if($entity_type=="taxonomy_term"){
            if(!empty($result['taxonomy_term'])){
                $term_tids = array_keys($result['taxonomy_term']);

                $terms = taxonomy_term_load_multiple($term_tids);
                return $terms;
            }
        }
    }catch (Exception $e) {
        throw $e;
    }

    return $nodes;
}

function cassioepia_article_import_form($form , $form_state) {
    $form['excell_file'] = array(
        '#title' => 'Excel file',
        '#type'  => 'file',
        '#description' => ($max_size = parse_size(ini_get('upload_max_filesize'))) ? t('Due to server restrictions, the <strong>maximum upload file size is !max_size</strong>. Files that exceed this size will be disregarded.', array('!max_size' => format_size($max_size))) : '',
    );

    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Commence Import'),
    );

    return $form ;
}

function cassioepia_article_import_form_validate(&$form, &$form_state) {
    $validators = array(
        'file_validate_extensions' => array( 'xls' ),
    );
    if ($file = file_save_upload('excell_file', $validators, "public://", FILE_EXISTS_REPLACE) ) {
        $form_state['values']['excell_file'] = $file;
    }
    else {
        form_set_error('excell_file', 'Kiểm tra lại file upload, chi chấp nhận file .xls');
    }

}
function cassioepia_article_import_form_submit(&$form, &$form_state) {
    module_load_include('inc', 'phpexcel');
    $data_import = phpexcel_import($form_state['values']['excell_file']->destination, FALSE);
    if (!empty($data_import[0])) {
        foreach ($data_import[0] as $key => $value) {
            if($key===0){
                continue;
            }
            $node = new stdClass();
            $node->type = "article";
            $node->uid = 1;
            $node->title = $value[0];
//            $node->field_article_tx['und'][0]['tid'] = 65;
            $node->body['und'][0]['summary'] = htmlspecialchars_decode($value[4]);
            $node->body['und'][0]['value'] = htmlspecialchars_decode( $value[3]);
            $node->status = 1;
            $node->created = date('U', $value[5]);
//            $node->created = 123123;
            $arr = explode("/",$value[1]);
            $file_temp = file_get_contents($value[1]);
            $file_temp = file_save_data($file_temp,'public://'.$arr[count($arr)-1]);
            $file_temp->status = 1;
            $node->field_image['und'][0] = (array)$file_temp;
            $node = node_submit($node);
            $node->created = date('U',$value[5]);
            node_save($node);
            die;
        }
    }
}

function cassiopeia_test_form($form,&$form_state){
    $form = array();
    $form['selected'] = array(
        '#type' => 'select',
        '#title' => t('Selected'),
        '#options' => array(
            0 => t('No'),
            1 => t('Yes'),
        ),
        '#default_value' => 1,
        '#description' => t('Set this to <em>Yes</em> if you would like this category to be selected by default.'),
    );
    print_r($form);
    return $form;
}


function cassiopeia_get_all_term_parents($term,&$list){
    $parent = taxonomy_get_parents($term->tid);
    if(!empty($parent)){
        foreach($parent as $item){
            $list[] = $item->tid;
            cassiopeia_get_all_term_parents($item,$list);
        }
    }
}
function cassiopeia_get_tx_tree($term,$list_ids=array()){
    $children = taxonomy_get_children($term->tid);?>
    <?php if(!empty($children)): ?>
        <ul class="sub-tx">
            <?php foreach($children as $child): ?>
                <?php $children1 = taxonomy_get_children($child->tid); ?>
                <?php if(!empty($children1)): ?>
                    <li class="<?php if((!empty($list_ids) && (in_array($child->tid,$list_ids,true)))) print("active"); ?>"><span><?php print($child->name); ?></span>
                        <?php cassiopeia_get_tx_tree($child); ?>
                    </li>
                <?php else: ?>
                    <li class="<?php if((!empty($list_ids) && (in_array($child ->tid,$list_ids,true)))) print("active"); ?>"><?php print(l($child->name,"taxonomy/term/".$child->tid,array("html"=>TRUE))); ?>
                        <?php cassiopeia_get_tx_tree($child); ?>
                    </li>
                <?php endif; ?>
            <?php endforeach; ?>
        </ul>
    <?php endif;
}
function cassiopeia_render_tx_tree($tx_machine_name,$current_term = null){
    $list_ids = array();
    if(!empty($current_term)){
        $list_ids[] = $current_term->tid;
        cassiopeia_get_all_term_parents($current_term,$list_ids);
    }
    $vocal = taxonomy_vocabulary_machine_name_load($tx_machine_name);
    $level1 = taxonomy_get_tree($vocal->vid,0,1);
    if(!empty($level1)): ?>
        <ul class="tx">
            <?php foreach($level1 as $item):?>
                <?php $children = taxonomy_get_children($item->tid); ?>
                <?php if(!empty($children)): ?>
                    <li class="<?php if((!empty($list_ids) && (in_array($item->tid,$list_ids,true)))) print("active"); ?>"><span><?php print($item->name); ?></span>
                        <?php cassiopeia_get_tx_tree($item,$list_ids); ?>
                    </li>
                <?php else: ?>
                    <li class="<?php if((!empty($list_ids) && (in_array($item->tid,$list_ids,true)))) print("active"); ?>"><?php print(l($item->name,"taxonomy/term/".$item->tid,array("html"=>TRUE))); ?></li>
                <?php endif; ?>
            <?php endforeach;?>
        </ul>
    <?php endif;
}
//
function cassiopeia_get_sih_nodes($type = "article",$limit = null){
    $conditions = array();
    $conditions['status'] = array(
        "type"      => "propertyCondition",
        "value"     => 1,
        "condition" => "=",
    );
    $conditions['created'] = array(
        "type"      => "propertyOrderBy",
        "direction" => "DESC",
    );
    $conditions['field_sih'] = array(
        "type"      => "fieldCondition",
        "key"       => "value",
        "value"     => 1,
        "condition" => "=",
    );
    $nodes = cassiopeia_get_items_by_conditions($conditions,$type,"node");
    return $nodes;
}
function cassiopeia_get_nodes_by_category($type="article",$term=null,$limit=null){
    global $language;
    try{
        $conditions = array();
        $conditions['status'] = array(
            "type"      => "propertyCondition",
            "value"     => 1,
            "condition" => "=",
        );
        $conditions['changed'] = array(
            "type"      => "propertyOrderBy",
            "direction" => "DESC",
        );
//        $conditions['language'] = array(
//            "type"      => "propertyCondition",
//            "value"     => $language->language,
//            "condition" => "=",
//        );
        if(!empty($limit)){
            $conditions['range'] = array(
                "type"      => "range",
                "start"     => 0,
                "limit"     => $limit,
            );
        }
        if(!empty($term)){
            $tids = array();
            $tids[$term->tid]   = $term->tid;
            $children = taxonomy_get_children($term->tid);
            if(!$children){
                foreach($children as $child){
                    $tids[$child->tid] = $child->tid;
                }
            }
            switch($type){
                case "article" :
                    $conditions['field_tx_article'] = array(
                        "type"      => "fieldCondition",
                        "key"       => "tid",
                        "value"     => $tids,
                        "condition" => "IN",
                    );
                    break;
                case "handbook" :
                    $conditions['field_tx_handbook'] = array(
                        "type"      => "fieldCondition",
                        "key"       => "tid",
                        "value"     => $tids,
                        "condition" => "IN",
                    );
                    break;
                case "ticket_article" :
                    $conditions['field_tx_ticket_article'] = array(
                        "type"      => "fieldCondition",
                        "key"       => "tid",
                        "value"     => $tids,
                        "condition" => "IN",
                    );
                    break;
                case "promotion_article" :
                    $conditions['field_tx_promotion_article'] = array(
                        "type"      => "fieldCondition",
                        "key"       => "tid",
                        "value"     => $tids,
                        "condition" => "IN",
                    );
                    break;
            }
        }
        $result = cassiopeia_get_items_by_conditions($conditions,$type,"node");
    }catch (Exception $e){
        print_r($e);
    }
    return $result;
}
function cassiopeia_featured_nodes($type="article",$limit=null){
    global $language;
    try{
        $conditions = array();
        $conditions['status'] = array(
            "type"      => "propertyCondition",
            "value"     => 1,
            "condition" => "=",
        );
        $conditions['created'] = array(
            "type"      => "propertyOrderBy",
            "direction" => "DESC",
        );
//        $conditions['language'] = array(
//            "type"      => "propertyCondition",
//            "value"     => $language->language,
//            "condition" => "=",
//        );
        $conditions['field_featured'] = array(
            "type"      => "fieldCondition",
            "key"     => "value",
            "value"     => 1,
            "condition" => "=",
        );
        if(!empty($limit)){
            $conditions['range'] = array(
                "type"      => "range",
                "start"     => 0,
                "limit"     => $limit,
            );
        }
        $result = cassiopeia_get_items_by_conditions($conditions,$type,"node");
    }catch (Exception $e){
        print_r($e);
    }
    return $result;
}
function cassiopeia_mail($key, &$message, $params)
{
//    print($key);die;
    switch ($key) {
        case 'custom_key':
            $message['subject'] = $params['subject'];
            $message['body'] = $params['body'];
            $message['headers'] = $params['headers'];
            break;
    }
}
function cassiopeia_get_booking_by_code($code){
    $result = null;
    try{
        $query = db_select("tbl_booking_product","tbl_booking_product");
        $query->fields("tbl_booking_product");
        $query->condition("code",$code);
        $result = $query->execute()->fetchObject();
    }catch (Exception $e){

    }
    return $result;
}
function cassiopeia_get_available_packet_by_uid($uid){
//    _print_r(user_load($uid));
    $result = null;
    try{
        $query = db_select("tbl_available_product","tbl_available_product");
        $query->fields("tbl_available_product",array("id","created","uid","tran_user","status","expired","product"));
        $query->join("node","tbl_node","tbl_node.nid=tbl_available_product.product");
        $query->addField("tbl_node","title","product_name");
        $query->condition("tbl_available_product.uid",$uid);
        $query->condition("tbl_available_product.status",1);
        $query->orderBy("tbl_available_product.created","DESC");
        $query->addField("tbl_available_product","uid","_uid");
        $result = $query->execute()->fetchObject();
        if(!empty($result)){
            $node = node_load($result->product);
            if(!empty($node)){
                $result->indexed_google = !empty($node->field_p_indexed_google['und'])?$node->field_p_indexed_google['und'][0]['value']:0;
                $result->content_duplicate = !empty($node->field_p_content_duplicate['und'])?$node->field_p_content_duplicate['und'][0]['value']:0;
                $result->device = !empty($node->field_p_device['und'])?$node->field_p_device['und'][0]['value']:0;
                $result->excel = !empty($node->field_p_excel_export['und'])?$node->field_p_excel_export['und'][0]['value']:0;
                $result->backlink_project = !empty($node->field_p_backlink_project['und'])?$node->field_p_backlink_project['und'][0]['value']:0;
                $result->key_project = !empty($node->field_p_key_project['und'])?$node->field_p_key_project['und'][0]['value']:0;
                $result->key_search = !empty($node->field_p_key_check['und'])?$node->field_p_key_check['und'][0]['value']:0;
                $result->check_backlink = !empty($node->field_p_backlink_check['und'])?$node->field_p_backlink_check['und'][0]['value']:0;
                $result->content_project = !empty($node->field_p_content_project['und'])?$node->field_p_content_project['und'][0]['value']:0;
                $result->content_article = !empty($node->field_p_article_content['und'])?$node->field_p_article_content['und'][0]['value']:0;
                $result->content_check = !empty($node->field_p_content_check['und'])?$node->field_p_content_check['und'][0]['value']:0;
                if($node->nid==AGENCY){
                    $result->expired = 0;
                }
            }
        }

    }catch (Exception $e){
        _print_r($e);
    }
    return $result;
}
function cassiopeia_seo_tool_key_check(){

}
function cassiopeia_seo_tool_anchor_text_check(){

}
function cassiopeia_seo_tool_indexed_google_check(){

}
function cassiopeia_seo_tool_content_duplicate_check(){

}

function cassiopeia_backlink_project_form($form , $form_state) {
    $form['project_nid'] = array(
        '#type'         => 'hidden',
        '#title'        => t('ID'),
        '#size'         => 60,
        '#maxlength'    => 128,
    );
    $form['project_title'] = array(
        '#type'         => 'textfield',
        '#title'        => t('Tên dự án (bắt buộc nhập)'),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#prefix'       => "<div class='input-wrap'>",
        '#suffix'       => "<p></p></div>",
        '#required'     => TRUE,
    );
    $form['project_domain'] = array(
        '#type'         => 'textfield',
        '#title'        => ('Domain (bắt buộc nhập)'),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#required'     => TRUE,
        '#prefix'       => "<div class='input-wrap'>",
        '#suffix'       => "<p></p></div>",
        '#attributes'   => array("placeholder"=>"eg: http://domain.com"),
    );

    $form['submit'] = array(
        '#type'         => 'submit',
        '#value'        => t("Thêm mới"),
        '#prefix'       => "<div class='form-buttons'>",
        '#suffix'       => "</div>",
        '#attributes'   => array("class"=>array("btn-type-2"))
    );
    return $form ;
}
function cassiopeia_backlink_project_form_submit($form,&$form_state){
    global $user;
    $project_id = $form_state['values']['project_nid'];
    $project_title = $form_state['values']['project_title'];
    $project_domain = $form_state['values']['project_domain'];
    if(!empty($project_id)){ // update
        $project = node_load($project_id);
        if(user_has_role(3) || $project->uid == $user->uid){
            try{
                $project->title = $project_title;
                $project->field_domain['und'][0]['value'] = $project_domain;
                node_save($project);
                drupal_set_message("Cập nhật dự án thành công!");
            }catch (Exception $e){

            }
        }
    }else{ // insert
        try{
            $packet = cassiopeia_get_available_packet_by_uid($user->uid);
            if(!empty($packet)){
//                if($packet->backlink_project>0){
                    $conditions = array();
                    $conditions['created'] = array(
                        "type"      => "propertyOrderBy",
                        "direction" => "DESC",
                    );
                    $conditions['uid'] = array(
                        "type"      => "propertyCondition",
                        "value"     => $user->uid,
                        "condition" => "=",
                    );
                    $projects = cassiopeia_get_items_by_conditions($conditions,"project_backlink","node");
                    if($packet->product!=BASIC && $packet->expired>0 && $packet->expired<REQUEST_TIME){ // tài khoản hết hạn
                        cassiopeia_set_alert("UserExpired","Tài khoản hết hạn");
                    }else{
                        if(count($projects)>=$packet->backlink_project && $packet->backlink_project>0){
                            cassiopeia_set_alert("UserLimited","Số lượng dự án backlink");
                        }else{
                            try{
                                $project_title = trim($project_title);
                                $project_domain = trim($project_domain);
                                $project_domain = str_replace("https","",$project_domain);
                                $project_domain = str_replace("http","",$project_domain);
                                $project_domain = str_replace(":","",$project_domain);
                                $project_domain = str_replace("//","",$project_domain);
                                $project_domain = str_replace("www.","",$project_domain);
                                $splitter = explode("/",$project_domain);
                                $project_domain = $splitter[0];
                                $conditions = array();
                                $conditions['field_domain'] = array(
                                    "type"      => "fieldCondition",
                                    "key"       => "value",
                                    "value"     => $project_domain,
                                    "condition" => "LIKE",
                                );
                                $conditions['uid'] = array(
                                    "type"      => "propertyCondition",
                                    "value"     => $user->uid,
                                    "condition" => "=",
                                );
                                $checkes = cassiopeia_get_items_by_conditions($conditions,"project_backlink","node");
                                if(!empty($checkes)){
                                    drupal_set_message("Domain ".$project_domain." đã tồn tại!","error");
                                }else{
                                    $_node = new stdClass();
                                    $_node->type = "project_backlink";
                                    $_node->title = $project_title;
                                    $_node->field_domain['und'][0]['value'] = $project_domain;
                                    $_node->uid = $user->uid;
                                    node_save($_node);
                                    node_submit($_node);
                                    drupal_set_message("Thêm mới dự án thành công!");
                                    drupal_goto("quan-ly-backlink/du-an/".$_node->nid);
                                }
                            }catch (Exception $e){
                                cassiopeia_dump($e);
//                            die;
                            }
                    }

//                    }
                }
            }else{
                drupal_set_message("??");
            }
        }catch (Exception $e){
            drupal_set_message("Đã xảy ra lỗi, vui lòng liên hệ với người quản trị!");
        }
    }
}
function cassiopeia_content_project_form($form , $form_state) {
    $form['project_nid'] = array(
        '#type'         => 'hidden',
        '#title'        => t('ID'),
        '#size'         => 60,
        '#maxlength'    => 128,
    );
    $form['project_title'] = array(
        '#type'         => 'textfield',
        '#title'        => t('Tên dự án (bắt buộc nhập)'),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#prefix'       => "<div class='input-wrap'>",
        '#suffix'       => "<p></p></div>",
        '#required'     => TRUE,
    );
    $form['project_domain'] = array(
        '#type'         => 'textfield',
        '#title'        => ('Domain (bắt buộc nhập)'),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#required'     => TRUE,
        '#prefix'       => "<div class='input-wrap'>",
        '#suffix'       => "<p></p></div>",
        '#attributes'   => array("placeholder"=>"eg: http://domain.com"),
    );

    $form['submit'] = array(
        '#type'         => 'submit',
        '#value'        => t("Thêm mới"),
        '#prefix'       => "<div class='form-buttons'>",
        '#suffix'       => "</div>",
        '#attributes'   => array("class"=>array("btn-type-2"))
    );
    return $form ;
}
function cassiopeia_content_project_form_submit($form,&$form_state){
    global $user;
    $project_id = $form_state['values']['project_nid'];
    $project_title = $form_state['values']['project_title'];
    $project_domain = $form_state['values']['project_domain'];
    if(!empty($project_id)){ // update
        $project = node_load($project_id);
        if(user_has_role(3) || $project->uid == $user->uid){
            try{
                $project->title = $project_title;
                $project->field_domain['und'][0]['value'] = $project_domain;
                $project->field_raw_title['und'][0]['value'] = stripVN($project_title);
                node_save($project);
                drupal_set_message("Cập nhật dự án thành công!");
            }catch (Exception $e){

            }
        }
    }else{ // insert
        try{
            $packet = cassiopeia_get_available_packet_by_uid($user->uid);
//            _print_r($packet);
//            die;
            if(!empty($packet)){
                    $conditions = array();
                    $conditions['created'] = array(
                        "type"      => "propertyOrderBy",
                        "direction" => "DESC",
                    );
                    $conditions['uid'] = array(
                        "type"      => "propertyCondition",
                        "value"     => $user->uid,
                        "condition" => "=",
                    );
                    $projects = cassiopeia_get_items_by_conditions($conditions,"content_project","node");
                    if($packet->product!=BASIC && $packet->expired>0 && $packet->expired<REQUEST_TIME){ // tài khoản hết hạn
                        cassiopeia_set_alert("UserExpired","Tài khoản hết hạn");
                    }else{
                        if(count($projects)>=$packet->content_project && $packet->content_project>0){
                            cassiopeia_set_alert("UserLimited","Số lượng dự án content");
                        }else{
                            try{
                                $project_title = trim($project_title);
                                $project_domain = trim($project_domain);
                                $project_domain = str_replace("https","",$project_domain);
                                $project_domain = str_replace("http","",$project_domain);
                                $project_domain = str_replace(":","",$project_domain);
                                $project_domain = str_replace("//","",$project_domain);
                                $project_domain = str_replace("www.","",$project_domain);
                                $splitter = explode("/",$project_domain);
                                $project_domain = $splitter[0];
                                $conditions = array();
                                $conditions['field_domain'] = array(
                                    "type"      => "fieldCondition",
                                    "key"       => "value",
                                    "value"     => $project_domain,
                                    "condition" => "LIKE",
                                );
                                $conditions['uid'] = array(
                                    "type"      => "propertyCondition",
                                    "value"     => $user->uid,
                                    "condition" => "=",
                                );
                                $checkes = cassiopeia_get_items_by_conditions($conditions,"content_project","node");
                                if(!empty($checkes)){
                                    drupal_set_message("Domain ".$project_domain." đã tồn tại!","error");
                                }else{
                                    $_node = new stdClass();
                                    $_node->type = "content_project";
                                    $_node->title = $project_title;
                                    $_node->field_domain['und'][0]['value'] = $project_domain;
                                    $_node->uid = $user->uid;
                                    node_save($_node);
                                    node_submit($_node);
                                    drupal_set_message("Thêm mới dự án thành công!");
                                    drupal_goto("quan-ly-du-an-content/du-an/".$_node->nid);
                                }
                            }catch (Exception $e){
                                cassiopeia_dump($e);
//                            die;
                            }
                    }

//                    }
                }
            }else{
                drupal_set_message("??");
            }
        }catch (Exception $e){
            drupal_set_message("Đã xảy ra lỗi, vui lòng liên hệ với người quản trị!");
        }
    }
}
function cassiopeia_add_backlink_project_form_submit($form,&$form_state){
    global $user;
    $project_id = $form_state['values']['project_nid'];
    $project_title = trim($form_state['values']['project_title']);
    $project_domain = $form_state['values']['project_domain'];
    if(!empty($project_id)){ // update
        $project = node_load($project_id);
        if(user_has_role(3) || $project->uid == $user->uid){
            try{
                $project->title = $project_title;
                $project->field_domain['und'][0]['value'] = $project_domain;
                node_save($project);
                drupal_set_message("Cập nhật dự án thành công!");
            }catch (Exception $e){

            }
        }
    }else{ // insert
        try{
            $packet = cassiopeia_get_available_packet_by_uid($user->uid);
            if(!empty($packet)){
                if($packet->backlink_project>0){
                    $conditions = array();
                    $conditions['created'] = array(
                        "type"      => "propertyOrderBy",
                        "direction" => "DESC",
                    );
                    $conditions['uid'] = array(
                        "type"      => "propertyCondition",
                        "value"     => $user->uid,
                        "condition" => "=",
                    );
                    $projects = cassiopeia_get_items_by_conditions($conditions,"project_backlink","node");

                    if(count($projects)>=$packet->backlink_project){
                        drupal_set_message("Vui lòng nâng cấp Gói sản phẩm để tạo thêm nhiều dự án!","error");
                    }else{
                        $project_title = trim($project_title);
                        $project_domain = trim($project_domain);
                        $project_domain = str_replace("https","",$project_domain);
                        $project_domain = str_replace("http","",$project_domain);
                        $splitter = explode("/",$project_domain);
                        $project_domain = $splitter[0];
                        $conditions = array();
                        $conditions['created'] = array(
                            "type"      => "propertyOrderBy",
                            "direction" => "DESC",
                        );
                        $conditions['uid'] = array(
                            "type"      => "propertyCondition",
                            "value"     => $user->uid,
                            "condition" => "=",
                        );
                        $conditions['field_domain'] = array(
                            "type"      => "fieldCondition",
                            "key"       => "value",
                            "value"     => "%".$project_domain."%",
                            "condition" => "LIKE",
                        );
                        $projects = cassiopeia_get_items_by_conditions($conditions,"project_backlink","node");
                        if(!empty($projects)){
                            drupal_set_message("Domain ".$project_domain." đã tồn tại!","error");
                        }else{
                            try{
                                $_node = new stdClass();
                                $_node->type = "project_backlink";
                                $_node->title = $project_title;
                                $_node->field_domain['und'][0]['value'] = $project_domain;
                                $_node->uid = $user->uid;
                                node_save($_node);
                                node_submit($_node);
                            }catch (Exception $e){
                                cassiopeia_dump($e);
                            }
                            drupal_set_message("Thêm mới dự án thành công!");
                        }
                    }
                }
            }
        }catch (Exception $e){
            drupal_set_message("Đã xảy ra lỗi, vui lòng liên hệ với người quản trị!");
        }
    }
}
function cassiopeia_user_project_form($form , $form_state,$type="backlink") {
    $form['#node_type'] = $type;
    $form['project_nid'] = array(
        '#type'         => 'hidden',
        '#title'        => t('ID'),
        '#size'         => 60,
        '#maxlength'    => 128,
    );
    $form['project_title'] = array(
        '#type'         => 'textfield',
        '#title'        => t('Tên dự án'),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#prefix'       => "<div class='input-wrap'>",
        '#suffix'       => "<p></p></div>",
        '#required'     => TRUE,
    );
    $form['project_domain'] = array(
        '#type'         => 'textfield',
        '#title'        => ('Domain'),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#prefix'       => "<div class='input-wrap'>",
        '#suffix'       => "<p></p></div>",
        '#required'     => TRUE,
        '#attributes'   => array("placeholder"=>"eg: http://domain.com"),
    );

    $form['submit'] = array(
        '#type'         => 'submit',
        '#value'        => t("Thêm mới"),
        '#prefix'       => "<div class='form-buttons'>",
        '#suffix'       => "</div>",
        '#attributes'   => array("class"=>array("btn-type-2"))
    );

    return $form ;
}
function cassiopeia_user_project_form_submit($form,&$form_state){
    global $user;

    $project_id = $form_state['values']['project_nid'];
    $project_title = $form_state['values']['project_title'];
    $project_domain = $form_state['values']['project_domain'];
    $project_type = $form['#node_type'];
    if(!empty($project_id)){ // update
        $project = node_load($project_id);
        if(user_has_role(3) || $project->uid == $user->uid){
            try{
                $project->title = $project_title;
                $project->field_domain['und'][0]['value'] = $project_domain;
                node_save($project);
                drupal_set_message("Cập nhật dự án thành công!");
            }catch (Exception $e){

            }
        }
    }else{ // insert
        try{
            $packet = cassiopeia_get_available_packet_by_uid($user->uid);
            if(!empty($packet)){
                switch ($project_type){
                    case "keyword" :
//                        if($packet->key_project>0){
                            $conditions = array();
                            $conditions['created'] = array(
                                "type"      => "propertyOrderBy",
                                "direction" => "DESC",
                            );
                            $conditions['uid'] = array(
                                "type"      => "propertyCondition",
                                "value"     => $user->uid,
                                "condition" => "=",
                            );
                            $projects = cassiopeia_get_items_by_conditions($conditions,"project_keyword","node");
                        if($packet->product!=BASIC && $packet->expired>0 && $packet->expired<REQUEST_TIME){ // tài khoản hết hạn
                                cassiopeia_set_alert("UserExpired","Tài khoản hết hạn");
                            }else{
                                if(count($projects)>=$packet->key_project && $packet->key_project>0){
                                    cassiopeia_set_alert("UserLimited","Số lượng dự án backlink");
                                }else{
                                    $project_title = trim($project_title);
                                    $project_domain = trim($project_domain);
                                    $project_domain = str_replace("https","",$project_domain);
                                    $project_domain = str_replace("http","",$project_domain);
                                    $project_domain = str_replace(":","",$project_domain);
                                    $project_domain = str_replace("//","",$project_domain);
                                    $project_domain = str_replace("www.","",$project_domain);
                                    $splitter = explode("/",$project_domain);
                                    $project_domain = $splitter[0];
//                                    $conditions = array();
//                                    $conditions['created'] = array(
//                                        "type"      => "propertyOrderBy",
//                                        "direction" => "DESC",
//                                    );
//                                    $conditions['uid'] = array(
//                                        "type"      => "propertyCondition",
//                                        "value"     => $user->uid,
//                                        "condition" => "=",
//                                    );
//                                    $conditions['field_domain'] = array(
//                                        "type"      => "fieldCondition",
//                                        "key"       => "value",
//                                        "value"     => $project_domain,
//                                        "condition" => "LIKE",
//                                    );
//                                    $projects = cassiopeia_get_items_by_conditions($conditions,"project_keyword","node");
                                    $projects = null;
                                    if(!empty($projects)){
                                        drupal_set_message("Domain ".$project_domain." đã tồn tại!","error");
                                    }else{
                                        try{
                                            $_node = new stdClass();
                                            $_node->type = "project_keyword";
                                            $_node->title = $project_title;
                                            $_node->field_domain['und'][0]['value'] = $project_domain;
                                            $_node->uid = $user->uid;
                                            node_save($_node);
                                            node_submit($_node);
                                        }catch (Exception $e){
                                            cassiopeia_dump($e);
                                        }
                                        drupal_set_message("Thêm mới dự án thành công!");
                                        drupal_goto("/quan-ly-keywords/du-an/".$_node->nid);
                                    }
                                }
                            }
//                        }
                        break;
                    case "backlink" :
                        if($packet->backlink_project>0){
                            $conditions = array();
                            $conditions['created'] = array(
                                "type"      => "propertyOrderBy",
                                "direction" => "DESC",
                            );
                            $conditions['uid'] = array(
                                "type"      => "propertyCondition",
                                "value"     => $user->uid,
                                "condition" => "=",
                            );
                            $projects = cassiopeia_get_items_by_conditions($conditions,"project_backlink","node");

                            if(count($projects)>=$packet->backlink_project){
                                drupal_set_message("Vui lòng nâng cấp Gói sản phẩm để tạo thêm nhiều dự án!","error");
                            }else{
                                try{

                                    $_node = new stdClass();
                                    $_node->type = "project_backlink";
                                    $_node->title = $project_title;
                                    $_node->field_domain['und'][0]['value'] = $project_domain;
                                    $_node->uid = $user->uid;
                                    node_save($_node);
                                    node_submit($_node);
                                }catch (Exception $e){
                                    cassiopeia_dump($e);
                                }
                                drupal_set_message("Thêm mới dự án thành công!");
                            }
                        }
                        break;
                }
            }


        }catch (Exception $e){
            drupal_set_message("Đã xảy ra lỗi, vui lòng liên hệ với người quản trị!");
        }
    }
}
function cassiopeia_dump($data){
    global $user;
    if($user->uid==1){
    print("---Admin----");
    print("<pre>");
    print_r($data);
    print("</pre>");
    }
}
function _print_r($data){
    global $user;
    if($user->uid==1 ||$user->uid==31||$user->uid==4630){
        print("---Admin----");
        print("<pre>");
        print_r($data);
        print("</pre>");
    }
}
function cassiopeia_get_project_by_uid_and_type($uid,$type){
    $query = db_select("tbl_project","tbl_project");
    $query->fields("tbl_project");
    $query->condition("tbl_project.uid",$uid);
    $query->condition("tbl_project.type",$type);
    $query->leftJoin("tbl_back_link","tbl_back_link","tbl_back_link.project_id=tbl_project.id");
    $query->addExpression("COUNT(tbl_back_link.id)","backlink");
    $query->groupBy("tbl_project.id");
    $result = $query->execute()->fetchAll();
    return $result;
}
function cassiopeia_get_project_by_id($id){
    $query = db_select("tbl_project","tbl_project");
    $query->fields("tbl_project");
    $query->condition("tbl_project.id",$id);
//    $query->condition("tbl_project.type","key_search");
    $result = $query->execute()->fetchObject();
    return $result;
}
function cassiopeia_user_key_search_form($form , $form_state) {
    $form['id'] = array(
        '#type'         => 'hidden',
        '#title'        => t('ID'),
        '#size'         => 60,
        '#maxlength'    => 128,
//        '#required'     => TRUE,
    );
    $form['project_id'] = array(
        '#type'         => 'hidden',
        '#title'        => t('ID'),
        '#size'         => 60,
        '#maxlength'    => 128,
//        '#required'     => TRUE,
    );
    $form['key_search'] = array(
        '#type'         => 'textfield',
        '#title'        => t('Từ khóa'),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#required'     => TRUE,
    );
    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t("Thêm mới"),
        '#prefix'   => "<div class='form-buttons'>",
        '#suffix'   => "</div>",
    );

    return $form ;
}
function cassiopeia_user_key_search_form_submit($form,&$form_state){
    if(!empty($form_state['values']['id'])){ // update

    }else{
        try{
            db_insert("tbl_key_search")->fields(array(
                "created"       => REQUEST_TIME,
                "key_search"       => $form_state['values']['key_search'],
                "project_id"       => $form_state['values']['project_id'],
            ))->execute();
        }catch (Exception $e){

        }
    }
}
function cassiopeia_get_key_search_by_project_id($pid){
    global $user;
    $query = db_select("tbl_key_search","tbl_key_search");
    $query->fields("tbl_key_search");
    $query->condition("project_id",$pid);
    $query->join("tbl_project","tbl_project","tbl_project.id=tbl_key_search.project_id");
    $query->condition("tbl_project.uid",$user->uid);
    $result = $query->execute()->fetchAll();
    return $result;
}
function cassiopeia_get_key_search_by_id($id){
    global $user;
    $query = db_select("tbl_key_search","tbl_key_search");
    $query->fields("tbl_key_search");
    $query->condition("id",$id);
//    $query->join("tbl_project","tbl_project","tbl_project.id=tbl_key_search.project_id");
//    $query->condition("tbl_project.uid",$user->uid);
    $result = $query->execute()->fetchAll();
    return $result;
}

function cassiopeia_get_user_tracking_by_date($date){
    global $user;
    $query = db_select("tbl_user_tracking","tbl_user_tracking");
    $query->fields("tbl_user_tracking");
    $query->condition("uid",$user->uid);
    $query->condition("date",$date);
    $result = $query->execute()->fetchObject();
    return $result;
}
function cassiopeia_user_check_backlink($responseObject){
    global $user;
    $data = array();
    $nid = $responseObject->id;
    $status = $responseObject->status;
    $today = date("d-m-Y",REQUEST_TIME);
    $tracking = cassiopeia_get_user_tracking_by_date($today);
    $packet = cassiopeia_get_available_packet_by_uid($user->uid);
    if(empty($tracking)){
        try{
            db_insert("tbl_user_tracking")->fields(array(
                "uid"  => $user->uid,
                "date"  => $today,
                "available_product" => $packet->id,
                "check_backlink" => 0,
                "indexed_google" => 0,
                "content_duplicate" => 0,
                "key_search" => 0,
            ))->execute();
            $tracking = cassiopeia_get_user_tracking_by_date($today);
        }catch (Exception $e){
            print_r($e);
        }
    }
    if($packet->product!=BASIC && $packet->expired>0 && $packet->expired<REQUEST_TIME){ // tài khoản hết hạn
        $data['response'] = "EXPIRED";
    }else{
        if($packet->check_backlink>0 && $tracking->check_backlink>=$packet->check_backlink){
            $data['response'] = "LIMITED";
        }else{
            db_update("tbl_user_tracking")->fields(array(
                "check_backlink"    => $tracking->check_backlink+1,
            ))->condition("uid",$user->uid)->condition("date",$tracking->date)->execute();
            if(empty($_SESSION['backlink-check-complete']) || $_SESSION['backlink-check-complete']==0){
                $inserted = true;
                db_delete("tbl_backlink_detail")->condition("nid",$nid)->execute();
                $query = db_select("tbl_backlink","tbl_backlink");
                $query->fields("tbl_backlink");
                $query->condition("id",$nid);
                $BackLink = $query->execute()->fetchObject();
                try{
                    $insert = db_insert("tbl_backlink_detail")->fields(array(
                        "nid",
                        "rel",
                        "created",
                        "url",
                        "pid",
                        "anchor_text",
                    ));
                    foreach($responseObject->backlink as $_backlink){
                        if(empty($_backlink->_rel)){
                            $rel = "dofollow";
                        }else{
                            $rel = $_backlink->_rel;
                        }
                        $insert->values(array(
                            "nid"           => $nid,
                            "rel"           => $rel,
                            "created"       => REQUEST_TIME,
                            "url"           => $_backlink->_href,
                            "pid"           => $BackLink->pid,
                            "anchor_text"   => $_backlink->_anchorText,
                        ));
                    };
                    $insert->execute();
                }catch (Exception $e){
                    $inserted = false;
                }
                try{
                    if(empty($responseObject->backlink) && $status==200){
                        $status = "NONE";
                    }
                    if(!$inserted){
                        $status = "CANNOT_INSERT";
                    }
                    db_update("tbl_backlink")->fields(array(
                        "changed"       => REQUEST_TIME,
                        "status"        => $status,
                    ))->condition("id",$nid)->execute();
                    $array = array(
                        "pid"   => null,
                        "nid"   => $nid,
                    );
                    $backlinks = cassiopeia_get_backlinks($array);
                    $data['values'] = json_encode($backlinks);
                }catch (Exception $e){

                }
            }else{
                $data['response'] = "FAIL";
                db_delete("tbl_backlink_detail")->condition("nid",$nid)->execute();
                foreach($responseObject->backlink as $_backlink){
                    if(empty($_backlink->_rel)){
                        $rel = "dofollow";
                    }else{
                        $rel = $_backlink->_rel;
                    }
                    if(empty($responseObject->backlink) && $status==200){
                        $status = "NONE";
                    }
                    try{
                        db_insert("tbl_backlink_detail")->fields(array(
                            "nid"           => $nid,
                            "rel"           => $rel,
                            "changed"       => REQUEST_TIME,
                            "created"       => REQUEST_TIME,
                            "url"           => $_backlink->_href,
                            "anchor_text"   => $_backlink->_anchorText,
                        ))->execute();
                    }catch (Exception $_e){

                    }
                };
                try{
                    db_update("tbl_backlink")->fields(array(
                        "status"        => $status,
                        "changed"       => REQUEST_TIME,
                    ))->condition("id",$nid)->execute();
                    $array = array(
                        "pid"   => null,
                        "nid"   => $nid,
                    );
                    $backlinks = cassiopeia_get_backlinks($array);
                    $data['values'] = json_encode($backlinks);
                }catch (Exception $e){

                }
            }
        }
    }
    return $data;
}
function cassiopeia_user_key_check($data){
    global $user;
    $response = array();
    $flag = 1;
    $today = date("d-m-Y",REQUEST_TIME);
    $tracking = cassiopeia_get_user_tracking_by_date($today);
    $packet = cassiopeia_get_available_packet_by_uid($user->uid);
    if(empty($tracking)){
        try{
            db_insert("tbl_user_tracking")->fields(array(
                "uid"  => $user->uid,
                "date"  => $today,
                "available_product" => $packet->id,
                "check_backlink" => 0,
                "indexed_google" => 0,
                "content_duplicate" => 0,
                "key_search" => 0,
            ))->execute();
            $tracking = cassiopeia_get_user_tracking_by_date($today);
        }catch (Exception $e){
//            print_r($e);
        }
    }else{

    }
    if(!empty($data)){
        if($packet->product!=BASIC && $packet->expired>0 && $packet->expired<REQUEST_TIME){ // tài khoản hết hạn
            $response['status'] = "EXPIRED";
        }else{
            if($packet->key_search>0 && $tracking->key_search>=$packet->key_search){
                $response['status'] = "LIMITED";
            }else{
                $key = node_load($data['id']);
                // save key check history
                try{
//                    _print_r($data['index']);
                    if(!empty($data['index'])){
                        $best = !empty($key->field_keyword_best_position['und'][0]['value'])?$key->field_keyword_best_position['und'][0]['value']:null;
                        if(!empty($best)){
                            if($best>$data['index']&&$data['index']>0){
                                $best = $data['index'];
                            }
                        }else{
                            $best = $data['index'];
                        }
                        $key->field_keyword_old_position['und'][0]['value'] = $key->field_keyword_position['und'][0]['value'];
                        $key->field_keyword_position['und'][0]['value'] = $data['index']==-1?0:$data['index'];
                        $key->field_url['und'][0]['value'] = $data['url'];
                        $key->field_keyword_best_position['und'][0]['value'] = $best==-1?0:$best;
                        $key->field_checked['und'][0]['value'] = 1;
                        $key->field_checked_date['und'][0]['value'] = REQUEST_TIME;
//                        _print_r($key);
                        db_update("tbl_user_tracking")->fields(array(
                            "key_search"    => $tracking->key_search+1,
                        ))->condition("uid",$user->uid)->condition("date",$tracking->date)->execute();
                    }
                    node_save($key);
                }catch (Exception $e){
                    cassiopeia_dump($e);
                }
            }
        }
    }
    return $response;
}

function cassiopeia_date_popup_process_alter(&$element, &$form_state, $context)
{
    if ($element['#name'] == 'expired') {
        $element['date']['#title'] = 'Ngày hết hạn';
    }
    if ($element['#name'] == 'from_date') {
        $element['date']['#title'] = 'Từ ngày';
    }
    if ($element['#name'] == 'to_date') {
        $element['date']['#title'] = 'Đến ngày';
    }
    $element['date']['#description'] = '';
    $element['date']['#attributes']['autocomplete'] = 'off';
    $element['time']['#attributes']['autocomplete'] = 'off';
}
function cassiopeia_admin_manager_user_filter_form($form,&$form_state,$cache){
    $form = array();
    $form['full_name'] = array(
        '#type'             => 'textfield',
        '#title'            => t('Họ và tên'),
        '#default_value'    => !empty($cache['full_name']) ? $cache['full_name'] :"",
        '#size'             => 60,
        '#maxlength'        => 128,
    );
    $form['mail'] = array(
        '#type'             => 'textfield',
        '#title'            => t('Email/Tên đăng nhập'),
        '#default_value'    => !empty($cache['mail']) ? $cache['mail'] :"",
        '#size'             => 60,
        '#maxlength'        => 128,
    );
    $form['tel'] = array(
        '#type'             => 'textfield',
        '#title'            => t('Số điện thoại'),
        '#default_value'    => !empty($cache['tel']) ? $cache['tel'] :"",
        '#size'             => 60,
        '#maxlength'        => 128,
    );
    $form['expired'] = array(
        '#type' => 'select',
        '#title' => t('Thời hạn'),
        '#options' => array(
            "all" => "Tất cả",
            1 => "Sắp hết hạn",
        ),
    );
    if(!empty($cache['expired'])){
        $form['expired']['#default_value'] = $cache['expired'];
    }
    $form['submit'] = array(
        '#type'     => 'submit',
        '#value'    => t('Lọc'),
        '#prefix'   => "<div class='buttons'>",
        '#suffix'   => "</div>"
    );
    return $form;
}
function cassiopeia_admin_manager_user_filter_form_submit($form, &$form_state)
{
    $arg = arg();
    $options = array(
        'query' => array(
            'data' => $form_state['values'],
        )
    );
    $form_state['redirect'] = array("/admin/manager/user", "data" => $options);
}
function cassiopeia_backlink_report_filter_form($form,&$form_state,$cache){
    $form['#project_id'] = $cache['project_id'];
    $form['date_filter'] = array(
        '#type' => 'select',
        '#title' => t('Chọn'),
        '#options' => array(
            "thisMonth" => "14 ngày",
            "lastMonth" => "Tháng trước",
            "other"     => "Theo ngày"
        ),
    );
    if(!empty($cache['date_filter'])){
        $form['date_filter']['#default_value'] = $cache['date_filter'];
    }
    $form['from_date'] = array(
        '#type' => 'date_popup',
        '#default_value' => !empty($cache['from_date'])?$cache['from_date']:"",
        '#date_type' => DATE_DATETIME,
        '#date_timezone' => date_default_timezone(),
        '#date_format' => 'd-m-Y',
        '#date_increment' => 1,
        '#date_year_range' => '-10:+10',
        '#attributes' => array("onchange" => "this.form.submit();", "class" => array("form_date")),
//        '#theme_wrappers'   => array("form")
    );
    if(!empty($cache['from_date'])){
        $form['from_date']['#default_value'] = $cache['from_date'];
    }
    $form['to_date'] = array(
        '#type' => 'date_popup',
        '#default_value' => !empty($cache['to_date'])?$cache['to_date']:"",
        '#date_type' => DATE_DATETIME,
        '#date_timezone' => date_default_timezone(),
        '#date_format' => 'd-m-Y',
        '#date_increment' => 1,
        '#date_year_range' => '-10:+10',
        '#attributes' => array("onchange" => "this.form.submit();", "class" => array("to_date")),
    );
    $form['submit'] = array(
        '#type'     => 'submit',
        '#value'    => t('Lọc'),
        '#prefix'   => "<div class='buttons'>",
        '#suffix'   => "</div>"
    );
    return $form;
}
function cassiopeia_backlink_report_filter_form_submit($form, &$form_state)
{
    $arg = arg();
    $options = array(
        'query' => array(
            'data' => $form_state['values'],
        )
    );
    $form_state['redirect'] = array('/quan-ly-backlink/du-an/'.$form['#project_id']."/bao-cao", "data" => $options);
}
function cassiopeia_keyword_report_filter_form($form,&$form_state,$cache){
    global $user;
    $form['#project_id'] = $cache['project_id'];
    $form['from_date'] = array(
        '#type' => 'date_popup',
        '#default_value' => !empty($cache['from_date'])?$cache['from_date']:"",
        '#date_type' => DATE_DATETIME,
        '#date_timezone' => date_default_timezone(),
        '#date_format' => 'd-m-Y',
        '#date_increment' => 1,
        '#date_year_range' => '-10:+10',
//        '#attributes' => array("onchange" => "this.form.submit();", "class" => array("form_date")),
//        '#theme_wrappers'   => array("form")
    );
    $form['to_date'] = array(
        '#type' => 'date_popup',
        '#default_value' => !empty($cache['to_date'])?$cache['to_date']:"",
        '#date_type' => DATE_DATETIME,
        '#date_timezone' => date_default_timezone(),
        '#date_format' => 'd-m-Y',
        '#date_increment' => 1,
        '#date_year_range' => '-10:+10',
//        '#attributes' => array("onchange" => "this.form.submit();", "class" => array("to_date")),
    );

    $form['submit'] = array(
        '#type'     => 'submit',
        '#value'    => t('Lọc'),
        '#prefix'   => "<div class='buttons'>",
        '#suffix'   => "</div>"
    );
    return $form;
}
function cassiopeia_keyword_report_filter_form_submit($form, &$form_state)
{
    $arg = arg();
    $options = array(
        'query' => array(
            'data' => $form_state['values'],
        )
    );
    $form_state['redirect'] = array('/quan-ly-keywords/du-an/'.$form['#project_id']."/bao-cao", "data" => $options);
}
function cassiopeia_content_project_filter_form($form,&$form_state,$cache){
    $form['sort_by'] = array(
        '#type' => 'select',
        '#title'        => t(''),
        '#theme_wrappers' => array(),
        '#options' => array(
            'title' => t('Tất cả'),
            'domain' => t('Tất cả'),
            'article_count' => t('Đạt tiêu chuẩn'),
            'word_count' => t('Đạt tiêu chuẩn'),
            'point' => t('Đạt tiêu chuẩn'),
            'changed' => t('Đạt tiêu chuẩn'),
        ),
        '#attributes'   => array("style"=>"display:none")
    );
    $form['sort_direction'] = array(
        '#type' => 'select',
        '#title'        => t(''),
        '#theme_wrappers' => array(),
        '#options' => array(
            'ASC' => t('Tất cả'),
            'DESC' => t('Tất cả'),
        ),
        '#attributes'   => array("style"=>"display:none")
    );
    $form['search'] = array(
        '#type'     => 'submit',
        '#value'    => '<i class="fa fa-search"></i>',
        '#attributes'    => array("class"=>array("btn-search"))
    );
    return $form;
}
function cassiopeia_content_project_filter_form_submit($form, &$form_state)
{
    $arg = arg();
    $options = array(
        'query' => array(
            'data' => $form_state['values'],
        )
    );
    $form_state['redirect'] = array('/quan-ly-du-an-content', "data" => $options);
}
function cassiopeia_content_article_filter_form($form,&$form_state,$cache){
    global $user;
    $form['#pid'] = $cache['pid'];
    $form['sort_by'] = array(
        '#type' => 'select',
        '#title'        => t(''),
        '#theme_wrappers' => array(),
        '#options' => array(
            'changed' => t('Tất cả'),
            'raw_title' => t('Tất cả'),
            'word_count' => t('Đạt tiêu chuẩn'),
            'point' => t('Đạt tiêu chuẩn'),
        ),
        '#attributes'   => array("style"=>"display:none")
    );
    $form['sort_direction'] = array(
        '#type' => 'select',
        '#title'        => t(''),
        '#theme_wrappers' => array(),
        '#options' => array(
            'ASC' => t('Tất cả'),
            'DESC' => t('Tất cả'),
        ),
        '#attributes'   => array("style"=>"display:none")
    );
    $form['page'] = array(
        '#type'         => 'textfield',
//        '#attributes' => array("class" => array("hidden")),
        '#default_value' => !empty($cache['page'])?$cache['page']:1
    );
    $form['limit'] = array(
        '#type'         => 'textfield',
//        '#attributes' => array("class" => array("hidden")),
        '#default_value' => !empty($cache['limit'])?$cache['limit']:10
    );
    $form['title'] = array(
        '#type'         => 'textfield',
        '#title'        => t(''),
        '#theme_wrappers' => array(),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#attributes' => array("placeholder" => "Tìm kiếm bài viết"),
    );
    $form['title'] = array(
        '#type'         => 'textfield',
        '#title'        => t(''),
        '#theme_wrappers' => array(),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#attributes' => array("placeholder" => "Tìm kiếm bài viết"),
    );
    if(!empty($cache['title'])){
        $form['title']['#default_value'] = $cache['title'];
    }
    $form['from_date'] = array(
        '#type'         => 'textfield',
        '#size'         => 60,
        '#maxlength'    => 128,
        '#attributes' => array("autocomplete" => "off"),
        '#title'        => t(''),
        '#theme_wrappers' => array()
    );
    if(!empty($cache['from_date'])){
        $form['from_date']['#default_value'] = $cache['from_date'];
    }
    $form['to_date'] = array(
        '#type'         => 'textfield',
        '#title'        => t(''),
        '#theme_wrappers' => array(),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#attributes' => array("autocomplete" => "off"),
    );
    if(!empty($cache['to_date'])){
        $form['to_date']['#default_value'] = $cache['to_date'];
    }
    $form['tag'] = array(
        '#type' => 'select',
        '#title'        => t(''),
        '#theme_wrappers' => array(),
        '#options' => $cache['tag_options'],
    );
    if(!empty($cache['tag'])){
        $form['tag']['#default_value'] = $cache['tag'];
    }
    $form['rank'] = array(
        '#type' => 'select',
        '#title'        => t(''),
        '#theme_wrappers' => array(),
        '#options' => array(
            'all' => t('Tất cả'),
            1 => t('Đạt tiêu chuẩn'),
            2 => t('Chưa đạt'),
            3 => t('Cần tối ưu'),
        ),
        '#attributes'   => array("style"=>"display:none")
    );
//    _print_r($cache);
    if(!empty($cache['rank'])){
        $form['rank']['#default_value'] = $cache['rank'];
    }
    $form['submit'] = array(
        '#type'     => 'submit',
        '#value'    => t('Lọc'),
        '#prefix'   => "<div class='buttons' >",
        '#suffix'   => "</div>",
        '#attributes'    => array("class"=>array("btn-green"))
    );
    $form['search'] = array(
        '#type'     => 'submit',
        '#value'    => '<i class="fa fa-search"></i>',
        '#attributes'    => array("class"=>array("btn-search"))
    );
    return $form;
}
function cassiopeia_content_article_filter_form_submit($form, &$form_state)
{
    $arg = arg();
    $options = array(
        'query' => array(
            'data' => $form_state['values'],
        )
    );
    $form_state['redirect'] = array('/quan-ly-du-an-content/'. $form['#pid'], "data" => $options);
}
function cassiopeia_backlink_filter_form($form,&$form_state,$cache){
    global $user;
    $form['#project_id'] = $cache['project_id'];
    $form['from_date'] = array(
        '#type'         => 'textfield',
        '#title'        => t('Từ ngày'),
        '#size'         => 60,
        '#maxlength'    => 128,
//        '#attributes' => array("onchange" => "this.form.submit();", "class" => array("form_date")),
    );
    if(!empty($cache['from_date'])){
        $form['from_date']['#default_value'] = $cache['from_date'];
    }
    $form['to_date'] = array(
        '#type'         => 'textfield',
        '#title'        => t('Đến ngày'),
        '#size'         => 60,
        '#maxlength'    => 128,
//        '#attributes' => array("onchange" => "this.form.submit();", "class" => array("form_date")),
    );
    if(!empty($cache['to_date'])){
        $form['to_date']['#default_value'] = $cache['to_date'];
    }
    $form['tag'] = array(
        '#type' => 'select',
        '#title' => t('Tag'),
        '#options' => $cache['tag_options'],
    );
    if(!empty($cache['tag'])){
        $form['tag']['#default_value'] = $cache['tag'];
    }
    $form['indexed'] = array(
        '#type' => 'select',
        '#title' => t('Google indexed'),
        '#options' => array(
            "all"   => "Tất cả",
            1   => "Có",
            0   => "Không",
            3   => "Chưa kiểm tra",
            2   => "Chưa kiểm tra trong ngày",
        ),
    );
    if(isset($cache['indexed'])){
        $form['indexed']['#default_value'] = $cache['indexed'];
    }
    $form['status'] = array(
        '#type' => 'select',
        '#title' => t('Tình trạng'),
        '#options' => array(
            "all"   => "Tất cả",
            200   => "Thành công",
            "ERROR"   => "Lỗi",
            "RAW"   => "Chưa kiểm tra",
        ),
    );
    if(isset($cache['status'])){
        $form['status']['#default_value'] = $cache['status'];
    }
    $form['submit'] = array(
        '#type'     => 'submit',
        '#value'    => t('Lọc'),
        '#prefix'   => "<div class='buttons' >",
        '#suffix'   => "</div>"
    );
    return $form;
}

function cassiopeia_backlink_filter_form_submit($form, &$form_state)
{
    $arg = arg();
    $options = array(
        'query' => array(
            'data' => $form_state['values'],
        )
    );
    $form_state['redirect'] = array('/quan-ly-backlink/du-an/'.$form['#project_id'], "data" => $options);
}
function cassiopeia_add_backlink_form($form,&$form_state,$project){
    $form['#project'] = $project;
    $form['value'] = array(
        '#title'    => t(''),
        '#type'     => 'textarea',
        '#prefix'       => "<div class='input-wrap'>",
        '#suffix'       => "<p></p></div>",
        '#attributes'    => array("placeholder"=> "Mời bạn nhập Backlink, mỗi Backlink nằm trên 1 dòng. Nhập tối đa 1.000 nguồn Backlink/mỗi lần. Nếu dự án > 1.000 nguồn Backlink thì chia nhiều lần nhập liệu"),
        '#required'     => TRUE
    );
    $form['tags'] = array(
        '#type'         => 'textfield',
        '#title'        => t('Tags ')."<div class=\"toolTip\">
                        <span
                            type=\"button\"
                            data-toggle=\"tooltip\"
                            data-placement=\"right\"
                            title=\"Tạo Tag nhằm mục đích nhóm các Backlink cùng Tính chất hoặc Chủ đề\"
                        >
                            <span class=\"fa fa-question-circle-o\" aria-hidden=\"true\"></span>
                        </span>
                    </div>",
        '#size'         => 60,
        '#maxlength'    => 128,
        '#prefix'       => "<div class='input-wrap'>",
        '#suffix'       => "<p></p></div>",
        '#attributes'    => array("class"=>array("tagify-input"), "placeholder"=> "Phân cách các thẻ Tag nhấn phím Enter"),
    );
    $form['submit'] = array(
        '#type'         => 'submit',
        '#value'        => t("Thêm mới"),
        '#prefix'       => "<div class='form-buttons'>",
        '#suffix'       => "</div>",
        '#attributes'   => array("class"=>array("btn-type-2")),
    );

    return $form ;
}
function cassiopeia_add_backlink_form_submit($form,&$form_state){
    global $user;
    $max_backlinks = 10000;
    $reg = "/^(?:[-A-Za-z0-9]+\.)+[A-Za-z]{2,6}$/i";
    $value = $form_state['values']['value'];
    $splitter = explode("\n",$value);
    $project = $form['#project'];
//    $duplicate = "<p>Backlink đã tồn tại! </p><ul>";
    $duplicate = 0;
    $invalid = 0;
    $valid = 0;
    $insert_valid = TRUE;
    $backlinks = array();
    $checkDuplicate = false;
    if($project->uid==$user->uid){
        try{
            if (count($splitter) > $max_backlinks) {
              $insert_valid = FALSE;
            }
            if ($insert_valid) {
                if(!empty($splitter)){
                    foreach($splitter as $datum){
                        if(!empty(trim($datum))){
                            $datum = trim($datum);

                            $query = db_select("tbl_backlink","tbl_backlink");
                            $query->fields("tbl_backlink");
                            $query->condition("uid",$user->uid);
                            $query->condition("pid",$project->nid);
                            $query->where('refer_page COLLATE utf8_bin = :title', array(':title' => $datum));
                            $check = $query->execute()->fetchAll();
                            if(empty($check)){
                                $url = str_replace("https://","",$datum);
                                $url = str_replace("http://","",$url);
                                $s1 = explode("/",$url);
                                $domain = $s1[0];
                                if(preg_match($reg, $domain)){
                                    $backlinks[] =  array(
                                        "created"       => REQUEST_TIME,
                                        "changed"       => REQUEST_TIME,
                                        "uid"       => $user->uid,
                                        "refer_page"       => $datum,
                                        "pid"       => $project->nid,
                                        "domain"       => $domain,
                                        "indexed"       => 2,
                                        "status"       => "RAW",
                                    );
                                    $valid++;
                                }else{
                                    $invalid++;
                                }
                            }else{
                                $checkDuplicate = true;
//                            $duplicate.="<li>".$datum."</li>";
                                $duplicate++;
                            }
                        }
                    }
                }
                $tids = array();
                if(!empty($form_state['values']['tags'])){
                    foreach(json_decode($form_state['values']['tags']) as $_tag){
                        $term = null;
                        $conditions = array();
                        $conditions['field_user'] = array(
                            "type"      => "fieldCondition",
                            "key"       => "target_id",
                            "value"     => $user->uid,
                            "condition" => "=",
                        );
                        $conditions['field_backlink_project'] = array(
                            "type"      => "fieldCondition",
                            "key"       => "nid",
                            "value"     => $project->nid,
                            "condition" => "=",
                        );
                        $conditions['name'] = array(
                            "type"      => "propertyCondition",
                            "value"     => $_tag->value,
                            "condition" => "=",
                        );
                        $tags = cassiopeia_get_items_by_conditions($conditions,"tags","taxonomy_term");
                        if(!empty($tags)){
                            $term = array_values($tags)[0];
                        }
                        if(!empty($term)){
//                            $term = array_values($term)[0];
                            $tids[] = $term->tid;
                        }else{
                            $v = taxonomy_vocabulary_machine_name_load("tags");
                            $newterm = new stdClass();
                            $newterm->name = $_tag->value;
                            $newterm->vid = $v->vid;
                            $newterm->field_user['und'][0]['target_id'] = $user->uid;
                            $newterm->field_backlink_project['und'][0]['nid'] = $project->nid;
                            taxonomy_term_save($newterm);
                            cassiopeia_dump($newterm);
                            $tids[] = $newterm->tid;
                        }
                    }
                }
              $_backlinks_ = array_chunk($backlinks, 100);
              foreach ($_backlinks_ as $__backlinks__) {
                foreach ($__backlinks__ as $__backlink__) {
                  $id = db_insert("tbl_backlink")->fields($__backlink__)->execute();
                  foreach((array)$tids as $tid){
                    db_insert("tbl_tags")->fields(array(
                      "created"   => REQUEST_TIME,
                      "nid"       => $id,
                      "tid"       => $tid,
                      "pid"       => $project->nid,
                    ))->execute();
                  }
                }
              }
              if(!empty($invalid)){
                $text = "backlink";
                if($invalid>1){
                  $text = "backlinks";
                }
                drupal_set_message("Hệ thống đã xóa tự động ".$invalid." ".$text." không hợp lệ!","error");
              }
              if($checkDuplicate){
                $data['response'] = "FAILED";
                $text = "backlink";
                if($checkDuplicate>1){
                  $text = "backlinks";
                }
                drupal_set_message("Hệ thống đã xóa tự động ".$duplicate." ".$text." trùng lặp!","error");
              }
              $data['response'] = "OK";
              drupal_set_message("Đã thêm ".$valid." backlinks");
            }else {
              drupal_set_message('Vượt qúa giới hạn '.$max_backlinks.' cho phép.',"error");
            }
        }catch (Exception $e){
            drupal_set_message(($e));
            $data['response'] = "FAIL";
//            drupal_set_message("Đã xảy ra lỗi, vui lòng liên hệ với người quản trị!");
        }
    }
}
function cassiopeia_add_keyword_form($form,&$form_state,$project){
    $form['#project'] = $project;
    $form['value'] = array(
        '#title'    => t(''),
        '#type'     => 'textarea',
        '#prefix'       => "<div class='input-wrap'>",
        '#suffix'       => "<p></p></div>",
        '#attributes'    => array("placeholder"=>array("Mời bạn nhập từ khóa, mỗi từ khóa nằm trên 1 dòng! Nhập tối đa 1.000 từ khóa/mỗi lần. Nếu dự án > 1.000 từ khóa thì chia nhiều lần nhập liệu")),
        '#required'     => TRUE,
    );
    $form['tags'] = array(
        '#type'         => 'textfield',
        '#title'        => t('Tags'),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#prefix'       => "<div class='form-item input-wrap' title='Tạo Tag nhằm mục đích nhóm các Từ khóa cùng Tính chất hoặc Chủ đề'>",
        '#suffix'       => "<p></p></div>",
        '#attributes'    => array("class"=>array("tagify-input"),"placeholder"=>"Phân cách các thẻ Tag nhấn phím Enter",'title' => "",)
    );
    $form['submit'] = array(
        '#type'         => 'submit',
        '#value'        => t("Thêm mới"),
        '#prefix'       => "<div class='form-buttons'>",
        '#suffix'       => "</div>",
        '#attributes'   => array("class"=>array("btn-type-2"))
    );

    return $form ;
}
function cassiopeia_add_keyword_form_submit($form,&$form_state){
    global $user;
    $duplicate = "<p>Từ khóa đã tồn tại! </p><ul>";
    $checkDuplicate = false;
    $value = $form_state['values']['value'];
    $splitter = explode("\n",$value);
    $project = $form['#project'];
    $TotalKeyword = 0;
    $TotalDuplicateKeyword = 0;
    if(count($splitter)>3000){
        drupal_set_message('Vượt qúa giới hạn 1.000 cho phép.',"error");
    }else{
        if($project->uid==$user->uid){
            try{
                foreach($splitter as $item) {
                    $item = trim($item);
                    if(!empty($item)){
                        $query = db_select("node", "tbl_node");
                        $query->fields("tbl_node");
                        $query->condition("tbl_node.type", "keyword");
                        $query->where('tbl_node.title COLLATE utf8_bin = :title', array(':title' => $item));
                        $query->join("field_data_field_keyword_project","field_keyword_project","field_keyword_project.entity_id=tbl_node.nid");
                        $query->condition("field_keyword_project.field_keyword_project_nid",$project->nid);
                        $check = $query->execute()->fetchAll();
                        if(empty($check)){
                            if (!empty($form_state['values']['tags'])) {
                                $tids = array();
                                foreach (json_decode($form_state['values']['tags']) as $_tag) {
                                    $conditions = array();
                                    $conditions['field_user'] = array(
                                        "type"      => "fieldCondition",
                                        "key"       => "target_id",
                                        "value"     => $user->uid,
                                        "condition" => "=",
                                    );
                                    $conditions['field_keyword_project'] = array(
                                        "type"      => "fieldCondition",
                                        "key"       => "nid",
                                        "value"     => $project->nid,
                                        "condition" => "=",
                                    );
                                    $conditions['name'] = array(
                                        "type"      => "propertyCondition",
                                        "value"     => $_tag->value,
                                        "condition" => "=",
                                    );
                                    $tags = cassiopeia_get_items_by_conditions($conditions,"tags","taxonomy_term");
                                    if(!empty($tags)){
                                        $term = array_values($tags)[0];
                                    }
                                    if (!empty($term)) {
                                        $tids[] = $term->tid;
                                    } else {
                                        $v = taxonomy_vocabulary_machine_name_load("tags");
                                        $newterm = new stdClass();
                                        $newterm->name = $_tag->value;
                                        $newterm->vid = $v->vid;
                                        $newterm->field_user['und'][0]['target_id'] = $user->uid;
                                        $newterm->field_keyword_project['und'][0]['nid'] = $project->nid;
                                        taxonomy_term_save($newterm);
                                        cassiopeia_dump($newterm);
                                        $tids[] = $newterm->tid;
                                    }
                                }
                            }

                            $_node = new stdClass();
                            $_node->type = "keyword";
                            if (!empty($tids)) {
                                foreach ($tids as $tid) {
                                    $_node->field_tags['und'][]['tid'] = $tid;
                                }
                            }
                            $_node->uid = $user->uid;
                            $_node->title = trim($item);
                            $_node->field_keyword_project['und'][0]['nid'] = $project->nid;
//                    $_node->field_url['und'][0]['value'] = $urlSeo;
                            node_save($_node);
                            node_submit($_node);
                            $TotalKeyword++;
                            $data['response'] = "OK";
//                    drupal_set_message("Thêm mới thành công!");
                        }else{
                            $checkDuplicate = true;
                            $TotalDuplicateKeyword++;
                            $duplicate.="<li>".$item."</li>";
//                    drupal_set_message("Từ khóa đã tồn tại!", "error");
                        }
                    }
                }
                $duplicate.="</ul>";
                if($checkDuplicate){
                    $data['response'] = "FAILED";
                    drupal_set_message("Đã tự động xóa ".$TotalDuplicateKeyword." từ khóa trùng lặp!","error");
                }else{
                    $data['response'] = "OK";
                    drupal_set_message("Đã thêm ".$TotalKeyword." từ khóa");
                }
            }catch (Exception $e){
                $data['response'] = "FAIL";
                drupal_set_message("Đã xảy ra lỗi, vui lòng liên hệ với người quản trị!","error");
            }
        }
    }
}
function cassiopeia_form_duplicate_content_node_form_alter(&$form,&$form_state){
    unset($form['title']);
    unset($form['actions']);
}

function cassiopeia_create_get_urls_export($key){
    global $user;
    if(!empty($key)){
        $urls = $_SESSION['GetUrlData'][$key];
    }else{
        $nodes = [];
        if(!empty($_SESSION['GetUrlData'])){
            foreach($_SESSION['GetUrlData'] as $item){
                foreach($item as $_key => $_item){
                    $nodes[$_key] = $_item;
                }
            }
        }
        $urls = $nodes;
    }
    module_load_include('inc', 'phpexcel');
    $data = array();
    $headers = array(
        "STT",
        "URL",
        "Số lượng ký tự",
        "Anchor Text",
    );
    $parent = null;
    $stt = 1;
    if(!empty($urls)){
        foreach($urls as $_key => $_value){
//            if(strlen($_key)<60) continue;
            $data[] = array(
                $stt,
                $_key,
                strlen($_key),
                $_value,
            );
            $stt++;
        }
    }
//    _print_r($urls);
//    die;
    // Store the file in sites/default/files
    $dir = file_stream_wrapper_get_instance_by_uri('public://')->realpath();
    $filename =  'export_'.date('d_m_Y_H_i', REQUEST_TIME).'.xlsx';
    $path = "$dir/$filename";

    // Use the .xls format
    $options = array('format' => 'xlsx');

    $result = phpexcel_export($headers, $data, $path, $options);
//    _print_r($result);

//    die;
    if ($result == PHPEXCEL_SUCCESS) {
        // notify to admin
        drupal_set_message(t("Ok"));
        return array('name'=>$filename,'uri'=>'public://'.$filename,'golf'=>$parent);
    }
    else {
        drupal_set_message($result, 'error');
        return null;
    }
}
function cassiopeia_create_duplicate_export(){
    global $user;
    $duplicate = $_SESSION['duplicate'];
    module_load_include('inc', 'phpexcel');
    $data = array();
    $headers = array(
        "STT",
        "Câu truy vấn",
        "Nguồn trùng lặp",
        "Kết quả",
    );
    $parent = null;
    $stt = 1;
    if(!empty($duplicate)){
        foreach($duplicate as $datum){
            $result = null;
            $_result = $datum->result==="true"?"Trùng lặp":"Độc đáo";
            $data[] = array(
                $datum->stt,
                $datum->text,
                $datum->sources,
                $_result
            );
            $stt++;
        }
    }
    // Store the file in sites/default/files
    $dir = file_stream_wrapper_get_instance_by_uri('public://')->realpath();
    $filename =  'export_'.date('d_m_Y_H_i', REQUEST_TIME).'.xlsx';
    $path = "$dir/$filename";

    // Use the .xls format
    $options = array('format' => 'xlsx');

    $result = phpexcel_export($headers, $data, $path, $options);
    if ($result == PHPEXCEL_SUCCESS) {
        // notify to admin
        drupal_set_message(t("Ok"));
        return array('name'=>$filename,'uri'=>'public://'.$filename,'golf'=>$parent);
    }
    else {
        drupal_set_message($result, 'error');
        return null;
    }
}
function cassiopeia_keyword_export_($items,$pid){
    global $user;
    $projects = cassiopeia_get_items_by_conditions(array(),"project_keyword","node");
    $stt = 1;
    $filename = "_từ khóa";
    drupal_add_http_header('Content-Type', 'application/vnd.ms-excel; charset=utf-8');
    drupal_add_http_header('Content-Disposition', 'attachment; filename=' . $filename . '.xls');
    print("\xEF\xBB\xBF"); // UTF-8 BOM
    ?>
    <table border="1" class="table table-striped table-div-responsive table-type-2 table-responsive">
        <thead>
        <tr>
            <th class="w-3">STT</th>
            <th class="w-18">Từ khóa</th>
            <th>Thay đổi</th>
            <th>Vị trí hiện tại</th>
            <th>Vị trí cũ</th>
            <th>Vị trí tốt nhất</th>
            <th>URL SEO</th>
            <th>Tag</th>
            <th>Ngày cập nhật</th>
        </tr>
        </thead>
        <tbody class="result">
        <?php if(!empty($projects)): ?>
            <?php foreach($projects as $project): ?>
                <?php
                $conditions = array();
                $conditions['nid'] = array(
                    "type"      => "propertyOrderBy",
                    "direction" => "DESC",
                );
                $conditions['field_keyword_project'] = array(
                    "type"      => "fieldCondition",
                    "key"       => "nid",
                    "value"     => $project->nid,
                    "condition" => "=",
                );
                $keywords = (array)cassiopeia_get_items_by_conditions($conditions,"keyword","node");
                ?><tr >
                <td colspan="9"><b><?php echo $project->title; ?></b></td>
                </tr>
                <?php foreach($keywords as $item): ?>
                    <tr data-nid="<?php echo($item->nid); ?>">
                        <td class="w-3"><?php echo $stt; ?></td>
                        <td class="w-18 text-left">
                            <?php echo($item->title); ?>
                        </td>
                        <?php
                        $status_class = "";
                        if(!empty($item->field_keyword_old_position['und'][0]['value']) && !empty($item->field_keyword_position['und'][0]['value'])){
                            if($item->field_keyword_position['und'][0]['value'] - $item->field_keyword_old_position['und'][0]['value']>0){
                                $status_class = " - ";
                            }elseif($item->field_keyword_position['und'][0]['value'] - $item->field_keyword_old_position['und'][0]['value']<0){
                                $status_class = " + ";
                            }
                        }
                        ?>
                        <td class="w-6 status <?php echo($status_class); ?> _loading">
                            <span class='loading-item'></span><span class='td-content'><?php echo $status_class; echo(!empty($item->field_keyword_old_position['und'][0]['value'])?abs($item->field_keyword_position['und'][0]['value']-$item->field_keyword_old_position['und'][0]['value']):"-"); ?></span>
                        </td>
                        <td class="w-7 _loading">  <span class='loading-item'></span><span class='td-content'><?php echo(!empty($item->field_keyword_position['und'][0]['value'])?$item->field_keyword_position['und'][0]['value']:"-"); ?></span></td>
                        <td class="w-10 _loading"> <span class='loading-item'></span><span class='td-content'><?php echo(!empty($item->field_keyword_old_position['und'][0]['value'])?$item->field_keyword_old_position['und'][0]['value']:"-"); ?></span></td>
                        <td class="w-10 _loading"> <span class='loading-item'></span><span class='td-content'><?php echo(!empty($item->field_keyword_best_position['und'][0]['value'])?$item->field_keyword_best_position['und'][0]['value']:"-"); ?></span></td>
                        <td class="w-20 _loading"> <span class='loading-item'></span><span class='td-content'><?php echo(!empty($item->field_url['und'][0]['value'])?$item->field_url['und'][0]['value']:"-"); ?></span></td>
                        <td class="w-10">
                            <?php if(!empty($item->field_tags['und'])): ?>
                                <div>
                                    <?php foreach($item->field_tags['und'] as $_tag):  ?>
                                        <?php $tag = taxonomy_term_load($_tag['tid']); if(!empty($tag)) echo($tag->name.","); ?>
                                    <?php endforeach; ?>
                                </div>
                            <?php endif; ?>
                        </td>
                        <td class="w-7"><?php echo date("d/m/Y",$item->created); ?></td>
                    </tr>
                    <?php $stt++; endforeach; ?>
            <?php endforeach; ?>
        <?php endif; ?>
        </tbody>
    </table>
    <?php
}
function cassiopeia_keyword_export($items,$pid){
    global $user;
    $project = node_load($pid);
    $stt = 1;
    $filename = $project->title."_từ khóa";
    drupal_add_http_header('Content-Type', 'application/vnd.ms-excel; charset=utf-8');
    drupal_add_http_header('Content-Disposition', 'attachment; filename=' . $filename . '.xls');
    print("\xEF\xBB\xBF"); // UTF-8 BOM
    ?>
    <table border="1" class="table table-striped table-div-responsive table-type-2 table-responsive">
        <thead>
        <tr>
            <th class="w-3">STT</th>
            <th class="w-18">Từ khóa</th>
            <th>Thay đổi</th>
            <th>Vị trí hiện tại</th>
            <th>Vị trí cũ</th>
            <th>Vị trí tốt nhất</th>
            <th>URL SEO</th>
            <th>Tag</th>
            <th>Ngày cập nhật</th>
        </tr>
        </thead>
        <tbody class="result">
        <?php if(!empty($items)): ?>
            <?php foreach($items as $item): ?>
                <tr data-nid="<?php echo($item->nid); ?>">
                    <td class="w-3"><?php echo $stt; ?></td>
                    <td class="w-18 text-left">
                        <?php echo($item->title); ?>
                    </td>
                    <?php
                    $status_class = "";
                    if(!empty($item->field_keyword_old_position['und'][0]['value']) && !empty($item->field_keyword_position['und'][0]['value'])){
                        if($item->field_keyword_position['und'][0]['value'] - $item->field_keyword_old_position['und'][0]['value']>0){
                            $status_class = " - ";
                        }elseif($item->field_keyword_position['und'][0]['value'] - $item->field_keyword_old_position['und'][0]['value']<0){
                            $status_class = " + ";
                        }
                    }
                    ?>
                    <td class="w-6 status <?php echo($status_class); ?> _loading">
                        <span class='loading-item'></span><span class='td-content'><?php echo $status_class; echo(!empty($item->field_keyword_old_position['und'][0]['value'])?abs($item->field_keyword_position['und'][0]['value']-$item->field_keyword_old_position['und'][0]['value']):"-"); ?></span>
                    </td>
                    <td class="w-7 _loading">  <span class='loading-item'></span><span class='td-content'><?php echo(!empty($item->field_keyword_position['und'][0]['value'])?$item->field_keyword_position['und'][0]['value']:"-"); ?></span></td>
                    <td class="w-10 _loading"> <span class='loading-item'></span><span class='td-content'><?php echo(!empty($item->field_keyword_old_position['und'][0]['value'])?$item->field_keyword_old_position['und'][0]['value']:"-"); ?></span></td>
                    <td class="w-10 _loading"> <span class='loading-item'></span><span class='td-content'><?php echo(!empty($item->field_keyword_best_position['und'][0]['value'])?$item->field_keyword_best_position['und'][0]['value']:"-"); ?></span></td>
                    <td class="w-20 _loading"> <span class='loading-item'></span><span class='td-content'><?php echo(!empty($item->field_url['und'][0]['value'])?$item->field_url['und'][0]['value']:"-"); ?></span></td>
                    <td class="w-10">
                        <?php if(!empty($item->field_tags['und'])): ?>
                            <div>
                                <?php foreach($item->field_tags['und'] as $_tag):  ?>
                                    <?php $tag = taxonomy_term_load($_tag['tid']); if(!empty($tag)) echo($tag->name.","); ?>
                                <?php endforeach; ?>
                            </div>
                        <?php endif; ?>
                    </td>
                    <td class="w-7"><?php echo date("d/m/Y",$item->created); ?></td>
                </tr>
                <?php $stt++; endforeach; ?>
        <?php endif; ?>
        </tbody>
    </table>
    <?php
}
function cassiopeia_create_content_projects(){
    global $user;
    $cassiopeia_content_query = db_select("cassiopeia_content","cassiopeia_content");
    $cassiopeia_content_query->addField("cassiopeia_content","pid","pid");
    $cassiopeia_content_query->addExpression("AVG(word_count)","word_count_avg");
    $cassiopeia_content_query->addExpression("AVG(point)","point_avg");
    $cassiopeia_content_query->addExpression("COUNT(id)","id_count");
    $cassiopeia_content_query->groupBy("cassiopeia_content.pid");
    $cassiopeia_content_query->condition("uid",$user->uid);

    $query = db_select("node","tbl_node");
    $query->fields("tbl_node");
    $query->condition("tbl_node.type","content_project");
    $query->condition("tbl_node.uid",$user->uid);
    $query->orderBy("tbl_node.changed","DESC");
    $query->join("field_data_field_domain","field_domain","field_domain.entity_id=tbl_node.nid");
    $query->addField("field_domain","field_domain_value","project_domain");
    $query->condition("tbl_node.nid",$_REQUEST['nid'],"IN");

    $query->leftJoin($cassiopeia_content_query,"tbl_count","tbl_count.pid=tbl_node.nid");
    $query->fields("tbl_count");

    $projects = $query->execute()->fetchAll();
//    _print_r($projects);
//    die;
    module_load_include('inc', 'phpexcel');
    $data = array();
    $headers = array(
        "STT",
        "Tên dự án",
        "Website",
        "Số bài viết",
        "Số từ trung bình",
        "Điểm trung bình",
        "Ngày cập nhật",
    );
    $parent = null;
    $stt = 1;
    if(!empty($projects)){
        foreach($projects as $item){
            $point = (int)$item->point_avg;
            $data[] = array(
                $stt++,
                $item->title,
                $item->project_domain,
                number_format($item->id_count,0,",","."),
                number_format((int)$item->word_count_avg,0,",","."),
                $point."/100",
                date("d/m/Y",$item->changed),
            );
        }
    }
//    print_r($data);
//    die;
    // Store the file in sites/default/files
    $dir = file_stream_wrapper_get_instance_by_uri('public://')->realpath();
    $filename =  'export_'.date('d_m_Y_H_i', REQUEST_TIME).'.xlsx';
    $path = "$dir/$filename";

    // Use the .xls format
    $options = array('format' => 'xlsx');

    $result = phpexcel_export($headers, $data, $path, $options);
    if ($result == PHPEXCEL_SUCCESS) {
        // notify to admin
        drupal_set_message(t("Ok"));
        return array('name'=>$filename,'uri'=>'public://'.$filename,'golf'=>$parent);
    }
    else {
        drupal_set_message($result, 'error');
        return null;
    }
}
function cassiopeia_create_keyword_projects(){
    global $user;
    $conditions = array();
    $conditions['changed'] = array(
        "type"      => "propertyOrderBy",
        "direction" => "DESC",
    );
    if(!empty($_REQUEST['nid'])){
        $conditions['nid'] = array(
            "type"      => "propertyCondition",
            "value"     => $_REQUEST['nid'],
            "condition" => "IN"
        );
    }
    $conditions['uid'] = array(
        "type"      => "propertyCondition",
        "value"     => $user->uid,
        "condition" => "=",
    );
    $projects = cassiopeia_get_items_by_conditions($conditions,"project_keyword","node");
    module_load_include('inc', 'phpexcel');
    $data = array();
    $headers = array(
        "STT",
        "Tên dự án",
        "Website",
        "Top 01-03",
        "Top 01-05",
        "Top 01-10",
        "Top 01-30",
        "Thứ hạng trung bình",
        "Ngày cập nhật",
    );
    $parent = null;
    $stt = 1;
    if(!empty($projects)){
        foreach($projects as $project){
            $query = db_select("node","tbl_node");
            $query->fields("tbl_node");
            $query->condition("type","keyword");
            $query->join("field_data_field_keyword_project","field_keyword_project","field_keyword_project.entity_id=tbl_node.nid");
            $query->condition("field_keyword_project.field_keyword_project_nid",$project->nid);
            $query->addExpression("COUNT(tbl_node.nid)","total");
            $query->leftJoin("field_data_field_keyword_position","field_keyword_position","field_keyword_position.entity_id=tbl_node.nid");
            $query->addExpression("SUM(CASE WHEN field_keyword_position.field_keyword_position_value<=3 THEN 1 ELSE 0 END)","top_3");
            $query->addExpression("SUM(CASE WHEN field_keyword_position.field_keyword_position_value<=5 THEN 1 ELSE 0 END)","top_5");
            $query->addExpression("SUM(CASE WHEN field_keyword_position.field_keyword_position_value<=10 THEN 1 ELSE 0 END)","top_10");
            $query->addExpression("SUM(CASE WHEN field_keyword_position.field_keyword_position_value<=30 THEN 1 ELSE 0 END)","top_30");
            $query->addExpression("SUM(CASE WHEN field_keyword_position.field_keyword_position_value<=100 THEN 1 ELSE 0 END)","top_100");
            $query->addExpression("AVG(field_keyword_position.field_keyword_position_value)","AVG");
            $query->range(0,1);
            $result = $query->execute()->fetchObject();
            $_total = !empty($result->total)?$result->total:0;
            $AVG = !empty($result->AVG)?round($result->AVG,2):"-";
            $top_3 = !empty($result->top_3)?$result->top_3."/".$result->total:"0/".$_total;
            $top_10 = !empty($result->top_10)?$result->top_10."/".$result->total:"0/".$_total;
            $top_30 = !empty($result->top_30)?$result->top_30."/".$result->total:"0/".$_total;
            $top_100 = !empty($result->top_100)?$result->top_100."/".$result->total:"0/".$_total;
            $data[] = array(
                $stt,
                $project->title,
                $project->field_domain['und'][0]['value'],
                $top_3,
                $top_10,
                $top_30,
                $top_100,
                $AVG,
                date("d/m/Y",$project->changed),
            );
            $stt++;
        }
    }
//    print_r($data);
//    die;
    // Store the file in sites/default/files
    $dir = file_stream_wrapper_get_instance_by_uri('public://')->realpath();
    $filename =  'export_'.date('d_m_Y_H_i', REQUEST_TIME).'.xlsx';
    $path = "$dir/$filename";

    // Use the .xls format
    $options = array('format' => 'xlsx');

    $result = phpexcel_export($headers, $data, $path, $options);
    _print_r($result);
    if ($result == PHPEXCEL_SUCCESS) {
        // notify to admin
        drupal_set_message(t("Ok"));
        return array('name'=>$filename,'uri'=>'public://'.$filename,'golf'=>$parent);
    }
    else {
        drupal_set_message($result, 'error');
        return null;
    }
}
function cassiopeia_export_keyword_projects(){
    global $user;

    $filename = "keyword".REQUEST_TIME;
    drupal_add_http_header('Content-Type', 'application/vnd.ms-excel; charset=utf-8');
    drupal_add_http_header('Content-Disposition', 'attachment; filename=' . $filename . '.xls');
    print("\xEF\xBB\xBF"); // UTF-8 BOM
    $conditions = array();
    $conditions['created'] = array(
        "type"      => "propertyOrderBy",
        "direction" => "DESC",
    );
    if(!empty($_REQUEST['nid'])){
        $conditions['nid'] = array(
            "type"      => "propertyCondition",
            "value"     => $_REQUEST['nid'],
            "condition" => "IN"
        );
    }
    $conditions['uid'] = array(
        "type"      => "propertyCondition",
        "value"     => $user->uid,
        "condition" => "=",
    );
    $projects = cassiopeia_get_items_by_conditions($conditions,"project_keyword","node");
    ?>
    <table class="table table-striped table-div-responsive table-type-2">
        <thead>
        <tr>
            <th>
                <label class="mask-chekbox">
                    <input type="checkbox" name="select" class="selectAll">
                    <span class="mask-checked"></span>
                </label>
            </th>
            <th>
                <span class="square">#</span>
            </th>
            <th data-sort="name" class="text-left sorting sorting_desc <?php if(isset($_REQUEST['direction']) && $_REQUEST['direction']=="ASC") echo "sorting_asc"; ?>">Tên dự án</th>
            <th data-sort="website" class="text-left sorting sorting_desc <?php if(isset($_REQUEST['direction']) && $_REQUEST['direction']=="ASC") echo "sorting_asc"; ?>">Website</th>
            <th class="w-8 sorting sorting_desc">Top 01-03</th>
            <th class="w-8 sorting sorting_desc">Top 01-05</th>
            <th class="w-8 sorting sorting_desc">Top 01-10</th>
            <th class="w-8 sorting sorting_desc">Top 01-30</th>
            <th class="w-8 sorting sorting_desc">Top 01-100</th>
            <th data-sort="created" class="sorting sorting_desc <?php if(isset($_REQUEST['direction']) && $_REQUEST['direction']=="ASC") echo "sorting_asc"; ?>">Ngày cập nhật</th>
        </tr>
        </thead>
        <tbody>
        <?php if(!empty($projects)): $stt=1; ?>
            <?php foreach($projects as $item): ?>
                <?php
                $query = db_select("node","tbl_node");
                $query->fields("tbl_node");
                $query->condition("type","keyword");
                $query->join("field_data_field_keyword_project","field_keyword_project","field_keyword_project.entity_id=tbl_node.nid");
                $query->condition("field_keyword_project.field_keyword_project_nid",$item->nid);
                $query->addExpression("COUNT(tbl_node.nid)","total");
                $query->leftJoin("field_data_field_keyword_position","field_keyword_position","field_keyword_position.entity_id=tbl_node.nid");
                $query->addExpression("SUM(CASE WHEN field_keyword_position.field_keyword_position_value<=3 THEN 1 ELSE 0 END)","top_3");
                $query->addExpression("SUM(CASE WHEN field_keyword_position.field_keyword_position_value<=5 THEN 1 ELSE 0 END)","top_5");
                $query->addExpression("SUM(CASE WHEN field_keyword_position.field_keyword_position_value<=10 THEN 1 ELSE 0 END)","top_10");
                $query->addExpression("SUM(CASE WHEN field_keyword_position.field_keyword_position_value<=30 THEN 1 ELSE 0 END)","top_30");
                $query->addExpression("SUM(CASE WHEN field_keyword_position.field_keyword_position_value<=100 THEN 1 ELSE 0 END)","top_100");
                $query->range(0,1);
                $result = $query->execute()->fetchObject();
                ?>
                <tr>
                    <td>
                        <label class="mask-chekbox">
                            <input name="nid[]" type="checkbox" value="<?php echo($item->nid); ?>">
                            <span class="mask-checked"></span>
                        </label>
                    </td>
                    <td><?php echo $stt; ?></td>
                    <td class="text-green text-left"><a href="/quan-ly-keywords/du-an/<?php echo($item->nid); ?>"><?php echo($item->title); ?></a></td>
                    <td class="text-left text-blue"><?php echo($item->field_domain['und'][0]['value']); ?></td>
                    <td type="general" style="mso-number-format:\@;"><?php echo !empty($result->top_3)?$result->top_3:0; ?>/<?php echo $result->total; ?></td>
                    <td type="general" style="mso-number-format:\@;"><?php echo !empty($result->top_5)?$result->top_5:0; ?>/<?php echo $result->total; ?></td>
                    <td type="general" style="mso-number-format:\@;"><?php echo !empty($result->top_10)?$result->top_10:0; ?>/<?php echo $result->total; ?></td>
                    <td type="general" style="mso-number-format:\@;"><?php echo !empty($result->top_30)?$result->top_30:0; ?>/<?php echo $result->total; ?></td>
                    <td type="general" style="mso-number-format:\@;"><?php echo !empty($result->top_100)?$result->top_100:0; ?>/<?php echo $result->total; ?></td>
                    <td type="general"><?php echo date("d/m/Y",$item->changed); ?></td>
                </tr>
                <?php $stt++; endforeach; ?>
        <?php endif; ?>

        </tbody>
    </table>
    <?php
}
function cassiopeia_create_backlink_projects(){
    global $user;

//    _print_r($projects);
    module_load_include('inc', 'phpexcel');
    $data = array();
    $headers = array(
        "STT",
        "Tên dự án",
        "Website",
        "Số lượng Backlink",
        "Số lượng Domain",
        "Tỷ lệ Google Index",
        "Tỷ lệ dofollow",
        "Ngày cập nhật",
    );
    $parent = null;
    $stt = 1;

    try{
        $domain_query = db_select("tbl_backlink","tbl_backlink");
        $domain_query->fields("tbl_backlink",array("domain","pid","_domain"));
        $domain_query->orderBy("tbl_backlink.created","DESC");
        $domain_query->groupBy("tbl_backlink.pid");
        $domain_query->addExpression("COUNT(DISTINCT _domain)","count_domain");
        $domain_query->condition("tbl_backlink.uid",$user->uid);
        $domain_query->condition("tbl_backlink.pid",$_REQUEST['nid'],"IN");

        $_domain_query = db_select($domain_query,"tbl_domain_query");
        $_domain_query->fields("tbl_domain_query");
        $_domain_query->addExpression("SUM(tbl_domain_query.count_domain)","total_domain");
        $_domain_query->groupBy("tbl_domain_query.pid");
        $_domain_query->condition("tbl_domain_query.pid",$_REQUEST['nid'],"IN");
//
        $query = db_select("node","tbl_node");;
        $query->fields("tbl_node");
        $query->condition("tbl_node.type","project_backlink");
        $query->condition("tbl_node.uid",$user->uid);
        $query->orderBy("tbl_node.changed","DESC");
        $query->condition("tbl_node.nid",$_REQUEST['nid'],"IN");

        $backlink_count_query = db_select("tbl_backlink","tbl_backlink");
        $backlink_count_query->fields("tbl_backlink");
        $backlink_count_query->condition("tbl_backlink.uid",$user->uid);
        $backlink_count_query->condition("tbl_backlink.pid",$_REQUEST['nid'],"IN");
        $backlink_count_query->leftJoin("tbl_backlink_detail","tbl_backlink_detail","tbl_backlink_detail.nid=tbl_backlink.id");
        $backlink_count_query->addExpression("SUM(CASE WHEN tbl_backlink_detail.rel='dofollow' THEN 1 ELSE 0 END)","total_dofollow");
//
        $backlink_count_query->addExpression("CASE WHEN tbl_backlink.indexed=1 THEN 1 ELSE 0 END","total_indexed");
//
        $backlink_count_query->addExpression("COUNT(DISTINCT(tbl_backlink_detail.id))","totalBacklink");
        $backlink_count_query->groupBy("tbl_backlink.id");
        $backlink_count_query->addExpression("COUNT(DISTINCT(tbl_backlink.id))","totalSource");
//    $backlink_count_query->range(0,5000);

        $backlink_count_query_sub = db_select($backlink_count_query,"tbl");

        $backlink_count_query_sub->addExpression("SUM(tbl.totalBacklink)","totalBacklink");
        $backlink_count_query_sub->addExpression("SUM(tbl.total_indexed)","totalIndex");
        $backlink_count_query_sub->addExpression("SUM(tbl.total_dofollow)","totalDofollow");
        $backlink_count_query_sub->addExpression("SUM(tbl.totalSource)","totalSource");
        $backlink_count_query_sub->fields("tbl",array("pid","id"));
        $backlink_count_query_sub->groupBy("tbl.pid");


        $query->leftJoin($backlink_count_query_sub,"tbl_backlink_count_sub_query","tbl_backlink_count_sub_query.pid=tbl_node.nid");
        $query->fields("tbl_backlink_count_sub_query");

        $query->leftJoin($_domain_query,"tbl_domain_query","tbl_domain_query.pid=tbl_node.nid");
        $query->fields("tbl_domain_query");

        $query->join("field_data_field_domain","field_domain","field_domain.entity_id=tbl_node.nid");
        $query->addField("field_domain","field_domain_value","project_domain");
//    $query->range(0,10);
        $result = $query->execute()->fetchAll();
//        _print_r($result);
    }catch (Exception $e){
        _print_r($e);
    }
    if(!empty($result)){
        foreach($result as $item){
            $totalSource = !empty($item->totalSource)?round(100*$item->totalIndex/$item->totalSource)."%":"-";
            $totalBacklink = !empty($item->totalBacklink)?round(100*$item->totalDofollow/$item->totalBacklink)."%":"-";
            $data[] = array(
                $stt,
                $item->title,
                $item->project_domain,
                $item->totalBacklink,
                $item->total_domain,
                $totalSource,
                $totalBacklink,
                date("d/m/Y",$item->changed),
            );
            $stt++;
        }
    }
    // Store the file in sites/default/files
    $dir = file_stream_wrapper_get_instance_by_uri('public://')->realpath();
    $filename =  'export_'.date('d_m_Y_H_i', REQUEST_TIME).'.xlsx';
    $path = "$dir/$filename";

    // Use the .xls format
    $options = array('format' => 'xlsx');
//    _print_r(123);
    $result = phpexcel_export($headers, $data, $path, $options);
    _print_r($result);
    _print_r(PHPEXCEL_SUCCESS);
    if ($result == PHPEXCEL_SUCCESS) {
        // notify to admin
        drupal_set_message(t("Ok"));
        return array('name'=>$filename,'uri'=>'public://'.$filename,'golf'=>$parent);
    }
    else {
        drupal_set_message($result, 'error');
        return null;
    }
}
function cassiopeia_export_backlink_projects(){

    global $user;

    $filename = "backlinks".REQUEST_TIME;
    drupal_add_http_header('Content-Type', 'application/vnd.ms-excel; charset=utf-8');
    drupal_add_http_header('Content-Disposition', 'attachment; filename=' . $filename . '.xls');
    print("\xEF\xBB\xBF"); // UTF-8 BOM
    $conditions = array();
    $conditions['created'] = array(
        "type"      => "propertyOrderBy",
        "direction" => "DESC",
    );
    if(!empty($_REQUEST['nid'])){
        $conditions['nid'] = array(
            "type"      => "propertyCondition",
            "value"     => $_REQUEST['nid'],
            "condition" => "IN"
        );
    }
    $conditions['uid'] = array(
        "type"      => "propertyCondition",
        "value"     => $user->uid,
        "condition" => "=",
    );
    $projects = cassiopeia_get_items_by_conditions($conditions,"project_backlink","node");

    ?>
    <table class="table table-striped table-div-responsive table-type-2" border="1">
        <thead>
        <tr>
            <th class="text-left sorting sorting_desc">STT</th>
            <th class="text-left sorting sorting_desc">Tên dự án</th>
            <th class="text-left sorting sorting_desc">Website</th>
            <th class="w-8 sorting sorting_desc">Số lượng Backlink</th>
            <th class="w-8 sorting sorting_desc">Số lượng Domain</th>
            <th class="w-8 sorting sorting_desc">Tỷ lệ Google Index</th>
            <th class="w-7 sorting sorting_desc">Tỷ lệ dofollow</th>
            <th class="sorting sorting_desc">Ngày cập nhật</th>
        </tr>
        </thead>
        <tbody class="">
        <?php if(!empty($projects)): $stt=1;?>
            <?php foreach($projects as $item):  ?>
                <?php
                $result = null;
                try{
                    $query = db_select("tbl_backlink","tbl_backlink");
                    $query->fields("tbl_backlink");

                    $query->leftJoin("tbl_backlink_detail","tbl_backlink_detail","tbl_backlink_detail.nid=tbl_backlink.id");
                    $query->addExpression("SUM((CASE WHEN tbl_backlink_detail.rel='dofollow' THEN 1 ELSE 0 END))","total_dofollow");

                    $query->addExpression("SUM(DISTINCT(CASE WHEN tbl_backlink.indexed=1 THEN 1 ELSE 0 END))","total_indexed");

//                                    $query->addExpression("COUNT(tbl_backlink_detail.nid)","totalBacklink");
                    $query->addExpression("COUNT(DISTINCT(tbl_backlink_detail.id))","totalBacklink");
                    $query->addExpression("COUNT(DISTINCT(tbl_backlink.id))","totalSource");

                    $query->condition("tbl_backlink.pid",$item->nid);

                    $query->groupBy("tbl_backlink.id");
                    $sub = db_select($query,"tbl");

                    $sub->addExpression("SUM(tbl.totalBacklink)","totalBacklink");
                    $sub->addExpression("SUM(tbl.total_indexed)","totalIndex");
                    $sub->addExpression("SUM(tbl.total_dofollow)","totalDofollow");
                    $sub->addExpression("SUM(tbl.totalSource)","totalSource");
                    $result = $sub->execute()->fetchObject();

                    $query = db_select("tbl_backlink","tbl_backlink");
                    $query->fields("tbl_backlink");
                    $query->groupBy("tbl_backlink.domain");
//                                    $query->addExpression("COUNT(id)","TotalDomain");
                    $query->condition("pid",$item->nid);
                    $domainResult = $query->execute()->fetchAll();

//                                    _print_r($domainResult);
                    $squery = db_select("tbl_backlink","tbl_backlink");
                    $squery->fields("tbl_backlink",array("id"));
                    $squery->orderBy("tbl_backlink.created","DESC");

                    $squery->groupBy("tbl_backlink.domain");
                    $squery->condition("tbl_backlink.pid",$item->nid);

                    $domain = $squery->execute()->fetchAll();
                }catch (Exception $e){
                    cassiopeia_dump($e);
                }
                $_domain = str_replace("http://","",$item->field_domain['und'][0]['value']);
                $_domain = str_replace("https://","",$_domain);
                $_domain = str_replace("www","",$_domain);
                ?>
                <tr>
                    <td width="50px;">
                        <?php echo($stt); ?>
                    </td>
                    <td data-key="title" data-title="title" class="text-green text-left title">
                        <div class="d-flex space-between">
                            <a href="/quan-ly-backlink/du-an/<?php echo($item->nid); ?>" title="<?php echo($item->title); ?>" class="project-title">
                                <?php echo($item->title); ?>
                            </a>
                            <a href="/quan-ly-backlink/du-an/<?php echo($item->nid); ?>" title="<?php echo($item->title); ?>" target="_blank">
                                <i class="fa fa-external-link"></i>
                            </a>
                        </div>
                    </td>
                    <td data-key="domain" class="text-left text-blue">
                        <a target="_blank" rel="\" href="//<?php echo $_domain; ?>" title="<?php echo $item->field_domain['und'][0]['value']; ?>">
                            <?php echo $item->field_domain['und'][0]['value']; ?>
                        </a>
                    </td>
                    <td data-key="totalBacklink" ><?php echo $result->totalBacklink; ?></td>
                    <td data-key="totalDomain" ><?php echo count($domainResult); ?></td>
                    <td data-value="<?php if(!empty($result->totalSource)) echo !empty($result->totalIndex)?round(100*$result->totalIndex/$result->totalSource):0; ?>" data-key="googleIndex" ><?php if(!empty($result->totalSource)) echo !empty($result->totalIndex)?round(100*$result->totalIndex/$result->totalSource)."%":"-"; ?></td>
                    <td data-value="<?php echo !empty($result->totalBacklink)?round(100*$result->totalDofollow/$result->totalBacklink):0; ?>" data-key="dofollow" ><?php echo !empty($result->totalBacklink)?round(100*$result->totalDofollow/$result->totalBacklink)."%":"-"; ?></td>
                    <td data-value="<?php echo $item->changed ?>" data-key="created" ><?php echo date("d/m/Y",$item->changed); ?></td>
                </tr>
                <?php $stt++; endforeach; ?>
        <?php endif; ?>
        </tbody>
    </table>
    <?php
}
function cassiopeia_backlink_project_detail_export_page_callback_($rr,$pid=null){
    global $user;
    $filename = "backlinks";
    $projects = cassiopeia_get_items_by_conditions(array(),"project_backlink","node");
//    drupal_add_http_header('Content-Type', 'application/vnd.ms-excel; charset=utf-8');
//    drupal_add_http_header('Content-Disposition', 'attachment; filename=' . $filename . '.xls');
//    print("\xEF\xBB\xBF"); // UTF-8 BOM
    $stt=1;
    ?>
    <table border="1" class="table table-striped table-div-responsive table-type-2 table-responsive">
        <thead>
        <tr>
            <th class="w-3">STT</th>
            <th class="w-18">Nguồn đặt Backlink</th>
            <th>Thuộc tính</th>
            <th>AnchorText</th>
            <th>URL SEO</th>
            <th>GG Indexed</th>
            <th>Tag</th>
            <th>Ngày tạo</th>
            <th>Lỗi</th>
        </tr>
        </thead>
        <tbody class="result">
        <?php foreach($projects as $project): ?>
            <tr>
                <td rowspan="" colspan="9"><b style="font-size: 15"><?php echo $project->title; ?></b></td>
            </tr>
<!--            --><?php //if(!empty($backlinks)): ?>
                <?php
                try{
                    $query = db_select("node","tbl_node");
                    $query->fields("tbl_node");
                    $query->addField("tbl_node","nid","bid");
                    $query->condition("tbl_node.type","backlink");
                    if(!empty($nid)){
                        $query->condition("tbl_node.nid",$nid);
                    }
                    $query->join("field_data_field_backlink_project","field_backlink_project","field_backlink_project.entity_id=tbl_node.nid");
                    if(!empty($project->nid)){
                        $query->condition("field_backlink_project.field_backlink_project_nid",$project->nid);
                        $query->condition("field_backlink_project.entity_type","node");
                    }
                    $query->join("field_data_field_backlink_refer_page","field_backlink_refer_page","field_backlink_refer_page.entity_id=tbl_node.nid");
                    $query->addField("field_backlink_refer_page","field_backlink_refer_page_value","source");
                    $query->leftJoin("tbl_backlink_detail","tbl_backlink_detail","tbl_backlink_detail.nid=tbl_node.nid");
                    $query->fields("tbl_backlink_detail");
                    $query->leftJoin("field_data_field_backlink_indexed","field_backlink_indexed","field_backlink_indexed.entity_id=tbl_node.nid");
                    $query->addField("field_backlink_indexed","field_backlink_indexed_value","indexed");
                    $query->addExpression("DATE_FORMAT(FROM_UNIXTIME(tbl_node.changed), '%e/%m/%Y') ","date_created");
                    $query->addExpression("CASE WHEN tbl_backlink_detail.is_in_content is null THEN -1 ELSE tbl_backlink_detail.is_in_content END","is_in_content");
                    $query->addExpression("CASE WHEN tbl_backlink_detail.url is null THEN '-' ELSE tbl_backlink_detail.url END","url");
                    $query->addExpression("CASE WHEN tbl_backlink_detail.rel is null THEN '-' ELSE tbl_backlink_detail.rel END","rel");
                    $query->addExpression("CASE WHEN tbl_backlink_detail.anchor_text is null THEN '-' ELSE tbl_backlink_detail.anchor_text END","anchor_text");
                    $query->addExpression("COUNT(tbl_node.nid)","nid_count");
                    $query->groupBy("tbl_backlink_detail.id");
                    $query->orderBy("tbl_node.nid","DESC");
                    $sub = db_select("node","tbl_node");
                    $sub->condition("tbl_node.type","backlink");
                    $sub->fields("tbl_node");
                    $sub->leftJoin("field_data_field_tags","field_tags","field_tags.entity_id=tbl_node.nid");
                    $sub->leftJoin("taxonomy_term_data","taxonomy_term_data","taxonomy_term_data.tid=field_tags.field_tags_tid");
                    $sub->groupBy("tbl_node.nid");
                    $sub->addExpression("GROUP_CONCAT (taxonomy_term_data.name SEPARATOR ',' ) ","tags");
                    $sub->join("field_data_field_backlink_project","field_backlink_project","field_backlink_project.entity_id=tbl_node.nid");
                    $sub->condition("field_backlink_project.field_backlink_project_nid",$project->nid);
                    $query->leftJoin($sub,"tbl_sub","tbl_sub.nid=tbl_node.nid");
                    $query->addField("tbl_sub","tags","tags");
                    $query->leftJoin("field_data_field_status","field_status","field_status.entity_id=tbl_node.nid");
                    $query->addField("field_status","field_status_value","status");
                    $backlinks = $query->execute()->fetchAll();
                }catch (Exception $e){
                    cassiopeia_dump($e);
                }
                ?>
                <?php foreach($backlinks as $item): ?>
                    <?php
                    $index = $item->indexed==1?"Có":"Không";
                    switch ($item->status){
                        case "404" :
                            $errorCode = 404;
                            $errorMessage = "Nguồn đặt Backlink không tồn tại!";
                            // console.log("errorMessage",errorMessage);
                            break;
                        case "999" :
                            $errorCode = "error";
                            $errorMessage = "Nguồn đặt Backlink không hợp lệ!";
                            break;
                        case "500" :
                            $errorCode = 500;
                            $errorMessage = "Nguồn đặt Backlink không hoạt động!";
                            break;
                        default :
                            $errorMessage = "";
                            $errorCode = $item->status;
                    }
                    ?>
                    <tr>
                        <td><?php echo $stt; ?></td>
                        <td><?php echo $item->source; ?></td>
                        <!--                      <td></td>-->
                        <td><?php echo $item->rel; ?></td>
                        <td><?php echo $item->anchor_text; ?></td>
                        <td><?php echo $item->url; ?></td>
                        <td><?php echo $index; ?></td>
                        <td><?php echo !empty($item->tags)?$item->tags:""; ?></td>
                        <td><?php echo $item->date_created; ?></td>
                        <td><?php if($errorCode!=200) echo $errorCode; ?></td>
                    </tr>
                    <?php $stt++; endforeach; ?>
<!--            --><?php //endif; ?>
        <?php endforeach; ?>
        </tbody>
    </table>
    <?php
}
function cassiopeia_backlink_project_detail_export_page_callback($backlinks,$pid=null){
    global $user;
    try{

    }catch (Exception $e){
        cassiopeia_dump($e);
    }
    $project = node_load($pid);
    $stt = 1;
    $filename = $project->title."_backlinks";
    drupal_add_http_header('Content-Type', 'application/vnd.ms-excel; charset=utf-8');
    drupal_add_http_header('Content-Disposition', 'attachment; filename=' . $filename . '.xls');
    print("\xEF\xBB\xBF"); // UTF-8 BOM
    ?>
    <table border="1" class="table table-striped table-div-responsive table-type-2 table-responsive">
        <thead>
        <tr>
            <th class="w-3">STT</th>
            <th class="w-18">Nguồn đặt Backlink</th>
            <th>Thuộc tính</th>
            <th>AnchorText</th>
            <th>URL SEO</th>
            <th>GG Indexed</th>
            <th>Tag</th>
            <th>Ngày cập nhật</th>
            <th>Lỗi</th>
        </tr>
        </thead>
        <tbody class="result">
            <?php if(!empty($backlinks)): ?>
                <?php foreach($backlinks as $item): ?>
                    <?php
                    $index = $item->indexed==1?"Có":"Không";
                    switch ($item->status){
                        case "404" :
                            $errorCode = 404;
                            $errorMessage = "Nguồn đặt Backlink không tồn tại!";
                            // console.log("errorMessage",errorMessage);
                            break;
                        case "999" :
                            $errorCode = "error";
                            $errorMessage = "Nguồn đặt Backlink không hợp lệ!";
                            break;
                        case "500" :
                            $errorCode = 500;
                            $errorMessage = "Nguồn đặt Backlink không hoạt động!";
                            break;
                        case "RAW" :
                            $errorCode = "-";
                            $errorMessage = "Nguồn đặt Backlink không hoạt động!";
                            break;
                        default :
                            $errorMessage = "";
                            $errorCode = $item->status;
                    }
                    ?>
                  <tr>
                      <td><?php _echo($stt); ?></td>
                      <td><?php _echo($item->source); ?></td>
                      <td><?php _echo($item->rel); ?></td>
                      <td><?php _echo($item->anchor_text); ?></td>
                      <td><?php _echo($item->url); ?></td>
                      <td><?php _echo($index); ?></td>
                      <td><?php echo !empty($item->tags)?$item->tags:""; ?></td>
                      <td><?php _echo($item->date_created); ?></td>
                      <td><?php if($errorCode!=200) echo $errorCode; ?></td>
                  </tr>
                    <?php $stt++; endforeach; ?>
            <?php endif; ?>
        </tbody>
    </table>
    <?php
}
function cassiopeia_event_registration_export($result){
    global $user;
//    $data = json_decode($_REQUEST['data']);
//    $caches = (array)$data;
    $filename = "Bao-cao-xuat-ve-" . REQUEST_TIME;
    drupal_add_http_header('Content-Type', 'application/vnd.ms-excel; charset=utf-8');
    drupal_add_http_header('Content-Disposition', 'attachment; filename=' . $filename . '.xls');
    print("\xEF\xBB\xBF"); // UTF-8 BOM
    ?>
    <table>
        <thead>
        <tr>
            <td>Tôi là Độ nát</td>
        </tr>
        </thead>
        <tbody>
            <?php if(!empty($result)): ?>
                <?php foreach($result as $item): ?>
                    <tr>
                        <td><?php echo $item->title; ?></td>
                    </tr>
                <?php endforeach; ?>
            <?php endif; ?>
        </tbody>
    </table>
    <?php
//    die;
}
function cassiopeia_get_backlink_domain_report($cache){
   try{
       $sub_query = db_select("tbl_backlink","tbl_backlink");
       $sub_query->addField("tbl_backlink","id","bid");
//    $sub_query->condition("tbl_node.type","backlink");
//    $sub_query->join("field_data_field_domain","field_domain","field_domain.entity_id=tbl_node.nid");
//    $sub_query->join("field_data_field_backlink_project","field_backlink_project","field_backlink_project.entity_id=tbl_node.nid");
//    $sub_query->condition("field_backlink_project.entity_type","node");
       $sub_query->condition("tbl_backlink.pid",$cache['project']->nid);
       $sub_query->condition("tbl_backlink.created",array(strtotime(date("d-m-Y 00:00",strtotime($cache['from_date']))),strtotime(date("d-m-Y 23:59",strtotime($cache['to_date'])))),"BETWEEN");
//    $sub_query->addField("field_backlink_project","field_backlink_project_nid","pid");
       $sub_query->orderBy("tbl_backlink.id","DESC");

       $sub_query->groupBy("tbl_backlink.domain");
//    $sub_query->groupBy("tbl_backlink.id");
       $sub_query->addExpression("DATE_FORMAT(FROM_UNIXTIME(tbl_backlink.created), '%e %b %Y') ","cr");
//    $sub_query->addExpression("COUNT(tbl_backlink_detail.nid)","domain_count");
       $query = db_select($sub_query,"tbl_sub");
       $query->addExpression("COUNT(DISTINCT(tbl_sub.bid))","total_domain");
       $query->fields("tbl_sub");
//       $query->addExpression("SUM( tbl_sub.bid)","total_domain");
       $query->groupBy("cr");
       $domains = $query->execute()->fetchAll();
//       _print_r($domains);
   }catch (Exception $e){
       _print_r($e);
   }

//    _print_r($domains);
    return $domains;
}
function cassiopeia_get_backlink_project_report($cache){
    try{
        $sub_query = db_select("tbl_backlink","tbl_backlink");
//        $sub_query->fields("tbl_backlink",array(""));
//    $sub_query->condition("tbl_node.type","backlink");

//    $sub_query->join("field_data_field_backlink_project","field_backlink_project","field_backlink_project.entity_id=tbl_node.nid");
//    $sub_query->join("field_data_field_backlink_refer_page","field_backlink_refer_page","field_backlink_refer_page.entity_id=tbl_node.nid");
//    $sub_query->leftJoin("field_data_field_backlink_indexed","field_backlink_indexed","field_backlink_indexed.entity_id=tbl_node.nid");
        $sub_query->addField("tbl_backlink","id","nid");
        $sub_query->addField("tbl_backlink_detail","rel","rel");
        $sub_query->condition("tbl_backlink.pid",$cache['project']->nid);
        $sub_query->leftJoin("tbl_backlink_detail","tbl_backlink_detail","tbl_backlink_detail.nid=tbl_backlink.id");
        $sub_query->condition("tbl_backlink_detail.created",array(strtotime($cache['from_date']),strtotime($cache['to_date'])),"BETWEEN");
        $sub_query->orderBy("tbl_backlink.id","DESC");
        $sub_query->groupBy("tbl_backlink_detail.id");
        $sub_query->addExpression("COUNT(tbl_backlink_detail.nid)","backlink_count");
        $sub_query->addExpression("CASE WHEN (tbl_backlink.indexed = 1) THEN 0 ELSE 1 END","notIndex");
        $sub_query->addExpression("CASE WHEN (tbl_backlink.indexed = 1) THEN 1 ELSE 0 END","indexed");
        $sub_query->addExpression("CASE WHEN (tbl_backlink_detail.rel LIKE 'dofollow') THEN 1 ELSE 0 END","dofollow");
        $sub_query->addExpression("CASE WHEN (tbl_backlink_detail.rel LIKE '%ucg%') THEN 1 ELSE 0 END","ucg");
        $sub_query->addExpression("CASE WHEN (tbl_backlink_detail.rel LIKE '%sponsor%') THEN 1 ELSE 0 END","sponsor");
        $sub_query->addExpression("CASE WHEN (tbl_backlink_detail.rel LIKE '%nofollow%') THEN 1 ELSE 0 END","nofollow");
        $sub_query->addExpression("DATE_FORMAT(FROM_UNIXTIME(tbl_backlink.created), '%e %b %Y') ","cr");
        $query = db_select($sub_query,"tbl_sub");
        $query->fields("tbl_sub");
        $query->addExpression("COUNT(nid)","domain_count");
        $query->addExpression("SUM(indexed)","indexed");
        $query->addExpression("SUM(notIndex)","notIndex");
        $query->addExpression("SUM(backlink_count)","backLinkCount");
        $query->addExpression("SUM(dofollow)","dofollowCount");
        $query->addExpression("SUM(sponsor)","sponsorCount");
        $query->addExpression("SUM(nofollow)","nofollowCount");
        $query->addExpression("SUM(ucg)","ucgCount");
        $query->groupBy("cr");
        $_backlinks = $query->execute()->fetchAll();
//        _print_r($_backlinks);
    }catch (Exception $e){
        _print_r($e);
    }
    return $_backlinks;
}
function cassiopeia_get_keyword_by_conditions($conditions){
    $sub_query = db_select("node","tbl_node");
    $sub_query->fields("tbl_node");
    $sub_query->condition("tbl_node.type","keyword");
    $sub_query->join("field_data_field_keyword_project","field_keyword_project","field_keyword_project.entity_id=tbl_node.nid");
    $sub_query->condition("field_keyword_project.field_keyword_project_nid",$conditions['project']->nid);
    $sub_query->addExpression("COUNT(tbl_node.nid)","TotalKeyword");
    $sub_query->addExpression("DATE_FORMAT(FROM_UNIXTIME(tbl_node.created), '%e %b %Y') ","cr");
    $result = $sub_query->execute()->fetchAll();
    return $result;
}
function cassiopeia_get_backlink_children($nid){
    $query = db_select("tbl_backlink","tbl_backlink");
    $query->fields("tbl_backlink");
    $query->addField("tbl_backlink","id","bid");
    $query->condition("tbl_backlink.id",$nid);
    $query->addField("tbl_backlink","refer_page","source");
    $query->groupBy("tbl_backlink_detail.id");
    $query->leftJoin("tbl_backlink_detail","tbl_backlink_detail","tbl_backlink_detail.nid=tbl_backlink.id");
    $query->fields("tbl_backlink_detail");

    $query->addExpression("DATE_FORMAT(FROM_UNIXTIME(tbl_backlink.created), '%e/%m/%Y') ","date_created");
    $query->addExpression("CASE WHEN tbl_backlink_detail.is_in_content is null THEN -1 ELSE tbl_backlink_detail.is_in_content END","is_in_content");
    $query->addExpression("CASE WHEN tbl_backlink_detail.url is null THEN '-' ELSE tbl_backlink_detail.url END","url");
    $query->addExpression("CASE WHEN tbl_backlink_detail.rel is null THEN '-' ELSE tbl_backlink_detail.rel END","rel");
    $query->addExpression("CASE WHEN tbl_backlink_detail.anchor_text is null THEN '-' ELSE tbl_backlink_detail.anchor_text END","anchor_text");
    $query->addExpression("COUNT(tbl_backlink.id)","nid_count");
//    $query->groupBy("tbl_node.nid");
    $query->orderBy("tbl_backlink.id","DESC");
    $sub = db_select("tbl_backlink","tbl_backlink");
//    $sub->condition("tbl_node.type","backlink");
    $sub->fields("tbl_backlink");
    $sub->leftJoin("tbl_tags","tbl_tags","tbl_tags.nid=tbl_backlink.id");
    $sub->leftJoin("taxonomy_term_data","taxonomy_term_data","taxonomy_term_data.tid=tbl_tags.tid");
    $sub->groupBy("tbl_backlink.id");
    $sub->addExpression("GROUP_CONCAT (taxonomy_term_data.name SEPARATOR ',' ) ","tags");
    $sub->condition("tbl_backlink.id",$nid);
    $query->join($sub,"tbl_sub","tbl_sub.id=tbl_backlink.id");
    $query->addField("tbl_sub","tags","tags");
//    $query->leftJoin("field_data_field_status","field_status","field_status.entity_id=tbl_backlink.id");
//    $query->addField("field_status","field_status_value","status");
    $result = $query->execute()->fetchAll();
//    _print_r($result);
    return $result;
}
function cassiopeia_get_backlinks($conditions=array()){
    try{
        $query = db_select("tbl_backlink","tbl_backlink");
        $query->fields("tbl_backlink");
            $query->addField("tbl_backlink","id","bid");
        if(!empty($conditions['pid'])){
            $query->condition("tbl_backlink.pid",$conditions['pid']);
        }
        if(!empty($conditions['nid'])){
            $query->condition("tbl_backlink.id",$conditions['nid']);
        }
        $query->addField("tbl_backlink","refer_page","source");
        $query->addField("tbl_backlink","indexed","indexed");
        $query->addExpression("DATE_FORMAT(FROM_UNIXTIME(tbl_backlink.changed), '%e/%m/%Y') ","date_created");
        $query->addExpression("COUNT(tbl_backlink.id)","nid_count");
        $query->leftJoin("tbl_backlink_detail","tbl_backlink_detail","tbl_backlink_detail.nid=tbl_backlink.id");
        $query->fields("tbl_backlink_detail");

        $query->addExpression("CASE WHEN tbl_backlink_detail.is_in_content is null THEN -1 ELSE tbl_backlink_detail.is_in_content END","is_in_content");
        $query->addExpression("CASE WHEN tbl_backlink_detail.url is null THEN '-' ELSE tbl_backlink_detail.url END","url");
        $query->addExpression("CASE WHEN tbl_backlink_detail.rel is null THEN '-' ELSE tbl_backlink_detail.rel END","rel");
        $query->addExpression("CASE WHEN tbl_backlink_detail.anchor_text is null THEN '-' ELSE tbl_backlink_detail.anchor_text END","anchor_text");
        $query->groupBy("tbl_backlink.id");

        $sub = db_select("tbl_backlink","tbl_backlink");
        $sub->fields("tbl_backlink");
        $sub->join("tbl_tags","tbl_tags","tbl_tags.nid=tbl_backlink.id");
        $sub->join("taxonomy_term_data","taxonomy_term_data","taxonomy_term_data.tid=tbl_tags.tid");
        $sub->groupBy("tbl_backlink.id");
        $sub->addExpression("GROUP_CONCAT (taxonomy_term_data.name SEPARATOR ',' ) ","tags");
        $sub->addExpression("tbl_backlink.status","b_status");
        if(!empty($conditions['pid'])){
            $sub->condition("tbl_backlink.pid",$conditions['pid']);
        }
        if(!empty($conditions['nid'])){
            $sub->condition("tbl_backlink.id",$conditions['nid']);
        }

        $query->leftJoin($sub,"tbl_sub","tbl_sub.id=tbl_backlink.id");
        $query->addField("tbl_sub","tags","tags");
        $query->addField("tbl_sub","b_status","b_status");
        $query->addField("tbl_backlink_detail","changed","b_changed");

        if(!empty($conditions['sort'])){
            switch ($conditions['sort']){
                case "refer-page" :
                    $query->orderBy("tbl_backlink.refer_page",$conditions['direction']);
                    break;
                case "rel" :
                    $query->orderBy("rel",$conditions['direction']);
                    break;
                case "anchor-text" :
                    $query->orderBy("anchor_text",$conditions['direction']);
                    break;
                case "url" :
                    $query->orderBy("url",$conditions['direction']);
                    break;
                case "indexed" :
                    $query->orderBy("tbl_backlink.indexed",$conditions['direction']);
                    break;
                case "created" :
                    $query->orderBy("tbl_backlink.created",$conditions['direction']);
                    break;
                case "status" :
                    $query->orderBy("tbl_backlink.status",$conditions['direction']);
                    break;
                case "tag" :
                    $query->orderBy("tbl_sub.tags",$conditions['direction']);
                    break;
                case "changed" :
                    $query->orderBy("tbl_backlink.changed",$conditions['direction']);
                    break;
                default:
                    $query->orderBy("tbl_backlink.changed",'DESC');
                    break;
            }
        }

        if(!empty($conditions['from_date'])){
            $query->condition("tbl_backlink.changed",strtotime(date("d-m-Y 00:00",strtotime($conditions['from_date']))),">=");;
        }
        if(!empty($conditions['to_date'])){
            $query->condition("tbl_backlink.changed",strtotime(date("d-m-Y 23:59",strtotime($conditions['to_date']))),"<=");;
        }
        if(!empty($conditions['tag']) && $conditions['tag']!="all"){
            $query->join("tbl_tags","tbl_tags","tbl_tags.nid=tbl_backlink.id");
            $query->condition("tbl_tags.tid",$conditions['tag']);
        }
        if(!empty($conditions['option'])){
            switch ($conditions['option']){
                case "total-dofollow" :
                    $query->condition("rel","dofollow");
                    break;
                case "total-indexed" :
                    $query->condition("tbl_backlink.indexed","1");
                    break;
            }
        }
        if(isset($conditions['indexed']) && $conditions['indexed']!="all"){
            if($conditions['indexed']==2){
                $query->condition("tbl_backlink.changed",strtotime(date("d-m-Y 00:00:00",REQUEST_TIME)),"<=");;
//                $query->condition("tbl_backlink.changed",strtotime(date("d-m-Y 00:00:00",REQUEST_TIME)),"=");;
            }elseif($conditions['indexed']==3){
                $query->condition("tbl_backlink.indexed",2);
            }else{
                $query->condition("tbl_backlink.indexed",$conditions['indexed']);
            }
        }
        if(isset($conditions['status']) && $conditions['status']!="all"){
            if($conditions['status']==200){
                $query->condition("tbl_backlink.status",200);
                $query->condition("tbl_backlink_detail.id",0,">");
            }elseif($conditions['status']=="RAW"){
                $query->condition("tbl_backlink.status","RAW");
            }else{
                $query->condition("tbl_backlink.status",array("RAW",200),"NOT IN");
            }
        }
        $result = $query->execute()->fetchAll();
//        _print_r($result);
        $_result = array();

        if(!empty($result)){
            foreach($result as $value){
                if(!empty($_SESSION['CheckBacklinkData'])){
                    if(array_key_exists($value->bid,$_SESSION['CheckBacklinkData'])){
                        $value->checked = 1;
                    }
                }
              $value->tels = "";
                if(user_has_role(3)){
                  $tel_query = db_select("cassiopeia_backlink_tel","cassiopeia_backlink_tel")->fields("cassiopeia_backlink_tel")->condition("bid",$value->bid);
                  $tels = $tel_query->execute()->fetchAll();
                  if(!empty($tels)){
                    $_tels = array();
                    foreach($tels as $tel){
                      $_tels[] = $tel->tel;
                    }
                    $value->tels = implode(", ",$_tels);
                  }
                  $value->admin = 1;
                }
                $_result[] = $value;
            }
        }
    }catch (Exception $e){
        cassiopeia_dump($e);
    }
    return $_result;
}
function cassiopeia_get_backlinks_by_pid($pid,$nid=null){
  try{
      $query = db_select("tbl_backlink","tbl_backlink");
      $query->fields("tbl_backlink");
      $query->addField("tbl_backlink","id","bid");
//      $query->condition("tbl_node.type","backlink");
      if(!empty($nid)){
          $query->condition("tbl_backlink.id",$nid);
      }
//      $query->join("field_data_field_backlink_project","field_backlink_project","field_backlink_project.entity_id=tbl_node.nid");
      if(!empty($pid)){
          $query->condition("tbl_backlink.pid",$pid);
//          $query->condition("field_backlink_project.entity_type","node");
      }
//      $query->join("field_data_field_backlink_refer_page","field_backlink_refer_page","field_backlink_refer_page.entity_id=tbl_node.nid");
      $query->addField("tbl_backlink","refer_page","source");
      $query->leftJoin("tbl_backlink_detail","tbl_backlink_detail","tbl_backlink_detail.nid=tbl_backlink.id");
      $query->fields("tbl_backlink_detail");
//      $query->leftJoin("field_data_field_backlink_indexed","field_backlink_indexed","field_backlink_indexed.entity_id=tbl_node.nid");
      $query->addField("tbl_backlink","indexed","indexed");
      $query->addExpression("DATE_FORMAT(FROM_UNIXTIME(tbl_backlink.changed), '%e/%m/%Y') ","date_created");
      $query->addExpression("CASE WHEN tbl_backlink_detail.is_in_content is null THEN -1 ELSE tbl_backlink_detail.is_in_content END","is_in_content");
      $query->addExpression("CASE WHEN tbl_backlink_detail.url is null THEN '-' ELSE tbl_backlink_detail.url END","url");
      $query->addExpression("CASE WHEN tbl_backlink_detail.rel is null THEN '-' ELSE tbl_backlink_detail.rel END","rel");
      $query->addExpression("CASE WHEN tbl_backlink_detail.anchor_text is null THEN '-' ELSE tbl_backlink_detail.anchor_text END","anchor_text");
      $query->addExpression("COUNT(tbl_backlink.id)","nid_count");
      $query->groupBy("tbl_backlink.id");
      $query->orderBy("tbl_backlink.id","DESC");

      $sub = db_select("tbl_backlink","tbl_backlink");
      $sub->fields("tbl_backlink");
      $sub->leftJoin("tbl_tags","tbl_tags","tbl_tags.nid=tbl_backlink.id");
      $sub->leftJoin("taxonomy_term_data","taxonomy_term_data","taxonomy_term_data.tid=tbl_tags.tid");
//      $sub->leftJoin("taxonomy_term_data","taxonomy_term_data","taxonomy_term_data.tid=field_tags.field_tags_tid");
      $sub->groupBy("tbl_backlink.id");
      $sub->addExpression("GROUP_CONCAT (taxonomy_term_data.name SEPARATOR ',' ) ","tags");
//      $sub->join("field_data_field_backlink_project","field_backlink_project","field_backlink_project.entity_id=tbl_backlink.id");
      if(!empty($pid)){
          $sub->condition("tbl_backlink.pid",$pid);
      }
      $query->leftJoin($sub,"tbl_sub","tbl_sub.id=tbl_backlink.id");
      $query->addField("tbl_sub","tags","tags");
      $query->addField("tbl_backlink_detail","changed","b_changed");
//      $query->leftJoin("field_data_field_status","field_status","field_status.entity_id=tbl_node.nid");
      $query->addField("tbl_backlink","status","status");
      $result = $query->execute()->fetchAll();
  }catch (Exception $e){
      cassiopeia_dump($e);
  }
    return $result;
}
function cassiopeia_form_product_node_form_alter(&$form,&$form_state){
//    _print_r($form);

    unset($form['actions']['preview']);
    unset($form['field_p_default']);
    if(!empty($form['#node']->nid)){

        $query = db_select("tbl_product_price","tbl_product_price");
        $query->fields("tbl_product_price");
        $query->condition("nid",$form['#node']->nid);
        $result = $query->execute()->fetchAll();
        if (empty($result)) {
            $result = array(0 => array());
        }
        $form_state['PriceList'] = !empty($form_state['PriceList']) ? $form_state['PriceList'] : $result;
        if($form['#node']->nid==BASIC || $form['#node']->nid==AGENCY){
            unset($form['actions']['delete']);
        }
        if($form['#node']->nid==AGENCY || $form['#node']->nid==BASIC){
            $form_state['PriceList'] = array();
        }
    }else{
        $form_state['PriceList'] = !empty($form_state['PriceList']) ? $form_state['PriceList'] : array(0 => array());
    }
    if(!empty($form['#node']->nid) && ($form['#node']->nid!=AGENCY && $form['#node']->nid!=BASIC)){
        $form['ProductPrice'] = array(
            '#type' => 'container',
            '#prefix' => '<div id="ProductPriceContainer"><label for="">Giá gói</label>',
            '#suffix' => '</div>',
        );
    }
    foreach ($form_state['PriceList'] as $key => $value) {
        $form['ProductPrice']['ProductPriceGroup_' . $key] = array(
            '#type' => 'container',
            '#prefix' => '<div id="ProductPriceGroup" class="product-price-group">',
            '#suffix' => '</div>',
        );
        $form['ProductPrice']['ProductPriceGroup_' . $key]['ProductPriceMonth_' . $key] = array(
            '#type' => 'textfield',
            '#title' => t('Số tháng '),
            '#required' => FALSE,
            '#default_value' => !empty($value) ? $value->month : 3,
        );
        $form['ProductPrice']['ProductPriceGroup_' . $key]['ProductPriceValue_' . $key] = array(
            '#type' => 'textfield',
            '#title' => t('Giá'),
            '#required' => FALSE,
            '#default_value' => !empty($value) ? $value->price : 0,
        );
        $form['ProductPrice']['ProductPriceGroup_' . $key]['ProductPriceGroupRemove_' . $key] = array(
            '#type' => 'submit',
            '#submit' => array('cassiopeia_remove_room_price_remove_one'),
            '#text' => '<span class="icon glyphicon glyphicon-trash" aria-hidden="true"></span>',
            '#value' => 'ProductPriceGroupRemove_' . $key,
            '#attributes' => array(
                'class' => array('close teaProductPriceItemRemove'), // insert space before attribute name :)
            ),
            '#ajax' => array(
                'callback' => 'cassiopeia_remove_room_price_ajax_callback',
                'wrapper' => 'ProductPriceContainer',
                'method' => 'replace',
                'effect' => 'fade',
            ),
        );
    }
    if(!empty($form['#node']->nid) && ($form['#node']->nid!=AGENCY && $form['#node']->nid!=BASIC)){
        $form['ProductPrice']['price_addMore'] = array(
            '#type' => 'submit',
            '#submit' => array('cassiopeia_add_room_price_add_one'),
            '#value' => 'Thêm giá',
            '#text' => '<span class="icon glyphicon glyphicon-plus" ></span> ',
            '#attributes' => array(
                'class' => array('btn close teaTimeAddMore'),
                'type' => 'button',
            ),
            '#ajax' => array(
                'callback' => 'cassiopeia_add_room_price_ajax_callback',
                'wrapper' => 'ProductPriceContainer',
                'method' => 'replace',
                'effect' => 'fade',
            ),
        );
    }

    $form['#submit'][] = "cassiopeia_form_product_node_form_alter_submit";
    return $form;
}
function cassiopeia_form_product_node_form_alter_submit(&$form, &$form_state){
    $form_state['values']['productPriceCount'] = count($form_state['PriceList']);
}
function cassiopeia_add_room_price_add_one(&$form, &$form_state)
{
    $form_state['PriceList'][] = array();
    drupal_get_messages();
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_add_room_price_ajax_callback($form, &$form_state)
{
    return $form['ProductPrice'];
}
function cassiopeia_node_insert($node)
{
    if ($node->type == "product") {
        $db_transaction = db_transaction();
        try {
            if (!empty($node->productPriceCount)) {
                for ($i = 0; $i < $node->productPriceCount; $i++) {
                    $ProductPriceMonth_ = "ProductPriceMonth_" . $i;
                    $ProductPriceValue_ = "ProductPriceValue_" . $i;
                    db_insert("tbl_product_price")->fields(array(
                        "created" => REQUEST_TIME,
                        "nid" => $node->nid,
                        "month" => $ProductPriceMonth_,
                        "price" => $ProductPriceValue_,
                    ))->execute();
                }
            }
        } catch (Exception $e) {
            $db_transaction->rollback();
        }
    } elseif ($node->type == "hotel") {

    }
}
function cassiopeia_node_presave($node){
//    _print_r($node);
//    die;
    if ($node->type == "product") {
        if (empty($node->is_new)) {
            db_delete("tbl_product_price")->condition("nid", $node->nid)->execute();
            $db_transaction = db_transaction();
            try {
                if (!empty($node->productPriceCount)) {
                    for ($i = 0; $i < $node->productPriceCount; $i++) {
                        $ProductPriceMonth_ = "ProductPriceMonth_" . $i;
                        $ProductPriceValue_ = "ProductPriceValue_" . $i;

                        db_insert("tbl_product_price")->fields(array(
                            "created" => REQUEST_TIME,
                            "nid" => $node->nid,
                            "month" => $node->$ProductPriceMonth_,
                            "price" => $node->$ProductPriceValue_,
                        ))->execute();
                    }
                }
            } catch (Exception $e) {
//                _print_r($e);
//                die;
                $db_transaction->rollback();
            }
        }
    } elseif ($node->type == "hotel") {

    }
}
function cassiopeia_speech_page_callback () {
    global  $user;
    global  $base_url;
    $query = db_select("tbl_witai_config","tbl_witai_config");
    $query->fields("tbl_witai_config");
    $result = $query->execute()->fetchAll();
    $accounts = array();
    if(!empty($result)){
        $index=0;
        foreach($result as $item){
            $accounts[$index] = $item;
            $index++;
        }
    }
    if(!empty($accounts)){
        $key = array_rand($accounts,1);
        $active = $accounts[$key];
    }
    $data = array();
    if(!empty($active)){

        $data['message'] = null;
        $audio = file_get_contents('php://input');
        //Test data form wit.ai
        //$audio = file_get_contents('https://t4t.vn/sites/default/files/audio.mp3');
        if(!empty($audio)) {
            $request = curl_init('https://api.wit.ai/speech?v='.$active->version);
            $headers[] = $active->account;
//    $headers[] = 'Transfer-encoding: chunked';
//    $headers[] = 'Connection: keep-alive';
            $headers[] = 'Content-Type: audio/mpeg3';
            curl_setopt($request, CURLOPT_CUSTOMREQUEST, "POST");
            curl_setopt($request, CURLOPT_POSTFIELDS, $audio);
            curl_setopt($request, CURLOPT_HTTPHEADER, $headers);
            curl_setopt($request, CURLOPT_RETURNTRANSFER, true);
            $result = curl_exec($request);
            if(!empty($result)) {
//            if($convert) {
//                $data['message'] =json_decode($result, true);
//            }else {
                $result = preg_replace('~[\r\n]+~', '', $result);
                $result = str_replace('}{', '},{', $result);
                $result = '['.$result.']';
                $arr = json_decode($result, true);
                $data['message'] =  end($arr);
//            }
            }
            curl_close($request);
        }
    }else{
        $data['Tài khoản WitAI không đúng!'];
    }

    return $data;
}
function cassiopeia_remove_room_price_remove_one(&$form, &$form_state)
{
    $delta_remove = !empty($form_state['values']['op']) ? $form_state['values']['op'] : null;
    $delta_remove_array = !empty($delta_remove) ? explode('_', $delta_remove) : null;
    $childIndex = $delta_remove_array[1];
    unset($form_state['PriceList'][$childIndex]);
    $temp = array();
    foreach ($form_state['PriceList'] as $item) {
        $temp[] = $item;
    }
    $form_state['PriceList'] = $temp;
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_remove_room_price_ajax_callback($form, &$form_state)
{
    return $form['ProductPrice'];
}
function cassiopeia_get_users_by_roles($roles = array(),$excludes = array()){
    $query = db_select("users","tbl_user");
    $query->fields("tbl_user");
    $query->join("users_roles","tbl_role","tbl_role.uid=tbl_user.uid");
    $query->leftJoin("field_data_field_full_name","field_full_name","field_full_name.entity_id=tbl_user.uid");
    $query->addField("field_full_name","field_full_name_value","full_name");
    if(!empty($roles)){
        $query->condition("tbl_role.rid",$roles,"IN");
    }
    if(!empty($excludes)){
        $query->condition("tbl_role.rid",$excludes,"NOT IN");
    }
    $query->orderBy("tbl_user.created","DESC");
    $users = $query->execute()->fetchAll();
    return (array)$users;
}
function _echo($value){
    echo !empty($value)?$value:"";
}
function cassiopeia_user_change_packet_form($form,&$form_state,$account){
    $packet = cassiopeia_get_available_packet_by_uid($account->uid);
//    _print_r($packet);
    $form = array();
    $_product = !empty($packet->product)?node_load($packet->product):null;
    $products = cassiopeia_get_nodes_by_category("product");
    $product_options = array();
    foreach($products as $product){
        $product_options[$product->nid] = $product->title;
    }
    $form['#uid'] = $account->uid;
    $form['product'] = array(
        '#type'             => 'radios',
        '#title'            => t('Gói'),
        '#default_value'    => !empty($packet) ? $packet->product : 0,
        '#options'          => $product_options,
        '#ajax'     => array(
            'callback' => 'cassiopeia_user_change_packet_form_change_product',
            'wrapper' => 'formContainer',
            'method' => 'replace',
            'effect' => 'fade',
        )
    );
    $form['_container'] = array(
        '#type' => 'container',
        '#attributes' => array(
            'id' => "formContainer",
        ),
    );
    if(!empty($form_state['values']['product'])){
        $_product = node_load($form_state['values']['product']);
    }
    $form['_container']['backlink_project'] = array(
        '#type'             => 'textfield',
        '#title'            => t('Dự án backlink'),
        '#default_value'    => !empty($packet) ? $packet->backlink_project : 0,
        '#size'             => 60,
        '#maxlength'        => 128,
        '#required'         => TRUE,
    );
    $form['_container']['backlink'] = array(
        '#type'             => 'textfield',
        '#title'            => t('Backlink'),
        '#default_value'    => !empty($packet) ? $packet->check_backlink : 0,
        '#size'             => 60,
        '#maxlength'        => 128,
        '#required'         => TRUE,
    );
    $form['_container']['indexed'] = array(
        '#type'             => 'textfield',
        '#title'            => t('Google Index'),
        '#default_value'    => !empty($packet) ? $packet->indexed_google :0,
        '#size'             => 60,
        '#maxlength'        => 128,
        '#required'         => TRUE,
    );
    $form['_container']['key_project'] = array(
        '#type'             => 'textfield',
        '#title'            => t('Dự án từ khóa'),
        '#default_value'    => !empty($packet) ? $packet->key_project : 0,
        '#size'             => 60,
        '#maxlength'        => 128,
        '#required'         => TRUE,
    );
    $form['_container']['key_search'] = array(
        '#type'             => 'textfield',
        '#title'            => t('Kiểm tra thứ hạng từ khóa'),
        '#default_value'    => !empty($packet) ? $packet->key_search : 0,
        '#size'             => 60,
        '#maxlength'        => 128,
        '#required'         => TRUE,
    );
    $form['_container']['content_project'] = array(
        '#type'             => 'textfield',
        '#title'            => t('Dự án Outline Content'),
        '#default_value'    => !empty($packet) ? $packet->content_project : 0,
        '#size'             => 60,
        '#maxlength'        => 128,
        '#required'         => TRUE,
    );
    $form['_container']['content_check'] = array(
        '#type'             => 'textfield',
        '#title'            => t('Kiểm tra Outline Content'),
        '#default_value'    => !empty($packet) ? $packet->content_check : 0,
        '#size'             => 60,
        '#maxlength'        => 128,
        '#required'         => TRUE,
    );
    $form['_container']['content_article'] = array(
        '#type'             => 'textfield',
        '#title'            => t('Số bài viết Outline Content'),
        '#default_value'    => !empty($packet) ? $packet->content_article : 0,
        '#size'             => 60,
        '#maxlength'        => 128,
        '#required'         => TRUE,
    );
    $form['_container']['content_duplicate'] = array(
        '#type'             => 'textfield',
        '#title'            => t('Trùng lặp nội dung'),
        '#default_value'    => !empty($packet) ? $packet->content_duplicate :0,
        '#size'             => 60,
        '#maxlength'        => 128,
        '#required'         => TRUE,
    );
    $form['_container']['device'] = array(
        '#type'             => 'textfield',
        '#title'            => t('Thiết bị'),
        '#default_value'    => !empty($packet) ? $packet->device :0,
        '#size'             => 60,
        '#maxlength'        => 128,
        '#required'         => TRUE,
    );
    $form['_container']['excel'] = array(
        '#type' => 'checkbox',
        '#title' => t('Xuất excel.'),
        '#default_value'    => !empty($packet) ? $packet->excel :0,
    );
    if(!empty($_product) && $_product->nid==AGENCY){

    }else{
        $form['_container']['expired'] = array(
            '#type' => 'date_popup',
//        '#default_value'    => !empty($packet->expired) ? date("Y-m-d H:i",$packet->expired) :0,
            '#date_type' => DATE_DATETIME,
            '#date_timezone' => date_default_timezone(),
            '#date_format' => 'd-m-Y',
            '#date_increment' => 1,
            '#date_year_range' => '-10:+10',
        );
    }
//    _print_r($packet);
    if(!empty($packet) && !empty($packet->expired)){
        $form['_container']['expired']['#default_value'] = date("Y-m-d H:i",$packet->expired);
    }
    if(!empty($_product)){
        $form['_container']['backlink_project']['#value'] = !empty($_product->field_p_backlink_project['und'][0]['value'])?$_product->field_p_backlink_project['und'][0]['value']:0;
        $form['_container']['backlink']['#value'] = !empty($_product->field_p_backlink_check['und'][0]['value'])?$_product->field_p_backlink_check['und'][0]['value']:0;
        $form['_container']['indexed']['#value'] = !empty($_product->field_p_indexed_google['und'][0]['value'])?$_product->field_p_indexed_google['und'][0]['value']:0;
        $form['_container']['key_project']['#value'] = !empty($_product->field_p_key_project['und'][0]['value'])?$_product->field_p_key_project['und'][0]['value']:0;
        $form['_container']['key_search']['#value'] = !empty($_product->field_p_key_check['und'][0]['value'])?$_product->field_p_key_check['und'][0]['value']:0;
        $form['_container']['content_project']['#value'] = !empty($_product->field_p_content_project['und'][0]['value'])?$_product->field_p_content_project['und'][0]['value']:0;
        $form['_container']['content_check']['#value'] = !empty($_product->field_p_content_check['und'][0]['value'])?$_product->field_p_content_check['und'][0]['value']:0;
        $form['_container']['content_article']['#value'] = !empty($_product->field_p_article_content['und'][0]['value'])?$_product->field_p_article_content['und'][0]['value']:0;
        $form['_container']['content_duplicate']['#value'] = !empty($_product->field_p_content_duplicate['und'][0]['value'])?$_product->field_p_content_duplicate['und'][0]['value']:0;
        $form['_container']['device']['#value'] = !empty($_product->field_p_device['und'][0]['value'])?$_product->field_p_device['und'][0]['value']:0;
        $form['_container']['excel']['#value'] = !empty($_product->field_p_excel_export['und'][0]['value'])?$_product->field_p_excel_export['und'][0]['value']:0;

    }
    $form['submit'] = array('#type' => 'submit', '#value' => t('Lưu'));

    return $form;
}
function cassiopeia_user_change_packet_form_submit($form,&$form_state){
    global $user;
    try{
//        _print_r($form['#uid']);
        db_insert("tbl_available_product")->fields(array(
            "created"                => REQUEST_TIME,
            "uid"                    => $form['#uid'],
            "tran_user"              => $user->uid,
            "product"                => $form_state['values']['product'],
            "check_backlink"         => $form_state['values']['backlink'],
            "indexed_google"         => $form_state['values']['indexed'],
            "content_duplicate"      => $form_state['values']['content_duplicate'],
            "device"                 => $form_state['values']['device'],
            "excel"                  => $form_state['values']['excel'],
            "backlink_project"       => $form_state['values']['backlink_project'],
            "key_project"            => $form_state['values']['key_project'],
            "key_search"             => $form_state['values']['key_search'],
            "content_project"             => $form_state['values']['content_project'],
            "content_check"             => $form_state['values']['content_check'],
            "content_article"             => $form_state['values']['content_article'],
            "expired"                => !empty($form_state['values']['expired'])?strtotime($form_state['values']['expired']):0,
            "status"                 => 1,
        ))->execute();
        if($form_state['values']['device']>0){
            user_save(user_load($form['#uid']), array('data' => array('session_limit' => $form_state['values']['device'])));
        }else{
            user_save(user_load($form['#uid']), array('data' => array('session_limit' => 99)));
        }

    }catch (Exception $e){
        _print_r($e);
        die;
    }
}
function cassiopeia_user_change_packet_form_change_product(&$form,&$form_state){
    return $form['_container'];
}
function cassiopeia_config_witai_form($form,&$form_state){
    $form = array();
    $form['WitAI'] = array(
        '#type' => 'container',
        '#prefix' => '<div id="WitAIContainer"><label for="">Group</label>',
        '#suffix' => '</div>',
    );
    $query = db_select("tbl_witai_config","tbl_witai_config");
    $query->fields("tbl_witai_config");
    $result = $query->execute()->fetchAll();
    if(!empty($result)){
        $form_state['groupList'] = !empty($form_state['groupList']) ? $form_state['groupList'] : $result;
    }else{
        $form_state['groupList'] = !empty($form_state['groupList']) ? $form_state['groupList'] : array(0 => array());
    }
    foreach( $form_state['groupList'] as $key => $value){
        $form['WitAI']['WitAIGroup_' . $key] = array(
            '#type' => 'container',
            '#prefix' => '<div id="WitAIGroup" class="WitAI-group">',
            '#suffix' => '</div>',
        );
        $form['WitAI']['WitAIGroup_' . $key]['version_'.$key] = array(
            '#type'         => 'textfield',
            '#title'        => t('Version'),
            '#size'         => 60,
            '#maxlength'    => 128,
            '#default_value'=> !empty($value)?$value->version:"",
            '#required'     => TRUE,
        );
        $form['WitAI']['WitAIGroup_' . $key]['account_'.$key] = array(
            '#type'         => 'textfield',
            '#title'        => t('Tài khoản'),
            '#size'         => 60,
            '#maxlength'    => 128,
            '#default_value'=> !empty($value)?$value->account:"",
            '#required'     => TRUE,
        );
        $form['WitAI']['WitAIGroup_' . $key]['WitAIRemove_' . $key] = array(
            '#type' => 'submit',
            '#submit' => array('cassiopeia_remove_WitAI_remove_one'),
            '#text' => '<span class="icon glyphicon glyphicon-trash" aria-hidden="true"></span>',
            '#value' => 'ProductPriceGroupRemove_' . $key,
            '#attributes' => array(
                'class' => array('close teaProductPriceItemRemove'), // insert space before attribute name :)
            ),
            '#ajax' => array(
                'callback' => 'cassiopeia_remove_WitAI_ajax_callback',
                'wrapper' => 'WitAIContainer',
                'method' => 'replace',
                'effect' => 'fade',
            ),
        );
    }
    $form['WitAI']['WitAI_addMore'] = array(
        '#type' => 'submit',
        '#submit' => array('cassiopeia_add_WitAI_add_one'),
        '#value' => 'Thêm group',
        '#text' => '<span class="icon glyphicon glyphicon-plus" ></span> ',
        '#attributes' => array(
            'class' => array('btn close teaTimeAddMore'),
            'type' => 'button',
        ),
        '#ajax' => array(
            'callback' => 'cassiopeia_add_WitAI_ajax_callback',
            'wrapper' => 'WitAIContainer',
            'method' => 'replace',
            'effect' => 'fade',
        ),
    );
    $form['submit'] = array('#type' => 'submit', '#value' => t('Lưu'));
    return $form;
}
function cassiopeia_config_witai_form_submit($form,&$form_state){
    $db_transaction = db_transaction();
    try{
        db_delete("tbl_witai_config")->execute();
        $query = db_insert("tbl_witai_config")->fields(array(
            "created","version","account"
        ));
        for($i=0;$i<count($form_state['groupList']);$i++){
            $query->values(array(REQUEST_TIME,trim($form_state['values']['version_'.$i]),trim($form_state['values']['account_'.$i])));
        }
        $query->execute();
    }catch (Exception $e){
        $db_transaction->rollback();
    }
}
function cassiopeia_add_WitAI_add_one(&$form, &$form_state)
{
    $form_state['groupList'][] = array();
    drupal_get_messages();
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_add_WitAI_ajax_callback($form, &$form_state){
    return $form['WitAI'];
}
function cassiopeia_remove_WitAI_ajax_callback($form, &$form_state)
{
    return $form['WitAI'];
}
function cassiopeia_remove_WitAI_remove_one(&$form, &$form_state)
{
    $delta_remove = !empty($form_state['values']['op']) ? $form_state['values']['op'] : null;
    $delta_remove_array = !empty($delta_remove) ? explode('_', $delta_remove) : null;
    $childIndex = $delta_remove_array[1];
    unset($form_state['groupList'][$childIndex]);
    $temp = array();
    foreach ($form_state['groupList'] as $item) {
        $temp[] = $item;
    }
    $form_state['groupList'] = $temp;
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_admin_manager_booking_filter_form($form,&$form_state,$cache){
    $arg = arg();
    $form['code'] = array(
        '#type'         => 'textfield',
        '#title'        => t('Mã đơn hàng'),
        '#size'         => 60,
        '#maxlength'    => 128,
    );
    if(!empty($cache['code'])){
        $form['code']['#default_value'] = $cache['code'];
    }
    $form['from_date'] = array(
        '#type' => 'date_popup',
        '#default_value' => !empty($cache['from_date'])?$cache['from_date']:"",
        '#date_type' => DATE_DATETIME,
        '#date_timezone' => date_default_timezone(),
        '#date_format' => 'd-m-Y',
        '#date_increment' => 1,
        '#date_year_range' => '-10:+10',
        '#attributes' => array( "class" => array("form_date")),
    );
    if(!empty($cache['from_date'])){
        $form['from_date']['#default_value'] = $cache['from_date'];
    }
    $form['to_date'] = array(
        '#type' => 'date_popup',
        '#default_value' => !empty($cache['to_date'])?$cache['to_date']:"",
        '#date_type' => DATE_DATETIME,
        '#date_timezone' => date_default_timezone(),
        '#date_format' => 'd-m-Y',
        '#date_increment' => 1,
        '#date_year_range' => '-10:+10',
        '#attributes' => array( "class" => array("to_date")),
    );
    $users = cassiopeia_get_users_by_roles(array(4));
    $options = array();
    $options['all'] = "Tất cả";
    foreach($users as $_user){
        $options[$_user->uid] = !empty($_user->field_full_name['und'][0]['value'])?$_user->field_full_name['und'][0]['value']:$_user->mail;
    }
    $form['account'] = array(
        '#type'     => 'select',
        '#title'    => t('Tài khoản'),
        '#options'  => $options,
    );
    if(!empty($cache['account'])){
        $form['account']['#default_value'] = $cache['account'];
    }
    $products = cassiopeia_get_nodes_by_category("product");
    $options = array();
    $options['all'] = "Tất cả";
    foreach($products as $product){
        $options[$product->nid] = $product->title;
    }
    $form['product'] = array(
        '#type'     => 'select',
        '#title'    => t('Gói'),
        '#options'  => $options,
    );
    if(!empty($cache['product'])){
        $form['product']['#default_value'] = $cache['product'];
    }
    if($arg[2]!="report"){
        $form['b_status'] = array(
            '#type'     => 'select',
            '#title'    => t('Tình trạng'),
            '#options'  => array(
                "all"   => "Tất cả",
                0   => "Chưa xử lý",
                1   => "Đang xử lý",
                2   => "Đã xử lý",
            ),
        );
        if(isset($cache['b_status'])){
            $form['b_status']['#default_value'] = $cache['b_status'];
        }

    }else{

    }
    $form['gift'] = array(
        '#type'     => 'select',
        '#title'    => t('Quà tặng'),
        '#options'  => array(
            "all"   => "Tất cả",
            0   => "Đơn hàng thường",
            1   => "Quà tặng",
        ),
    );
    if(isset($cache['gift'])){
        $form['gift']['#default_value'] = $cache['gift'];
    }
    $form['submit'] = array(
        '#type'     => 'submit',
        '#value'    => t('Lọc'),
        '#prefix'   => "<div class='buttons'>",
        '#suffix'   => "</div>"
    );
    return $form;
}
function cassiopeia_admin_manager_booking_filter_form_submit($form, &$form_state)
{
    $arg = arg();
    $options = array(
        'query' => array(
            'data' => $form_state['values'],
        )
    );
    if($arg[2]=="booking"){
        $form_state['redirect'] = array("/admin/manager/booking", "data" => $options);
    }else{
        $form_state['redirect'] = array("/admin/manager/report", "data" => $options);
    }
}
function cassiopeia_form_node_delete_confirm_alter(&$form,&$form_state){
//    if($form['#node']->nid==BASIC || $form['#node']->nid==AGENCY){
//        drupal_set_message("Bạn không được xóa mục này!");
//        drupal_goto("/admin/manager/product");
//    }
}
function cassiopeia_admin_add_booking_form($form,&$form_state){
    $form = array();
    $accounts = cassiopeia_get_users_by_roles(array(4));
    $options = array();
    $options['_none'] = "Chọn";
    foreach($accounts as $account){
        $options[$account->uid] = !empty($account->field_full_name['und'][0]['value'])?$account->field_full_name['und'][0]['value']:$account->name;
    }
    $form['account'] = array(
        '#type'     => 'select',
        '#title'    => t('Tài khoản'),
        '#options'  => $options,
        '#required' => TRUE,
    );
    $conditions = array();
    $conditions['nid'] = array(
        "type"      => "propertyCondition",
        "value"     => array(BASIC),
        "condition" => "NOT IN",
    );
    $products = cassiopeia_get_items_by_conditions($conditions,"product","node");
    $options = array();
    $index=1;
    $_node = null;
    foreach($products as $product){
        if($index==1){
            $_node = $product;
        }
        $options[$product->nid] = $product->title;
        $index++;
    }
    $form['product'] = array(
        '#type'     => 'select',
        '#title'    => t('Gói'),
        '#options'  => $options,
        '#ajax' => array(
            'callback' => 'cassiopeia_admin_add_booking_form_change_product',
            'wrapper' => 'ProductPriceContainer',
            'method' => 'replace',
            'effect' => 'fade',
        ),
    );
    if(!empty($form_state['values']['product'])){
        $_node = node_load($form_state['values']['product']);
    }
    $query = db_select("tbl_product_price","tbl_product_price");
    $query->fields("tbl_product_price");
    $query->condition("nid",$_node->nid);
    $result = $query->execute()->fetchAll();
    $price_options = array();
    if(!empty($result)){
        foreach($result as $item){
            $label = "<div><div>".$item->month." tháng</div><div>".number_format($item->price,0,",",".")."đ/tháng</div></div>";
            $price_options[$item->id] = $label;
        }
    }
    $form['ProductPrice'] = array(
        '#type' => 'container',
        '#prefix' => '<div id="ProductPriceContainer"><label for=""></label>',
        '#suffix' => '</div>',
    );
    if(!empty($_node) && $_node->nid==AGENCY){
//        $form['ProductPrice']['price'] = array(
//            '#type' => 'radios',
//            '#title' => t('Chọn'),
//            '#options' => $price_options,
//        );
    }else{
        $form['ProductPrice']['price'] = array(
            '#type' => 'radios',
            '#title' => t('Chọn'),
            '#options' => $price_options,
            '#required' => TRUE,
        );
    }
    $form['gift'] = array(

        '#type' =>
            'checkbox',

        '#title' => t('Quà tặng'),

    );
    $form['submit'] = array(
        '#type'     => 'submit',
        '#value'    => t('Thêm mới'),
        '#prefix'   => "<div class='buttons'>",
        '#suffix'   => "</div>"
    );
    return $form;
}
function cassiopeia_admin_add_booking_form_change_product(&$form,&$form_state){
    return $form['ProductPrice'];
}
function cassiopeia_admin_add_booking_form_submit($form,&$form_state){
    $query =db_select("tbl_booking_product","tbl_booking_product");
    $query->fields("tbl_booking_product");
    $query->range(0,1);
    $query->orderBy("id","DESC");
    $last = $query->execute()->fetchObject();
    $Price = null;
    $_price = 0;
    if(!empty($form_state['values']['price'])){
        $query = db_select("tbl_product_price","tbl_product_price");
        $query->fields("tbl_product_price");
        $query->condition("id",$form_state['values']['price']);
        $Price = $query->execute()->fetchObject();
        $_price = !empty($Price->price)?$Price->price:0;
    }
    if($form_state['values']['product']==AGENCY){
        $product = node_load($form_state['values']['product']);
        $_price  = !empty($product->field_price['und'][0]['value'])?$product->field_price['und'][0]['value']:0;
    }
    if(!empty($last)){
        $code = $last->code;
        $code = str_replace("DH","",$code);
        $code = str_replace("0","",$code);
        $code++;
        $temp = $code;
//        _print_r(($code));
//        _print_r(strlen($code));
//        die;
        for($i=1;$i<=6-strlen($code);$i++){
            $temp = "0".$temp;
        }
        $code = "DH".$temp;
    }else{
        $code = "DH000001";
    }
    try{
        db_insert("tbl_booking_product")->fields(array(
            "created"  => REQUEST_TIME,
            "uid"  => $form_state['values']['account'],
            "status"  => 1,
            "priceID"  => !empty($form_state['values']['price'])?$form_state['values']['price']:-1,
            "month"  => !empty($Price)?$Price->month:-1,
            "nid"  => !empty($form_state['values']['product'])?$form_state['values']['product']:-1,
            "gift"  => !empty($form_state['values']['gift'])?$form_state['values']['gift']:0,
            "code"  => $code,
            "price"  => $_price,
        ))->execute();
        drupal_set_message("Đăng ký thành công, vui lòng xác nhận lại đơn hàng!");
        $form_state['redirect'] = "/admin/manager/booking";
    }catch (Exception $e){
        _print_r($e);
        die;
    }
}
function cassiopeia_set_alert($type,$message=""){
    $_SESSION['custom_alert'] = array(
        "type"  => $type,
        "message"  => $message,
    );
}
function cassiopeia_download_exntesion_callback(){
    $filename = 'extension/SEO MiniSuite.zip'; // of course find the exact filename....
    header('Pragma: public');
    header('Expires: 0');
    header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
    header('Cache-Control: private', false); // required for certain browsers
    header('Content-Type: application/zip');

    header('Content-Disposition: attachment; filename="'. basename($filename) . '";');
    header('Content-Transfer-Encoding: binary');
    header('Content-Length: ' . filesize($filename));

    readfile($filename);

    exit;
}
function cassiopeia_create_keywords_export($items,$pid) {
//    _print_r($items);
    if(!empty($items)){
        module_load_include('inc', 'phpexcel');
        $data = array();
        $headers = array(
            "STT",
            "Từ khóa",
            "Thay đổi",
            "Vị trí hiện tại",
            "Vị trí cũ",
            "Vị trí tốt nhất",
            "URL SEO",
            "Tag",
            "Ngày cập nhật",
        );
        $parent = null;
        $stt = 1;
        foreach($items as $item){
            $tags = "";
            $status_class = "";
            if(!empty($item->field_keyword_old_position) && !empty($item->field_keyword_position)){
                if($item->field_keyword_position - $item->field_keyword_old_position>0){
                    $status_class = " - ";
                }elseif($item->field_keyword_position - $item->field_keyword_old_position<0){
                    $status_class = " + ";
                }
            }
            if(!empty($item->field_tags)){
                $_tags = explode(",",$item->field_tags);
                foreach($_tags as $_tag){
                    $tag = taxonomy_term_load($_tag); if(!empty($tag)) $tags.=$tag->name.",";
                }
            }
            if(!empty($item->field_keyword_old_position)){
                $change_position = $status_class.abs($item->field_keyword_position-$item->field_keyword_old_position);
            }else{
                $change_position = "-";
            }
            $current_position = !empty($item->field_keyword_position)?$item->field_keyword_position:"-";
            $old_position = !empty($item->field_keyword_old_position)?$item->field_keyword_old_position:"-";
            $best_position = !empty($item->field_keyword_best_position)?$item->field_keyword_best_position:"-";
            $url = !empty($item->field_url)?$item->field_url:"-";
            $data[] = array(
                $stt,
                $item->title,
                $change_position,
                $current_position,
                $old_position,
                $best_position,
                $url,
                $tags,
                date("d/m/Y",$item->changed),
            );
            $stt++;
        }
        // Store the file in sites/default/files
        $dir = file_stream_wrapper_get_instance_by_uri('public://')->realpath();
        $filename =  'export_'.date('d_m_Y_H_i', REQUEST_TIME).'.xlsx';
        $path = "$dir/$filename";

        // Use the .xls format
        $options = array('format' => 'xlsx');

        $result = phpexcel_export($headers, $data, $path, $options);
//        _print_r($result);
        if ($result == PHPEXCEL_SUCCESS) {
            // notify to admin
            drupal_set_message(t("Ok"));
            return array('name'=>$filename,'uri'=>'public://'.$filename,'golf'=>$parent);
        }
        else {
            drupal_set_message($result, 'error');
            return null;
        }
    }
}
function cassiopeia_create_user_export($accounts) {
    module_load_include('inc', 'phpexcel');
    $data = array();
    $headers = array(
        "STT",
        "Họ tên",
        "Tên đăng nhập/email",
        "Số điện thoại",
        "Gói",
        "Dự án backlink",
        "Dự án từ khóa",
        "Ngày tạo",
        "Thời hạn",
    );
    $stt=count($accounts);
    foreach($accounts as $_account){
        $account = user_load($_account->uid);
        $packet = cassiopeia_get_available_packet_by_uid($_account->uid);
        $TotalBacklinkProject = !empty($_account->TotalBacklinkProject)?$_account->TotalBacklinkProject:0;
        $TotalkeywordProject = !empty($_account->TotalkeywordProject)?$_account->TotalkeywordProject:0;
        $expired = !empty($packet->expired)?date("d-m-Y H:i",$packet->expired):"";
//        if($packet->expired>REQUEST_TIME&&$packet->expired<=REQUEST_TIME+30*86400){
//            ?>
<!--            <span class="color-red">--><?php //echo "Còn ".floor(($packet->expired-REQUEST_TIME)/86400)." ngày"; ?><!--</span>-->
<!--            --><?php
//        }else{
//            if($packet  ->expired>0) echo date("d-m-Y H:i",$packet->expired);
//        }
        $data[] = array(
            $stt,
            $_account->full_name,
            $_account->mail,
            $_account->field_tel,
            $packet->product_name,
            $TotalBacklinkProject,
            $TotalkeywordProject,
            date("d-m-Y H:i",$_account->created),
            $expired
        );
        $stt--;
    }
    $dir = file_stream_wrapper_get_instance_by_uri('public://')->realpath();
    $filename =  'export_'.date('d_m_Y_H_i', REQUEST_TIME).'.xlsx';
    $path = "$dir/$filename";

    // Use the .xls format
    $options = array('format' => 'xlsx');

    $result = phpexcel_export($headers, $data, $path, $options);
    if ($result == PHPEXCEL_SUCCESS) {
        // notify to admin
        drupal_set_message(t("Ok"));
        return array('name'=>$filename,'uri'=>'public://'.$filename);
    }
    else {
        drupal_set_message($result, 'error');
        return null;
    }
}
function cassiopeia_create_backlinks_export($backlinks) {
  global $user;
    module_load_include('inc', 'phpexcel');
    $data = array();

    if(user_has_role(3)){
      $headers = array(
        "STT",
        "Nguồn đặt Backlink",
        "Thuộc tính",
        "AnchorText",
        "URL SEO",
        "GG Indexed",
        "Tag",
        "Số điện thoại",
        "Ngày cập nhật",
        "Tình trạng",
      );
    }else{
      $headers = array(
        "STT",
        "Nguồn đặt Backlink",
        "Thuộc tính",
        "AnchorText",
        "URL SEO",
        "GG Indexed",
        "Tag",
        "Ngày cập nhật",
        "Tình trạng",
      );
    }
    $parent = null;
    $stt = 1;
    foreach($backlinks as $item){
      $__tels = "";
      $tel_query = db_select("cassiopeia_backlink_tel","cassiopeia_backlink_tel")->fields("cassiopeia_backlink_tel")->condition("bid",$item->bid);
      $tels = $tel_query->execute()->fetchAll();
      if(!empty($tels)){
        $_tels = array();
        foreach($tels as $tel){
          $_tels[] = $tel->tel;
        }
        $__tels = implode(", ",$_tels);
      }
        $index = $item->indexed==1?"Có":"Không";
        if($item->status==200){
            $errorCode = "Success";
        }else{
            $errorCode = "Fail";
        }
        if(user_has_role(3)){
          $data[] = array(
            $stt,
            $item->source,
            $item->rel,
            $item->anchor_text,
            $item->url,
            $index,
            $item->tags,
            $__tels,
            date("d-m-Y",$item->changed),
            $errorCode,
          );
        }else{
          $data[] = array(
            $stt,
            $item->source,
            $item->rel,
            $item->anchor_text,
            $item->url,
            $index,
            $item->tags,
            date("d-m-Y",$item->changed),
            $errorCode,
          );
        }
        $stt++;
    }
    // Store the file in sites/default/files
    $dir = file_stream_wrapper_get_instance_by_uri('public://')->realpath();
    $filename =  'export_'.date('d_m_Y_H_i', REQUEST_TIME).'.xlsx';
    $path = "$dir/$filename";

    // Use the .xls format
    $options = array('format' => 'xlsx');

    $result = phpexcel_export($headers, $data, $path, $options);
    if ($result == PHPEXCEL_SUCCESS) {
        // notify to admin
        drupal_set_message(t("Ok"));
        return array('name'=>$filename,'uri'=>'public://'.$filename,'golf'=>$parent);
    }
    else {
        drupal_set_message($result, 'error');
        return null;
    }
}
function cassiopeia_download_excel_callback(){
    global $base_url;
    $arg = arg();
    $file_name = $arg[2];
    $filename = "public://".$file_name; // of course find the exact filename....
    $file_name = file_create_url($filename);
//    print($file_name);
//    die;
    header('Pragma: anytextexeptno-cache', true);
    header('Expires: 0');
    header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
    header('Cache-Control: private', false); // required for certain browsers
    header('Content-Type: application/zip');
    header('Content-Disposition: attachment; filename="'. basename($filename) . '";');
    header('Content-Transfer-Encoding: binary');
    header('Content-Length: ' . filesize($filename));

    readfile($filename);
    if (file_exists($filename)) {
        $deleted = unlink($filename);
    }

    drupal_get_messages();
    exit;
}
function vn_to_str ($str){

    $unicode = array(

        'a'=>'á|à|ả|ã|ạ|ă|ắ|ặ|ằ|ẳ|ẵ|â|ấ|ầ|ẩ|ẫ|ậ',

        'd'=>'đ',

        'e'=>'é|è|ẻ|ẽ|ẹ|ê|ế|ề|ể|ễ|ệ',

        'i'=>'í|ì|ỉ|ĩ|ị',

        'o'=>'ó|ò|ỏ|õ|ọ|ô|ố|ồ|ổ|ỗ|ộ|ơ|ớ|ờ|ở|ỡ|ợ',

        'u'=>'ú|ù|ủ|ũ|ụ|ư|ứ|ừ|ử|ữ|ự',

        'y'=>'ý|ỳ|ỷ|ỹ|ỵ',

        'A'=>'Á|À|Ả|Ã|Ạ|Ă|Ắ|Ặ|Ằ|Ẳ|Ẵ|Â|Ấ|Ầ|Ẩ|Ẫ|Ậ',

        'D'=>'Đ',

        'E'=>'É|È|Ẻ|Ẽ|Ẹ|Ê|Ế|Ề|Ể|Ễ|Ệ',

        'I'=>'Í|Ì|Ỉ|Ĩ|Ị',

        'O'=>'Ó|Ò|Ỏ|Õ|Ọ|Ô|Ố|Ồ|Ổ|Ỗ|Ộ|Ơ|Ớ|Ờ|Ở|Ỡ|Ợ',

        'U'=>'Ú|Ù|Ủ|Ũ|Ụ|Ư|Ứ|Ừ|Ử|Ữ|Ự',

        'Y'=>'Ý|Ỳ|Ỷ|Ỹ|Ỵ',

    );

    foreach($unicode as $nonUnicode=>$uni){

        $str = preg_replace("/($uni)/i", $nonUnicode, $str);

    }
    $str = str_replace(' ','_',$str);

    return $str;

}
function cassiopeia_phpexcel_export($op, &$data, &$phpexcel, $options, $column = NULL, $row = NULL) {
//    _print_r($op);
//    die;
    switch($op) {
        case 'post cell':
            if ($column == 1 && $row == 3) {
                $styleArray = array(
                    'font' => array(
                        'bold' => TRUE,
                        'italic' => TRUE
                    )
                );
                $phpexcel->getStyleByColumnAndRow($column,$row)->applyFromArray($styleArray);
            }
            break;
        default:
            if ( $column == 2|| $column == 3|| $column == 4 || $column == 5|| $column == 6|| $column == 7|| $column == 8) {
                $phpexcel->getColumnDimensionByColumn($column)->setAutoSize(true);
            }
            if($column==1){
                $phpexcel->getColumnDimensionByColumn($column)->setWidth(100);

            }
            if($row==1){
                $styleArray = array(
                    'fill' => array(
                        'type' => PHPExcel_Style_Fill::FILL_SOLID,
                        'color' => array('rgb' => 'DCE6F1')
                    )
                );
                $phpexcel->getStyleByColumnAndRow($column,$row)->applyFromArray($styleArray);
            }
    }
}
function cassiopeia_test_1_form($form,&$form_state,$start){
    $form['#start'] = $start;
    $form['submit'] = array('#type' => 'submit', '#value' => t('Lưu'));
    return $form;
}
function cassiopeia_test_1_form_submit($form, &$form_state) {
    $domain_query = db_select("tbl_backlink","tbl_backlink");
    $domain_query->fields("tbl_backlink",array("id","domain"));
    $domain_query->orderBy("tbl_backlink._domain","ASC");
    $domain_query->where("tbl_backlink._domain is null");
    $domain_query->range(0,10000);
    $result = $domain_query->execute()->fetchAll();
    $operations = [];
    foreach($result as $nid=>$node) {
        // $operations[] = array(<function name>, <array of arguments to pass to function>);
        $operations[] = array('drupology_associate_audio_tiles_to_song', array($node));
    }
    // build the batch instructions
    $batch = array(
        'operations' => $operations,
        'finished' => 'drupology_associate_audio_tiles_to_songs_finished',
    );
    batch_set($batch);
}
function drupology_associate_audio_tiles_to_song($node, &$context) {
    $query = db_select("tbl_domain","tbl_domain");
    $query->fields("tbl_domain");
    $query->condition("domain",$node->domain);
    $check = $query->execute()->fetchObject();
    if(!empty($check)){
        db_update("tbl_backlink")->fields(array("_domain"=>$check->id))->condition("id",$node->id)->execute();
    }else{
        $id = db_insert("tbl_domain")->fields(array(
            "created"   => REQUEST_TIME,
            "domain"    => $node->domain,
        ))->execute();
        db_update("tbl_backlink")->fields(array("_domain"=>$id))->condition("id",$node->id)->execute();
    }
}
function drupology_associate_audio_tiles_to_songs_finished($success, $results, $operations) {
    $_SESSION['start']+=1000;
}
function cassiopeia_get_url_form($form,&$form_state){
    $form['keywords'] = array(
        '#title'        => t('Từ khóa'),
        '#type'         => 'textarea',
        '#attributes'   => array("placeholder"=> "Mời bạn nhập từ khóa, mỗi từ khóa nằm trên 1 dòng"),
        '#required'     => TRUE
    );
    $form['exclude-urls'] = array(
        '#title'    => t('Loại trừ urls'),
        '#type'     => 'textarea',
    );
    $form['submit'] = array(
        '#type'         => 'submit',
        '#value'        => t("Xác nhận"),
        '#prefix'       => "<div class='form-buttons'>",
        '#suffix'       => "</div>",
        '#attributes'   => array("class"=>array("btn-type-2")),
    );

    return $form ;
}
function cassiopeia_form_content_article_node_form_alter(&$form,&$form_state){
    unset($form['title']['#title']);
    unset($form['body']['und'][0]['#title']);

    $form['tags'] = array(
        '#type'         => 'textfield',
        '#title'        => "Tags <button
                        type=\"button\"
                        class=\"btn btn-secondary  btn-notice-tooltip\"
                        data-toggle=\"tooltip\"
                        data-placement=\"right\"
                        title=\"Tạo Tag nhằm mục đích nhóm các Bài viết cùng Tính chất hoặc Chủ Đề\"
                    >
                        <span class=\"btn-tag-tooltip fa fa-question-circle-o\" aria-hidden=\"true\"></span>
                    </button>",
        '#size'         => 60,
        '#maxlength'    => 128,
        '#prefix'       => "<div class='form-item input-wrap' title='Tạo Tag nhằm mục đích nhóm các Bài viết cùng Tính chất hoặc Chủ đề'>",
        '#suffix'       => "<p></p></div>",
        '#attributes'   => array("class"=>array("tagify-input seo-input"),"placeholder"=>"Phân cách các thẻ Tag nhấn phím Enter",'title' => "",),
        '#weight'       => 9999,
    );
    if(!empty($form['#node']->id)){
        $query = db_select("tbl_tags","tbl_tags");
        $query->fields("tbl_tags");
        $query->condition("nid",$form['#node']->id);
        $query->condition("pid",$form['#node']->pid);
        $query->orderBy("created","DESC");
        $current_tags = $query->execute()->fetchAll();
        $tag_defaults = [];
        if(!empty($current_tags)){
            foreach ($current_tags as $current_tag){
                $_tag = taxonomy_term_load($current_tag->tid);
                if(!empty($_tag)){
                    $tag_defaults[] = array("value"=>$_tag->name);
                }
            }
            $form['tags']['#default_value'] = json_encode($tag_defaults);
        }
    }
    $form['title']['#attributes']['class'][] = "seo-input";
    $form['#submit'] = array("cassiopeia_form_content_article_node_form_submit");
//    _print_r($form)
    $form['#validate'][] ="cassiopeia_form_content_article_node_form_validate";
}
function cassiopeia_form_content_article_node_form_validate(&$form,&$form_state){
    global $user;
    $packet = cassiopeia_get_available_packet_by_uid($user->uid);
    if(!empty($packet)){
        $query = db_select("cassiopeia_content","cassiopeia_content");
        $query->fields("cassiopeia_content",array("id"));
        $query->condition("uid",$user->uid);
        $result = $query->execute()->fetchAll();
        if($packet->product!=BASIC && $packet->expired>0 && $packet->expired<REQUEST_TIME){ // tài khoản hết hạn
            cassiopeia_set_alert("UserExpired","Tài khoản hết hạn");
            form_set_error('changed', '');
        }else{
            if(count($result)>=$packet->content_article && $packet->content_article>0){
                cassiopeia_set_alert("UserLimited","Số lượng dự án content");
                form_set_error('changed', '');
            }else {

            }
        }
    }else{
        drupal_set_message("??");
    }
}
function cassiopeia_form_content_article_node_form_submit(&$form,&$form_state){
    global $user;
    $packet = cassiopeia_get_available_packet_by_uid($user->uid);
    if(!empty($packet)){
        $query = db_select("cassiopeia_content","cassiopeia_content");
        $query->fields("cassiopeia_content",array("id"));
        $query->condition("uid",$user->uid);
        $result = $query->execute()->fetchAll();
        if($packet->product!=BASIC && $packet->expired>0 && $packet->expired<REQUEST_TIME){ // tài khoản hết hạn
            cassiopeia_set_alert("UserExpired","Tài khoản hết hạn");
//            drupal_goto($_SERVER[HTTP_REFERER]);
        }else{
            if(count($result)>=$packet->content_article && $packet->content_article>0){
                cassiopeia_set_alert("UserLimited","Số lượng dự án content");
//                drupal_goto($_SERVER[HTTP_REFERER]);
            }else{
                $tags = !empty($form_state['values']['tags'])?json_decode($form_state['values']['tags']):array();
                if(!empty($tags)){
                    foreach(($tags) as $_tag){
                        $term = null;
                        $conditions = array();
                        $conditions['field_user'] = array(
                            "type"      => "fieldCondition",
                            "key"       => "target_id",
                            "value"     => $user->uid,
                            "condition" => "=",
                        );
                        $conditions['field_content_project'] = array(
                            "type"      => "fieldCondition",
                            "key"       => "nid",
                            "value"     => $form['#node']->pid,
                            "condition" => "=",
                        );
                        $conditions['name'] = array(
                            "type"      => "propertyCondition",
                            "value"     => $_tag->value,
                            "condition" => "=",
                        );
                        $tags = cassiopeia_get_items_by_conditions($conditions,"tags","taxonomy_term");
                        if(!empty($tags)){
                            $term = array_values($tags)[0];
                        }
                        if(!empty($term)){
                            $tids[] = $term->tid;
                        }else{
                            $v = taxonomy_vocabulary_machine_name_load("tags");
                            $newterm = new stdClass();
                            $newterm->name = $_tag->value;
                            $newterm->vid = $v->vid;
                            $newterm->field_user['und'][0]['target_id'] = $user->uid;
                            $newterm->field_content_project['und'][0]['nid'] = $form['#node']->pid;
                            taxonomy_term_save($newterm);
                            $tids[] = $newterm->tid;
                        }
                    }
                }

                try{
                    $node = new stdClass();
                    $node->title = $form_state['values']['title'];
                    $node->raw_title = stripVN($form_state['values']['title']);
                    $node->body = htmlspecialchars($form_state['values']['body']['und'][0]['value']);
                    $node->word_count = $form_state['values']['field_content_word_count']['und'][0]['value'];
                    $node->h2_count = $form_state['values']['field_content_h2_count']['und'][0]['value'];
                    $node->h3_count = $form_state['values']['field_content_h3_count']['und'][0]['value'];
                    $node->image_count = $form_state['values']['field_content_img_count']['und'][0]['value'];
                    $node->point = !empty($form_state['values']['field_content_point']['und'][0]['value'])?$form_state['values']['field_content_point']['und'][0]['value']:0;
                    $node->keyword = !empty($form_state['values']['field_content_keyword']['und'][0]['value'])?$form_state['values']['field_content_keyword']['und'][0]['value']:"";
                    $node->changed = REQUEST_TIME;
                    $query = db_select("cassiopeia_content_check","cassiopeia_content_check");
                    $query->fields("cassiopeia_content_check");
                    $query->condition("cassiopeia_content_check.nid",0);
                    $query->condition("cassiopeia_content_check.uid",$user->uid);
                    $checks = $query->execute()->fetchAll();

                    if(!empty($form['#node']->id)){ // cập nhật
                        $node->id = $form['#node']->id;
                        drupal_write_record("cassiopeia_content",$node,array("id"));
                        if(!empty($checks)){ // có lượt quét mới thì xóa dữ liệu quét cũ
                            db_delete("cassiopeia_content_check")->condition("nid",$node->id)->condition("uid",$user->uid)->execute();
                        }
                    }else{
                        $node->uid = $user->uid;
                        $node->pid = $form['#node']->pid;
                        $node->created = REQUEST_TIME;
                        drupal_write_record("cassiopeia_content",$node);
                    }
                    if(!empty($checks)){
                        db_update("cassiopeia_content_check")->fields(array("nid"=>$node->id))->condition("nid",0)->condition("uid",$user->uid)->execute();
                    }
                    db_delete("tbl_tags")->condition("nid",$form['#node']->id)->condition("pid",$form['#node']->pid)->execute();
                    if(!empty($tids)){
                        foreach((array)$tids as $tid){
                            db_insert("tbl_tags")->fields(array(
                                "created"   => REQUEST_TIME,
                                "nid"       => $node->id,
                                "tid"       => $tid,
                                "pid"       => $form['#node']->pid,
                            ))->execute();
                        }
                    }
                    $project = node_load($form['#node']->pid);
                    $project->changed = REQUEST_TIME;
                    node_save($project);
                }catch (Exception $e){
//        _print_r($e);
//        die;
                }
                drupal_goto("quan-ly-du-an-content/".$form['#node']->pid);
            }
        }
    }else{
        drupal_set_message("??");
    }

}
function stripVN($str) {
    $str = preg_replace("/(à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ)/", 'a', $str);
    $str = preg_replace("/(è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ)/", 'e', $str);
    $str = preg_replace("/(ì|í|ị|ỉ|ĩ)/", 'i', $str);
    $str = preg_replace("/(ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ)/", 'o', $str);
    $str = preg_replace("/(ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ)/", 'u', $str);
    $str = preg_replace("/(ỳ|ý|ỵ|ỷ|ỹ)/", 'y', $str);
    $str = preg_replace("/(đ)/", 'd', $str);

    $str = preg_replace("/(À|Á|Ạ|Ả|Ã|Â|Ầ|Ấ|Ậ|Ẩ|Ẫ|Ă|Ằ|Ắ|Ặ|Ẳ|Ẵ)/", 'A', $str);
    $str = preg_replace("/(È|É|Ẹ|Ẻ|Ẽ|Ê|Ề|Ế|Ệ|Ể|Ễ)/", 'E', $str);
    $str = preg_replace("/(Ì|Í|Ị|Ỉ|Ĩ)/", 'I', $str);
    $str = preg_replace("/(Ò|Ó|Ọ|Ỏ|Õ|Ô|Ồ|Ố|Ộ|Ổ|Ỗ|Ơ|Ờ|Ớ|Ợ|Ở|Ỡ)/", 'O', $str);
    $str = preg_replace("/(Ù|Ú|Ụ|Ủ|Ũ|Ư|Ừ|Ứ|Ự|Ử|Ữ)/", 'U', $str);
    $str = preg_replace("/(Ỳ|Ý|Ỵ|Ỷ|Ỹ)/", 'Y', $str);
    $str = preg_replace("/(Đ)/", 'D', $str);
    return $str;
}

function cassiopeia_css_alter(&$css) {
    global $theme_info, $base_theme_info;
    $arg = arg();
    if(drupal_is_front_page()){

        unset($css['sites/all/themes/cassiopeia_theme/css/style.css']);
    }
}

function cassiopeia_send_booking_mail_form($form , $form_state) {
    $form['id'] = array(
        '#type'         => 'textfield',
        '#title'        => t('ID'),
        '#size'         => 60,
        '#maxlength'    => 128,
    );
    $form['type'] = array(
        '#type' => 'select',
        '#title' => t('Selected'),
        '#options' => array(
            'product' => t('No'),
            'domain' => t('Yes'),
        ),
        '#required' => TRUE
    );
    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t("Thêm mới"),
        '#submit' => array("cassiopeia_send_booking_mail_form_submit"),
        '#ajax' => array(
            'callback' => 'cassiopeia_send_booking_mail_form_ajax_submit',
        ),
    );

    return $form ;
}
function cassiopeia_send_booking_mail_form_ajax_submit($form,&$form_state){

}
function cassiopeia_send_booking_mail_form_submit($form,&$form_state){
    global $user;
    if($form_state['values']['type']=="domain"){
        $booking = cassiopeia_guest_post_domain_change_booking_load_by_id($form_state['values']['id']);
        $booking->created = REQUEST_TIME;
        cassiopeia_guest_post_domain_change_booking_save($booking);
        cassiopeia_guest_post_send_domain_change_booking_mail($user,$booking);
    }else{
        $booking = tbl_booking_product_load($form_state['values']['id']);
        cassiopeia_booking_send_mail($user,$booking);
        db_update("tbl_booking_product")->fields(array(
            "created"        => REQUEST_TIME,
        ))->condition("code",$booking->code)->execute();
    }
}
function cassiopeia_booking_send_mail($_user,$booking){
    $query = db_select("tbl_product_price","tbl_product_price");
    $query->fields("tbl_product_price");
    $query->condition("id",$booking->priceID);
    $price = $query->execute()->fetchObject();
    $product = node_load($booking->nid);

    $amount = 0;
    if($product->nid==AGENCY){
        $amount = !empty($product->field_price['und'][0]['value'])?$product->field_price['und'][0]['value']:0;
    }else{
        $amount = !empty($price->price)?($price->price * $price->month):0;
    }

    $site_mail = "";
    $content = variable_get('cassiopeia_config_mail_buy_product_content', array(
        'value' => '',
        'format' => 'full_html'
    ));
    $content = $content['value'];
    $content = str_replace("#email",$_user->mail,$content);
    $content = str_replace("#product",$product->title,$content);
    $content = str_replace("#tel",$_user->field_tel['und'][0]['value'],$content);
    $content = str_replace("#price",number_format($amount,0,",",".")." đ",$content);
    if($product->nid==AGENCY){
        $content = str_replace("#month","trọn đời",$content);
    }else{
        $content = str_replace("#month",$price->month." tháng",$content);
    }
    $mails = variable_get("cassiopeia_config_mail_buy_product_mail");
    $splitter = explode(",",$mails);
    $cc = "";
    $first = "";
    $index = 1;
    if(!empty($splitter)){
        foreach($splitter as $item){
            if($index>1){
                $cc.=",".trim($item);
            }else{
                $first = $item;
                $cc.=trim($item);
            }
            $index++;
        }
    }
    if(!empty($cc)){
        $headers['Cc'] = $cc;
    }
    $body[] = $content;
    $headers['From'] = $headers['Sender'] = $headers['Return-Path'] = $site_mail;
    $headers['MIME-Version'] = '1.0';
    $headers['Content-Type'] = 'text/html; charset=UTF-8; format=flowed; delsp=yes';
    $params = array(
        'body' => $body,
        'subject' => "Khách hàng ".$_user->field_full_name['und'][0]['value']." mua gói dịch vụ",
        'headers' => $headers,
    );
    if (drupal_mail('cassiopeia', 'custom_key',$first, language_default(), $params)) {

    };
}
function tbl_booking_product_save(){

}

/**
 * Implements hook_cron().
 */
function cassiopeia_cron() {
  // Gọi hàm xử lý hàng đợi khi chạy cron
  module_load_include('inc', 'cassiopeia', 'cassiopeia.queue');

  // Lấy giới hạn từ cài đặt
  $limit = variable_get('cassiopeia_queue_cron_limit', 50);
  $max_execution_time = variable_get('cassiopeia_queue_cron_execution_time', 30);

  // Xử lý hàng đợi chính
  $count = cassiopeia_process_queue('cassiopeia_processing_queue', $limit, $max_execution_time);

  // Ghi log thông tin về xử lý hàng đợi
  if ($count > 0) {
    watchdog('cassiopeia', 'Đã xử lý @count mục trong hàng đợi trong quá trình cron.',
      array('@count' => $count),
      WATCHDOG_INFO);
  }

  // Dọn dẹp hàng đợi lỗi cũ (thời gian tính bằng giây, mặc định 7 ngày)
  $cleanup_age = variable_get('cassiopeia_queue_cleanup_age', 604800);
  cassiopeia_clean_failed_queue($cleanup_age);
  // Gọi hàm xử lý hàng đợi khi chạy cron
  module_load_include('inc', 'cassiopeia', 'cassiopeia.queue');
  cassiopeia_process_queue('cassiopeia_processing_queue', 50);
}
