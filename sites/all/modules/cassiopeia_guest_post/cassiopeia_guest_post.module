<?php
define("POINT_PER_ARTICLE",10);
define("POINT_PER_WEBSITE",200);
define("POINT_PER_DAY",20);
define("DEV_UID",1);
function cassiopeia_guest_post_init(){
//    drupal_add_js( 'sites/all/libraries/yairEO/tagify/jQuery.tagify.min.js');
    drupal_add_js('sites/all/libraries/yairEO/tagify/tagify.polyfills.min.js');
//    drupal_add_css('sites/all/libraries/yairEO/tagify/tagify.css');
    drupal_add_js('sites/all/libraries/yairEO/dragsort/dragsort.js');
    drupal_add_css('sites/all/libraries/yairEO/dragsort/dragsort.css');
}
//db_delete("cassiopeia_guest_post_user_day_point")->execute();
//db_delete("cassiopeia_guest_post_user_point")->execute();

function cassiopeia_guest_post_menu(){
    $items = array();
    $items['admin/manager/guest-post/domain-change/%user/edit'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_guest_post_user_domain_change_edit_callback',
        'page arguments'     => array(4),
        'title'             => t('Lượt đổi domain'),
        'access arguments' => array('cassiopeia module'),
        'file'              => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/point/%user/edit'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_guest_post_user_point_edit_callback',
        'page arguments'     => array(4),
        'title'             => t('Cài đặt điểm'),
        'access arguments' => array('cassiopeia module'),
        'file'              => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/order-content'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_guest_post_admin_order_content_callback',
        'title'             => t('Đơn vị nhận viết content'),
        'access arguments' => array('cassiopeia module'),
        'file'              => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/website/%cassiopeia_guest_post_website/delete'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_website_delete_page_callback',
        'page arguments' => array(4),
        'title' => t('Xóa website'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/website/%cassiopeia_guest_post_website/edit'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_website_edit_page_callback',
        'page arguments' => array(4),
        'title' => t('Sửa website'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/website/add'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_website_add_page_callback',
        'title' => t('Thêm website'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );

    $items['admin/manager/guest-post/complain'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_complain_page_callback',
        'title' => t('Khiếu nại'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/domain/booking/price/%cassiopeia_guest_post_domain_change_booking_price/edit'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_domain_booking_price_edit_page_callback',
        'page arguments' => array(6),
        'title' => t('Giá thay đổi domain'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/domain/booking/price/%cassiopeia_guest_post_domain_change_booking_price/delete'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_domain_booking_price_delete_page_callback',
        'page arguments' => array(6),
        'title' => t('Giá thay đổi domain'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/domain/booking/price/add'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_domain_booking_price_add_page_callback',
        'title' => t('Giá thay đổi domain'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/domain/booking/price'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_domain_booking_price_page_callback',
        'title' => t('Giá thay đổi domain'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/domain/change/booking/%cassiopeia_guest_post_domain_change_booking/delete'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_domain_change_booking_delete_page_callback',
        'page arguments' => array(6),
        'title' => t('Đơn hàng'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/domain/change/booking'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_domain_change_booking_page_callback',
        'title' => t('Đơn hàng'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/domain/booking/price/config'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => array('drupal_get_form'),
        'page arguments' => array('cassiopeia_guest_post_admin_manager_domain_booking_price_config_form'),
        'title' => t('Giá thay đổi domain'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/website'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_website_page_callback',
        'title' => t('Website'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/website/category'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_website_category_page_callback',
        'title' => t('Website category'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/website/category/add'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_website_category_add_page_callback',
        'title' => t('Website category'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/website/category/%cassiopeia_guest_post_website_category/edit'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_website_category_edit_page_callback',
        'page arguments' => array(5),
        'title' => t('Edit website category'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['admin/manager/guest-post/website/category/%cassiopeia_guest_post_website_category/delete'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_admin_manager_website_category_delete_page_callback',
        'page arguments' => array(5),
        'title' => t('Website category'),
        'access arguments' => array('cassiopeia module'),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['guest-post/complain/%cassiopeia_guest_post_complain/view'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_guest_post_complain_view_callback',
        'page arguments'     => array(2),
        'title'             => t('Chi tiết khiếu nại'),
        'access callback' => 'cassiopeia_guest_post_accept',
        'file'              => 'cassiopeia_guest_post.inc',
    );
    $items['guest/post/article/%cassiopeia_guest_post_article/view'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_guest_post_article_view_callback',
        'page arguments'     => array(3),
        'title'             => t('Review bài viết'),
        'access callback' => 'cassiopeia_guest_post_accept',
        'file'              => 'cassiopeia_guest_post.inc',
    );
    $items['guest-post/point/exchange'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_guest_post_point_exchange_callback',
        'title'             => t('Giao dịch điểm'),
        'access callback' => 'cassiopeia_guest_post_accept',
        'file'              => 'cassiopeia_guest_post.inc',
    );
    $items['guest-post/order-content'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_guest_post_order_content_callback',
        'title'             => t('Đơn vị nhận viết content'),
        'access callback' => 'cassiopeia_guest_post_accept',
        'file'              => 'cassiopeia_guest_post.inc',
    );

    $items['guest-post/complain'] = array(
        'title' => 'Quản lý khiếu nại',
        'page callback' => 'cassiopeia_guest_post_complain_page_callback',
        'access callback' => 'cassiopeia_guest_post_accept',
        'type' => MENU_CALLBACK,
        'file' => 'cassiopeia_guest_post.inc',
    ); 
    $items['guest-post/complain/add'] = array(
        'title' => 'Gửi khiếu nại mới',
        'page callback' => 'cassiopeia_guest_post_complain_add_page_callback',
        'access callback' => 'cassiopeia_guest_post_complain_add_accept',
        'type' => MENU_CALLBACK,
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['guest-post/domain/change/sample-file'] = array(
        'page callback' => 'cassiopeia_guest_post_domain_change_sample_file_page_callback',
        'access callback' => 'cassiopeia_guest_post_accept',
        'type' => MENU_CALLBACK,
        'file' => 'cassiopeia_guest_post.inc',
    );

    $items['guest-post/domain/change/booking'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_domain_change_booking_page_callback',
        'title' => t('Mua lượt đổi domain'),
        'access callback' => 'cassiopeia_guest_post_accept',
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['guest-post/domain/change/booking/payment/%cassiopeia_guest_post_domain_change_booking'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_domain_change_booking_payment_page_callback',
        'page arguments' => array(5),
        'title' => t('Thanh toán'),
        'access callback' => 'cassiopeia_guest_post_accept',
        'file' => 'cassiopeia_guest_post.inc',
    );

    $items['guest-post/domain'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_domain_page_callback',
        'title' => t('Domain'),
        'access callback' => 'cassiopeia_guest_post_accept',
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['guest-post/website'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_website_page_callback',
        'title' => t('Website'),
        'access callback' => 'cassiopeia_guest_post_accept',
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['guest-post/website/add'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_website_add_page_callback',
        'title' => t('Thêm Website'),
        'access callback' => 'cassiopeia_guest_post_accept',
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['guest-post/article'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_article_callback',
        'title' => t('Danh sách guest post'),
        'access callback' => 'cassiopeia_guest_post_accept',
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['guest-post/article/%cassiopeia_guest_post_article/re-post'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_article_re_post_callback',
        'page arguments' => array(2),
        'title' => t('Đăng guest post'),
        'access callback' => 'cassiopeia_guest_post_accept',
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['guest-post/article/add'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_article_add_callback',
        'title' => t('Đăng guest post'),
        'access callback' => 'cassiopeia_guest_post_article_add_accept',
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['guest-post/article/%cassiopeia_guest_post_article/edit'] = array(
        'type' => MENU_CALLBACK,
        'page callback' => 'cassiopeia_guest_post_article_edit_callback',
        'page arguments' => array(2),
        'title' => t('Đăng guest post'),
        'access callback' => 'cassiopeia_guest_post_article_edit_accept',
        'access arguments' => array(2),
        'file' => 'cassiopeia_guest_post.inc',
    );
    $items['cassiopeia_guest_post/ajax'] = array(
        'type'              => MENU_CALLBACK,
        'page callback'     => 'cassiopeia_guest_post_ajax_page',
        'delivery callback' => 'drupal_json_output',
        'access callback' => 'cassiopeia_guest_post_accept',
        'file'              => 'cassiopeia_guest_post.inc',
    );
    return $items;
}
function cassiopeia_guest_post_domain_search_form($form,&$form_state){
    global $user;
    $form['#cache'] = !empty($form_state['values'])?$form_state['values']:array();
    $form_state['#page'] = !empty($form_state['#page'])?$form_state['#page']:1;
    if(!empty($form_state['complete form']['#cache'])&&$form_state['complete form']['#cache']['num_per_page']!=$form_state['values']['num_per_page']){
        $form_state['#page'] = 1;
    }
    $form_wrapper = "cassiopeia-guest-post-domain-search-form-wrapper";
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    $form['#attributes'] = array("class"=>array("cassiopeia-guest-post-domain-search-form"));
    $form['#values'] = !empty($form_state['values'])?$form_state['values']:array();
    $form['sort_by'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'domain' => t('Tên đơn vị'),
            'article_count' => t('Website'),
            'backlink_count' => t('Giá niêm yết'),
            'status' => t('Khuyến mại'),
            'changed' => t('Giá ưu đãi'),
        ),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_domain_search_form_ajax_callback',
            'wrapper' => $form_wrapper,
        ),
        '#default_value' => 'status',
        '#required' => TRUE,
        '#attributes' => array("class"=>array("hidden"))
    );
    $form['sort_direction'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'ASC' => t('ASC'),
            'DESC' => t('DESC'),
        ),
        '#default_value' => 'DESC',
        '#attributes' => array("class"=>array("hidden"))
    );
    $form['#attached']['js'] = array(
        drupal_get_path("module","cassiopeia_guest_post")."/js/cassiopeia-guest-post-domain-search-form.js"
    );
    $form['keyword'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#theme_wrappers' => array(),
        '#attributes'   => array("placeholder"=>"Tìm kiếm domain...","class"=>array("seo-input "))
    );
    $form['search'] = array(
        '#type'     =>'button',
        '#value'    => '<i class="fa fa-search"></i>',
        '#attributes'   => array("class"=>array("color-green border-none bg-grey btn-search")),
        '#submit'   => array('cassiopeia_guest_post_domain_search_form_submit'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_domain_search_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    try{
        $cache = $form['#cache'];
        $form['#limit'] = $limit = !empty($form_state['values']['num_per_page'])?$form_state['values']['num_per_page']:10;
        $form['#page'] = $page =  $form_state['#page'];
        $start = ($page-1)*$limit;
        $query = db_select("cassiopeia_guest_post_domain","cassiopeia_guest_post_domain");
        $query->fields("cassiopeia_guest_post_domain");
        $query->condition("cassiopeia_guest_post_domain.uid",$user->uid);
        if(!empty($cache['keyword'])){
            $query->condition("cassiopeia_guest_post_domain.domain","%".$cache['keyword']."%","LIKE");
        }
        $form['#sort_direction'] = $sort_direction = !empty($form_state['values']['sort_direction'])?$form_state['values']['sort_direction']:"DESC";
        $sort_by = !empty($form_state['values']['sort_by'])?$form_state['values']['sort_by']:"status";
        $sort_by_column = "cassiopeia_guest_post_domain.".$sort_by;
        $query->orderBy($sort_by_column,$sort_direction);


        $total_query = db_select($query,"tbl_total");
        $total_query->addExpression("COUNT(id)","total");
        $total_result = $total_query->execute()->fetchObject();
        $total_page = ceil($total_result->total/$limit);

        $query->range($start,$limit);
        $domains = $query->execute()->fetchAll();
        $form['#domains'] = $domains;
        $form['#total_result'] = $total_result;
    }catch (Exception $e){
        _print_r($e);
    }
    $form['page'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#theme_wrappers' => array(),
        '#attributes'   => array("class"=>array("hidden")),
        '#value'    => $form_state['#page']
    );
    $form['num_per_page'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            10 => 10,
            50 => 50,
            100 => 100,
            200 => 200,
        ),
        '#default_value' => 1,
        '#theme_wrappers' => array(),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_search_form_num_per_page_change_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    if($form_state['#page']==1){
        $form['prev'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-left" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none"),"disabled"=>"disabled","readonly"=>"readonly"),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_prev_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_prev_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['prev'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-left" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none")),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_prev_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_prev_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }
    if($form_state['#page']>=$total_page){
        $form['next'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-right" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none"),"disabled"=>"disabled","readonly"=>"readonly"),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_next_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_next_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['next'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-right" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none")),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_next_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_next_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }
    return $form;
}
function cassiopeia_guest_post_domain_search_form_submit($form,&$form_state){
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_domain_search_form_ajax_submit($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_domain_search_form_ajax_callback($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_complain_search_form($form,&$form_state){
    global $user;
    $form['#cache'] = !empty($form_state['values'])?$form_state['values']:array();
    $form_wrapper = "cassiopeia-guest-post-complain-search-form-wrapper";
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    $form['#attributes'] = array("class"=>array("cassiopeia-guest-post-article-search-form advanced-filter"));
    $form_state['#page'] = !empty($form_state['#page'])?$form_state['#page']:1;
    if(!empty($form_state['complete form']['#cache'])&&$form_state['complete form']['#cache']['num_per_page']!=$form_state['values']['num_per_page']){
        $form_state['#page'] = 1;
    }
    $form['sort_by'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'title' => t('Tên đơn vị'),
            'ref_domain' => t('Website'),
            'organic_traffic' => t('Giá niêm yết'),
            'posted' => t('Khuyến mại'),
            'posted_of_day' => t('Giá ưu đãi'),
            'last_posted_date' => t('Số điện thoại'),
        ),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
        '#default_value' => 'changed',
        '#required' => TRUE,
        '#attributes' => array("class"=>array("hidden"))
    );
    $form['sort_direction'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'ASC' => t('ASC'),
            'DESC' => t('DESC'),
        ),
        '#default_value' => 'DESC',
        '#attributes' => array("class"=>array("hidden"))
    );

    $form['#limit'] = $limit = !empty($form_state['values']['num_per_page'])?$form_state['values']['num_per_page']:10;
    $form['#page'] = $page =  $form_state['#page'];
    $start = ($page-1)*$limit;
    $cache = !empty($form['#cache'])?$form['#cache']:null;

    $form['keyword'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#theme_wrappers' => array(),
        '#attributes'   => array("placeholder"=>"Từ khóa tìm kiếm...","class"=>array("seo-input "))
    );
    $form['search'] = array(
        '#type'     =>'button',
        '#value'    => '<i class="fa fa-search"></i>',
        '#attributes'   => array("class"=>array("color-green border-none bg-grey btn-search")),
        '#submit'   => array('cassiopeia_guest_post_complain_search_form_submit'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_complain_search_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    $form['author'] = array(
        '#type' => 'radios',
        '#title' => t(''),
        '#options' => array(
            1 => t('Yêu cầu khiếu nại'),
            2 => t('Bị khiếu nại'),
        ),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_search_form_ajax_submit',
            'wrapper' => $form_wrapper,
            'progress' => "none",
        ),
        '#default_value' => 1
    );

    $form['status'] = array(
        '#type' => 'select',
        '#title' => t('Trạng thái'),
        '#options' => array(
            'all' => t('Tất cả'),
            '0' => t('Admin đang kiểm tra'),
            '1' => t('Thành công'),
            '2' => t('Đã hủy'),
            '3' => t('Thất bại'),
        ),
        '#default_value' => 'all',
    );
    $form['search_2'] = array(
        '#type'     =>'button',
        '#value'    => 'Lọc',
        '#attributes'   => array("class"=>array("btn-green border-none btn-small")),
        '#submit'   => array('cassiopeia_guest_post_complain_search_form_submit'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_complain_search_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    $form['#attached']['js'] = array(
        drupal_get_path("module","cassiopeia_guest_post")."/js/cassiopeia-guest-post-article-search-form.js"
    );
    $form['complain_add'] = array(
        '#type'     =>'submit',
        '#value'    => '<i class="fa fa-plus"></i> Khiếu nại',
        '#name'    => 'article_add',
        '#attributes'   => array("class"=>array("btn-green border-none")),
        '#submit'   => array('cassiopeia_guest_post_complain_search_form_complain_add_submit'),
//        '#validate'   => array('cassiopeia_guest_post_website_export_form_validate'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_complain_search_form_complain_add_ajax_submit',
        ),
    );
    $author = !empty($form_state['values']['author'])?$form_state['values']['author']:1;
    try{
        $query = db_select("cassiopeia_guest_post_complain","cassiopeia_guest_post_complain");
        $query->fields("cassiopeia_guest_post_complain");

        $query->join("cassiopeia_guest_post_article","cassiopeia_guest_post_article","cassiopeia_guest_post_article.id=cassiopeia_guest_post_complain.aid");

        $query->orderBy("cassiopeia_guest_post_complain.created","DESC");
        if($author==1){ // bài đã đăng
            $query->condition("cassiopeia_guest_post_complain.uid",$user->uid);
        }else{ // bài của khách
            $query->condition("cassiopeia_guest_post_complain.target_id",$user->uid);
        }
        if(!empty($cache['keyword'])){
            $or = db_or();
            $or->condition("cassiopeia_guest_post_complain.title","%".$cache['keyword']."%","LIKE");
            $or->condition("cassiopeia_guest_post_article.title","%".$cache['keyword']."%","LIKE");
            $query->condition($or);
        }
        if(isset($cache['status'])&&$cache['status']!="all"){
            $query->condition("cassiopeia_guest_post_complain.status",$cache['status']);
        }
        $query->groupBy("cassiopeia_guest_post_complain.id");

        $sort_by = !empty($form_state['values']['sort_by'])?$form_state['values']['sort_by']:"changed";
        $form['#sort_direction'] = $sort_direction = !empty($form_state['values']['sort_direction'])?$form_state['values']['sort_direction']:"DESC";
        $sort_by_column = "cassiopeia_guest_post_complain.".$sort_by;
        $query->orderBy($sort_by_column,$sort_direction);

        $total_query = db_select($query,"tbl_total");
        $total_query->addExpression("COUNT(id)","total");
        $total_result = $total_query->execute()->fetchObject();

        $query->range($start,$limit);
        $nodes = $query->execute()->fetchAll();
        $total_page = ceil($total_result->total/$limit);
        $form['#nodes'] = $nodes;
        $form['#total_result'] = $total_result;
    }catch (Exception $e){

    }

    $form['page'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#theme_wrappers' => array(),
        '#attributes'   => array("class"=>array("hidden")),
        '#value'    => $form_state['#page']
    );
    $form['num_per_page'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            10 => 10,
            50 => 50,
            100 => 100,
            200 => 200,
        ),
        '#default_value' => 1,
        '#theme_wrappers' => array(),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_search_form_num_per_page_change_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    if($form_state['#page']==1){
        $form['prev'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-left" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none"),"disabled"=>"disabled","readonly"=>"readonly"),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_prev_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_prev_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['prev'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-left" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none")),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_prev_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_prev_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }
    if($form_state['#page']>=$total_page){
        $form['next'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-right" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none"),"disabled"=>"disabled","readonly"=>"readonly"),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_next_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_next_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['next'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-right" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none")),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_next_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_next_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }
    return $form;
}
function cassiopeia_guest_post_complain_search_form_complain_add_submit($form,&$form_state){
    global $user;
    $flag = true;
    $form_state['#error_message'] = array();
    if(!cassiopeia_guest_post_accept()){
        $form_state['#error_message'][] = "Tài khoản của bạn tạm thời bị khóa tính năng này!";
        $flag = false;
    }
    if($flag){
        if(!cassiopeia_guest_post_point_status_check()){
            $form_state['#error_message'][] = "Tài khoản của bạn tạm thời bị khóa tính năng này!";
            $flag = false;
        }
    }
    if($flag){
        $available_point = cassiopeia_guest_post_user_available_point_load($user->uid);
        if($available_point->point<20){
            $form_state['#error_message'][] = "Bạn không đủ điểm để thực hiện tính năng này!";
        }else{
            $form_state['#added'] = 1;
        }
    }else{
        $form_state['#error_message'][] = "Tài khoản của bạn tạm thời bị khóa tính năng này!";
    }
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_complain_search_form_complain_add_ajax_submit($form,&$form_state){
    if(!empty($form_state['#added'])){
        ctools_include('ajax');
        ctools_add_js('ajax-responder');
        $commands[] = ctools_ajax_command_redirect('guest-post/complain/add');
        print ajax_render($commands);
        exit;
    }else{
        ctools_include('ajax');

        $commands[] = ajax_command_invoke("","guestPostAlert",array(json_encode($form_state['#error_message'])));
        $form_state['#error_message'] = array();
        $form_state['rebuild'];
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }
}
function cassiopeia_guest_post_complain_search_form_submit($form,&$form_state){
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_complain_search_form_ajax_submit($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_article_search_form($form,&$form_state){
    global $user;
    $form['#cache'] = !empty($form_state['values'])?$form_state['values']:array();
    $form_wrapper = "cassiopeia-guest-post-article-search-form-wrapper";
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    $form['#attributes'] = array("class"=>array("cassiopeia-guest-post-article-search-form advanced-filter"));
    $form_state['#page'] = !empty($form_state['#page'])?$form_state['#page']:1;
    if(!empty($form_state['complete form']['#cache'])&&$form_state['complete form']['#cache']['num_per_page']!=$form_state['values']['num_per_page']){
        $form_state['#page'] = 1;
    }

    $form['sort_by'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'title' => t('Tên đơn vị'),
            'url_guest_post' => t('Website'),
            'organic_traffic' => t('Giá niêm yết'),
            'publish_date' => t('Khuyến mại'),
        ),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
        '#default_value' => 'publish_date',
        '#required' => TRUE,
        '#attributes' => array("class"=>array("hidden"))
    );
    $form['sort_direction'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'ASC' => t('ASC'),
            'DESC' => t('DESC'),
        ),
        '#default_value' => 'DESC',
        '#attributes' => array("class"=>array("hidden"))
    );
    $form['#attached']['js'] = array(
        drupal_get_path("module","cassiopeia_guest_post")."/js/cassiopeia-guest-post-article-search-form.js"
    );
    $form['keyword'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#theme_wrappers' => array(),
        '#attributes'   => array("placeholder"=>"Tìm kiếm bài viết...","class"=>array("seo-input "))
    );
    $form['search'] = array(
        '#type'     =>'button',
        '#value'    => '<i class="fa fa-search"></i>',
        '#attributes'   => array("class"=>array("color-green border-none bg-grey btn-search")),
        '#submit'   => array('cassiopeia_guest_post_article_search_form_submit'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_search_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    $form['author'] = array(
        '#type' => 'radios',
        '#title' => t(''),
        '#options' => array(
            1 => t('Bài đã đăng'),
            2 => t('Bài của khách'),
        ),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_search_form_ajax_submit',
            'wrapper' => $form_wrapper,
            'progress' => "none",
        ),
        '#default_value' => 1
    );
    $form['from_date'] = array(
        '#type' => 'date_popup',
        '#default_value' => !empty($cache['from_date'])?$cache['from_date']:"",
        '#date_type' => DATE_DATETIME,
        '#date_timezone' => date_default_timezone(),
        '#date_format' => 'd-m-Y',
        '#date_increment' => 1,
        '#date_year_range' => '-10:+10',
        '#attributes' => array( "class" => array("form_date"),"placeholder"=>"dd/mm/yyyy"),
    );
    if(!empty($cache['from_date'])){
        $form['from_date']['#default_value'] = $cache['from_date'];
    }
    $form['to_date'] = array(
        '#type' => 'date_popup',
        '#default_value' => !empty($cache['to_date'])?$cache['to_date']:"",
        '#date_type' => DATE_DATETIME,
        '#date_timezone' => date_default_timezone(),
        '#date_format' => 'd-m-Y',
        '#date_increment' => 1,
        '#date_year_range' => '-10:+10',
        '#attributes' => array( "class" => array("to_date"),"placeholder"=>"dd/mm/yyyy"),
    );
    $query = db_select("cassiopeia_guest_post_tag","cassiopeia_guest_post_tag");
    $query->fields("cassiopeia_guest_post_tag");
    $query->condition("uid",$user->uid);
    $tags = $query->execute()->fetchAll();
    $tag_options = array();
    $tag_options['all'] = "Tất cả";
    if(!empty($tags)){
        foreach($tags as $tag){
            $tag_options[$tag->id] = $tag->title;
        }
    }
    $form['tag'] = array(
        '#type' => 'select',
        '#title' => t('Tag'),
        '#options' =>$tag_options,
    );
    $form['search_2'] = array(
        '#type'     =>'button',
        '#value'    => 'Lọc',
        '#attributes'   => array("class"=>array("btn-green border-none btn-small")),
        '#submit'   => array('cassiopeia_guest_post_website_search_form_submit'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_search_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    $form['export'] = array(
        '#type'     =>'submit',
        '#value'    => 'Xuất báo cáo',
        '#attributes'   => array("class"=>array("btn-green border-none btn-small")),
        '#submit'   => array('cassiopeia_guest_post_article_search_form_export_form_submit'),
//        '#validate'   => array('cassiopeia_guest_post_website_export_form_validate'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_search_form_export_form_ajax_submit',
        ),
    );
    $form['article_add'] = array(
        '#type'     =>'submit',
        '#value'    => '<i class="fa fa-plus"></i> Đăng bài guest post',
        '#name'    => 'article_add',
        '#attributes'   => array("class"=>array("btn-green border-none")),
        '#submit'   => array('cassiopeia_guest_post_article_search_form_article_add_submit'),
//        '#validate'   => array('cassiopeia_guest_post_website_export_form_validate'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_search_form_article_add_ajax_submit',
        ),
    );
    $author = !empty($form_state['values']['author'])?$form_state['values']['author']:1;
    $form['#limit'] = $limit = !empty($form_state['values']['num_per_page'])?$form_state['values']['num_per_page']:10;
    $form['#page'] = $page =  $form_state['#page'];
    $start = ($page-1)*$limit;
    $cache = !empty($form['#cache'])?$form['#cache']:null;
    try{
        $query = db_select("cassiopeia_guest_post_article","cassiopeia_guest_post_article");
        $query->fields("cassiopeia_guest_post_article");
//        $query->orderBy("cassiopeia_guest_post_article.created","DESC");
        if($author==1){ // bài đã đăng
            $query->condition("cassiopeia_guest_post_article.uid",$user->uid);
        }else{ // bài của khách
            $website_query = db_select("cassiopeia_guest_post_website","cassiopeia_guest_post_website");
            $website_query->fields("cassiopeia_guest_post_website");
            $website_query->condition("cassiopeia_guest_post_website.uid",$user->uid);
            $query->join($website_query,"tbl_website","tbl_website.id=cassiopeia_guest_post_article.website");
            $query->condition("cassiopeia_guest_post_article.uid",$user->uid,"<>");

        }
        if(!empty($cache['keyword'])){
            $or = db_or();
            $or->condition("cassiopeia_guest_post_article.title","%".$cache['keyword']."%","LIKE");
            $query->condition($or);
        }
        if(!empty($cache['from_date'])){
            $query->condition("cassiopeia_guest_post_article.publish_date",strtotime(date("d-m-Y 00:00:00",strtotime($cache['from_date']))),">=");
        }
        if(!empty($cache['to_date'])){
            $query->condition("cassiopeia_guest_post_article.publish_date",strtotime(date("d-m-Y 23:59:59",strtotime($cache['to_date']))),"<=");
        }
        if(!empty($cache['tag'])&&$cache['tag']!="all"){
            $tag_query = db_select("cassiopeia_guest_post_article_tag","cassiopeia_guest_post_article_tag");
            $tag_query->fields("cassiopeia_guest_post_article_tag");
            $tag_query->condition("cassiopeia_guest_post_article_tag.tid",$cache['tag']);
            $tag_query->condition("cassiopeia_guest_post_article_tag.uid",$user->uid);

            $query->join($tag_query,"tbl_tag","tbl_tag.aid = cassiopeia_guest_post_article.id");
        }
        $query->groupBy("cassiopeia_guest_post_article.id");

        $sort_by = !empty($form_state['values']['sort_by'])?$form_state['values']['sort_by']:"created";
        $form['#sort_direction'] = $sort_direction = !empty($form_state['values']['sort_direction'])?$form_state['values']['sort_direction']:"DESC";
        $sort_by_column = "cassiopeia_guest_post_article.".$sort_by;
        $query->orderBy($sort_by_column,$sort_direction);

        $total_query = db_select($query,"tbl_total");
        $total_query->addExpression("COUNT(id)","total");
        $total_result = $total_query->execute()->fetchObject();

        $query->range($start,$limit);
        $nodes = $query->execute()->fetchAll();
        $total_page = ceil($total_result->total/$limit);
        $form['#nodes'] = $nodes;
        $form['#total_result'] = $total_result;
    }catch (Exception $e){
        _print_r($e);
    }

    $form['page'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#theme_wrappers' => array(),
        '#attributes'   => array("class"=>array("hidden")),
        '#value'    => $form_state['#page']
    );
    $form['num_per_page'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            10 => 10,
            50 => 50,
            100 => 100,
            200 => 200,
        ),
        '#default_value' => 1,
        '#theme_wrappers' => array(),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_search_form_num_per_page_change_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    if($form_state['#page']==1){
        $form['prev'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-left" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none"),"disabled"=>"disabled","readonly"=>"readonly"),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_prev_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_prev_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['prev'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-left" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none")),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_prev_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_prev_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }
    if($form_state['#page']>=$total_page){
        $form['next'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-right" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none"),"disabled"=>"disabled","readonly"=>"readonly"),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_next_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_next_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['next'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-right" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none")),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_next_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_next_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }
    return $form;
}
function cassiopeia_guest_post_article_search_form_article_add_submit($form,&$form_state){
    if(cassiopeia_guest_post_article_add_accept()){
        $form_state['#added'] = 1;
    }
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_article_search_form_article_add_ajax_submit($form,&$form_state){
    if(!empty($form_state['#added'])){
        ctools_include('ajax');
        ctools_add_js('ajax-responder');
        $commands[] = ctools_ajax_command_redirect('guest-post/article/add');
        print ajax_render($commands);
        exit;
    }else{
        $form_state['#error_message'][] = "Tài khoản của bạn tạm thời bị khóa tính năng này!";
        ctools_include('ajax');

        $commands[] = ajax_command_invoke("","guestPostAlert",array(json_encode($form_state['#error_message'])));
        $form_state['#error_message'] = array();
        $form_state['rebuild'];
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }
}

function cassiopeia_guest_post_article_search_form_export_form_ajax_submit($form,&$form_state){
    if(!empty($form_state['#export_empty'])&&$form_state['#export_empty']==TRUE){
        ctools_include('ajax');

        $commands[] = ajax_command_invoke("","guestPostExportEmpty",array(json_encode($form_state['#export_empty'])));
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }else{
//        _print_r($form_state['#export']);
//        ctools_include('ajax');
//        ctools_add_js('ajax-responder');
        ctools_include('ajax');
        ctools_add_js('ajax-responder');
        $commands[] = ctools_ajax_command_redirect('excel/download/'.$form_state['#export']['name']);
//        $commands[] = ctools_ajax_command_redirect('user/manager/topup');
        print ajax_render($commands);
        exit;
    }
}
function cassiopeia_guest_post_article_search_form_export_form_submit($form,&$form_state){
    if(empty($_REQUEST['id'])){
        $form_state['#export_empty'] = TRUE;
    }else{
        $form_state['#export_empty'] = FALSE;
    }
    $form_state['rebuild'] = TRUE;
    if(!empty($_REQUEST['id'])){
        $form_state['#export'] = cassiopeia_guest_post_create_article_export($_REQUEST['id']);
    }
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_article_search_form_ajax_submit($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_article_search_form_submit($form,&$form_state){
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_admin_manager_website_search_form($form,&$form_state){
    $form['#cache'] = !empty($form_state['values'])?$form_state['values']:array();
    $form_wrapper = "cassiopeia-guest-post-admin-manager-website-search-form-wrapper";
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    $form['#attributes'] = array("class"=>array("cassiopeia-guest-post-admin-manager-website-search-form"));
    $form['sort_by'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'raw_title' => t('Tên đơn vị'),
            'raw_website' => t('Website'),
            'price' => t('Giá niêm yết'),
            'discount' => t('Khuyến mại'),
            'promotion_price' => t('Giá ưu đãi'),
            'tel' => t('Số điện thoại'),
            'email' => t('Email'),
        ),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_search_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
        '#default_value' => 'raw_title',
        '#required' => TRUE,
        '#attributes' => array("class"=>array("hidden"))
    );
    $form['sort_direction'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'ASC' => t('ASC'),
            'DESC' => t('DESC'),
        ),
        '#default_value' => 'ASC',
        '#attributes' => array("class"=>array("hidden"))
    );
    $form['keyword'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#theme_wrappers' => array(),
        '#attributes'   => array("placeholder"=>"Tìm kiếm website...","class"=>array("seo-input "))
    );

//    $categories =

    $form['search'] = array(
        '#type'     =>'button',
        '#value'    => '<i class="fa fa-search"></i>',
        '#attributes'   => array("class"=>array("color-green border-none bg-grey btn-search")),
        '#submit'   => array('cassiopeia_guest_post_website_search_form_submit'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_search_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    return $form;
}
function cassiopeia_guest_post_website_search_form($form,&$form_state){
    $form['#cache'] = !empty($form_state['values'])?$form_state['values']:array();
    $form_wrapper = "cassiopeia-guest-post-website-search-form-wrapper";
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    $form['#attributes'] = array("class"=>array("cassiopeia-guest-post-website-search-form advanced-filter"));
    $form_state['#page'] = !empty($form_state['#page'])?$form_state['#page']:1;
    if(!empty($form_state['complete form']['#cache'])&&$form_state['complete form']['#cache']['num_per_page']!=$form_state['values']['num_per_page']){
        $form_state['#page'] = 1;
    }

    $form['sort_by'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'domain' => t('Tên đơn vị'),
            'ref_domain' => t('Website'),
            'organic_traffic' => t('Giá niêm yết'),
            'posted' => t('Khuyến mại'),
            'posted_of_day' => t('Giá ưu đãi'),
            'last_posted_date' => t('Số điện thoại'),
        ),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_search_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
        '#default_value' => 'last_posted_date',
        '#required' => TRUE,
        '#attributes' => array("class"=>array("hidden"))
    );
    $form['sort_direction'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'ASC' => t('ASC'),
            'DESC' => t('DESC'),
        ),
        '#default_value' => 'DESC',
        '#attributes' => array("class"=>array("hidden"))
    );
    $form['keyword'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#theme_wrappers' => array(),
        '#attributes'   => array("placeholder"=>"Tìm kiếm website...","class"=>array("seo-input "))
    );
    $categories = cassiopeia_guest_post_website_category();
    $options = array();
    $options['all'] = "Tất cả";
    if(!empty($categories)){
        foreach($categories as $category){
            $options[$category->id] = $category->title;
        }
    }
    $form['category'] = array(
        '#title' => 'Lĩnh vực',
        '#type' => 'select',
        '#options' => $options,
    );
    if(!empty($form_state['values']['advanced_filter'])&&$form_state['values']['advanced_filter']!="all"){
        $form['min'] = array(
            '#type' => 'textfield',
            '#title' => t(''),
            '#size' => 60,
            '#maxlength' => 128,
            '#attributes' => array("placeholder"=>"Min","class"=>array("number-format"))
        );
        $form['max'] = array(
            '#type' => 'textfield',
            '#title' => t(''),
            '#size' => 60,
            '#maxlength' => 128,
            '#attributes' => array("placeholder"=>"Max","class"=>array("number-format"))
        );
    }
    $form['advanced_filter'] = array(
        '#title' => 'Lọc nâng cao',
        '#type' => 'select',
        '#options' => array(
            "all"   => "Tất cả",
            "ref_domain"    => "Ref domain",
            "organic_traffic"    => "Organic traffic",
            "posted"    => "Bài viết đã đăng",
            "posted_of_day"    => "Đã đăng trong ngày",
        ),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_search_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    $form['search'] = array(
        '#type'     =>'button',
        '#value'    => '<i class="fa fa-search"></i>',
        '#attributes'   => array("class"=>array("color-green border-none bg-grey btn-search")),
        '#submit'   => array('cassiopeia_guest_post_website_search_form_submit'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_search_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    $form['search_2'] = array(
        '#type'     =>'button',
        '#value'    => 'Lọc',
        '#attributes'   => array("class"=>array(" border-none btn-small btn-green")),
        '#submit'   => array('cassiopeia_guest_post_website_search_form_submit'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_search_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    $form['export'] = array(
        '#type'     =>'submit',
        '#value'    => 'Xuất báo cáo',
        '#attributes'   => array("class"=>array("btn-green border-none")),
        '#submit'   => array('cassiopeia_guest_post_website_export_form_submit'),
//        '#validate'   => array('cassiopeia_guest_post_website_export_form_validate'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_export_form_ajax_submit',
        ),
    );
    $form['#attached']['js'] = array(
        drupal_get_path('module', 'cassiopeia_guest_post') . '/js/cassiopeia-guest-post-website-search-form.js'
    );
    $form['#limit'] = $limit = !empty($form_state['values']['num_per_page'])?$form_state['values']['num_per_page']:10;
    $form['#page'] = $page =  $form_state['#page'];
    $start = ($page-1)*$limit;
    $cache = !empty($form['#cache'])?$form['#cache']:null;
    try{
        $query = db_select("cassiopeia_guest_post_website","cassiopeia_guest_post_website");
        $query->fields("cassiopeia_guest_post_website");
        $query->condition("cassiopeia_guest_post_website.status",1);
        if(!empty($cache['keyword'])){
            $query->condition("cassiopeia_guest_post_website.domain","%".$cache['keyword']."%","LIKE");
        }
        if(!empty($cache['advanced_filter'])&&$cache['advanced_filter']!="all"){
            if(!empty($cache['min'])){
                $query->condition($cache['advanced_filter'],$cache['min'],">=");
            }
            if(!empty($cache['max'])){
                $query->condition($cache['advanced_filter'],$cache['max'],"<=");
            }
        }
        if(!empty($cache['category'])&&$cache['category']!="all"){
            $query->join("cassiopeia_guest_post_website_field_tx_category","field_tx_category","field_tx_category.entity_id=cassiopeia_guest_post_website.id");
            $query->condition("field_tx_category.tid",$cache['category']);
        }
        $sort_by = !empty($form_state['values']['sort_by'])?$form_state['values']['sort_by']:"last_posted_date";
        $form['#sort_direction'] = $sort_direction = !empty($form_state['values']['sort_direction'])?$form_state['values']['sort_direction']:"DESC";
        $sort_by_column = "cassiopeia_guest_post_website.".$sort_by;
        $query->orderBy($sort_by_column,$sort_direction);

        $total_query = db_select($query,"tbl_total");
        $total_query->addExpression("COUNT(id)","total");
        $total_result = $total_query->execute()->fetchObject();

        $query->range($start,$limit);
        $websites = $query->execute()->fetchAll();
        $total_page = ceil($total_result->total/$limit);
        $form['#websites'] = $websites;
        $form['#total_result'] = $total_result;
    }catch (Exception $e){

    }
    $form['page'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#theme_wrappers' => array(),
        '#attributes'   => array("class"=>array("hidden")),
        '#value'    => $form_state['#page']
    );
    $form['num_per_page'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            10 => 10,
            50 => 50,
            100 => 100,
            200 => 200,
        ),
        '#default_value' => 1,
        '#theme_wrappers' => array(),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_search_form_num_per_page_change_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    if($form_state['#page']==1){
        $form['prev'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-left" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none"),"disabled"=>"disabled","readonly"=>"readonly"),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_prev_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_prev_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['prev'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-left" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none")),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_prev_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_prev_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }
    if($form_state['#page']>=$total_page){
        $form['next'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-right" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none"),"disabled"=>"disabled","readonly"=>"readonly"),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_next_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_next_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['next'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-right" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none")),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_next_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_next_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }
    $form['article_add'] = array(
        '#type'     =>'submit',
        '#value'    => '<i class="fa fa-plus"></i> Đăng bài guest post',
        '#name'    => 'article_add',
        '#attributes'   => array("class"=>array("btn-green border-none")),
        '#submit'   => array('cassiopeia_guest_post_article_search_form_article_add_submit'),
//        '#validate'   => array('cassiopeia_guest_post_website_export_form_validate'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_search_form_article_add_ajax_submit',
        ),
    );
    return $form;
}
function cassiopeia_guest_post_website_search_form_num_per_page_change_ajax_submit($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_website_search_form_next_page_ajax_submit($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_website_search_form_next_page_submit($form,&$form_state){
    $form_state['#page'] = $form_state['values']['page']+1;
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_website_search_form_prev_page_ajax_submit($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_website_search_form_prev_page_submit($form,&$form_state){
    $form_state['#page'] = $form_state['values']['page']-1;
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_website_search_form_ajax_submit($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_website_search_form_submit($form,&$form_state){
    $form_state['rebuild'] = TRUE;
}

function cassiopeia_guest_post_website_export_form_ajax_submit($form,&$form_state){
    if(!empty($form_state['#export_empty'])&&$form_state['#export_empty']==TRUE){
        ctools_include('ajax');

        $commands[] = ajax_command_invoke("","guestPostExportEmpty",array(json_encode($form_state['#export_empty'])));
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }else{
//        _print_r($form_state['#export']);
//        ctools_include('ajax');
//        ctools_add_js('ajax-responder');
        ctools_include('ajax');
        ctools_add_js('ajax-responder');
        $commands[] = ctools_ajax_command_redirect('excel/download/'.$form_state['#export']['name']);
//        $commands[] = ctools_ajax_command_redirect('user/manager/topup');
        print ajax_render($commands);
        exit;
    }
}
function cassiopeia_guest_post_website_export_form_validate($form,&$form_state){

}
function cassiopeia_guest_post_website_export_form_submit($form,&$form_state){
    if(empty($_REQUEST['id'])){
        $form_state['#export_empty'] = TRUE;
    }else{
        $form_state['#export_empty'] = FALSE;
    }
    $form_state['rebuild'] = TRUE;
    if(!empty($_REQUEST['id'])){
        $form_state['#export'] = cassiopeia_guest_post_create_website_export($_REQUEST['id']);
//        _print_r($form_state['#export']);
    }
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_theme($existing, $type, $theme, $path) {
    $themes = array(
        'cassiopeia_guest_post_website_search_form' => array(
            'render element' => 'form',
            'template' => 'cassiopeia_guest_post_website_search_form',
            'path' => drupal_get_path('module', 'cassiopeia_guest_post') . '/templates/forms'
        ),
        'cassiopeia_guest_post_article_form' => array(
            'render element' => 'form',
            'template' => 'cassiopeia_guest_post_article_form',
            'path' => drupal_get_path('module', 'cassiopeia_guest_post') . '/templates/forms'
        ),
        'cassiopeia_guest_post_article_search_form' => array(
            'render element' => 'form',
            'template' => 'cassiopeia_guest_post_article_search_form',
            'path' => drupal_get_path('module', 'cassiopeia_guest_post') . '/templates/forms'
        ),
        'cassiopeia_guest_post_admin_manager_website_search_form' => array(
            'render element' => 'form',
            'template' => 'cassiopeia_guest_post_admin_manager_website_search_form',
            'path' => drupal_get_path('module', 'cassiopeia_guest_post') . '/templates/forms'
        ),
        'cassiopeia_guest_post_domain_search_form' => array(
            'render element' => 'form',
            'template' => 'cassiopeia_guest_post_domain_search_form',
            'path' => drupal_get_path('module', 'cassiopeia_guest_post') . '/templates/forms'
        ),
        'cassiopeia_guest_post_domain_change_booking_form' => array(
            'render element' => 'form',
            'template' => 'cassiopeia_guest_post_domain_change_booking_form',
            'path' => drupal_get_path('module', 'cassiopeia_guest_post') . '/templates/forms'
        ),
        'cassiopeia_guest_post_domain_change_form' => array(
            'render element' => 'form',
            'template' => 'cassiopeia_guest_post_domain_change_form',
            'path' => drupal_get_path('module', 'cassiopeia_guest_post') . '/templates/forms'
        ),
        'cassiopeia_guest_post_complain_form' => array(
            'render element' => 'form',
            'template' => 'cassiopeia_guest_post_complain_form',
            'path' => drupal_get_path('module', 'cassiopeia_guest_post') . '/templates/forms'
        ),
        'cassiopeia_guest_post_complain_search_form' => array(
            'render element' => 'form',
            'template' => 'cassiopeia_guest_post_complain_search_form',
            'path' => drupal_get_path('module', 'cassiopeia_guest_post') . '/templates/forms'
        ),
        'cassiopeia_guest_post_order_content_search_form' => array(
            'render element' => 'form',
            'template' => 'cassiopeia_guest_post_order_content_search_form',
            'path' => drupal_get_path('module', 'cassiopeia_guest_post') . '/templates/forms'
        ),
        'cassiopeia_guest_post_article_re_post_form' => array(
            'render element' => 'form',
            'template' => 'cassiopeia_guest_post_article_re_post_form',
            'path' => drupal_get_path('module', 'cassiopeia_guest_post') . '/templates/forms'
        ),
        'cassiopeia_guest_post_point_exchange_form' => array(
            'render element' => 'form',
            'template' => 'cassiopeia_guest_post_point_exchange_form',
            'path' => drupal_get_path('module', 'cassiopeia_guest_post') . '/templates/forms'
        ),
    );
    return $themes;
}
function cassiopeia_guest_post_article_form($form,&$form_state,$data = array("article")){
    global $user;
    if(empty($form_state['#article'])){
        $form_state['#article'] = $article = !empty($data['article'])?$data['article']:null;
    }else{
        $article = $form_state['#article'];
    }
//    _print_r($form_state['#preview']);

    $form_state['#post_access'] = $post_access = false;
    $packet = cassiopeia_get_available_packet_by_uid($user->uid);
    if(!empty($packet)&&$packet->product!=BASIC){
        $form_state['#post_access'] = $post_access = true;
    }
    $_website = isset($_REQUEST['website'])?$_REQUEST['website']:null;
    $form['#preview'] = !empty($form_state['#preview'])?$form_state['#preview']:FALSE;
    $form_wrapper = "cassiopeia-guest-post-article-form-wrapper";
    $form['#attributes'] = array("class"=>array("cassiopeia-guest-post-article-form"));
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    $form['title'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#attributes'   => array("class"=>array("seo-input")),
        '#default_value' => !empty($article)?$article->title:"",
    );
    $form['content'] = array(
        '#type' => 'text_format',
        '#title' => t(''),
        '#format' => 'filtered_html',
        '#weight' => 0,
        '#default_value' => !empty($article)?$article->content:"",
    );
    $form['seo_title'] = array(
        '#type' => 'textfield',
        '#title' => t('Tiêu đề Seo'),
        '#size' => 60,
        '#maxlength' => 128,
        '#attributes'   => array("class"=>array("seo-input")),
        '#default_value' => !empty($article)?$article->seo_title:"",
    );
    $form['seo_description'] = array(
        '#type' => 'textarea',
        '#title' => t('Thẻ mô tả'),
        '#attributes' => array("class"=>array("no-grippie")),
        '#default_value' => !empty($article)?$article->seo_description:"",
    );
    $form['fb_image'] = array(
        '#title' => t('Facebook image'),
        '#type' => 'managed_file',
        '#upload_location' => 'public://guest-post/',
    );
    $form['fb_title'] = array(
        '#type' => 'textfield',
        '#title' => t('Facebook title'),
        '#size' => 60,
        '#maxlength' => 128,
        '#attributes'   => array("class"=>array("seo-input"))
    );
    $form['fb_description'] = array(
        '#type' => 'textarea',
        '#title' => t('Facebook description'),
        '#attributes'   => array("class"=>array("seo-input"))
    );
    $form['tags'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
//        '#attributes'   => array("class"=>array("seo-input")),
        '#attributes'    => array("class"=>array("tagify-input"), "placeholder"=> "Phân cách các thẻ Tag nhấn phím Enter"),
    );
    $form['image'] = array(
        '#title' => t('Ảnh đại diện'),
        '#type' => 'managed_file',
        '#upload_location' => 'public://guest-post/',
    );
    if(!empty($article)&&!empty($article->image)&&!empty($article->image->fid)){
        $form['image']['#default_value'] = $article->image->fid;
    }
    $form['duplicate_content'] = array(
        '#type' => 'container',
        '#tree' => TRUE,
    );
    $form['duplicate_content']['exclude_domains'] = array(
        '#type' => 'hidden',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#theme_wrappers' => array(),
        '#attributes'    => array("class"=>array("tagify-input seo-input"), "placeholder"=> "Phân cách các thẻ Tag nhấn phím Enter","readonly"=>"readonly","disabled"=>"disabled"),
    );
    $form['duplicate_content']['check'] = array(
        '#type'     =>'submit',
        '#value'    => 'Kiểm tra đạo văn',
        '#attributes'   => array("class"=>array("bg-green color-white border-none bold ml-12")),
        '#submit'   => array('cassiopeia_guest_post_article_form_save_draft_submit'),
        '#validate'   => array('cassiopeia_guest_post_article_form_save_draft_validate'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_form_duplicate_ajax_submit',
        ),
    );
    $form['outline_content'] = array(
        '#type' => 'container',
        '#tree' => TRUE,
    );
    $form['outline_content']['keyword'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#theme_wrappers' => array(),
        '#attributes'   => array("placeholder"=>"Nhập từ khóa chính của bài viết...","class"=>array("seo-input"))
    );
    $form['outline_content']['check'] = array(
        '#type'     =>'button',
        '#value'    => '<i class="fa fa-search"></i>',
        '#attributes'   => array("class"=>array("color-green border-none bg-grey btn-form-build")),
        '#submit'   => array('cassiopeia_guest_post_article_form_outline_content_submit'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_form_outline_content_ajax_submit',
            'wrapper' => $form_wrapper
        ),
    );
    $form['#attached']['js'] = array(
        drupal_get_path("module","cassiopeia_guest_post")."/js/cassiopeia-guest-post-article-form.js"
    );
    if($post_access){
        $form['save'] = array(
            '#type'     =>'submit',
            '#value'    => 'Lưu bài viết',
            '#attributes'   => array("class"=>array("bg-green color-white border-none btn-ajax btn-save-post")),
            '#submit'   => array('cassiopeia_guest_post_article_form_save_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_article_form_save_ajax_submit',
            ),
        );
    }
    $categories = cassiopeia_guest_post_website_category();
    $options = array();
    $websites = cassiopeia_guest_post_website_load_by_category("all");
    $options['all'] = "Tất cả lĩnh vực"." (".count($websites)." website)";;
    if(!empty($categories)){
        foreach($categories as $category){
            $websites = cassiopeia_guest_post_website_load_by_category($category->id);
            if(!empty($websites)){
                $options[$category->id] = $category->title." (".count($websites)." website)";
            }
        }
    }
    $form['category'] = array(
        '#title' => '',
        '#type' => 'select',
        '#options' => $options,
        '#default_value' => "all",
        '#chosen' => TRUE,
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_form_ajax_callback',
            'wrapper' => $form_wrapper,
            'progress' => "fullscreen",
        ),
        '#attributes'   => array("class"=>array("seo-input"))
    );
    $tid = !empty($form_state['values']['category'])?$form_state['values']['category']:"all";
    try{
        $websites = cassiopeia_guest_post_website_load_by_category($tid);
    }catch (Exception $e){
        $websites = array();
    }

    $options = array();
    $options['_none'] = "Chọn website";
    if(!empty($websites)){
        foreach($websites as $website){
            $options[$website->id] = $website->domain;
        }
    }
    $form['website'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => $options,
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_form_ajax_callback',
            'wrapper' => $form_wrapper,
            'progress' => "fullscreen",
        ),
        '#attributes'   => array("class"=>array("seo-input")),
        '#chosen' => TRUE,
//        '#default_value' => !empty($article)?$article->website:0
    );
    if(!empty($_website)){
        $form['website']['#default_value'] = $_website;
    }
    $_website = !empty($form_state['values']['website'])?($form_state['values']['website']):$_website;
    if(!empty($_website)&&$_website!="_none"){
        $wp_categories = cassiopeia_guest_post_category_load_by_website($_website);
        $options = array();
        if(!empty($wp_categories)){
            foreach($wp_categories as $wp_category){
                $options[$wp_category->tid] = $wp_category->title;
            }
            $form['wp_category'] = array(
                '#type' => 'checkboxes',
                '#title' => t(''),
                '#options' => $options,
            );
        }

    }
    $form['pre-save'] = array(
        '#type'     =>'submit',
        '#value'    => '<i class="fa-regular fa-bookmark"></i> Đăng bài viết',
        '#name'    => 'pre-save',
        '#attributes'   => array("class"=>array("bg-green color-white border-none btn-ajax btn-after")),
        '#submit'   => array('cassiopeia_guest_post_article_form_pre_save_submit'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_form_pre_save_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    if(!$form['#preview']){
        $form['preview'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa-regular fa-eye mr-5"></i> Xem trước',
            '#attributes'   => array("class"=>array("bg-green color-white border-none btn-ajax")),
            '#submit'   => array('cassiopeia_guest_post_article_form_preview_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_article_form_preview_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['return'] = array(
            '#type'     =>'submit',
            '#value'    => 'Quay lại',
            '#attributes'   => array("class"=>array("bg-green color-white border-none btn-ajax")),
            '#submit'   => array('cassiopeia_guest_post_article_form_return_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_article_form_return_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }
    $form['non_duplicate'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#attributes'   => array("class"=>array("hidden")),
    );
    $form['save_draft'] = array(
        '#type'     =>'submit',
        '#value'    => ' Lưu nháp',
        '#name'    => 'save-draft',
        '#icon'    => '',
        '#attributes'   => array("class"=>array("bg-green color-white border-none btn-ajax btn-after")),
        '#submit'   => array('cassiopeia_guest_post_article_form_save_draft_submit'),
        '#validate'   => array('cassiopeia_guest_post_article_form_save_draft_validate'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_form_save_draft_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    $form['#theme'] = array("cassiopeia_guest_post_article_form");
    return $form;
}
function cassiopeia_guest_post_article_form_save_draft_validate($form,&$form_state){
    global $user;
    if(!empty($form_state['values']['image'])){
        // Load the file via file.fid.
        $file = file_load($form_state['values']['image']);
        // Change status to permanent.
        $file->status = FILE_STATUS_PERMANENT;
        // Save.
        file_save($file);
        // Record that the module (in this example, user module) is using the file.
        file_usage_add($file, 'user', 'user', $user->uid);
    }
    if(!empty($file)){
        $form_state['#image'] = $file;
    }
//    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_article_form_save_draft_submit($form,&$form_state){
    global $user;
    try{
//        _print_r($form_state['values']);
//        die;
        $node = !empty($form_state['#article'])?$form_state['#article']:new stdClass();
        $node->title = !empty($form_state['values']['title'])?$form_state['values']['title']:"";
        $node->content = !empty($form_state['values']['content']['value'])?$form_state['values']['content']['value']:"";
        $node->image = !empty($form_state['#image'])?$form_state['#image']->fid:0;
        $node->uid = $user->uid;
        $node->website = !empty($form_state['values']['website'])?$form_state['values']['website']:"";
        $node->seo_title = !empty($form_state['values']['seo_title'])?$form_state['values']['seo_title']:"";
        $node->seo_description = !empty($form_state['values']['seo_description'])?$form_state['values']['seo_description']:"";
        $node->draft = 1;
        foreach($form_state['values']['wp_category'] as $_cat){
            if(!empty($_cat)){
                $node->wp_category = $form_state['values']['wp_category'];
            }
        }
        $_node = cassiopeia_guest_post_article_save($node);
        $form_state['#article'] = $_node;
        $form_state['rebuild'] = TRUE;
    }catch (Exception $e){
//        _print_r($e);
    }
}
function cassiopeia_guest_post_article_form_save_draft_ajax_submit($form,&$form_state){
    drupal_set_message("Lưu nháp thành công!");
    ctools_include('ajax');
    ctools_add_js('ajax-responder');
    $commands[] = ctools_ajax_command_redirect('guest-post/article');
    print ajax_render($commands);
    exit;
}
function cassiopeia_guest_post_article_pre_save_form($form,&$form_state){
//    $form['re-captcha'] = array(
//        '#type' => 'captcha',
//        '#captcha_type' => 'recaptcha/reCAPTCHA',
//    );
    $form_wrapper = "cassiopeia-guest-post-article-pre-save-form-wrapper";
    $form['#attributes'] = array("class"=>array("cassiopeia-guest-post-article-pre-save-form cassiopeia-guest-post-article-form"));
    $form['#prefix'] = "<div id='".$form_wrapper."'><p>Bạn <span class=\"color-red\"><b>không có quyền chỉnh sửa</b></span> khi bài viết đã đăng.</p>
                <p>Bạn có chắc chắn muốn đăng bài viết này không?</p>";
    $form['#suffix'] = "</div>";
    $form['#attached']['js'] = array(
        drupal_get_path("module","cassiopeia_guest_post")."/js/cassiopeia-guest-post-article-form.js"
    );
    $form['save'] = array(
        '#type'     =>'submit',
        '#value'    => 'Đồng ý đăng',
        '#attributes'   => array("class"=>array("bg-grey border-none btn-ajax btn-medium btn-default btn-final")),
        '#submit'   => array('cassiopeia_guest_post_article_pre_save_form_submit'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_pre_save_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
        '#prefix' => "<div class='d-flex justify-center mt-24'><button type=\"button\" class=\"btn btn-default btn-medium border-none bg-green color-white mr-10 btn-close-modal\" data-dismiss=\"modal\">Hủy</button>",
        '#suffix'   => "</div>"
    );
    return $form;
}

function cassiopeia_guest_post_article_pre_save_form_submit($form,&$form_state){
    $form_state['#added'] = 1;
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_article_pre_save_form_ajax_submit($form,&$form_state){
    if(!empty($form_state['#added'])){
        ctools_include('ajax');
        drupal_get_messages();
        $access = $form_state['#post_access']??array();
        $commands[] = ajax_command_invoke("","guestPostAddConfirmed",array(json_encode($access)));
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }else{
        drupal_get_messages();
        $commands[] = ajax_command_replace('#cassiopeia-guest-post-article-pre-save-form-wrapper', drupal_render($form));
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }
}
function cassiopeia_guest_post_article_form_pre_save_ajax_submit($form,&$form_state){
    ctools_include('ajax');
    $commands[] = ajax_command_invoke("","guestPostAddConfirm",array(json_encode($form_state['#post_access'])));
    return array(
        '#type'     => 'ajax',
        '#commands' => $commands,
    );
}
function cassiopeia_guest_post_article_form_pre_save_submit($form,&$form_state){
    global $user;
    if(!empty($form_state['values']['image'])){
        // Load the file via file.fid.
        $file = file_load($form_state['values']['image']);
        // Change status to permanent.
        $file->status = FILE_STATUS_PERMANENT;
        // Save.
        file_save($file);
        // Record that the module (in this example, user module) is using the file.
        file_usage_add($file, 'user', 'user', $user->uid);
    }
    if(!empty($file)){
        $form_state['#image'] = $file;
    }
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_article_form_ajax_callback($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_article_form_return_ajax_submit($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_article_form_return_submit($form,&$form_state){
    $form_state['#preview'] = FALSE;
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_article_form_preview_ajax_submit($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_article_form_preview_submit($form,&$form_state){
    $form_state['#preview'] = true;
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_article_form_outline_content_submit($form,&$form_state){
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_article_form_duplicate_submit($form,&$form_state){
    // to-do
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_article_form_duplicate_ajax_submit($form,&$form_state){
    ctools_include('ajax');

    $commands[] = ajax_command_invoke("","guestPostDuplicateContentCheck",array(json_encode($form_state['values']['content']['value'])));
    return array(
        '#type'     => 'ajax',
        '#commands' => $commands,
    );
}
function cassiopeia_guest_post_article_form_outline_content_ajax_submit($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_article_form_save_validate($form,&$form_state){
    global $user;
    if(empty(trim($form_state['values']['title']))){
        $form_state['#error_message'][] = "Bạn chưa nhập tiêu đề";
    }
    $available_point = cassiopeia_guest_post_user_available_point_load($user->uid);
    if($available_point->day_point<POINT_PER_ARTICLE&&$available_point->point<POINT_PER_ARTICLE){
        $form_state['#error_message'][] = "Bạn không đủ point để đăng bài mới!";
    }
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_article_send($article){
//    print_r($article);
//    die;
    $content = ($article->content);
    $article->content = "";
    $curl = curl_init();

//    curl_setopt( $curl, CURLOPT_ENCODING, "UTF-8" );
    curl_setopt_array($curl, array(
//        CURLOPT_URL => 'https://igem.vn/admin-ajax.php',
        CURLOPT_URL => $article->website_domain.'/wp-admin/admin-ajax.php',
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_ENCODING => 'UTF-8',
        CURLOPT_MAXREDIRS => 10,
        CURLOPT_TIMEOUT => 0,
        CURLOPT_FOLLOWLOCATION => true,
        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
        CURLOPT_CUSTOMREQUEST => 'POST',
        CURLOPT_POSTFIELDS => array('action' => 'seominisuite_add_article','node' => json_encode($article),"content"=>$content,"title"=>$article->title),
        CURLOPT_HTTPHEADER => array(
            'Cookie: IzqfAHoN=OV7GsJ%40S632uQY%5Bx; MtpXvTLhHc=fiZ2hobD; qfzTlIsNyv=AyC2vkL; tFkw_QpHJDxZOKeA=8nRzwafoM'
        ),
    ));
    $response = curl_exec($curl);

    curl_close($curl);
//  if(user_has_role(3)){
//    _print_r(array(
//      //        CURLOPT_URL => 'https://igem.vn/admin-ajax.php',
//      CURLOPT_URL => $article->website_domain.'/wp-admin/admin-ajax.php',
//      CURLOPT_RETURNTRANSFER => true,
//      CURLOPT_ENCODING => 'UTF-8',
//      CURLOPT_MAXREDIRS => 10,
//      CURLOPT_TIMEOUT => 0,
//      CURLOPT_FOLLOWLOCATION => true,
//      CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
//      CURLOPT_CUSTOMREQUEST => 'POST',
//      CURLOPT_POSTFIELDS => array('action' => 'seominisuite_add_article','node' => json_encode($article),"content"=>$content,"title"=>$article->title),
//      CURLOPT_HTTPHEADER => array(
//        'Cookie: IzqfAHoN=OV7GsJ%40S632uQY%5Bx; MtpXvTLhHc=fiZ2hobD; qfzTlIsNyv=AyC2vkL; tFkw_QpHJDxZOKeA=8nRzwafoM'
//      ),
//    ));
//    die;
//  }
    return(json_decode($response));
//    if($user->uid==DEV_UID){
//        _print_r(json_decode($response));die;
//    }
//    die;
//    print_r($article);
}
function cassiopeia_guest_post_article_form_save_ajax_submit($form,&$form_state){
  global $user;
//    $_SESSION['article'] = ($form_state['#article']);
//    _print_r($_SESSION['article']);
//    die;
//    _print_r($form_state['#added']);
    if(!empty($form_state['#added'])){
        ctools_include('ajax');
        $wp_post = cassiopeia_guest_post_article_send($form_state['#article']);
        if($user->uid==DEV_UID){
          _print_r($wp_post);
          die;
        }
//        print_r($wp_post);
        if(!empty($wp_post)&&!empty($wp_post->ID)){
            $node = cassiopeia_guest_post_article_load($form_state['#article']->id);
            $node->url_guest_post = $wp_post->guid;
            $node->publish_date = strtotime($wp_post->post_date);
            $node->post_status = $wp_post->post_status=="publish"?1:0;
            $node->post_id = $wp_post->ID;
            $node->re_post = 0;
            $file = file_load($node->image->fid);
            db_delete("file_managed")->condition("fid",$file->fid)->execute();
            drupal_unlink($file->uri);
            $node->image = 0;
            $node->is_new = true;
            cassiopeia_guest_post_article_save($node);
//            print_r($node);
            $data['response'] = "OK";
            drupal_set_message("Đăng bài thành công!");
            $log = new stdClass();
            $log->aid = $form_state['#article']->id;
            unset($wp_post->post_content);
            $log->wp_post = serialize($wp_post);
            cassiopeia_guest_post_article_log_save($log);
            ctools_add_js('ajax-responder');
            $commands[] = ctools_ajax_command_redirect('guest-post/article');
            print ajax_render($commands);
            exit;
        }else{
            cassiopeia_guest_post_article_delete($form_state['#article']->id);
            $commands[] = ajax_command_invoke("","guestPostAlert",array(json_encode(array(0=>" Đăng bài chưa thành công. Mời bạn đăng lại bài viết!"))));
        }
//        $commands[] = ajax_command_invoke("","guestPostArticleAdd",array(json_encode($form_state['#article'])));
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }else{
        if($form_state['#error_message']){
            ctools_include('ajax');
            $commands[] = ajax_command_invoke("","guestPostAlert",array(json_encode($form_state['#error_message'])));
        }else{
            drupal_get_messages();
            $commands[] = ajax_command_replace('#cassiopeia-guest-post-article-form-wrapper', drupal_render($form));
        }
        $form_state['#error_message'] = array();
        $form_state['rebuild'];
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }
}
function cassiopeia_guest_post_article_form_save_submit($form,&$form_state){
//    print_r($form_state['values']);
//    die;
    global $user;
    $flag = true;
    try{

        $form_state['#error_message'] = array();
        $raw_content = $form_state['values']['content']['value'];
        if(empty(trim($form_state['values']['title']))){
            $form_state['#error_message'][] = "Bạn chưa nhập tiêu đề!";
            $flag = false;
        }
        // kiểm tra ảnh đại diện
        if(empty($form_state['values']['image'])){
            $form_state['#error_message'][] = "Bạn chưa chọn ảnh đại diện!";
            $flag = false;
        }

        // check độ dài content
        $content = str_replace("<p>"," ",$raw_content);
        $content = str_replace("</p>"," ",$content);
        $content = str_replace("<br>"," ",$content);
        $content = str_replace("\n"," ",$content);
        $content = str_replace("&nbsp;"," ",$content);
        $content = strip_tags($content);
        $content = trim($content);
        $splitter = explode(" ",$content);
        $word_count = 0;
        foreach($splitter as $value){
            if(!empty(trim($value))){
                $word_count++;
            }
        }
        if($word_count<800){
            $form_state['#error_message'][] = "Nội dung độ dài ".$word_count." từ, không đạt hạn mức quy định!";
            $flag = false;
        }
        // check trùng lặp nội dung
        if($form_state['values']['non_duplicate']<95){
            $form_state['#error_message'][] = "Nội dung ".(100-$form_state['values']['non_duplicate'])."% trùng lặp, vượt quá hạn mức quy định!";
            $flag = false;
        }
        // kiểm tra số lượng bài viết trên cùng website
        $query = db_select("cassiopeia_guest_post_article","cassiopeia_guest_post_article");
        $query->fields("cassiopeia_guest_post_article");
        $query->condition("cassiopeia_guest_post_article.website",$form_state['values']['website']);
//        $query->condition("uid",$user->uid);
        $query->addExpression("COUNT(id)","total_article");
        $query->condition("cassiopeia_guest_post_article.created",array(strtotime(date("d-m-Y 00:00:00",REQUEST_TIME)),strtotime(date("d-m-Y 23:59:59",REQUEST_TIME))),"BETWEEN");
        $check = $query->execute()->fetchObject();
        if(!empty($check)&&$check->total_article>=5){
            $form_state['#error_message'][] = "Website đăng bài vượt quá 5 bài/ngày. Mời bạn chọn đăng trên website khác";
            $flag = false;
        }

        $available_point = cassiopeia_guest_post_user_available_point_load($user->uid);
        if($available_point->day_point<POINT_PER_ARTICLE&&$available_point->point<POINT_PER_ARTICLE){
            $form_state['#error_message'][] = "Bạn không đủ point để đăng bài mới!";
            $flag = false;
        }
        $list_of_domain = cassiopeia_guest_post_domain_load_by_user($user->uid);

        $domains = array();
        $doc = new DOMDocument();
        $doc->loadHTML('<?xml encoding="utf-8" ?>'.$raw_content);
        $a_tags = $doc->getElementsByTagName('a');
        $img_tags = $doc->getElementsByTagName('img');

        $total_domain = 0;
        foreach ($a_tags as $a_tag) {
            $_href = $a_tag->getAttribute('href');
            $domain = strtolower(cassiopeia_guest_post_domain_load_from_href($_href));
            if (array_key_exists($domain,$list_of_domain)){

            }else{
                $form_state['#error_message'][] = "Chỉ được chèn link trong danh sách domain của bạn!";
                $flag = false;
                break;
            }
            $domains[$domain] = !empty($domains[$domain])?$domains[$domain]+1:1;
            $total_domain++;
        }
//        _print_r($form_state['#error_message']);
        if($total_domain>2){
            $form_state['#error_message'][] = "Nội dung bài viết không đặt quá 2 External Links (Backlinks)!";
            $flag = false;
        }
        // check hình ảnh trong nội dung
        if($img_tags->length<1){
            $form_state['#error_message'][] = "Nội dung không có hình ảnh, không đạt theo quy định!";
            $flag = false;
        }
        if($form_state['values']['website']=="_none"){
            $form_state['#error_message'][] = "Bạn chưa chọn website!";
            $flag = false;
        }
        $categories = array();
        if(!empty($form_state['values']['wp_category'])){
            foreach($form_state['values']['wp_category'] as $_cat){
                if(!empty($_cat)){
                    $categories[] = $_cat;
                }
            }
        }
//        $flag = true;
        if(empty($categories)){
            $form_state['#error_message'][] = "Bạn chưa chọn danh mục đăng bài!";
            $flag = false;
        }
//        _print_r($form_state['values']);
        if($user->uid==31){
            $flag = true;
        }
        if($flag){
            if(!empty($domains)){
                foreach($domains as $_domain => $quantity){
                    $node = cassiopeia_guest_post_domain_load_by_domain($_domain);
                    $node->article_count = !empty($node->article_count)?$node->article_count+1:1;
                    $node->backlink_count = !empty($node->backlink_count)?$node->backlink_count+$quantity:$quantity;
                    cassiopeia_guest_post_domain_save($node);
                }
            }
        }
        if($user->uid==DEV_UID){
            $flag= true;
        }
        if($flag){
            $available_point = cassiopeia_guest_post_user_available_point_load($user->uid);
            if($available_point->day_point>=POINT_PER_ARTICLE||$available_point->point>=POINT_PER_ARTICLE){
                $node = !empty($form_state['#article'])?$form_state['#article']:new stdClass();
                $node->title = $form_state['values']['title'];
                $node->content = !empty($form_state['values']['content']['value'])?$form_state['values']['content']['value']:"";
                $node->image = !empty($form_state['#image'])?$form_state['#image']->fid:0;
                $node->uid = $user->uid;
                $node->website = $form_state['values']['website'];
                $node->draft = 0;
                $_node = cassiopeia_guest_post_article_save($node);

//                print_r($node);
                if(!empty($node->id)){
                    $article = cassiopeia_guest_post_article_load($node->id);
                    $website = cassiopeia_guest_post_website_load($node->website);
//                    _print_r($website);
//                    _print_r($node);
                    $article->website_domain = $website->domain;
                    foreach($form_state['values']['wp_category'] as $_cat){
                        if(!empty($_cat)){
                            $article->wp_category = $form_state['values']['wp_category'];
                        }
                    }
                    $form_state['#article'] = $article;
                    $form_state['#added'] = 1;
//                    $wp_post = cassiopeia_guest_post_article_send($form_state['#article']);
//                    print_r($wp_post);
//                    die;
                }
                if(!empty($form_state['values']['tags'])){
                    $tags = json_decode($form_state['values']['tags']);
                    foreach($tags as $tag){
                        $query = db_select("cassiopeia_guest_post_tag","cassiopeia_guest_post_tag");
                        $query->fields("cassiopeia_guest_post_tag");
                        $query->condition("title",$tag->value);
                        $query->condition("uid",$user->uid);
                        $_tag = $query->execute()->fetchObject();
                        if(empty($_tag)){
                            $_tag = new stdClass();
                            $_tag->uid = $user->uid;
                            $_tag->title = $tag->value;
                            $_tag = cassiopeia_guest_post_tag_save($_tag);
                        }
                        $article_tag = new stdClass();
                        $article_tag->created = REQUEST_TIME;
                        $article_tag->tid = $_tag->id;
                        $article_tag->aid = $node->id;
                        $article_tag->uid = $user->uid;
                        drupal_write_record("cassiopeia_guest_post_article_tag",$article_tag);
                    }
                }
            }else{
                $form_state['#NOT_ENOUGH_POINT'] = TRUE;
            }
        }
        $form_state['rebuild'] = TRUE;
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_category_form($form,&$form_state){
    $form['title'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#required' => TRUE,
    );
    $form['save'] = array(
        '#type'     =>'submit',
        '#value'    => 'Lưu',
    );
    return $form;
}
function cassiopeia_guest_post_category_form_submit($form,&$form_state){
    try{
        $node = new stdClass();
        $node->title = $form_state['values']['title'];
        $node->created = REQUEST_TIME;
        $node->changed = REQUEST_TIME;
        drupal_write_record("cassiopeia_guest_post_category",$node);
    }catch (Exception $e){
        _print_r($e);
        die;
    }
}
function cassiopeia_guest_post_website_category_form($form,&$form_state,$data = array("category")){
    $form['#category'] = $form_state['#category'] = !empty($data['category'])?$data['category']:new stdClass();
    $form['#attributes'] = array("class"=>array("cassiopeia-guest-post-admin-manager-website-category-form"));
    $form['title'] = array(
        '#type' => 'textfield',
        '#title' => t('Tiêu đề'),
        '#size' => 60,
        '#maxlength' => 128,
        '#required' => TRUE,
    );
    if(!empty($form['#category']->id)){
        $form['title']['#default_value'] = $form['#category']->title;
    }
    $form['submit'] = array(
        '#type'     =>'submit',
        '#value'    => 'Lưu',
    );
    return $form;
}
function cassiopeia_guest_post_website_category_form_submit($form,&$form_state){
    try{
        $node = $form_state['#category'];
        $node->title = $form_state['values']['title'];
        if(empty($node->id)){
            $node->created = REQUEST_TIME;
            $node->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_website_category",$node);
        }else{
            $node->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_website_category",$node,array("id"));
        }
    }catch (Exception $E){

    }
}
function cassiopeia_guest_post_user_point_edit_form($form,&$form_state,$data = array("account"=>null    )){
    $form_state['#account'] = $account = $data['account'];
    $available_point = cassiopeia_guest_post_user_available_point_load($account->uid);
    $form['point'] = array(
        '#type' => 'textfield',
        '#title' => t('Điểm tích lũy'),
        '#size' => 60,
        '#maxlength' => 128,
        '#required' => TRUE,
        '#default_value' => !empty($available_point)?$available_point->point:0,
    );
    $form['day_point'] = array(
        '#type' => 'textfield',
        '#title' => t('Điểm ngày'),
        '#size' => 60,
        '#maxlength' => 128,
        '#required' => TRUE,
        '#default_value' => !empty($available_point)?$available_point->day_point:0,
    );
    $form['save'] = array(
        '#type'     =>'submit',
        '#value'    => 'Lưu',
    );

    return $form;
}
function cassiopeia_guest_post_user_point_edit_form_submit($form,&$form_state){
    try{
        $point = cassiopeia_guest_post_user_point_load($form_state['#account']->uid);
        $day_point = cassiopeia_guest_post_user_day_point_load($form_state['#account']->uid);
        $point = !empty($point)?$point:new stdClass();
        $day_point = !empty($day_point)?$day_point:new stdClass();
        $point->point=$form_state['values']['point'];
        $point->note="admin cập nhật điểm";
        $day_point->point=$form_state['values']['day_point'];
        $day_point->note="admin cập nhật điểm";
        if(empty($point->id)){
            $point->uid = $form_state['#account']->uid;
        }
        if(empty($day_point->id)){
            $day_point->uid = $form_state['#account']->uid;
        }
        cassiopeia_guest_post_user_point_save($point);
        cassiopeia_guest_post_user_day_point_save($day_point);
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_user_domain_change_edit_form($form,&$form_state,$data = array("account"=>null    )){
    $form_state['#account'] = $account = $data['account'];
    $form_state['#domain_change'] = $domain_change = cassiopeia_guest_post_domain_change_load($account->uid);
    $form['remaining'] = array(
        '#type' => 'textfield',
        '#title' => t('Số lượt đổi domain còn lại'),
        '#size' => 60,
        '#maxlength' => 128,
        '#required' => TRUE,
        '#default_value' => !empty($domain_change)?$domain_change->remaining:0,
    );
    $form['save'] = array(
        '#type'     =>'submit',
        '#value'    => 'Lưu',
    );

    return $form;
}
function cassiopeia_guest_post_user_domain_change_edit_form_submit($form,&$form_state){
    try{
        $change = $form_state['#domain_change'];
        $change->total=$form_state['values']['remaining'];
        $change->remaining=$form_state['values']['remaining'];
        cassiopeia_guest_post_domain_change_save($change);
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_website_form($form,&$form_state,$data = array("website"=>null    )){
    $form['#website'] = $form_state['#website'] = !empty($data['website'])?$data['website']:new stdClass();
    $form['#attributes'] = array("class"=>array("cassiopeia-guest-post-website-form"));
    $form['domain'] = array(
        '#type' => 'textfield',
        '#title' => t('Domain'),
        '#size' => 60,
        '#maxlength' => 128,
        '#required' => TRUE,
    );
    $form['ref_domain'] = array(
        '#type' => 'textfield',
        '#title' => t('Ref domain'),
        '#size' => 60,
        '#maxlength' => 128,
    );
    $form['organic_traffic'] = array(
        '#type' => 'textfield',
        '#title' => t('Organic traffic'),
        '#size' => 60,
        '#maxlength' => 128,
    );
    $options = array();
    try {
        $query = db_select("users", "tbl_user");
        $query->fields("tbl_user");
        $query->join("users_roles", "tbl_role", "tbl_role.uid = tbl_user.uid");
//        $query->condition("tbl_role.rid", 4);
        $query->join("field_data_field_full_name", "field_full_name", "field_full_name.entity_id=tbl_user.uid");
        $query->addField("field_full_name", "field_full_name_value", "agent_transaction_name");
        $result = $query->execute()->fetchAll();
        foreach ($result as $row) {
            $options[$row->uid] = $row->name;
        }
    }catch (Exception $e) {

    }
    $form['user'] = array(
        '#title' => 'Tài khoản',
        '#type' => 'select',
        '#options' => $options,
        '#required' => TRUE
    );
    $categories = cassiopeia_guest_post_website_category();
    $options = array();
    if(!empty($categories)){
        foreach($categories as $category){
            $options[$category->id] = $category->title;
        }
    }
    $form['category'] = array(
        '#title' => 'Lĩnh vực',
        '#type' => 'select',
        '#options' => $options,
        '#required' => TRUE,
        '#multiple' => TRUE,
        '#chosen' => TRUE,
    );
    if(!empty($form['#website']->id)){
        $form['domain']['#default_value'] = $form['#website']->domain;
        $form['ref_domain']['#default_value'] = $form['#website']->ref_domain;
        $form['organic_traffic']['#default_value'] = $form['#website']->organic_traffic;
        $form['user']['#default_value'] = $form['#website']->uid;
        if(!empty($form['#website']->categories)){
            $default_value = array();
            foreach($form['#website']->categories as $category){
                $default_value[$category->tid] = $category->tid;
            }
            _print_r($default_value);
            $form['category']['#default_value'] = $default_value;
        }
    }
    $form['save'] = array(
        '#type'     =>'submit',
        '#value'    => 'Lưu',
    );
    $form['#attached']['js'] = array(
        drupal_get_path("module","cassiopeia_guest_post")."/js/cassiopeia-guest-post-website-form.js"
    );
    return $form;
}
function cassiopeia_guest_post_website_agent_process ($element, &$form_state, &$form) {
    $value = !empty($element['#value'])?$element['#value']:'';
    $element['#field_prefix'] ='<input name="tagify-agent" class="form-control tagify-agent" id="tagify-agent" value="'.check_plain($value).'">';
    return $element;
}

function cassiopeia_guest_post_website_form_submit($form,&$form_state){
    try{
        $node = $form_state['#website'];
        $node->domain = $form_state['values']['domain'];
        $node->ref_domain = $form_state['values']['ref_domain'];
        $node->organic_traffic = $form_state['values']['organic_traffic'];
        $node->uid = $form_state['values']['user'];
        $node->uid = $form_state['values']['user'];
        $node->category = $form_state['values']['category'];
        cassiopeia_guest_post_website_save($node);

    }catch (Exception $e){
        _print_r($e);
        die;
    }
}
function cassiopeia_guest_post_website_delete($node){
    $transaction = db_transaction();
    try{
        db_delete("cassiopeia_guest_post_website_field_tx_category")->condition("entity_id",$node->id)->execute();
        db_delete("cassiopeia_guest_post_website")->condition("id",$node->id)->execute();
        db_delete("cassiopeia_guest_post_user_day_point")->condition("uid",$node->uid)->execute();
        db_delete("cassiopeia_guest_post_user_point")->condition("uid",$node->uid)->execute();
    }catch (Exception $e){
        $transaction->rollback();
    }
}
function cassiopeia_guest_post_website_save($node){
    $point = cassiopeia_guest_post_user_point_load($node->uid);
    $day_point = cassiopeia_guest_post_user_day_point_load($node->uid);
    $point = !empty($point)?$point:new stdClass();
    $day_point = !empty($day_point)?$day_point:new stdClass();
    if(empty($point->id)){
        $point->uid = $node->uid;
    }
    if(empty($day_point->id)){
        $day_point->uid = $node->uid;
    }
    try{
//        $node->domain = str_replace("https","",$node->domain);
//        $node->domain = str_replace("http","",$node->domain);
//        $node->domain = str_replace("www.","",$node->domain);
//        $node->domain = str_replace("/","",$node->domain);
//        $node->domain = str_replace(":","",$node->domain);
        if(!empty($node->id)){
            $node->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_website",$node,array("id"));
            if(!empty($node->wp_check)&&$node->wp_check==1){
                if($node->status==0){
                    $point->status=0;
                    $day_point->status=0;
                }else{
                    $point->status=1;
                    $day_point->status=1;
                    if(!empty($node->wp_check)&& $node->wp_check==1&&$node->status!=0){
                        $point->uid = $node->uid;
                        if(empty($point->id)||$point->first!=1){
                            $point->first = 1;
                            $current_point = !empty($point->point)?$point->point:0;
                            $point->point = $current_point+POINT_PER_WEBSITE;
                            $point->note = "Tạo website mới (".$node->id.")";
                            $change = cassiopeia_guest_post_domain_change_load($node->uid);
                            $change->total+=1;
                            $change->remaining+=1;
                            cassiopeia_guest_post_domain_change_save($change);
                        }
                    }
                }
                cassiopeia_guest_post_user_point_save($point);
                if(!empty($day_point->id)){
                    cassiopeia_guest_post_user_day_point_save($day_point);
                }
            }
        }else{
            $node->created = REQUEST_TIME;
            $node->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_website",$node);
        }
        if(!empty($node->category)){
            db_delete("cassiopeia_guest_post_website_field_tx_category")->condition("entity_id",$node->id)->execute();
            $insert = db_insert("cassiopeia_guest_post_website_field_tx_category")->fields(array("tid","entity_id","uid","created","changed"));
            foreach($node->category as $item){
                $insert->values(array($item,$node->id,$node->uid,$node->created,$node->changed));
            }
            $insert->execute();
        }
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_user_point_load($uid){
    try{
        $query = db_select("cassiopeia_guest_post_user_point","cassiopeia_guest_post_user_point");
        $query->fields("cassiopeia_guest_post_user_point");
        $query->condition("uid",$uid);
        $result = $query->execute()->fetchObject();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_user_point_save($point){
    try{
        if(empty($point->point)){
            $point->point=0;
        }
        if(!empty($point->id)){
            $point->change = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_user_point",$point,array("id"));
        }else{
            $point->created = REQUEST_TIME;
            $point->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_user_point",$point);
        }
        $point_revision = new stdClass();
        $point_revision->created = REQUEST_TIME;
        $point_revision->changed = REQUEST_TIME;
        $point_revision->point = $point->point;
        $point_revision->note = !empty($point->note)?$point->note:"";
        $point_revision->uid = $point->uid;
        drupal_write_record("cassiopeia_guest_post_user_point_revision",$point_revision);
    }catch (Exception $e){

        return null;
    }
}
function cassiopeia_guest_post_user_day_point_load($uid){
    try{
        $query = db_select("cassiopeia_guest_post_user_day_point","cassiopeia_guest_post_user_day_point");
        $query->fields("cassiopeia_guest_post_user_day_point");
        $query->condition("uid",$uid);
        $result = $query->execute()->fetchObject();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_user_available_point_load($uid){
    $result = new stdClass();
    try{
        $day_point = cassiopeia_guest_post_user_day_point_load($uid);
        $result->day_point = !empty($day_point)?$day_point->point:0;
        $point = cassiopeia_guest_post_user_point_load($uid);
        $result->point = !empty($point)?$point->point:0;
        $result->point_status = !empty($point)?$point->status:1;
        $result->day_point_status = !empty($day_point)?$day_point->status:1;
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_order_content_load($id){
    try{
        $query = db_select("cassiopeia_guest_post_order_content","cassiopeia_guest_post_order_content");
        $query->fields("cassiopeia_guest_post_order_content");
        $query->condition("cassiopeia_guest_post_order_content.id",$id);
        $result = $query->execute()->fetchObject();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_user_day_point_delete($point){
    try{
        db_delete("cassiopeia_guest_post_user_day_point")->condition("uid",$point->uid)->execute();
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_user_day_point_save($point){
    try{
        if(empty($point->point)){
            $point->point = 0;
        }
        if(!empty($point->id)){
            $point->change = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_user_day_point",$point,array("id"));
        }else{
            $point->created = REQUEST_TIME;
            $point->change = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_user_day_point",$point);
        }
        $point_revision = new stdClass();
        $point_revision->created = REQUEST_TIME;
        $point_revision->changed = REQUEST_TIME;
        $point_revision->point = $point->point;
        $point_revision->note = $point->note;
        $point_revision->uid = $point->uid;
        drupal_write_record("cassiopeia_guest_post_user_day_point_revision",$point_revision);
    }catch (Exception $e){

        return null;
    }
}
function cassiopeia_guest_post_website_load_all(){
    try{
        $query = db_select("cassiopeia_guest_post_website","cassiopeia_guest_post_website");
        $query->fields("cassiopeia_guest_post_website");
        $result = $query->execute()->fetchAll();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_website_load_by_category($tid){
    try{
        $query = db_select("cassiopeia_guest_post_website","cassiopeia_guest_post_website");
        $query->fields("cassiopeia_guest_post_website");
        $query->condition("status",1);
        if($tid!="all"){
            $query->join("cassiopeia_guest_post_website_field_tx_category","cassiopeia_guest_post_website_field_tx_category","cassiopeia_guest_post_website_field_tx_category.entity_id=cassiopeia_guest_post_website.id");
            $query->condition("cassiopeia_guest_post_website_field_tx_category.tid",$tid);
        }
        $result = $query->execute()->fetchAll();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_admin_website_load_by_category($tid){
    try{
        $user_role_query = db_select("users","tbl_user");
        $user_role_query->fields("tbl_user");
        $user_role_query->join("users_roles","tbl_user_role","tbl_user_role.uid=tbl_user.uid");
        $user_role_query->condition("tbl_user_role.rid",3);

        $query = db_select("cassiopeia_guest_post_website","cassiopeia_guest_post_website");
        $query->fields("cassiopeia_guest_post_website");
        $query->join($user_role_query,"tbl_user_role","tbl_user_role.uid=cassiopeia_guest_post_website.uid");
        $query->condition("cassiopeia_guest_post_website.status",1);
        if($tid!="all"){
            $query->join("cassiopeia_guest_post_website_field_tx_category","cassiopeia_guest_post_website_field_tx_category","cassiopeia_guest_post_website_field_tx_category.entity_id=cassiopeia_guest_post_website.id");
            $query->condition("cassiopeia_guest_post_website_field_tx_category.tid",$tid);
        }
        $result = $query->execute()->fetchAll();
        return $result;
    }catch (Exception $e){
//        _print_r($e);
        return array();
    }
}

function cassiopeia_guest_post_website_load_by_uid($uid){
    try{
        $query = db_select("cassiopeia_guest_post_website","cassiopeia_guest_post_website");
        $query->fields("cassiopeia_guest_post_website");
        $query->condition("uid",$uid);
        $result = $query->execute()->fetchObject();

        return $result;
    }catch (Exception $e){
        _print_r($e);
        return null;
    }
}
function cassiopeia_guest_post_website_load($id){
    try{
        $query = db_select("cassiopeia_guest_post_website","cassiopeia_guest_post_website");
        $query->fields("cassiopeia_guest_post_website");
        $query->condition("id",$id);
        $result = $query->execute()->fetchObject();
        if(!empty($result)){
            $_query = db_select("cassiopeia_guest_post_website_field_tx_category","cassiopeia_guest_post_website_field_tx_category");
            $_query->fields("cassiopeia_guest_post_website_field_tx_category");

            $_query->join("cassiopeia_guest_post_website_category","cassiopeia_guest_post_website_category","cassiopeia_guest_post_website_category.id=cassiopeia_guest_post_website_field_tx_category.tid");
            $_query->addField("cassiopeia_guest_post_website_category","title","category");

            $_query->condition("entity_id",$result->id);
            $categories = $_query->execute()->fetchAll();
            if(!empty($categories)){
                $result->categories = $categories;
                $temp = array();
                foreach($categories as $category){
                    $temp[] = $category->category;
                }
                $result->list_of_category = implode(", ",$temp);
            }
        }
        return $result;
    }catch (Exception $e){
        _print_r($e);
        return null;
    }
}
function cassiopeia_guest_post_article_delete($id){
    try{
        db_delete("cassiopeia_guest_post_article")->condition("id",$id)->execute();
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_article_load($id){
    try{
        $query = db_select("cassiopeia_guest_post_article","cassiopeia_guest_post_article");
        $query->fields("cassiopeia_guest_post_article");
        $query->condition("id",$id);
        $result = $query->execute()->fetchObject();
        if(!empty($result->image)){
            $image = file_load($result->image);
            if(!empty($image)){
                $image_url = file_create_url($image->uri);
                $image->url = $image_url;
            }
            $result->image = !empty($image)?$image:null;
        }
        if(!empty($result)){
            $tags = cassiopeia_guest_post_article_tag_load($result->id);
            if(!empty($tags)){
                $result->tags =  $tags;
                $_tags = array();
                foreach($tags as $tag){
                    $_tags[$tag->id] = $tag->title;
                }
                $result->list_of_tag = implode(", ",$_tags);
            }
        }
        return $result;
    }catch (Exception $E){
        return null;
    }
}
function cassiopeia_guest_post_article_load_all(){
    try{
        $query = db_select("cassiopeia_guest_post_article","cassiopeia_guest_post_article");
        $query->fields("cassiopeia_guest_post_article");
        $query->orderBy("created","DESC");
        $result = $query->execute()->fetchAll();
        return $result;
    }catch (Exception $E){
        return null;
    }
}
function cassiopeia_guest_post_article_save($node){
    global $user;
    if($user->uid==1){
//        _print_r($node);
//        die;
    }
    try{
        $website = cassiopeia_guest_post_website_load($node->website);
        if(!empty($node->image)&&is_object($node->image)){
            $node->image = !empty($node->image->fid)?$node->image->fid:0;
        }
        if(!empty($node->id)){ // edit
            $node->change = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_article",$node,array("id"));
        }else{ // add new
            $node->created = REQUEST_TIME;
            $node->change = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_article",$node);
            if(empty($node->draft)){
                $website->last_posted_date = REQUEST_TIME;
                $website->posted +=1;

                $query = db_select("cassiopeia_guest_post_article","cassiopeia_guest_post_article");
                $query->fields("cassiopeia_guest_post_article");
                $query->condition("website",$website->id);
                $query->condition("created",array(strtotime(date("d-m-Y 00:00:00",REQUEST_TIME)),strtotime(date("d-m-Y 23:59:59"),REQUEST_TIME)),"BETWEEN");
                $query->addExpression("COUNT(id)","total");
                $check = $query->execute()->fetchObject();

                $website->posted_of_day = !empty($check)?$check->total:0;
                cassiopeia_guest_post_website_save($website);
            }
        }
        if($website->uid!=$node->uid&&empty($node->draft)){
            if($node->is_new){
                $day_point = cassiopeia_guest_post_user_day_point_load($node->uid);
                if(!empty($day_point)&&$day_point->point>=POINT_PER_ARTICLE){ // ưu tiền trừ điểm hàng ngày trước
                    $day_point->uid = $node->uid;
                    $current_point = !empty($day_point->point)?$day_point->point:0;
                    $day_point->point = $current_point-POINT_PER_ARTICLE;
                    $day_point->note = "Đăng bài viết (".$node->id.")";
                    cassiopeia_guest_post_user_day_point_save($day_point);
                }else{ // trừ point tích lũy
                    $point = cassiopeia_guest_post_user_point_load($node->uid);
                    $point = !empty($point)?$point:new stdClass();
                    $point->uid = $node->uid;
                    $current_point = !empty($point->point)?$point->point:0;
                    $point->point = $current_point-POINT_PER_ARTICLE;
                    $point->note = "Đăng bài viết (".$node->id.")";

                    cassiopeia_guest_post_user_point_save($point);
                }
                // cộng point cho chủ website

                $point = cassiopeia_guest_post_user_point_load($website->uid);
                $point = !empty($point)?$point:new stdClass();
                $point->uid = $website->uid;
                $current_point = !empty($point->point)?$point->point:0;
                $point->point = $current_point+10;
                $point->note = "Website có bài viét mới (".$node->id.")";
                cassiopeia_guest_post_user_point_save($point);
            }
        }
        return $node;
    }catch (Exception $E){
        return null;
    }
}
function cassiopeia_guest_post_tag_save($tag){
    try{
        if(!empty($tag->id)){
            drupal_write_record("cassiopeia_guest_post_tag",$tag,array("id"));
        }else{
            $tag->created = REQUEST_TIME;
            $tag->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_tag",$tag);
        }
        return $tag;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_article_tag_load($aid){
    try{
        $query = db_select("cassiopeia_guest_post_article_tag","cassiopeia_guest_post_article_tag");
        $query->fields("cassiopeia_guest_post_article_tag");
        $query->condition("cassiopeia_guest_post_article_tag.aid",$aid);
        $query->join("cassiopeia_guest_post_tag","cassiopeia_guest_post_tag","cassiopeia_guest_post_tag.id=cassiopeia_guest_post_article_tag.tid");
        $query->addField("cassiopeia_guest_post_tag","title","title");
        $result = $query->execute()->fetchAll();
        return $result;
    }catch (Exception $E){
        return array();
    }
}
function cassiopeia_guest_post_day_point_reset(){
    global $user;
    if(!empty($user->uid)){
        $day_point = cassiopeia_guest_post_user_day_point_load($user->uid);
        $reset = false;
        if(empty($day_point)){
            $reset = true;
        }else{
            $today = strtotime(date("d-m-Y 00:00:00",REQUEST_TIME));
            if($day_point->created<$today){
                $reset = true;
            }
        }
        if($reset==true){
            $websites = cassiopeia_guest_post_website_load_by_uid($user->uid);
            $day_point = !empty($day_point)?$day_point:new stdClass();
            $day_point->created = REQUEST_TIME;
            $day_point->uid = $user->uid;
            $day_point->note = "Reset điểm hàng ngày";
            if(!empty($websites)&&$websites->status==1){
                $day_point->point = POINT_PER_DAY;
            }else{
                $_account = user_load($user->uid);
                $point_per_day = !empty($_account->field_account_day_point['und'][0]['value'])?$_account->field_account_day_point['und'][0]['value']:0;
                $day_point->point = $point_per_day;

            }
            cassiopeia_guest_post_user_day_point_save($day_point);
        }
    }
}
function cassiopeia_guest_post_website_category_load($id){
    try{
        $query = db_select("cassiopeia_guest_post_website_category","cassiopeia_guest_post_website_category");
        $query->fields("cassiopeia_guest_post_website_category");
        $query->condition("id",$id);
        $result = $query->execute()->fetchObject();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_website_category(){
    try{
        $query = db_select("cassiopeia_guest_post_website_category","cassiopeia_guest_post_website_category");
        $query->fields("cassiopeia_guest_post_website_category");
        $result = $query->execute()->fetchAll();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_website_category_delete_form ($form, &$form_state, $category) {
    $form_state['#category'] = $category;
    $form = confirm_form($form,
        t('Bạn có chắc chắn muốn xóa Lĩnh vực %name?', array('%name' => $category->title)),
        'admin/manager/guest-post/website/category',
        '<p>' . t('This action cannot be undone.') .'</p>',
        t('Delete'),
        t('Cancel'),
        'confirm'
    );
    $form['actions']['cancel']['#attributes'] = array('class'=>array('btn btn-icon-before btn-open-search bg-primary c-white'), 'style'=>array('display: inline-block;'));
    $form['actions']['cancel']['#options']['html']  = true;
//  $form['actions']['cancel']['#options']['text']  = '<i class="fal fa-magnifying-glass fa-fw" aria-hidden="true"></i> Cancel';
    $form['actions']['cancel']['#title']  = '<i class="fal fa-ban fa-fw" aria-hidden="true"></i> '. t('Cancel');
    $form['actions']['submit']['#icon'] ='<span class="fal fa-trash fa-fw"></span>';
    $form['#submit'][] = 'cassiopeia_guest_post_website_category_delete_form_submit';
    return $form;
}
function cassiopeia_guest_post_website_category_delete_form_submit($form,&$form_state){
    try{
        db_delete("cassiopeia_guest_post_website_category")->condition("id",$form_state['#category']->id)->execute();
    }catch(Exception $e){

    }
}
function cassiopeia_guest_post_admin_domain_change_booking_delete_form ($form, &$form_state, $booking) {
    $form_state['#booking'] = $booking;
    $form = confirm_form($form,
        t('Bạn có chắc chắn muốn xóa đơn hàng %name?', array('%name' => $booking->booking_code)),
        'admin/manager/guest-post/domain/change/booking',
        '<p>' . t('This action cannot be undone.') .'</p>',
        t('Delete'),
        t('Cancel'),
        'confirm'
    );
    $form['actions']['cancel']['#attributes'] = array('class'=>array('btn btn-icon-before btn-open-search bg-primary c-white'), 'style'=>array('display: inline-block;'));
    $form['actions']['cancel']['#options']['html']  = true;
//  $form['actions']['cancel']['#options']['text']  = '<i class="fal fa-magnifying-glass fa-fw" aria-hidden="true"></i> Cancel';
    $form['actions']['cancel']['#title']  = '<i class="fal fa-ban fa-fw" aria-hidden="true"></i> '. t('Cancel');
    $form['actions']['submit']['#icon'] ='<span class="fal fa-trash fa-fw"></span>';
    $form['#submit'][] = 'cassiopeia_guest_post_admin_domain_change_booking_delete_form_submit';
    return $form;
}
function cassiopeia_guest_post_admin_domain_change_booking_delete_form_submit($form,&$form_state){
    try{
        if($form_state['#booking']->status!=1){
            db_delete("cassiopeia_guest_post_domain_change_booking")->condition("id",$form_state['#booking']->id)->execute();
            drupal_set_message("Xóa thành công!");
        }else{
            drupal_set_message("Đơn hàng không thể xóa!");
        }
    }catch(Exception $e){
        drupal_set_message("Đã xảy ra lỗi!");
    }
}
function cassiopeia_guest_post_admin_manager_domain_booking_price_delete_form ($form, &$form_state, $price) {
    $form_state['#price'] = $price;
    $form = confirm_form($form,
        t('Bạn có chắc chắn muốn xóa mục này?'),
        'admin/manager/guest-post/domain/booking/price',
        '<p>' . t('This action cannot be undone.') .'</p>',
        t('Delete'),
        t('Cancel'),
        'confirm'
    );
    $form['actions']['cancel']['#attributes'] = array('class'=>array('btn btn-icon-before btn-open-search bg-primary c-white'), 'style'=>array('display: inline-block;'));
    $form['actions']['cancel']['#options']['html']  = true;
//  $form['actions']['cancel']['#options']['text']  = '<i class="fal fa-magnifying-glass fa-fw" aria-hidden="true"></i> Cancel';
    $form['actions']['cancel']['#title']  = '<i class="fal fa-ban fa-fw" aria-hidden="true"></i> '. t('Cancel');
    $form['actions']['submit']['#icon'] ='<span class="fal fa-trash fa-fw"></span>';
    $form['#submit'][] = 'cassiopeia_guest_post_admin_manager_domain_booking_price_delete_form_submit';
    return $form;
}
function cassiopeia_guest_post_admin_manager_domain_booking_price_delete_form_submit($form,&$form_state){
    try{
        db_delete("cassiopeia_guest_post_domain_change_booking_price")->condition("id",$form_state['#price']->id)->execute();
    }catch(Exception $e){

    }
}
function cassiopeia_guest_post_website_delete_form ($form, &$form_state, $website) {
    $form_state['#website'] = $website;
    $form = confirm_form($form,
        t('Bạn có chắc chắn muốn xóa Website %name?', array('%name' => $website->domain)),
        'admin/manager/guest-post/website',
        '<p>' . t('This action cannot be undone.') .'</p>',
        t('Delete'),
        t('Cancel'),
        'confirm'
    );
    $form['actions']['cancel']['#attributes'] = array('class'=>array('btn btn-icon-before btn-open-search bg-primary c-white'), 'style'=>array('display: inline-block;'));
    $form['actions']['cancel']['#options']['html']  = true;
//  $form['actions']['cancel']['#options']['text']  = '<i class="fal fa-magnifying-glass fa-fw" aria-hidden="true"></i> Cancel';
    $form['actions']['cancel']['#title']  = '<i class="fal fa-ban fa-fw" aria-hidden="true"></i> '. t('Cancel');
    $form['actions']['submit']['#icon'] ='<span class="fal fa-trash fa-fw"></span>';
    $form['#submit'][] = 'cassiopeia_guest_post_website_delete_form_submit';
    return $form;
}
function cassiopeia_guest_post_website_delete_form_submit($form,&$form_state){
    try{
        cassiopeia_guest_post_website_delete($form_state['#website']);
    }catch(Exception $e){

    }
}

function cassiopeia_guest_post_website_filter_form($form,&$form_state,$cache){
    $form['#attributes']['class'][] = "custom-filter";
    $form['domain'] = array(
        '#type' => 'textfield',
        '#title' => t('Tên miền'),
    );
    if(!empty($cache['domain'])){
        $form['domain']['#default_value'] = $cache['domain'];
    }
    $categories = cassiopeia_guest_post_website_category();
    $options = array();
    $options['all'] = "Tất cả";
    if(!empty($categories)){
        foreach($categories as $category){
                $options[$category->id] = $category->title;
        }
    }
    $form['category'] = array(
        '#type' => 'select',
        '#title' => t('Lĩnh vực'),
        '#options' => $options,
    );
    if(!empty($cache['category'])){
        $form['category']['#default_value'] = $cache['category'];
    }
    $form['status'] = array(
        '#type' => 'select',
        '#title' => t('Tình trạng'),
        '#options' => array(
            "all"   => "Tất cả",
            0   => "Lỗi",
            1   => "OK"
        ),
    );
    if(isset($cache['status'])){
        $form['status']['#default_value'] = $cache['status'];
    }
    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Lọc'),
        '#suffix' => "<span class='btn btn-success btn-website-get-categories ml-10'>Quét</span>"
    );

    return $form;
}
function cassiopeia_guest_post_website_filter_form_submit($form, &$form_state){
    $arg = arg();
    $options = array(
        'query' => array(
            'data' => $form_state['values'],
        )
    );
    $form_state['redirect'] = array("/admin/manager/guest-post/website", "data" => $options);
}
function cassiopeia_guest_post_order_content_filter_form($form,&$form_state,$cache){
    $form['#attributes']['class'][] = "custom-filter";
    $form['title'] = array(
        '#type' => 'textfield',
        '#title' => t('Tên đơn vị'),
    );
    if(!empty($cache['title'])){
        $form['title']['#default_value'] = $cache['title'];
    }
    $form['website'] = array(
        '#type' => 'textfield',
        '#title' => t('Website/profile'),
    );
    if(!empty($cache['website'])){
        $form['website']['#default_value'] = $cache['website'];
    }
    $form['tel'] = array(
        '#type' => 'textfield',
        '#title' => t('Số điện thoại'),
    );
    if(!empty($cache['tel'])){
        $form['tel']['#default_value'] = $cache['tel'];
    }
    $form['status'] = array(
        '#type' => 'select',
        '#title' => t('Tình trạng'),
        '#options' => array(
            "all"   => "Tất cả",
            0   => "Chờ",
            1   => "Thành công",
            2   => "Không thành công"
        ),
    );
    if(isset($cache['status'])){
        $form['status']['#default_value'] = $cache['status'];
    }
    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Lọc'),
    );

    return $form;
}
function cassiopeia_guest_post_order_content_filter_form_submit($form, &$form_state){
    $arg = arg();
    $options = array(
        'query' => array(
            'data' => $form_state['values'],
        )
    );
    $form_state['redirect'] = array("/admin/manager/guest-post/order-content", "data" => $options);
}
function cassiopeia_guest_post_complain_filter_form($form,&$form_state,$cache){
    $form['#attributes']['class'][] = "custom-filter";
//    $articles = cassiopeia_guest_post_article_load_all();
//    $options = array();
//    $options['all'] = "Tất cả";
//    if(!empty($articles)){
//        foreach($articles as $article){
//            $options[$article->id] = $article->title;
//        }
//    }
//    $form['article'] = array(
//        '#type' => 'select',
//        '#title' => t('Bài viết'),
//        '#options' => $options,
//    );

    $form['keyword'] = array(
        '#type'         => 'textfield',
        '#title'        => t('Bài viết'),
        '#size'         => 60,
        '#maxlength'    => 128,
    );
    if(!empty($cache['keyword'])){
        $form['keyword']['#default_value'] = $cache['keyword'];
    }
    if(!empty($cache['category'])){
        $form['category']['#default_value'] = $cache['category'];
    }
    $form['submit'] = array(
        '#type' => 'submit',
        '#value' => t('Lọc'),
    );

    return $form;
}
function cassiopeia_guest_post_complain_filter_form_submit($form, &$form_state){
    $arg = arg();
    $options = array(
        'query' => array(
            'data' => $form_state['values'],
        )
    );
    $form_state['redirect'] = array("/admin/manager/guest-post/complain", "data" => $options);
}
function cassiopeia_guest_post_domain_change_booking_filter_form($form,&$form_state,$cache){
    $form['#attributes']['class'][] = "custom-filter";
    $form['code'] = array(
        '#type'         => 'textfield',
        '#title'        => t('Mã đơn hàng'),
        '#size'         => 60,
        '#maxlength'    => 128,
    );
    if(!empty($cache['code'])){
        $form['code']['#default_value'] = $cache['code'];
    }
    $form['from_date'] = array(
        '#type' => 'date_popup',
        '#default_value' => !empty($cache['from_date'])?$cache['from_date']:"",
        '#date_type' => DATE_DATETIME,
        '#date_timezone' => date_default_timezone(),
        '#date_format' => 'd-m-Y',
        '#date_increment' => 1,
        '#date_year_range' => '-10:+10',
        '#attributes' => array( "class" => array("form_date")),
    );
    if(!empty($cache['from_date'])){
        $form['from_date']['#default_value'] = $cache['from_date'];
    }
    $form['to_date'] = array(
        '#type' => 'date_popup',
        '#default_value' => !empty($cache['to_date'])?$cache['to_date']:"",
        '#date_type' => DATE_DATETIME,
        '#date_timezone' => date_default_timezone(),
        '#date_format' => 'd-m-Y',
        '#date_increment' => 1,
        '#date_year_range' => '-10:+10',
        '#attributes' => array( "class" => array("to_date")),
    );
    $users = cassiopeia_get_users_by_roles(array(4));
    $options = array();
    $options['all'] = "Tất cả";
    foreach($users as $_user){
        $options[$_user->uid] = !empty($_user->field_full_name['und'][0]['value'])?$_user->field_full_name['und'][0]['value']:$_user->mail;
    }
    $form['account'] = array(
        '#type'     => 'select',
        '#title'    => t('Tài khoản'),
        '#options'  => $options,
    );
    if(!empty($cache['account'])){
        $form['account']['#default_value'] = $cache['account'];
    }
    $form['status'] = array(
        '#type' => 'select',
        '#title' => t('Tình trạng'),
        '#options' => array(
            'all'   => "Tất cả",
            0   => "Đang chờ",
            1   => "Hoàn thành",
            2   => "Đã hủy",
        ),
        '#default_value' => isset($cache['status'])?$cache['status']:"all",
        '#required' => TRUE,
    );
    $form['submit'] = array(
        '#type'     => 'submit',
        '#value'    => t('Lọc'),
        '#prefix'   => "<div class='buttons'>",
        '#suffix'   => "</div>",
    );

    return $form;
}
function cassiopeia_guest_post_domain_change_booking_filter_form_submit($form, &$form_state)
{
    $arg = arg();
    $options = array(
        'query' => array(
            'data' => $form_state['values'],
        )
    );
    $form_state['redirect'] = array("/admin/manager/guest-post/domain/change/booking", "data" => $options);
}
function cassiopeia_guest_post_create_website_export($ids){
    global $user;
    module_load_include('inc', 'phpexcel');
    $data = array();
    $headers = array(
        "STT",
        "Tên miền",
        "Lĩnh vực",
        "Ref domain",
        "Organic traffic",
        "Bài viết đã đăng",
        "Đã đăng trong ngày",
        "Ngày đăng gần nhất",
    );
    $parent = null;
    $stt = 1;
    if(!empty($ids)){
        foreach($ids as $id){
            $website = cassiopeia_guest_post_website_load($id);
            $data[] = array(
                $stt,
                $website->domain,
                !empty($website->list_of_category)?$website->list_of_category:"",
                $website->ref_domain,
                $website->organic_traffic,
                $website->posted,
                $website->posted_of_day,
                !empty($website->last_posted_date)?date("d/m/Y",$website->last_posted_date):"",
            );
            $stt++;
        }
    }
    // Store the file in sites/default/files
    $dir = file_stream_wrapper_get_instance_by_uri('public://')->realpath();
    $filename =  'export_'.date('d_m_Y_H_i', REQUEST_TIME).'.xlsx';
    $path = "$dir/$filename";

    // Use the .xls format
    $options = array('format' => 'xlsx');

    $result = phpexcel_export($headers, $data, $path, $options);
    if ($result == PHPEXCEL_SUCCESS) {
        // notify to admin
        drupal_set_message(t("Ok"));
        return array('name'=>$filename,'uri'=>'public://'.$filename,'golf'=>$parent);
    }
    else {
        drupal_set_message($result, 'error');
        return null;
    }
}
function cassiopeia_guest_post_create_article_export($ids){
    global $user;
    module_load_include('inc', 'phpexcel');
    $data = array();
    $headers = array(
        "STT",
        "Bài viết lưu trên hệ thống",
        "Url guest post",
        "Tag",
        "Ngày xuất bản",
    );
    $parent = null;
    $stt = 1;
    if(!empty($ids)){
        foreach($ids as $id){
            $article = cassiopeia_guest_post_article_load($id);
            $data[] = array(
                $stt,
                $article->title,
                $article->url_guest_post,
                $article->list_of_tag,
                !empty($article->publish_date)?date("d/m/Y",$article->publish_date):"",
            );
            $stt++;
        }
    }
    // Store the file in sites/default/files
    $dir = file_stream_wrapper_get_instance_by_uri('public://')->realpath();
    $filename =  'export_'.date('d_m_Y_H_i', REQUEST_TIME).'.xlsx';
    $path = "$dir/$filename";

    // Use the .xls format
    $options = array('format' => 'xlsx');

    $result = phpexcel_export($headers, $data, $path, $options);
    if ($result == PHPEXCEL_SUCCESS) {
        // notify to admin
        drupal_set_message(t("Ok"));
        return array('name'=>$filename,'uri'=>'public://'.$filename,'golf'=>$parent);
    }
    else {
        drupal_set_message($result, 'error');
        return null;
    }
}
function cassiopeia_guest_post_domain_change_load_by_user($uid){
    try{
        $query = db_select("cassiopeia_guest_post_domain_change","cassiopeia_guest_post_domain_change");
        $query->fields("cassiopeia_guest_post_domain_change");
        $query->condition("uid",$uid);
        $result = $query->execute()->fetchObject();
        if(empty($result)){
            $result = new stdClass();
            $result->total = 0;
            $result->used = 0;
            $result->remaining = 0;
            return $result;
        }
        return $result;
    }catch (Exception $e){
        $result = new stdClass();
        $result->total = 0;
        $result->used = 0;
        $result->remaining = 0;
        return $result;
    }
}
function cassiopeia_guest_post_domain_change_load($uid){
    try{
        $query = db_select("cassiopeia_guest_post_domain_change","cassiopeia_guest_post_domain_change");
        $query->fields("cassiopeia_guest_post_domain_change");
        $query->condition("uid",$uid);
        $result = $query->execute()->fetchObject();
        if(empty($result)){
            $result = new stdClass();
            $result->total = 0;
            $result->used = 0;
            $result->remaining = 0;
            $result->uid = $uid;
            cassiopeia_guest_post_domain_change_save($result);
            return $result;
        }
        return $result;
    }catch (Exception $e){
        $result = new stdClass();
        $result->total = 0;
        $result->used = 0;
        $result->remaining = 0;
        return $result;
    }
}
function cassiopeia_guest_post_admin_manager_domain_booking_price_form($form,&$form_state,$data = array("price"=>null)){
    $price = $form['#price'] = $form_state['#price'] = !empty($data['price'])?$data['price']:new stdClass();
    $form['quantity'] = array(
        '#type' => 'textfield',
        '#title' => t('Số lượt'),
        '#size' => 60,
        '#maxlength' => 128,
        '#attributes'   => array("placeholder"=>"Nhập số lượt thay đổi domain","class"=>array("seo-input ")),
        '#required' => TRUE
    );
    $form['price'] = array(
        '#type' => 'textfield',
        '#title' => t('Giá tiền / lượt'),
        '#size' => 60,
        '#maxlength' => 128,
        '#attributes'   => array("placeholder"=>"Nhập giá tiền cho mỗi lượt","class"=>array("seo-input ")),
        '#required' => TRUE
    );
    $form['percent'] = array(
        '#type' => 'textfield',
        '#title' => t('Giảm giá (%)'),
        '#size' => 60,
        '#maxlength' => 128,
        '#default_value' => 0,
        '#required' => TRUE
    );
    $form['weight'] = array(
        '#type' => 'textfield',
        '#title' => t('Độ nặng'),
        '#size' => 60,
        '#maxlength' => 128,
        '#attributes'   => array("placeholder"=>"Nhập độ nặng để thay đổi thứ tự hiển thị","class"=>array("seo-input ")),
        '#required' => TRUE
    );
    if(!empty($price->id)){
        $form['quantity']['#default_value'] = $price->quantity;
        $form['price']['#default_value'] = $price->price;
        $form['weight']['#default_value'] = $price->weight;
        $form['percent']['#default_value'] = $price->percent;
    }
    $form['save'] = array(
        '#type'     =>'submit',
        '#value'    => 'Lưu',
        '#attributes'   => array("class"=>array("btn-green border-none")),
    );
    return $form;
}
function cassiopeia_guest_post_admin_manager_domain_booking_price_form_submit($form,&$form_state){
    global $user;
    try{
        $node = $form_state['#price'];
        $node->quantity = $form_state['values']['quantity'];
        $node->price = str_replace(",","",str_replace(".","",$form_state['values']['price']));
        $node->weight = $form_state['values']['weight'];
        $node->percent = $form_state['values']['percent'];
        if(!empty($node->id)){
            $node->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_domain_change_booking_price",$node,array("id"));
            drupal_set_message("Cập nhật thành công!");
        }else{
            $node->uid = $user->uid;
            $node->created = REQUEST_TIME;
            $node->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_domain_change_booking_price",$node);
            drupal_set_message("Thêm mới thành công!");
        }
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_domain_change_booking_price_load($id){
    try{
        $query = db_select("cassiopeia_guest_post_domain_change_booking_price","cassiopeia_guest_post_domain_change_booking_price");
        $query->fields("cassiopeia_guest_post_domain_change_booking_price");
        $query->condition("id",$id);
        $result = $query->execute()->fetchObject();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_admin_manager_domain_booking_price_config_form(){
    $content = variable_get('domain_booking_price_content', array(
        'value' => '',
        'format' => 'full_html'
    ));

    $form['domain_booking_price_content'] = array(
        '#type' => "text_format",
        '#title' => t('Ghi chú'),
        '#format' => 'full_html',
        "#default_value" => $content['value'],
    );
    return system_settings_form($form);
}
function cassiopeia_guest_post_domain_change_booking_form($form,&$form_state){
    $form_wrapper = "cassiopeia_guest_post_domain_change_booking_form_wrapper";
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    $form['#attributes']['class'][] = "cassiopeia-guest-post-domain-change-booking-form";
    $query = db_select("cassiopeia_guest_post_domain_change_booking_price","cassiopeia_guest_post_domain_change_booking_price");
    $query->fields("cassiopeia_guest_post_domain_change_booking_price");
    $query->orderBy("cassiopeia_guest_post_domain_change_booking_price.weight","ASC");
    $result = $query->execute()->fetchAll();
    $default_value = !empty($result)?array_values($result)[0]:null;
    $options = array();
    if(!empty($result)){
        foreach($result as $item){
            $promotion = "";
            if($item->percent>0){
                $promotion = "<div class='promotion'>Tiết kiệm ".$item->percent." %</div>";
            }
            $options[$item->id] = "
            <div>
    ".$promotion."
    <div class='quantity'>".$item->quantity." lượt</div>
    <div class='price'>".number_format($item->price,0,",",".")."đ/lượt</div>
</div>
            ";
        }
    }
    $form['price'] = array(
        '#type' => 'radios',
        '#title' => t(''),
        '#options' => $options,
        '#default_value' => !empty($default_value)?$default_value->id:"",
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_domain_change_booking_form_ajax_submit',
            'wrapper' => $form_wrapper,
            'progress' => "none",
        ),
    );
    $form['submit'] = array(
        '#type'     =>'submit',
        '#value'    => 'Thanh toán',
        '#attributes'   => array("class"=>array("btn-green border-none btn-medium")),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_domain_change_booking_form_submit_ajax_submit',
        ),
    );
    return $form;
}
function cassiopeia_guest_post_domain_change_booking_form_ajax_submit($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_domain_change_booking_form_submit_ajax_submit($form,&$form_state){
    ctools_include('ajax');
    ctools_add_js('ajax-responder');
    $commands[] = ctools_ajax_command_redirect($form_state['#redirect']);
//        $commands[] = ctools_ajax_command_redirect('user/manager/topup');
    print ajax_render($commands);
    exit;
}
function cassiopeia_guest_post_domain_change_booking_form_submit($form,&$form_state){
    global $user;
    try{
        $query = db_select("cassiopeia_guest_post_domain_change_booking","cassiopeia_guest_post_domain_change_booking");
        $query->fields("cassiopeia_guest_post_domain_change_booking");
        $query->orderBy("created","DESC");
        $query->range(0,1);
        $last = $query->execute()->fetchObject();
        if(!empty($last)){
            $last_code = $last->booking_code;
            $last_code = str_replace("DH","",$last_code);
            $last_code = (int)$last_code+1;
            $len = strlen($last_code);
            $max = 6-$len;
            if($max>=1){
                for($i=1;$i<=$max;$i++){
                    $last_code = "0".$last_code;
                }
            }
            $booking_code = "DH".$last_code;
        }else{
            $booking_code = "DH000001";
        }

        $price = cassiopeia_guest_post_domain_change_booking_price_load($form_state['values']['price']);
        $node = new stdClass();
        $node->uid = $user->uid;
        $node->quantity = $price->quantity;
        $node->total_price = $price->price*$price->quantity;
        $node->status=0;
        $node->booking_code=$booking_code;
        cassiopeia_guest_post_domain_change_booking_save($node);
        $form_state['#redirect'] = "/guest-post/domain/change/booking/payment/".$booking_code;


        $account = user_load($user->uid);
        cassiopeia_guest_post_send_domain_change_booking_mail($account,$node);
    }catch (Exception $e){
        drupal_set_message("Đã xảy ra lỗi!");
    }
}
function cassiopeia_guest_post_domain_change_booking_save($booking){
    try{
        if(!empty($booking->id)){
            $booking->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_domain_change_booking",$booking,array("id"));
        }else{
            $booking->created = REQUEST_TIME;
            $booking->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_domain_change_booking",$booking);
        }
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_domain_change_booking_load($booking_code){
    try{
        $query = db_select("cassiopeia_guest_post_domain_change_booking","cassiopeia_guest_post_domain_change_booking");
        $query->fields("cassiopeia_guest_post_domain_change_booking");
        $query->condition("booking_code",$booking_code);
        $result = $query->execute()->fetchObject();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_domain_change_booking_load_by_id($id){
    try{
        $query = db_select("cassiopeia_guest_post_domain_change_booking","cassiopeia_guest_post_domain_change_booking");
        $query->fields("cassiopeia_guest_post_domain_change_booking");
        $query->condition("id",$id);
        $result = $query->execute()->fetchObject();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function tbl_booking_product_load($id){
    try{
        $query = db_select("tbl_booking_product","tbl_booking_product");
        $query->fields("tbl_booking_product");
        $query->condition("id",$id);
        $result = $query->execute()->fetchObject();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_domain_change_booking_edit_form($form,&$form_state,$data = array("booking"=>null)){
    $form_state['#booking'] = $booking = $data['booking'];
    $form['status'] = array(
        '#type' => 'select',
        '#title' => t('Tình trạng'),
        '#options' => array(
            0   => "Đang chờ",
            1   => "Hoàn thành",
            2   => "Đã hủy",
        ),
        '#default_value' => $booking->status,
        '#required' => TRUE,
    );
    $form['submit'] = array(
        '#type'     =>'submit',
        '#value'    => 'Lưu',
        '#attributes'   => array("class"=>array("btn-green border-none")),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_domain_change_booking_edit_form_ajax_submit',
        ),
    );
    return $form;
}
function cassiopeia_guest_post_domain_change_booking_edit_form_ajax_submit($form,&$form_state){
    ctools_include('ajax');
    ctools_include('modal');
    $commands[] = ctools_modal_command_dismiss();
    $commands[] = ctools_ajax_command_reload();
    return array(
        '#type'     => 'ajax',
        '#commands' => $commands,
    );
}

function cassiopeia_guest_post_domain_change_booking_edit_form_submit($form,&$form_state){
    global $user;
    $node = $form_state['#booking'];
    if($node->status!=1){
        $node->status = $form_state['values']['status'];
        $node->tran_user = $user->uid;
        drupal_write_record("cassiopeia_guest_post_domain_change_booking",$node,array("id"));
        if($form_state['values']['status']==1){
            $change = cassiopeia_guest_post_domain_change_load($node->uid);
            $change->total+=$node->quantity;
            $change->remaining+=$node->quantity;
            cassiopeia_guest_post_domain_change_save($change);
        }
    }
}
function cassiopeia_guest_post_domain_change_save($change){
    try{
        if(!empty($change->id)){
            $change->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_domain_change",$change,array("id"));
        }else{
            $change->created = REQUEST_TIME;
            $change->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_domain_change",$change);
        }
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_domain_change_form($form,&$form_state){
    $form_wrapper = "cassiopeia-guest-post-domain-change-form-wrapper";
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    $form['#attributes']['class'][] = "cassiopeia-guest-post-domain-change-form";
    $form['excel_file'] = array(
        '#title' => '',
        '#type' => 'file',
        '#field_prefix' => "<div class='mb-10'>Nếu bạn có file .xlsx .xls .csv chứa thông tin domains, bạn có thể tải file lên tại đây.</div>"
    );
    $form['submit'] = array(
        '#type'     =>'submit',
        '#value'    => 'Chấp nhận',
        '#attributes'   => array("class"=>array("btn-green border-none btn-small")),
        '#ajax' => array(
            "callback"=> "cassiopeia_guest_post_domain_change_form_ajax_submit",
            'wrapper' => $form_wrapper,
        )
    );
    if(!empty($form_state['#invalid_file'])){
        _print_r($form_state['#invalid_file']);
    }
    $form['#attached']['js'] = array(
        drupal_get_path("module","cassiopeia_guest_post")."/js/cassiopeia-guest-post-domain-change-form.js"
    );
    return $form;
}
//function cassiopeia_guest_post_domain_change_form_validate(&$form, &$form_state){
//    $validators = array(
//        'file_validate_extensions' => array('xls xlsx'),
//    );
//    if ($file = file_save_upload('excel_file', $validators, "public://", FILE_EXISTS_REPLACE)) {
//        $form_state['values']['excel_file'] = $file;
//    } else {
//        $form_state['values']['error'] = "invalid_file";
//    }
//}
function cassiopeia_guest_post_domain_change_form_submit($form,&$form_state){
    global $user;
    $flag = true;
    if(empty($_FILES['files']['name']['excel_file'])){
        $form_state['#error_message'] = "Bạn chưa chọn file excel để đăng";
        $form_state['rebuild'] = TRUE;
        $flag = false;
    }
    if($flag){
        $_excel_file = $_FILES['files']['name']['excel_file'];
        $splitter = explode(".",$_excel_file);
        $extension = $splitter[1];
        if(!in_array($extension,array('xls','xlsx'))){
            $form_state['#error_message'] = "Hệ thống chỉ chấp nhận tải file .xlsx .xls";
            $form_state['rebuild'] = TRUE;
            $flag = false;
        }
    }
//    _print_r($form_state['values']);
//    die;
    if($flag){
        $validators = array(
            'file_validate_extensions' => array('xls xlsx csv'),
        );
        if ($file = file_save_upload('excel_file', $validators, "public://", FILE_EXISTS_REPLACE)) {
            $form_state['values']['excel_file'] = $file;
        }
        include  drupal_get_path('module','cassiopeia')."/excel/phpspreadsheet.inc";
        $data = phpspreadsheet_import(drupal_realpath($form_state['values']['excel_file']->destination), false, true, false);
//        _print_r($file);
//        die;
        if (!empty($data['data'])) {
            db_update("cassiopeia_guest_post_domain")->condition("uid",$user->uid)->fields(array("status"=>0))->execute();
            $change = cassiopeia_guest_post_domain_change_load($user->uid);
            if($change->remaining<1){
                drupal_set_message("Vui lòng mua thêm lượt đổi domain để tiếp tục!");
            }else{
                $total = 0;

                $_data_ = array_values($data['data']);
                $_merge = array_values($data['merge']);
                $new_data = array();
                foreach($_merge as $_merge_value){
                    $matches = array();
                    preg_match_all('!\d+!', $_merge_value, $matches);
                    for($i=$matches[0][0]-1;$i<=$matches[0][1]-1;$i++){
                        $_data_[$i]['group'] = $matches[0][0]-1;
                    }
                }
                foreach($_data_ as $key => $__data){
                    $group = !empty($__data['group'])?$__data['group']:$key;
                    $new_data[$group][] = $__data;
                }
                if(count($new_data)>11){
                    $form_state['#error_message'] = "Bạn đã nhập quá 10 domains, mời bạn nhập lại!";
                    $form_state['rebuild'] = TRUE;
                    $flag = false;
                }
                if($flag){
                    $change->remaining--;
                    cassiopeia_guest_post_domain_change_save($change);
                    $counter = 0;
                    foreach ($new_data as $key => $new_data_value) {
                        if ($key >0) {
                            $counter = $counter + 1;
                            if ($counter <= 500) {
                                $_value = $new_data_value[0]; // first row contain values
                                if(!empty($_value[0])) {
                                    foreach($new_data_value as $value){
                                        if($total<=9){
                                            $domain            = trim($value[0]);
                                            $query = db_select("cassiopeia_guest_post_domain","cassiopeia_guest_post_domain");
                                            $query->fields("cassiopeia_guest_post_domain");
                                            $query->condition("cassiopeia_guest_post_domain.domain",$domain);
                                            $query->condition("cassiopeia_guest_post_domain.uid",$user->uid);
                                            $result = $query->execute()->fetchObject();
                                            $node = !empty($result)?$result:new stdClass();
                                            $node->domain = $domain;
                                            $node->status = 1;
                                            $node->uid = $user->uid;
                                            cassiopeia_guest_post_domain_save($node);
                                        }
                                        $total++;
                                    }
                                }
                            }
                        }
                    }
                    $form_state['#added']=true;
                }
                $form_state['rebuild'] = TRUE;
            }
        }
    }

}

function cassiopeia_guest_post_domain_save($domain){
    try{
        $domain->domain = str_replace("https","",$domain->domain);
        $domain->domain = str_replace("http","",$domain->domain);
        $domain->domain = str_replace("www.","",$domain->domain);
        $domain->domain = str_replace("/","",$domain->domain);
        $domain->domain = str_replace(":","",$domain->domain);
        if(!empty($domain->id)){
            $domain->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_domain",$domain,array("id"));
        }else{
            $domain->created = REQUEST_TIME;
            $domain->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_domain",$domain);
        }
    }catch (Exception $e){
        _print_r($e);
    }
}
function cassiopeia_guest_post_domain_change_form_ajax_submit($form,&$form_state){
    if($form_state['#added']){
        ctools_include('ajax');
        ctools_include('modal');
        $commands[] = ctools_modal_command_dismiss();
        $commands[] = ctools_ajax_command_reload();
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }else{
//        drupal_get_messages();
        ctools_include('ajax');
        $commands[] = ajax_command_replace('#cassiopeia-guest-post-domain-change-form-wrapper', drupal_render($form));
        $commands[] = ajax_command_invoke("","guestPostChangeDomainAlert",array(json_encode($form_state['#error_message'])));
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }
}
function cassiopeia_guest_post_domain_load_from_href($href){
    $d = "";
    $a = explode("//",$href);
    if(count($a)==1){
        $b = $a[0];
    }else{
        $b = $a[1];
    }
    if(!empty($b)){
        $c = explode("/",$b);
        $d = strtolower($c[0]);
        $d = str_replace("www.","",$d);
    }
    return $d;
}
function cassiopeia_guest_post_domain_load_by_user($uid){
    try{
        $query = db_select("cassiopeia_guest_post_domain","cassiopeia_guest_post_domain");
        $query->fields("cassiopeia_guest_post_domain");
        $query->condition("cassiopeia_guest_post_domain.uid",$uid);
        $query->condition("cassiopeia_guest_post_domain.status",1);

        $query->orderBy("cassiopeia_guest_post_domain.created","DESC");
        $result = $query->execute()->fetchAll();
        $temp = array();
        if(!empty($result)){
            foreach($result as $item){
                $temp[strtolower($item->domain)] = $item;
            }
        }
        $result = $temp;
        return $result;
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_domain_load_by_domain($domain){
    try{
        $query = db_select("cassiopeia_guest_post_domain","cassiopeia_guest_post_domain");
        $query->fields("cassiopeia_guest_post_domain");
        $query->condition("cassiopeia_guest_post_domain.domain",$domain);
        $result = $query->execute()->fetchObject();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_complain_form($form,&$form_state){
    $form_wrapper = "cassiopeia-guest-post-complain-form-wrapper";
    $form['#attributes']['class'][] = "cassiopeia-guest-post-complain-form";
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    global $user;
    try {
        $query = db_select("users", "tbl_user");
        $query->fields("tbl_user");
        $query->join("users_roles", "tbl_role", "tbl_role.uid = tbl_user.uid");
        $query->condition("tbl_role.rid", 4);
        $query->join("field_data_field_full_name", "field_full_name", "field_full_name.entity_id=tbl_user.uid");
        $query->addField("field_full_name", "field_full_name_value", "agent_transaction_name");
        $result = $query->execute()->fetchAll();
        foreach ($result as $row) {
            $options[$row->uid] = $row->name;
        }
    }catch (Exception $e) {

    }
    $form['user'] = array(
        '#title' => 'Đối tượng khiếu nại',
        '#type' => 'textfield',
        '#value' => !empty($user->field_full_name['und'][0]['value'])?$user->field_full_name['und'][0]['value']:$user->name,
        '#attributes'   => array("class"=>array("seo-input"),"disabled"=>"disabled","readonly"=>"readonly")
    );
    $form['target'] = array(
        '#title' => 'Vai trò của tôi',
        '#type' => 'select',
        '#options' => array(
            1 => "Người đăng",
            2 => "Chủ website",
        ),
        '#required' => TRUE,
        '#chosen' => TRUE,
        '#default_value' => 1,
        '#attributes'   => array("class"=>array("seo-input ")),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_complain_form_ajax_callback',
            'wrapper' => $form_wrapper,
        ),
    );
    $form['title'] = array(
        '#type' => 'textfield',
        '#title' => t('Tiêu đề'),
        '#size' => 60,
        '#maxlength' => 128,
        '#attributes'   => array("class"=>array("seo-input "))
    );
    $form['content'] = array(
        '#title' => 'Nội dung',
        '#type' => 'text_format',
        '#format' => 'filtered_html',
        '#weight' => 0,
        '#attributes'   => array("placeholder"=>"Mời bạn nhập nội dung...")
    );
    try{
        $target = !empty($form_state['values']['target'])?$form_state['values']['target']:1;

        $cassiopeia_guest_post_complain_query = db_select("cassiopeia_guest_post_complain","cassiopeia_guest_post_complain");
        $cassiopeia_guest_post_complain_query->fields("cassiopeia_guest_post_complain");
        $cassiopeia_guest_post_complain_query->addExpression("GROUP_CONCAT(aid SEPARATOR ',' )","aids");
        $cassiopeia_guest_post_complain_result = $cassiopeia_guest_post_complain_query->execute()->fetchObject();
        $exclude = !empty($cassiopeia_guest_post_complain_result)?explode(",",$cassiopeia_guest_post_complain_result->aids):array(0);
        $query = db_select("cassiopeia_guest_post_article","cassiopeia_guest_post_article");
        $query->fields("cassiopeia_guest_post_article");
        $query->orderBy("cassiopeia_guest_post_article.created","DESC");
        $query->condition("cassiopeia_guest_post_article.id",$exclude,"NOT IN");


        $website_query = db_select("cassiopeia_guest_post_website","cassiopeia_guest_post_website");
        $website_query->fields("cassiopeia_guest_post_website");
        $website_query->condition("cassiopeia_guest_post_website.uid",$user->uid);
        $website_query->addExpression("GROUP_CONCAT(id SEPARATOR ',')","ids");
        $website_result = $website_query->execute()->fetchObject();

        if($target==1){ // người đăng
            $query->condition("cassiopeia_guest_post_article.uid",$user->uid);
        }else{ // chủ website
            $query->condition("cassiopeia_guest_post_article.uid",$user->uid,"<>");
            $query->condition("cassiopeia_guest_post_article.website",explode(",",$website_result->ids),"IN");
        }

        $query->groupBy("cassiopeia_guest_post_article.id");
        $nodes = $query->execute()->fetchAll();
        $options = array();

        if(!empty($nodes)){
            foreach($nodes as $node){
                $options[$node->id] = $node->title;
            }
        }

        $form['article'] = array(
            '#title' => 'Bài viết cần khiếu nại',
            '#type' => 'select',
            '#options' => $options,
            '#chosen' => TRUE,
            '#required' => TRUE,
            '#attributes'   => array("class"=>array("seo-input "))
        );

    }catch (Exception $e){

    }
        $form['re-captcha'] = array(
        '#type' => 'captcha',
        '#captcha_type' => 'recaptcha/reCAPTCHA',
    );
    $form['submit'] = array(
        '#type'     =>'submit',
        '#value'    => 'Gửi khiếu nại',
        '#attributes'   => array("class"=>array("btn-green border-none")),
    );

    return $form;
}
function cassiopeia_guest_post_complain_form_ajax_callback($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_complain_form_submit($form,&$form_state){
    global $user;
    try{

        $complain = new stdClass();
        $complain->uid = $user->uid;
        $complain->aid = $form_state['values']['article'];
        $complain->target = $form_state['values']['target'];
        $complain->title = $form_state['values']['title'];
        $complain->content = $form_state['values']['content']['value'];
        $article = cassiopeia_guest_post_article_load($complain->aid);
        if($complain->target==2){ // chủ website
            $complain->target_id = $article->uid;
        }else{ // người đăng
            $website = cassiopeia_guest_post_website_load($article->website);
            $complain->target_id = $website->uid;
        }

        cassiopeia_guest_post_complain_save($complain);
        drupal_set_message("Đã gửi khiếu nại thành công!");
        $form_state['redirect'] = "guest-post/complain";

      $site_mail = variable_get("site_mail");
      $_mail =  variable_get("cassiopeia_config_mail_guest_post_receiver_mail");
      $cc = "";
      $cc_mail = variable_get("cassiopeia_config_mail_guest_post_receiver_mail");
      $splitter = explode(",",$cc_mail);
      $index=1;
      if(!empty($splitter)){
        foreach($splitter as $item){
          if($index>1){
            $cc.=",".trim($item);
          }else{
            $cc.=trim($item);
          }
          $index++;
        }
      }
      $account = user_load($user->uid);
      $full_name = !empty($account->field_full_name['und'][0]['value'])?$account->field_full_name['und'][0]['value']:"";
      $field_tel = !empty($account->field_tel['und'][0]['value'])?$account->field_tel['und'][0]['value']:"";
      try{
        $body[] = "<table class=\"table table-hover table-stripped\">
    <tbody>
        <tr>
            <td>Họ tên:</td>
            <td>".$full_name."</td>
        </tr>
    </tbody>
</table>";
        $headers['From'] = $headers['Sender'] = $headers['Return-Path'] = "";
        $headers['MIME-Version'] = '1.0';
        $headers['Content-Type'] = 'text/html; charset=UTF-8; format=flowed; delsp=yes';
        if(!empty($cc)){
          $headers['Cc'] = $cc;
        }
        $params = array(
          'body' => $body,
          'subject' => "Khách hàng ".$full_name." có khiếu nại mới (".date("d/m/Y H:i:s",REQUEST_TIME).")",
          'headers' => $headers,
        );
        if (drupal_mail('cassiopeia_guest_post', 'custom_key', $splitter[0], language_default(), $params)) {};
      }catch (Exception $e){

      }
    }catch (Exception $e){
        _print_r($e);
        die;
    }
}
function cassiopeia_guest_post_complain_save($complain){
    try{
        if(!empty($complain->id)){
            $complain->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_complain",$complain,array("id"));
        }else{
            $query = db_select("cassiopeia_guest_post_complain","cassiopeia_guest_post_complain");
            $query->fields("cassiopeia_guest_post_complain");
            $query->orderBy("created","DESC");
            $query->range(0,1);
            $last = $query->execute()->fetchObject();
            if(!empty($last)){
                $code = $last->code+1;
            }else{
                $code = "100000";
            }
            $complain->code = $code;
            $complain->created = REQUEST_TIME;
            $complain->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_complain",$complain);
        }
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_complain_load($id){
    try{
        $query = db_select("cassiopeia_guest_post_complain","cassiopeia_guest_post_complain");
        $query->fields("cassiopeia_guest_post_complain");
        $query->condition("id",$id);
        $result = $query->execute()->fetchObject();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_complain_load_by_uid($uid,$limit=null){
    try{
        $query = db_select("cassiopeia_guest_post_complain","cassiopeia_guest_post_complain");
        $query->fields("cassiopeia_guest_post_complain");
        $query->orderBy("cassiopeia_guest_post_complain.created","DESC");
        if(!empty($limit)){
            $query->range(0,$limit);
        }
        $query->condition("uid",$uid);
        $result = $query->execute()->fetchAll();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_category_save($category){
    try{
        if(!empty($category->id)){
            $category->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_category",$category,array("id"));
        }else{
            $category->changed = REQUEST_TIME;
            $category->created = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_category",$category);
        }
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_category_load($wp_cat_id){
    try{
        $query = db_select("cassiopeia_guest_post_category","cassiopeia_guest_post_category");
        $query->fields("cassiopeia_guest_post_category");
        $query->condition("cassiopeia_guest_post_category.tid",$wp_cat_id);
        $result = $query->execute()->fetchObject();
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_category_load_by_website($website_id){
    try{
        $query = db_select("cassiopeia_guest_post_category","cassiopeia_guest_post_category");
        $query->fields("cassiopeia_guest_post_category");
        $query->condition("cassiopeia_guest_post_category.website",$website_id);
        $result = $query->execute()->fetchAll();
//        _print_r($result);
        return $result;
    }catch (Exception $e){
        return null;
    }
}
function cassiopeia_guest_post_complain_edit_form($form,&$form_state,$data = array("complain"=>null)){
    $form_state['#complain'] = $complain = $data['complain'];
    $form['status'] = array(
        '#type' => 'select',
        '#title' => t('Tình trạng'),
        '#options' => array(
            0   => "Đang chờ",
            1   => "Thành công",
            2   => "Đã hủy",
            3   => "Thất bại",
        ),
        '#default_value' => $complain->status,
        '#required' => TRUE,
    );
    $form['note'] = array(
        '#type' => "textarea",
        '#title' => 'Ghi chú',
//        '#resizable' => TRUE,
//        '#format' => 'full_html',
    );
    $form['submit'] = array(
        '#type'     =>'submit',
        '#value'    => 'Lưu',
        '#attributes'   => array("class"=>array("btn-green border-none")),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_complain_edit_form_ajax_submit',
        ),
    );
    return $form;
}
function cassiopeia_guest_post_complain_edit_form_ajax_submit($form,&$form_state){
    ctools_include('ajax');
    ctools_include('modal');
    $commands[] = ctools_modal_command_dismiss();
    $commands[] = ctools_ajax_command_reload();
    return array(
        '#type'     => 'ajax',
        '#commands' => $commands,
    );
}

function cassiopeia_guest_post_complain_edit_form_submit($form,&$form_state){
    global $user;
    $node = $form_state['#complain'];
    $article = cassiopeia_guest_post_article_load($node->aid);
    $website = cassiopeia_guest_post_website_load($article->website);

    if($node->target==1){ // người đăng khiếu nại
        switch ($form_state['values']['status']){
            case 1 : // thành công
                // cộng điểm cho người đăng
                $point = cassiopeia_guest_post_user_point_load($article->uid);
                $point = !empty($point)?$point:new stdClass();
                $point->uid = $article->uid;
                $current_point = !empty($point->point)?$point->point:0;
                $point->point = $current_point+20;
                $point->note = "Khiếu nại thành công (".$website->uid.")";
                cassiopeia_guest_post_user_point_save($point);
                $node->point = 20;
                $node->defendant_point = -50;
                // trừ điểm chủ website
                $point = cassiopeia_guest_post_user_point_load($website->uid);
                $point = !empty($point)?$point:new stdClass();
                $point->uid = $website->uid;
                $current_point = !empty($point->point)?$point->point:0;
                $point->point = $current_point-50;
                $point->note = "Bị khiếu nại (".$article->uid.")";
                cassiopeia_guest_post_user_point_save($point);

                $article->re_post = 1;
                $_node = cassiopeia_guest_post_article_save($article);
                break;
            case 2 : // Hủy

                break;
            case 3 : // Thất bại
                // trừ điểm  người đăng
                $article->re_post = 0;
                $_node = cassiopeia_guest_post_article_save($article);
                $point = cassiopeia_guest_post_user_point_load($article->uid);
                $point = !empty($point)?$point:new stdClass();
                $point->uid = $node->uid;
                $current_point = !empty($point->point)?$point->point:0;
                $point->point = $current_point-50;
                $point->note = "Khiếu nại thất bại (".$website->uid.")";
                cassiopeia_guest_post_user_point_save($point);
                $node->point = -50;
                $node->defendant_point = 0;
                break;
        }
    }else{ // chủ website khiếu nại
        switch ($form_state['values']['status']){
            case 1 : // thành công
                // cộng điểm cho chủ website
                $point = cassiopeia_guest_post_user_point_load($website->uid);
                $point = !empty($point)?$point:new stdClass();
                $point->uid = $website->uid;
                $current_point = !empty($point->point)?$point->point:0;
                $point->point = $current_point+10;
                $point->note = "Khiếu nại thành công (".$article->uid.")";
                cassiopeia_guest_post_user_point_save($point);
                $node->point = +10;
                $node->defendant_point = 0;
                break;
            case 2 : // Hủy

                break;
            case 3 : // Thất bại
                // trừ điểm  chủ website
                $point = cassiopeia_guest_post_user_point_load($website->uid);
                $point = !empty($point)?$point:new stdClass();
                $point->uid = $website->uid;
                $current_point = !empty($point->point)?$point->point:0;
                $point->point = $current_point-20;
                $point->note = "Khiếu nại thất bại (".$article->uid.")";
                cassiopeia_guest_post_user_point_save($point);
                $node->point = -20;
                $node->defendant_point = 0;

                break;
        }
    }
    $node->status = $form_state['values']['status'];
    $node->tran_user = $user->uid;
    $node->note = $form_state['values']['note'];
    drupal_write_record("cassiopeia_guest_post_complain",$node,array("id"));
}

function cassiopeia_guest_post_regulation_form($form,&$form_state){
//    $form['agree'] = array(
//        '#type' => 'checkbox',
//        '#title' => t('Tôi đồng ý tham gia vào hệ thống!'),
//        '#required' => TRUE
//    );
    $form['submit'] = array(
        '#type'     =>'submit',
        '#value'    => 'Tham gia',
        '#attributes'   => array("class"=>array("btn-green border-none")),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_regulation_form_ajax_callback',
        ),
        '#submit' => array('cassiopeia_guest_post_regulation_form_submit'),
    );
//    return $form;
}
function cassiopeia_guest_post_regulation_form_ajax_callback($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_regulation_form_submit($form,&$form_state){
    global $user;
    $site_mail = variable_get("site_mail");
    $_mail =  variable_get("cassiopeia_config_mail_guest_post_receiver_mail");
    $cc = "";
    $cc_mail = variable_get("cassiopeia_config_mail_guest_post_receiver_mail");
    $splitter = explode(",",$cc_mail);
    $index=1;
    if(!empty($splitter)){
        foreach($splitter as $item){
            if($index>1){
                $cc.=",".trim($item);
            }else{
                $cc.=trim($item);
            }
            $index++;
        }
    }
    $account = user_load($user->uid);
    $full_name = !empty($account->field_full_name['und'][0]['value'])?$account->field_full_name['und'][0]['value']:"";
    $field_tel = !empty($account->field_tel['und'][0]['value'])?$account->field_tel['und'][0]['value']:"";
    try{
        $body[] = "<table class=\"table table-hover table-stripped\">
    <tbody>
        <tr>
            <td>Họ tên:</td>
            <td>".$full_name."</td>
        </tr>
        <tr>
            <td>Email:</td>
            <td>".$account->mail."</td>
        </tr>
        <tr>
            <td>Số điện thoại:</td>
            <td>".$field_tel."</td>
        </tr>
    </tbody>
</table>";
        $headers['From'] = $headers['Sender'] = $headers['Return-Path'] = "";
        $headers['MIME-Version'] = '1.0';
        $headers['Content-Type'] = 'text/html; charset=UTF-8; format=flowed; delsp=yes';
        if(!empty($cc)){
            $headers['Cc'] = $cc;
        }
        $params = array(
            'body' => $body,
            'subject' => "Khách hàng ".$full_name." muốn đăng ký hệ thống GuestPost",
            'headers' => $headers,
        );
        if (drupal_mail('cassiopeia_guest_post', 'custom_key', $splitter[0], language_default(), $params)) {};
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_mail($key, &$message, $params){
    switch ($key) {
        case 'custom_key':
            $message['subject'] = $params['subject'];
            $message['body'] = $params['body'];
            $message['headers'] = $params['headers'];
            break;
        case 'booking_send_ticket':
    }

}
function cassiopeia_guest_post_order_content_search_form($form,&$form_state){

    $form['#cache'] = !empty($form_state['values'])?$form_state['values']:array();
    $form_wrapper = "cassiopeia-order-content-search-form-wrapper";
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    $form['#attributes']['class'][] = "cassiopeia-order-content-search-form cassiopeia-guest-post-order-content-search-form";
    $form_state['#page'] = !empty($form_state['#page'])?$form_state['#page']:1;
    if(!empty($form_state['complete form']['#cache'])&&$form_state['complete form']['#cache']['num_per_page']!=$form_state['values']['num_per_page']){
        $form_state['#page'] = 1;
    }
    $form['sort_by'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'title' => t('Tên đơn vị'),
            'website' => t('Website'),
            'price' => t('Giá niêm yết'),
            'promotion_price' => t('Khuyến mại'),
            'tel' => t('Giá ưu đãi'),
            'email' => t('Số điện thoại'),
        ),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
        '#default_value' => 'title',
        '#required' => TRUE,
        '#attributes' => array("class"=>array("hidden"))
    );
    $form['sort_direction'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'ASC' => t('ASC'),
            'DESC' => t('DESC'),
        ),
        '#default_value' => 'DESC',
        '#attributes' => array("class"=>array("hidden"))
    );

    $form['#limit'] = $limit = !empty($form_state['values']['num_per_page'])?$form_state['values']['num_per_page']:10;
    $form['#page'] = $page =  $form_state['#page'];
    $start = ($page-1)*$limit;
    $cache = !empty($form['#cache'])?$form['#cache']:null;

    $form['#attached']['js'] = array(
        drupal_get_path('module', 'cassiopeia_guest_post') . '/js/cassiopeia-guest-post-order-content-search-form.js'
    );
    try{
        $query = db_select("cassiopeia_guest_post_order_content","cassiopeia_guest_post_order_content");
        $query->fields("cassiopeia_guest_post_order_content");
        $query->condition("cassiopeia_guest_post_order_content.status",1);
        if(!empty($cache['title'])){
            $or = db_or();
            $or->condition("cassiopeia_guest_post_order_content.title","%".$cache['title']."%","LIKE");
            $or->condition("cassiopeia_guest_post_order_content.website","%".$cache['title']."%","LIKE");
            $query->condition($or);
        }
//        $query->orderBy($form['sort_by']['#value'],$form['sort_direction']['#value']);


        $sort_by = !empty($form_state['values']['sort_by'])?$form_state['values']['sort_by']:"promotion_price";
        $form['#sort_direction'] = $sort_direction = !empty($form_state['values']['sort_direction'])?$form_state['values']['sort_direction']:"ASC";
        $sort_by_column = "cassiopeia_guest_post_order_content.".$sort_by;
        $query->orderBy($sort_by_column,$sort_direction);

        $total_query = db_select($query,"tbl_total");
        $total_query->addExpression("COUNT(id)","total");
        $total_result = $total_query->execute()->fetchObject();

        $query->range($start,$limit);
        $nodes = $query->execute()->fetchAll();
        $total_page = ceil($total_result->total/$limit);
        $form['#nodes'] = $nodes;
        $form['#total_result'] = $total_result;
    }catch (Exception $e){

    }
    $form['title'] = array(
        '#type' => 'textfield',
        '#title' => t('Tìm kiếm đơn vị'),
        '#attributes' => array("placeholder"=>"Tìm kiếm đơn vị...","class"=>array("seo-input")),
        '#theme_wrappers' => array(),
    );

    $form['search'] = array(
        '#type'         => 'submit',
        '#value'        => "<i class=\"fas fa-magnifying-glass fa-fw\" aria-hidden=\"true\"></i>",
        '#attributes'   => array('class'=>array('btn-type-1 btn-submit btn-search')),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_order_content_search_form_ajax_callback',
            'wrapper' => $form_wrapper,
        ),
        '#submit' => array('cassiopeia_guest_post_order_content_search_form_submit'),
    );
    $form['page'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#theme_wrappers' => array(),
        '#attributes'   => array("class"=>array("hidden")),
        '#value'    => $form_state['#page']
    );
    $form['num_per_page'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            10 => 10,
            50 => 50,
            100 => 100,
            200 => 200,
        ),
        '#default_value' => 1,
        '#theme_wrappers' => array(),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_search_form_num_per_page_change_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    if($form_state['#page']==1){
        $form['prev'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-left" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none"),"disabled"=>"disabled","readonly"=>"readonly"),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_prev_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_prev_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['prev'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-left" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none")),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_prev_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_prev_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }
    if($form_state['#page']>=$total_page){
        $form['next'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-right" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none"),"disabled"=>"disabled","readonly"=>"readonly"),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_next_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_next_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['next'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-right" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none")),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_next_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_next_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }
    return $form;
}
function cassiopeia_guest_post_order_content_search_form_ajax_callback($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_order_content_search_form_submit($form,&$form_state){
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_order_content_form($form , $form_state) {
    $form_wrapper = "cassiopeia-order-content-form-wrapper";
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    $form['#attributes']['class'][] = "cassiopeia-order-content-form";
    $form['title'] = array(
        '#type'         => 'textfield',
        '#title'        => ('Tên đơn vị (bắt buộc nhập)'),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#required'     => TRUE,
        '#attributes'   => array("autocomplete"=>"off"),
    );
    $form['field_title'] = array(
        '#type'         => 'textfield',
        '#title'        => ('Tên website/ profile cá nhân (bắt buộc nhập)'),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#required'     => TRUE,
        '#attributes'   => array("autocomplete"=>"off"),
    );
    $form['email'] = array(
        '#type'         => 'textfield',
        '#title'        => ('Email'),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#required'     => TRUE,
        '#attributes'   => array("autocomplete"=>"off"),
    );
    $form['tel'] = array(
        '#type'         => 'textfield',
        '#title'        => ('Số điện thoại'),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#required'     => TRUE,
        '#attributes'   => array("autocomplete"=>"off"),
    );
    $form['price'] = array(
        '#type'         => 'textfield',
        '#title'        => ('Giá niêm yết cho 1000 words'),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#required'     => TRUE,
        '#attributes'   => array("autocomplete"=>"off","class"=>array("number-format")),
        '#field_suffix' => "<span class='input-suffix'>VNĐ</span>"
    );
    $form['discount'] = array(
        '#type'         => 'textfield',
        '#title'        => ('Khuyến mại'),
        '#size'         => 60,
        '#maxlength'    => 128,
        '#attributes'   => array("autocomplete"=>"off","class"=>array("number-format")),
        '#required'     => TRUE,
        '#field_suffix' => "<span class='input-suffix'>%</span>"
    );

    $form['submit'] = array(
        '#type'         => 'submit',
        '#value'        => t("Đăng ký"),
        '#prefix'       => "<div class='form-buttons'>",
        '#suffix'       => "</div>",
        '#attributes'   => array("class"=>array("btn-type-2 btn-full-width")),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_order_content_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
        '#submit' => array('cassiopeia_guest_post_order_content_form_submit'),
    );
    $form['#attached']['js'] = array(
        drupal_get_path('module', 'cassiopeia_guest_post') . '/js/cassiopeia-guest-post-order-content-form.js'
    );
//    drupal_add_js('https://www.gstatic.com/recaptcha/releases/6MY32oPwFCn9SUKWt8czDsDw/recaptcha__vi.js');
    return $form;
}
function cassiopeia_guest_post_order_content_form_ajax_submit ($form, &$form_state) {

    if(!empty($form_state['#added'])){
        ctools_include('ajax');
        ctools_include('modal');
        $commands[] = ctools_modal_command_dismiss();
        $commands[] = ctools_ajax_command_reload();
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }else{
        if($form_state['#error_message']){
            ctools_include('ajax');
            $commands[] = ajax_command_invoke("","guestPostAlert",array(json_encode($form_state['#error_message'])));
        }else{
            drupal_get_messages();
            $commands[] = ajax_command_replace('#cassiopeia-order-content-form-wrapper', drupal_render($form));
        }
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }
}
function cassiopeia_guest_post_order_content_form_submit($form , &$form_state) {
    $form_state['#error_message'] = array();
    try{
        $flag = true;
        $email = $form_state['values']['email'];
        if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
            $form_state['#error_message'][] = "Email không hợp lệ!";
            $flag = false;
        }
        if(!is_numeric($form_state['values']['tel'])||strlen($form_state['values']['tel'])<8||strlen($form_state['values']['tel'])>12){
            $form_state['#error_message'][] = "Số điện thoại không hợp lệ!";
            $flag = false;
        }
        if($flag){
            $node = new stdClass();
            $node->title = $form_state['values']['title'];
            $node->raw_title = stripVN($form_state['values']['title']);
            $node->website = $form_state['values']['field_title'];
            $node->raw_website = stripVN($form_state['values']['field_title']);
            $node->email = $form_state['values']['email'];
            $node->tel = $form_state['values']['tel'];
            $node->price = $promotion_price = str_replace(".","",$form_state['values']['price']);
            $node->discount = str_replace(".","",$form_state['values']['discount']);
            if(!empty($node->discount)){
                $promotion_price = $node->price - $node->discount*$node->price/100;
            }
            $node->promotion_price = $promotion_price;
            $node->status = 0;
            cassiopeia_guest_post_order_content_save($node);
            drupal_set_message("Admin đang xét duyệt thông tin. Bạn vui lòng chờ đợi ít phút!");
            $form_state['#added'] = 1;
        }
        $form_state['rebuild'] = TRUE;
    }catch (Exception $e){
        _print_r($e);
        die;
        drupal_set_message("Đã xảy ra lỗi!");
    }
}
function cassiopeia_guest_post_article_re_post_form($form,&$form_state,$article){
//    print_r($article);
    global $user;
    $form_state['#article'] = $form['#article'] = $article;
    $form_state['#post_access'] = $post_access = false;
    $packet = cassiopeia_get_available_packet_by_uid($user->uid);
    if(!empty($packet)&&$packet->product!=BASIC){
        $form_state['#post_access'] = $post_access = true;
    }
    $_website = isset($_REQUEST['website'])?$_REQUEST['website']:null;
    $form['#preview'] = !empty($form_state['#preview'])?$form_state['#preview']:FALSE;
    $form_wrapper = "cassiopeia-guest-post-article-form-wrapper";
    $form['#attributes'] = array("class"=>array("cassiopeia-guest-post-article-form"));
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    $form['title'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#attributes'   => array("class"=>array("seo-input"),"disabled"=>"disabled","readonly"=>"readonly"),
        '#value'    => $article->title
    );
    $form['#attached']['js'] = array(
        drupal_get_path("module","cassiopeia_guest_post")."/js/cassiopeia-guest-post-article-re-post-form.js"
    );
    if($post_access){
        $form['save'] = array(
            '#type'     =>'submit',
            '#value'    => 'Lưu bài viết',
            '#attributes'   => array("class"=>array("bg-green color-white border-none btn-ajax btn-save-post")),
            '#submit'   => array('cassiopeia_guest_post_article_re_post_form_save_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_article_re_post_form_save_ajax_submit',
            ),
        );
    }
    $categories = cassiopeia_guest_post_website_category();
    $options = array();
    $websites = cassiopeia_guest_post_admin_website_load_by_category("all");
//    _print_r($websites);
    $options['all'] = "Tất cả lĩnh vực"." (".count($websites)." website)";;
    if(!empty($categories)){
        foreach($categories as $category){
            $websites = cassiopeia_guest_post_admin_website_load_by_category($category->id);
            if(!empty($websites)){
                $options[$category->id] = $category->title." (".count($websites)." website)";
            }
        }
    }
    $form['category'] = array(
        '#title' => '',
        '#type' => 'select',
        '#options' => $options,
        '#default_value' => "all",
        '#chosen' => TRUE,
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_form_ajax_callback',
            'wrapper' => $form_wrapper,
            'progress' => "fullscreen",
        ),
        '#attributes'   => array("class"=>array("seo-input"))
    );
    $tid = !empty($form_state['values']['category'])?$form_state['values']['category']:"all";
    try{
        $websites = cassiopeia_guest_post_admin_website_load_by_category($tid);
    }catch (Exception $e){
        $websites = array();
    }

    $options = array();
    $options['_none'] = "Chọn website";
    if(!empty($websites)){
        foreach($websites as $website){
            $options[$website->id] = $website->domain;
        }
    }
    $form['website'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => $options,
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_form_ajax_callback',
            'wrapper' => $form_wrapper,
            'progress' => "fullscreen",
        ),
        '#attributes'   => array("class"=>array("seo-input")),
        '#chosen' => TRUE,
    );
    if(!empty($_website)){
        $form['website']['#default_value'] = $_website;
    }
    $_website = !empty($form_state['values']['website'])?($form_state['values']['website']):$_website;
    if(!empty($_website)&&$_website!="_none"){
        $wp_categories = cassiopeia_guest_post_category_load_by_website($_website);
        $options = array();
        if(!empty($wp_categories)){
            foreach($wp_categories as $wp_category){
                $options[$wp_category->tid] = $wp_category->title;
            }
            $form['wp_category'] = array(
                '#type' => 'checkboxes',
                '#title' => t(''),
                '#options' => $options,
            );
        }
    }
    $form['image'] = array(
        '#title' => t('Ảnh đại diện'),
        '#type' => 'managed_file',
        '#upload_location' => 'public://guest-post/',
    );
    return $form;
}
function cassiopeia_guest_post_article_re_post_form_save_ajax_submit($form,&$form_state){
    if(!empty($form_state['#added'])){
        ctools_include('ajax');
//        print_r($form_state['#article']);
//        die;
//        $article = cassiopeia_guest_post_article_load($form_state['#article']->id);
        $form_state['#article']->image = !empty($form_state['#article']->image)?file_load($form_state['#article']->image):null;
        if(!empty($form_state['#article']->image)){
            $form_state['#article']->image->url = file_create_url($form_state['#article']->image->uri);
        }
        $wp_post = cassiopeia_guest_post_article_send($form_state['#article']);
//        print_r($form_state['#article']);
//        print_r($wp_post);
//        die;
        if(!empty($wp_post)&&!empty($wp_post->ID)){
            $node = cassiopeia_guest_post_article_load($form_state['#article']->id);
            $node->url_guest_post = $wp_post->guid;
            $node->publish_date = strtotime($wp_post->post_date);
            $node->post_status = $wp_post->post_status=="publish"?1:0;
            $node->post_id = $wp_post->ID;
            $node->re_post = 0;
            $file = file_load($node->image->fid);
            db_delete("file_managed")->condition("fid",$file->fid)->execute();
            drupal_unlink($file->uri);
            $node->image = 0;
//            $node->is_new = true;
            cassiopeia_guest_post_article_save($node);
//            print_r($node);
            $data['response'] = "OK";
            drupal_set_message("Đăng bài thành công!");
            $log = new stdClass();
            $log->aid = $form_state['#article']->id;
            unset($wp_post->post_content);
            $log->wp_post = serialize($wp_post);
            cassiopeia_guest_post_article_log_save($log);
            ctools_add_js('ajax-responder');
            $commands[] = ctools_ajax_command_redirect('guest-post/article');
            print ajax_render($commands);
            exit;
        }else{
            cassiopeia_guest_post_article_delete($form_state['#article']->id);
            $commands[] = ajax_command_invoke("","guestPostAlert",array(json_encode(array(0=>" Đăng bài chưa thành công. Mời bạn đăng lại bài viết!"))));
        }
//        $commands[] = ajax_command_invoke("","guestPostArticleAdd",array(json_encode($form_state['#article'])));
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }else{
        if($form_state['#error_message']){
            ctools_include('ajax');
            $commands[] = ajax_command_invoke("","guestPostAlert",array(json_encode($form_state['#error_message'])));
        }else{
            drupal_get_messages();
            $commands[] = ajax_command_replace('#cassiopeia-guest-post-article-form-wrapper', drupal_render($form));
        }
        $form_state['#error_message'] = array();
        $form_state['rebuild'];
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }
}
function cassiopeia_guest_post_article_re_post_form_save_submit($form,&$form_state){
    global $user;
    $flag = true;
//    print_r($form_state['#article']);
//    die;
    try{
        if($form_state['values']['website']=="_none"){
            $form_state['#error_message'][] = "Bạn chưa chọn website!";
            $flag = false;
        }
        if(empty($form_state['values']['image'])){
            $form_state['#error_message'][] = "Bạn chưa chọn ảnh đại diện!";
            $flag = false;
        }
        if($flag){
            if(!empty($domains)){
                foreach($domains as $_domain => $quantity){
                    $node = cassiopeia_guest_post_domain_load_by_domain($_domain);
                    $node->article_count = !empty($node->article_count)?$node->article_count+1:1;
                    $node->backlink_count = !empty($node->backlink_count)?$node->backlink_count+$quantity:$quantity;
                    cassiopeia_guest_post_domain_save($node);
                }
            }
            $article = $form_state['#article'];
            $article->website = $form_state['values']['website'];
            $website = cassiopeia_guest_post_website_load($article->website);
            $article->website_domain = $website->domain;
            foreach($form_state['values']['wp_category'] as $_cat){
                if(!empty($_cat)){
                    $article->wp_category = $form_state['values']['wp_category'];
                }
            }
            // Load the file via file.fid.
            $file = file_load($form_state['values']['image']);
            // Change status to permanent.
            $file->status = FILE_STATUS_PERMANENT;
            // Save.
            file_save($file);
            // Record that the module (in this example, user module) is using the file.
            file_usage_add($file, 'user', 'user', $user->uid);
            if(!empty($file)){
                $article->image = !empty($file)?$file:null;
            }

//            print_r($article);
//            die;
            $_node = cassiopeia_guest_post_article_save($article);
            $article = cassiopeia_guest_post_article_load($article->id);
//            print_r($article);
//            die;
            $form_state['#article'] = $article;
            $form_state['#added'] = 1;
        }

        $form_state['rebuild'] = TRUE;
//        print_r($_node);
//        print_r($form_state['#article']);
//        die;
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_point_exchange_form($form,&$form_state){
    global $user;
    $form_state['#page'] = !empty($form_state['#page'])?$form_state['#page']:1;
    if(!empty($form_state['complete form']['#cache'])&&$form_state['complete form']['#cache']['num_per_page']!=$form_state['values']['num_per_page']){
        $form_state['#page'] = 1;
    }
    $form_wrapper = "cassiopeia-guest-post-point-exchange-form-wrapper";
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    $form['#attributes'] = array("class"=>array("cassiopeia-guest-post-point-exchange-form"));
    $form['#values'] = !empty($form_state['values'])?$form_state['values']:array();
    $form['sort_by'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'domain' => t('Tên đơn vị'),
            'article_count' => t('Website'),
            'backlink_count' => t('Giá niêm yết'),
            'status' => t('Khuyến mại'),
            'changed' => t('Giá ưu đãi'),
        ),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_domain_search_form_ajax_callback',
            'wrapper' => $form_wrapper,
        ),
        '#default_value' => 'status',
        '#required' => TRUE,
        '#attributes' => array("class"=>array("hidden"))
    );
    $form['sort_direction'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'ASC' => t('ASC'),
            'DESC' => t('DESC'),
        ),
        '#default_value' => 'DESC',
        '#attributes' => array("class"=>array("hidden"))
    );
    $form['tel'] = array(
        '#type' => 'textfield',
        '#title' => t('Số điện thoại (bắt buộc nhập)'),
        '#size' => 60,
        '#maxlength' => 128,
        '#attributes'   => array("placeholder"=>"Nhập số điện thoại người nhận ( TK người nhận )","class"=>array("seo-input"),"autocomplete"=>"off"),
//        '#required' => TRUE
    );
    $form['email'] = array(
        '#type' => 'textfield',
        '#title' => 'Email (bắt buộc nhập)',
        '#size' => 60,
        '#maxlength' => 128,
        '#attributes'   => array("placeholder"=>"Nhập email người nhận ( TK người nhận )","class"=>array("seo-input"),"autocomplete"=>"off"),
//        '#required' => TRUE
    );
    $form['point'] = array(
        '#type' => 'textfield',
        '#title' => t('Số điểm chuyển (bắt buộc nhập)'),
        '#size' => 60,
        '#maxlength' => 128,
        '#attributes'   => array("placeholder"=>"Nhập số điểm muốn chuyển","class"=>array("seo-input"),"autocomplete"=>"off"),
//        '#required' => TRUE,
    );
    $form['submit'] = array(
        '#type'     =>'submit',
        '#value'    => 'Tạo giao dịch',
        '#name'    => 'submit',
        '#attributes'   => array("class"=>array("bg-green color-white border-none btn-ajax btn-medium")),
        '#submit'   => array('cassiopeia_guest_post_point_exchange_form_submit'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_point_exchange_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
//    $form['pre-save'] = array(
//        '#type'     =>'submit',
//        '#value'    => 'Tạo giao dịch',
//        '#name'    => 'pre-save',
//        '#attributes'   => array("class"=>array("bg-green color-white border-none btn-ajax btn-medium")),
//        '#submit'   => array('cassiopeia_guest_post_point_exchange_form_pre_save'),
//        '#ajax' => array(
//            'callback' => 'cassiopeia_guest_post_point_exchange_form_ajax_pre_save',
//            'wrapper' => $form_wrapper,
//        ),
//    );
    $form['exchange-update-status'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            1 => "Chuyển điểm",
            2 => "Hủy giao dịch",
        ),
        '#default_value' => 1,
        '#theme_wrappers' => array(),
    );
    $form['exchange-update'] = array(
        '#type'     =>'submit',
        '#value'    => 'Tạo giao dịch',
        '#name'    => 'exchange-update',
        '#attributes'   => array("class"=>array("bg-green color-white border-none btn-ajax btn-medium")),
        '#submit'   => array('cassiopeia_guest_post_point_exchange_form_exchange_update'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_point_exchange_form_exchange_update_ajax_callback',
            'wrapper' => $form_wrapper,
        ),
    );
    $form['exchange-update-confirm'] = array(
        '#type'     =>'submit',
        '#value'    => 'Tạo giao dịch',
        '#name'    => 'exchange-update-confirm',
        '#attributes'   => array("class"=>array("bg-green color-white border-none btn-ajax btn-medium")),
        '#submit'   => array('cassiopeia_guest_post_point_exchange_form_exchange_update_confirm'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_point_exchange_form_exchange_update_confirm_ajax_callback',
            'wrapper' => $form_wrapper,
        ),
    );
    $form['exchange-update-id'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
    );
    $form['#attached']['js'] = array(
        drupal_get_path("module","cassiopeia_guest_post")."/js/cassiopeia-guest-post-point-exchange-form.js"
    );
    $form['#limit'] = $limit = !empty($form_state['values']['num_per_page'])?$form_state['values']['num_per_page']:10;
    $form['#page'] = $page =  $form_state['#page'];
    $start = ($page-1)*$limit;
    try{
        $query = db_select("cassiopeia_guest_post_point_exchange","cassiopeia_guest_post_point_exchange");
        $query->fields("cassiopeia_guest_post_point_exchange");
        $query->orderBy("cassiopeia_guest_post_point_exchange.created","DESC");
        $query->condition("uid",$user->uid);

        $total_query = db_select($query,"tbl_total");
        $total_query->addExpression("COUNT(id)","total");
        $total_result = $total_query->execute()->fetchObject();

        $query->range($start,$limit);
        $exchanges = $query->execute()->fetchAll();
        $total_page = ceil($total_result->total/$limit);
        $form['#total_result'] = $total_result;
        $form['#nodes'] = $exchanges;
    }catch (Exception $e){
        _print_r($e);
    }
    $form['page'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#theme_wrappers' => array(),
        '#attributes'   => array("class"=>array("hidden")),
        '#value'    => $form_state['#page']
    );
    $form['num_per_page'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            10 => 10,
            50 => 50,
            100 => 100,
            200 => 200,
        ),
        '#default_value' => 1,
        '#theme_wrappers' => array(),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_search_form_num_per_page_change_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    if($form_state['#page']==1){
        $form['prev'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-left" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none"),"disabled"=>"disabled","readonly"=>"readonly"),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_prev_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_prev_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['prev'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-left" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none")),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_prev_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_prev_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }
    if($form_state['#page']>=$total_page){
        $form['next'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-right" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none"),"disabled"=>"disabled","readonly"=>"readonly"),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_next_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_next_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['next'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-right" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none")),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_next_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_next_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }

    return $form;
}
function cassiopeia_guest_post_point_exchange_form_exchange_update_confirm($form,&$form_state){
    $status = $form_state['values']['exchange-update-status'];
    $exchange = cassiopeia_guest_post_point_exchange_load($form_state['values']['exchange-update-id']);
    $exchange->status = $status;
    cassiopeia_guest_post_point_exchange_save($exchange);
    try{
        if($status == 1){
            // trừ điểm tài khoản gửi
            $point = cassiopeia_guest_post_user_point_load($exchange->uid);
            $point = !empty($point)?$point:new stdClass();
            $current_point = !empty($point->point)?$point->point:0;
            $point->point = $current_point-$exchange->point;
            $point->note = "Chuyển điểm cho tài khoản ".$exchange->receiver;
            if(empty($point->id)){
                $point->uid = $exchange->uid;
            }
            cassiopeia_guest_post_user_point_save($point);

            // cộng điểm tài khoản nhận
            $point = cassiopeia_guest_post_user_point_load($exchange->receiver);
            $point = !empty($point)?$point:new stdClass();
            $current_point = !empty($point->point)?$point->point:0;
            $point->point = $current_point+$exchange->point;
            $point->note = "Nhận điểm từ tài khoản ".$exchange->uid;
            if(empty($point->id)){
                $point->uid = $exchange->receiver;
            }
            cassiopeia_guest_post_user_point_save($point);
        }
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_point_exchange_form_exchange_update_confirm_ajax_callback($form,&$form_state){
    drupal_set_message("Chuyển điểm thành công!");
    ctools_include('ajax');
    $commands[] = ctools_ajax_command_reload();
    return array(
        '#type'     => 'ajax',
        '#commands' => $commands,
    );
}
function cassiopeia_guest_post_point_exchange_form_exchange_update_ajax_callback($form,&$form_state){
    if(!empty($form_state['#added'])){
        ctools_include('ajax');
        $commands[] = ajax_command_invoke("","guestPostPointExchangeAdd",array(json_encode($form_state['#confirm_message'])));
    }else{
        drupal_set_message("Hủy giao dịch thành công!");
        ctools_include('ajax');
        $commands[] = ctools_ajax_command_reload();
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }
    $form_state['#error_message'] = array();
    $form_state['rebuild'];
    return array(
        '#type'     => 'ajax',
        '#commands' => $commands,
    );
}
function cassiopeia_guest_post_point_exchange_form_exchange_update($form,&$form_state){
    $status = $form_state['values']['exchange-update-status'];
    $exchange = cassiopeia_guest_post_point_exchange_load($form_state['values']['exchange-update-id']);
    if($status==1){
        $receiver = user_load($exchange->receiver);
        $receiver_name = !empty($receiver->field_full_name['und'][0]['value'])?$receiver->field_full_name['und'][0]['value']:"";
        $receiver_tel = !empty($receiver->field_tel['und'][0]['value'])?" ( ".$receiver->field_tel['und'][0]['value']." - ".$receiver->mail." ) ":"";
        $form_state['#confirm_message'] = "Bạn có chắc chắn muốn chuyển điểm cho tài khoản <b>".$receiver_name."</b> ".$receiver_tel;
        $form_state['#added'] = TRUE;
    }else{
        $exchange->status = $status;
        cassiopeia_guest_post_point_exchange_save($exchange);
    }
    $form_state['rebuild'];
}
function cassiopeia_guest_post_point_exchange_load($id){
    try{
        $query = db_select("cassiopeia_guest_post_point_exchange","cassiopeia_guest_post_point_exchange");
        $query->fields("cassiopeia_guest_post_point_exchange");
        $query->condition("cassiopeia_guest_post_point_exchange.id",$id);
        $result = $query->execute()->fetchObject();
        return $result;
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_point_exchange_form_pre_save($form,&$form_state){
    $form_state['#error_message'] = [];
    $flag = true;
    if(!(cassiopeia_guest_post_point_status_check())){
        $form_state['#error_message'][] = "Tài khoản của bạn tạm thời bị khóa tính năng này!";
        $flag = false;
    }
    if($flag){
        try{
            $query = db_select("users","tbl_user");
            $query->fields("tbl_user");
            $query->join("field_data_field_tel","field_tel","field_tel.entity_id=tbl_user.uid");
            $query->condition("field_tel.bundle","user");
            $query->condition("field_tel.field_tel_value",trim($form_state['values']['tel']));
            $query->condition("tbl_user.mail",trim($form_state['values']['email']));
            $receiver = $query->execute()->fetchObject();
            if(!empty($receiver)){
                $receiver = user_load($receiver->uid);
            }
        }catch (Exception $e){
            $receiver = null;
        }
        if(empty($receiver)){
            $form_state['#error_message'][] = "Người nhận không tồn tại!";
            $flag = false;
        }
        if(empty($form_state['values']['point'])){
            $form_state['#error_message'][] = "Bạn chưa nhập số điểm muốn chuyển!";
            $flag = false;
        }
        if($flag){
            $form_state['#added'] = TRUE;
        }
    }
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_point_exchange_form_ajax_pre_save($form,&$form_state){
    if(!empty($form_state['#added'])){
        ctools_include('ajax');
        $commands[] = ajax_command_invoke("","guestPostPointExchangeAdd",array(json_encode($form_state['#confirm_message'])));
    }else{
        if($form_state['#error_message']){
            ctools_include('ajax');
            $commands[] = ajax_command_invoke("","guestPostAlert",array(json_encode($form_state['#error_message'])));
        }else{
            drupal_get_messages();
            $commands[] = ajax_command_replace('#cassiopeia-guest-post-point-exchange-form-wrapper', drupal_render($form));
        }
    }
    $form_state['#error_message'] = array();
    $form_state['rebuild'];
    return array(
        '#type'     => 'ajax',
        '#commands' => $commands,
    );
}
function cassiopeia_guest_post_point_exchange_form_submit($form,&$form_state){
    global $user;
    $form_state['#error_message'] = [];
    $flag = true;
    if(!(cassiopeia_guest_post_point_status_check())){
        $form_state['#error_message'][] = "Tài khoản của bạn tạm thời bị khóa tính năng này!";
        $flag = false;
    }
    $point = cassiopeia_guest_post_user_point_load($user->uid);
    if($point->point<$form_state['values']['point']){
        $form_state['#error_message'][] = "Tài khoản của bạn không đủ điểm để chuyển!";
        $flag = false;
    }
    if($flag){
        try{
            $query = db_select("users","tbl_user");
            $query->fields("tbl_user");
            $query->join("field_data_field_tel","field_tel","field_tel.entity_id=tbl_user.uid");
            $query->condition("field_tel.bundle","user");
            $query->condition("field_tel.field_tel_value",trim($form_state['values']['tel']));
            $query->condition("tbl_user.mail",trim($form_state['values']['email']));
            $receiver = $query->execute()->fetchObject();
            if(!empty($receiver)){
                $receiver = user_load($receiver->uid);
                $form_state['#receiver'] = $receiver;
            }
        }catch (Exception $e){
            $receiver = null;
        }
        if(empty($receiver)){
            $form_state['#error_message'][] = "Người nhận không tồn tại!";
            $flag = false;
        }
        if(empty($form_state['values']['point'])){
            $form_state['#error_message'][] = "Bạn chưa nhập số điểm muốn chuyển!";
            $flag = false;
        }
        if($flag){
            $form_state['#added'] = TRUE;
        }
    }
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_point_exchange_form_ajax_submit($form,&$form_state){
    global $user;
    if(!empty($form_state['#added'])){
        try{
            $exchange = new stdClass();
            $exchange->uid = $user->uid;
            $exchange->point = $form_state['values']['point'];
            $exchange->tel = trim($form_state['values']['tel']);
            $receiver = $form_state['#receiver'];
            $exchange->receiver = $receiver->uid;
            $exchange->status = 0;
            cassiopeia_guest_post_point_exchange_save($exchange);
        }catch (Exception $e){

        }
        drupal_set_message("Chuyển điểm thành công!");
        ctools_include('ajax');
        $commands[] = ctools_ajax_command_reload();
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }else{
        if($form_state['#error_message']){
            ctools_include('ajax');
            $commands[] = ajax_command_invoke("","guestPostAlert",array(json_encode($form_state['#error_message'])));
        }else{
            drupal_get_messages();
            $commands[] = ajax_command_replace('#cassiopeia-guest-post-point-exchange-form-wrapper', drupal_render($form));
        }
        $form_state['#error_message'] = array();
        $form_state['rebuild'];
        return array(
            '#type'     => 'ajax',
            '#commands' => $commands,
        );
    }
}
function cassiopeia_guest_post_point_exchange_save($exchange){
    try{
        if(!empty($exchange->id)){
            $exchange->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_point_exchange",$exchange,array("id"));
        }else{
            $exchange->created = REQUEST_TIME;
            $exchange->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_point_exchange",$exchange);
        }
    }catch (Exception $e){

    }
}


function cassiopeia_guest_post_order_content_edit_form($form,&$form_state,$data = array("node"=>null)){
    $form_state['#node'] = $booking = $data['node'];
    $form['status'] = array(
        '#type' => 'select',
        '#title' => t('Tình trạng'),
        '#options' => array(
            0   => "Đang chờ",
            1   => "Hoàn thành",
            2   => "Đã hủy",
        ),
        '#default_value' => $booking->status,
        '#required' => TRUE,
    );
    $form['submit'] = array(
        '#type'     =>'submit',
        '#value'    => 'Lưu',
        '#attributes'   => array("class"=>array("btn-green border-none")),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_order_content_edit_form_ajax_submit',
        ),
    );
    return $form;
}
function cassiopeia_guest_post_order_content_edit_form_ajax_submit($form,&$form_state){
    ctools_include('ajax');
    ctools_include('modal');
    $commands[] = ctools_modal_command_dismiss();
    $commands[] = ctools_ajax_command_reload();
    return array(
        '#type'     => 'ajax',
        '#commands' => $commands,
    );
}

function cassiopeia_guest_post_order_content_edit_form_submit($form,&$form_state){
    global $user;
    $node = $form_state['#node'];
    $node->status = $form_state['values']['status'];
    $node->tran_user = $user->uid;
    cassiopeia_guest_post_order_content_save($node);
    drupal_set_message("Cập nhật thành công!");
}
function cassiopeia_guest_post_order_content_save($node){
    try{
        if(!empty($node->id)){
            $node->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_order_content",$node,array("id"));
        }else{
            $node->created = REQUEST_TIME;
            $node->changed = REQUEST_TIME;
            drupal_write_record("cassiopeia_guest_post_order_content",$node);
        }
    }catch (Exception $e){

    }
}
function cassiopeia_guest_post_article_tag_form($form,&$form_state){
    global $user;
    $form_wrapper = "cassiopeia-guest-post-article-tag-form-wrapper";
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    $form['#attributes'] = array("class"=>array("cassiopeia-guest-post-article-tag-form"));
    try{
        $query = db_select("cassiopeia_guest_post_tag","cassiopeia_guest_post_tag");
        $query->fields("cassiopeia_guest_post_tag");
        $query->condition("cassiopeia_guest_post_tag.uid",$user->uid);
        $query->orderBy("cassiopeia_guest_post_tag.created","DESC");
        $result = $query->execute()->fetchAll();
        
        if(!empty($result)){
            foreach($result as $item){
                $form['tags'][$item->id] = array(
                    '#type' => 'container',
                    '#tree' => TRUE,
                );
                $form['tags'][$item->id]['title'] = array(
                    '#type' => 'textfield',
                    '#title' => t(''),
                    '#size' => 60,
                    '#maxlength' => 128,
                    '#default_value' => $item->title
                );
                $form['tags'][$item->id]['submit'] = array(
                    '#type'     =>'submit',
                    '#value'    => 'Xóa',
                    '#attributes'   => array("class"=>array("btn-co-danger border-none")),
                    '#submit'   => array('cassiopeia_guest_post_article_tag_form_delete'),
                    '#ajax' => array(
                        'callback' => 'cassiopeia_guest_post_article_tag_form_ajax_delete',
                    ),
                );
            }
        }
    }catch (Exception $e){

    }
    $form['submit'] = array(
        '#type'     =>'submit',
        '#value'    => 'Lưu',
        '#attributes'   => array("class"=>array("btn-green border-none")),
        '#submit'   => array('cassiopeia_guest_post_article_tag_form_submit'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_tag_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    return $form;
}
function cassiopeia_guest_post_article_tag_form_submit($form,&$form_state){
    global $user;
    try{
        foreach($form_state['values'] as $key => $value){
            if(is_numeric($key)){
                $_tag = cassiopeia_guest_post_tag_load($key);
                $_tag->title = $form_state['values'][$key]['title'];
                cassiopeia_guest_post_tag_save($_tag);
            }
        }
    }catch (Exception $e){

    }
    $form_state['rebuild'] = TRUE;
}
function cassiopeia_guest_post_article_tag_form_ajax_submit($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_tag_delete($id){
    $transaction = db_transaction();
    try{
        db_delete("cassiopeia_guest_post_tag")->condition("id",$id)->execute();
        db_delete("cassiopeia_guest_post_article_tag")->condition("tid",$id)->execute();
    }catch (Exception $e){
        $transaction->rollback();
    }
}
function cassiopeia_guest_post_tag_load($id){
    $transaction = db_transaction();
    try{
        $query = db_select("cassiopeia_guest_post_tag","cassiopeia_guest_post_tag");
        $query->fields("cassiopeia_guest_post_tag");
        $query->condition("cassiopeia_guest_post_tag.id",$id);
        $result = $query->execute()->fetchObject();
        return $result;
    }catch (Exception $e){
        $transaction->rollback();
    }
}

function cassiopeia_guest_post_accept(){
    global $user;
    if(user_has_role(3)){
        return true;
    }
    $available_point = cassiopeia_guest_post_user_available_point_load($user->uid);
    if($available_point->point>0||$available_point->day_point>0){
        return true;
    }
    drupal_goto("node/986751");
}
function cassiopeia_guest_post_article_add_accept(){
    global $user;
    if(user_has_role(3)){
        return true;
    }
    if(!cassiopeia_guest_post_accept()){
        return false;
    }
    if(!cassiopeia_guest_post_point_status_check()){
       return false;
    }
    $available_point = cassiopeia_guest_post_user_available_point_load($user->uid);
    if($available_point->point_status==0||$available_point->day_point_status==0 ||($available_point->point<POINT_PER_ARTICLE&&$available_point->day_point<POINT_PER_ARTICLE)){
        return false;
    }
    return true;
}
function cassiopeia_guest_post_article_edit_accept($article){
    global $user;
    if(empty($article->draft)){
        return false;
    }
    if(user_has_role(3)){
        return true;
    }
    if(!cassiopeia_guest_post_accept()){
        return false;
    }
    if(!cassiopeia_guest_post_point_status_check()){
       return false;
    }
    $available_point = cassiopeia_guest_post_user_available_point_load($user->uid);
    if($available_point->point_status==0||$available_point->day_point_status==0 ||($available_point->point<POINT_PER_ARTICLE&&$available_point->day_point<POINT_PER_ARTICLE)){
        return false;
    }
    return true;
}
function cassiopeia_guest_post_complain_add_accept(){
    global $user;
    if(user_has_role(3)){
        return true;
    }
    if(!cassiopeia_guest_post_accept()){
        return false;
    }
    if(!cassiopeia_guest_post_point_status_check()){
        return false;
    }
    $available_point = cassiopeia_guest_post_user_available_point_load($user->uid);
    if($available_point->point<20){
     return false;
    }
    return true;
}
function cassiopeia_guest_post_point_status_check(){
    global $user;
    if(user_has_role(3)){
        return true;
    }
    $available_point = cassiopeia_guest_post_user_available_point_load($user->uid);
    if($available_point->point_status==0||$available_point->day_point_status==0){
        return false;
    }
    return true;
}
function cassiopeia_guest_post_send_domain_change_booking_mail($account,$node){
    $cc = "";
    $cc_mail = variable_get("cassiopeia_config_mail_guest_post_domain_booking_receiver_mail");
    $splitter = explode(",",$cc_mail);
    $index=1;
    if(!empty($splitter)){
        foreach($splitter as $item){
            if($index>1){
                $cc.=",".trim($item);
            }else{
                $cc.=trim($item);
            }
            $index++;
        }
    }
    $full_name = !empty($account->field_full_name['und'][0]['value'])?$account->field_full_name['und'][0]['value']:"";
    $field_tel = !empty($account->field_tel['und'][0]['value'])?$account->field_tel['und'][0]['value']:"";
    $body[] = "<table class=\"table table-hover table-stripped\">
    <tbody>
        <tr>
            <td>Họ tên:</td>
            <td>".$full_name."</td>
        </tr>
        <tr>
            <td>Email:</td>
            <td>".$account->mail."</td>
        </tr>
        <tr>
            <td>Số điện thoại:</td>
            <td>".$field_tel."</td>
        </tr> 
        <tr>
            <td>Số tiền:</td>
            <td>".number_format($node->total_price,0,",",".")." VND</td>
        </tr>
    </tbody>
</table>";
    $headers['From'] = $headers['Sender'] = $headers['Return-Path'] = "";
    $headers['MIME-Version'] = '1.0';
    $headers['Content-Type'] = 'text/html; charset=UTF-8; format=flowed; delsp=yes';
    if(!empty($cc)){
        $headers['Cc'] = $cc;
    }
    $params = array(
        'body' => $body,
        'subject' => "Khách hàng ".$full_name." mua ".$node->quantity." lượt đổi domain đặt Backlink",
        'headers' => $headers,
    );
    if (drupal_mail('cassiopeia_guest_post', 'custom_key', $splitter[0], language_default(), $params)) {};
}
function cassiopeia_guest_post_demo_ajax_form($form,&$form_state){
    $form['#cache'] = !empty($form_state['values'])?$form_state['values']:array();
    $form_wrapper = "cassiopeia-guest-post-website-search-form-wrapper";
    $form['#prefix'] = "<div id='".$form_wrapper."'>";
    $form['#suffix'] = "</div>";
    $form['#attributes'] = array("class"=>array("cassiopeia-guest-post-website-search-form advanced-filter"));
    $form_state['#page'] = !empty($form_state['#page'])?$form_state['#page']:1;
    if(!empty($form_state['complete form']['#cache'])&&$form_state['complete form']['#cache']['num_per_page']!=$form_state['values']['num_per_page']){
        $form_state['#page'] = 1;
    }
    $form['sort_by'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'domain' => t('Tên đơn vị'),
            'ref_domain' => t('Website'),
            'organic_traffic' => t('Giá niêm yết'),
            'posted' => t('Khuyến mại'),
            'posted_of_day' => t('Giá ưu đãi'),
            'last_posted_date' => t('Số điện thoại'),
        ),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_form_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
        '#default_value' => 'last_posted_date',
        '#required' => TRUE,
        '#attributes' => array("class"=>array("hidden"))
    );
    $form['sort_direction'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            'ASC' => t('ASC'),
            'DESC' => t('DESC'),
        ),
        '#default_value' => 'DESC',
        '#attributes' => array("class"=>array("hidden"))
    );

    $form['#limit'] = $limit = !empty($form_state['values']['num_per_page'])?$form_state['values']['num_per_page']:10;
    $form['#page'] = $page =  $form_state['#page'];
    $start = ($page-1)*$limit;
    $cache = !empty($form['#cache'])?$form['#cache']:null;
    try{

        $sort_by = !empty($form_state['values']['sort_by'])?$form_state['values']['sort_by']:"last_posted_date";
        $form['#sort_direction'] = $sort_direction = !empty($form_state['values']['sort_direction'])?$form_state['values']['sort_direction']:"DESC";
        $sort_by_column = "cassiopeia_guest_post_website.".$sort_by;
        $query->orderBy($sort_by_column,$sort_direction);

        $total_query = db_select($query,"tbl_total");
        $total_query->addExpression("COUNT(id)","total");
        $total_result = $total_query->execute()->fetchObject();

        $query->range($start,$limit);
        $websites = $query->execute()->fetchAll();
        $total_page = ceil($total_result->total/$limit);
        $form['#websites'] = $websites;
        $form['#total_result'] = $total_result;
    }catch (Exception $e){

    }
    $form['page'] = array(
        '#type' => 'textfield',
        '#title' => t(''),
        '#size' => 60,
        '#maxlength' => 128,
        '#theme_wrappers' => array(),
        '#attributes'   => array("class"=>array("hidden")),
        '#value'    => $form_state['#page']
    );
    $form['num_per_page'] = array(
        '#type' => 'select',
        '#title' => t(''),
        '#options' => array(
            10 => 10,
            50 => 50,
            100 => 100,
            200 => 200,
        ),
        '#default_value' => 1,
        '#theme_wrappers' => array(),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_website_search_form_num_per_page_change_ajax_submit',
            'wrapper' => $form_wrapper,
        ),
    );
    if($form_state['#page']==1){
        $form['prev'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-left" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none"),"disabled"=>"disabled","readonly"=>"readonly"),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_prev_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_prev_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['prev'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-left" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none")),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_prev_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_prev_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }
    if($form_state['#page']>=$total_page){
        $form['next'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-right" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none"),"disabled"=>"disabled","readonly"=>"readonly"),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_next_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_next_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }else{
        $form['next'] = array(
            '#type'     =>'submit',
            '#value'    => '<i class="fa fa-angle-right" aria-hidden="true"></i>',
            '#attributes'   => array("class"=>array("border-none")),
            '#submit'   => array('cassiopeia_guest_post_website_search_form_next_page_submit'),
            '#ajax' => array(
                'callback' => 'cassiopeia_guest_post_website_search_form_next_page_ajax_submit',
                'wrapper' => $form_wrapper,
            ),
        );
    }
    $form['article_add'] = array(
        '#type'     =>'submit',
        '#value'    => '<i class="fa fa-plus"></i> Đăng bài guest post',
        '#name'    => 'article_add',
        '#attributes'   => array("class"=>array("btn-green border-none")),
        '#submit'   => array('cassiopeia_guest_post_article_search_form_article_add_submit'),
//        '#validate'   => array('cassiopeia_guest_post_website_export_form_validate'),
        '#ajax' => array(
            'callback' => 'cassiopeia_guest_post_article_search_form_article_add_ajax_submit',
        ),
    );
    return $form;
}
function cassiopeia_guest_post_form_ajax_submit($form,&$form_state){
    return $form;
}
function cassiopeia_guest_post_article_log_save($log){
    global $user;
    $log->uid = $user->uid;
    $log->changed = REQUEST_TIME;
    $log->created = REQUEST_TIME;
    try{
        drupal_write_record("cassiopeia_guest_post_article_log",$log);
    }catch (Exception $e){

    }
}